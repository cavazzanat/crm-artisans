<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ operation.id_operation }} - {{ operation.type_prestation }} â€“ CRM Artisans</title>
    {% load static %}
  <link rel="icon" type="image/png" href="/static/core/image/favicon.png">
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
      --ring: rgba(99,102,241,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: var(--bg);
      color: var(--text); 
      line-height: 1.6; 
      padding-bottom:3rem;
    }

    /* ========================================
       EN-TÃŠTE MODERNE (DASHBOARD STYLE)
       ======================================== */
    .header{ 
      position: sticky; 
      top: 0; 
      z-index: 40;
      backdrop-filter: saturate(180%) blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .header-inner{ 
      max-width:1280px; 
      margin:0 auto; 
      padding:.85rem 1rem; 
      display:flex; 
      align-items:center; 
      gap:1rem; 
      justify-content:space-between;
    }
    .brand{ 
      display:flex; 
      align-items:center; 
      gap:.75rem; 
      font-weight:700; 
      letter-spacing:.2px; 
      color: var(--text); 
    }
    .logo{ 
      width:34px; 
      height:34px; 
      border-radius:10px; 
      background:linear-gradient(145deg, var(--primary), var(--accent)); 
      box-shadow: var(--shadow); 
      display:grid; 
      place-items:center;
    }
    .logo svg{ width:18px; height:18px; color:white }

    .nav{ 
      display: flex; 
      gap: .25rem; 
      align-items: center;
    }
    .nav a{ 
      text-decoration: none; 
      color: var(--muted); 
      padding: .55rem .8rem; 
      border-radius: 10px; 
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }
    .nav a:hover{ 
      color: var(--text); 
      background: rgba(148,163,184,.08); 
      border-color: var(--border);
    }
    .nav a.active{ 
      color: white; 
      background: rgba(99,102,241,.18); 
      border-color: rgba(99,102,241,.35); 
      box-shadow: 0 0 0 2px var(--ring);
    }

    .user{ 
      display: flex; 
      align-items: center; 
      gap: .75rem; 
      color: var(--muted); 
      font-size: .95rem;
    }
    .user form button{ 
      background: none; 
      border: none; 
      color: var(--muted); 
      cursor: pointer; 
      text-decoration: underline; 
      font: inherit; 
      padding: 0;
    }
    .user form button:hover{ color: var(--text); }

    /* ========================================
       RESTE DU STYLE
       ======================================== */
    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    
    h1{ font-size:1.8rem; font-weight:800; margin-bottom:.5rem; color: var(--text); }
    .breadcrumb{ color:var(--muted); font-size:.9rem; margin-bottom:1rem }
    .breadcrumb a{ color:var(--muted); text-decoration:none }
    .breadcrumb a:hover{ color:var(--text) }

    .status-badge{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; 
      border-radius:20px; font-size:.85rem; font-weight:600; border:1px solid;
    }
    .status-badge::before{ content:''; width:8px; height:8px; border-radius:50%; background:currentColor }
    .status-badge.en_attente_devis{ color:#f59e0b; background: rgba(245,158,11,.1); border-color: rgba(245,158,11,.3); }
    .status-badge.a_planifier{ color:#3b82f6; background: rgba(59,130,246,.1); border-color: rgba(59,130,246,.3); }
    .status-badge.planifie{ color:#8b5cf6; background: rgba(139,92,246,.1); border-color: rgba(139,92,246,.3); }
    .status-badge.realise{ color:#22c55e; background: rgba(34,197,94,.1); border-color: rgba(34,197,94,.3); }
    .status-badge.paye{ color:#10b981; background: rgba(16,185,129,.1); border-color: rgba(16,185,129,.3); }
    .status-badge.devis_refuse{ color:#ef4444; background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.3); }
    
    .section{ 
      background: white;
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:1.5rem; 
      box-shadow: var(--shadow); 
      margin-bottom:1.5rem 
    }
    .section-header{ 
      display:flex; align-items:center; justify-content:space-between; gap:1rem; 
      padding-bottom:1rem; border-bottom:1px solid var(--border); margin-bottom:1rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }
    .section-header:hover {
      background: rgba(148,163,184,.03);
      border-radius: 8px;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700; color: var(--text); }

    /* ========================================
       SECTIONS REPLIABLES (ACCORDÃ‰ON)
       ======================================== */
    .section-header .toggle-icon {
      transition: transform 0.3s ease;
      color: var(--muted);
      flex-shrink: 0;
    }

    .section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .section-body {
      max-height: 5000px;
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
      opacity: 1;
    }

    .section-body.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    /* Badge indicateur sur les sections */
    .section-badge {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .2rem .5rem;
      border-radius: 12px;
      font-size: .75rem;
      font-weight: 600;
      margin-left: .5rem;
    }

    .section-badge.complete {
      background: rgba(34,197,94,.1);
      color: var(--success);
      border: 1px solid rgba(34,197,94,.2);
    }

    .section-badge.pending {
      background: rgba(245,158,11,.1);
      color: var(--warning);
      border: 1px solid rgba(245,158,11,.2);
    }

    .section-badge.disabled {
      background: rgba(148,163,184,.1);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,.2);
    }

    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem }
    .info-card{
      background: #f8fafc;
      border:1px solid var(--border); 
      border-radius:10px; 
      padding:1rem; 
      transition: all 0.2s ease;
    }
    .info-card:hover{ background: #f1f5f9; border-color: #cbd5e1; }
    .info-card .label{
      display:flex; align-items:center; gap:.5rem; color:var(--muted); 
      font-size:.85rem; font-weight:600; text-transform:uppercase; 
      letter-spacing:.05rem; margin-bottom:.75rem
    }
    .info-card .value{ color: var(--text); font-weight: 600; font-size: 1rem; line-height: 1.4 }

    .input, .select{ 
      width:100%; padding:.65rem .8rem; border-radius:8px; border:1px solid var(--border); 
      background: white; color: var(--text); font:inherit 
    }
    .input:focus, .select:focus{ 
      outline:none; 
      box-shadow: 0 0 0 3px rgba(99,102,241,.1); 
      border-color: var(--primary);
    }

    .btn{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; 
      border-radius:8px; border:1px solid var(--border); 
      background:white; color:var(--text); cursor:pointer; font:inherit; text-decoration:none;
      transition: all 0.2s;
    }
    .btn:hover{ background:#f8fafc; border-color: #cbd5e1; }
    .btn.success{ background:var(--success); border-color: var(--success); color: white; }
    .btn.success:hover{ background:#16a34a; }
    .btn.primary{ background:var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover{ background:#4f46e5; }
    .btn.danger{ background: var(--danger); border-color: var(--danger); color: white; }
    .btn.danger:hover{ background:#dc2626; }
    .btn.sm{ padding:.4rem .6rem; border-radius:6px; font-size:.9rem }

    .alert{ 
      padding:.75rem 1rem; border-radius:8px; margin-top:1rem; 
      display:flex; align-items:center; gap:.5rem; font-size:.9rem;
    }
    .alert.warning{ background: #fef3c7; color: #92400e; border:1px solid #fde68a; }
    .alert.danger, .alert.error{ background: #fee2e2; color: #991b1b; border:1px solid #fecaca; }
    .alert.success{ background: #d1fae5; color: #065f46; border:1px solid #a7f3d0; }
    .alert.info{ background: #dbeafe; color: #1e40af; border:1px solid #bfdbfe; }

    .radio-option{ 
      display:flex; align-items:center; gap:.5rem; padding:.6rem 1rem; 
      border:2px solid var(--border); border-radius:8px; cursor:pointer; 
      transition: all .2s; margin-bottom:.5rem; background: white;
    }
    .radio-option:hover{ border-color:var(--primary); background:#f8fafc; }
    .radio-option.selected{ border-color:var(--primary); background:#eef2ff; box-shadow: 0 0 0 3px rgba(99,102,241,.1); }
    .radio-option input[type="radio"]{ width:auto; margin:0; cursor:pointer }
    .radio-option label{ margin:0; cursor:pointer; font-weight:500; flex:1 }

    .payment-box{ background: #f8fafc; border:1px solid var(--border); border-radius:10px; padding:1rem; margin-top:1rem }

    .table-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--border); margin-top:1rem; background: white; }
    table{ width:100%; border-collapse: collapse }
    thead th{ 
      background: #f8fafc; color:var(--muted); text-transform:uppercase; letter-spacing:.08rem; 
      font-size:.75rem; text-align:left; padding:.9rem .85rem; border-bottom:1px solid var(--border)
    }
    tbody td{ padding:.9rem .85rem; border-bottom:1px solid var(--border); }
    tbody tr:hover{ background: #f8fafc; }
    .echeance-row{ background: #f0fdf4; }
    .reste-row{ background: #fef3c7; font-weight:700; color:#92400e; }
    .total-row{ background: #eef2ff; font-weight:700; }

    .workflow-steps{
      display:flex; align-items:center; gap:.5rem; margin-top:1rem; padding:1rem; 
      background:white; border-radius:10px; flex-wrap:wrap; border:1px solid var(--border);
    }
    .workflow-step{
      padding:.4rem .8rem; background:#f1f5f9; 
      border-radius:6px; font-size:.8rem; color:var(--muted); font-weight:600;
    }
    .workflow-step.active{ background:var(--primary); color:white; }
    .workflow-arrow{ color:var(--muted); font-weight:bold }

    .main-content{ 
      display: grid; 
      grid-template-columns: 2fr 1fr; 
      gap: 2rem; 
      align-items: start; /* â† AJOUTEZ CETTE LIGNE */
    }
    .hidden { display: none !important; }

    /* ========================================
   NOTIFICATIONS TOAST
   ======================================== */
.toast-container {
  position: fixed;
  top: 80px; /* â† ChangÃ© de 20px Ã  80px pour Ãªtre sous le header */
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
  align-items: center;
}

.toast {
  min-width: 320px;
  max-width: 420px;
  padding: 1rem 1.25rem;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,.15), 0 4px 12px rgba(0,0,0,.1);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  pointer-events: auto;
  animation: slideInRight 0.3s ease-out;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,.2);
}

.toast.hiding {
  animation: slideOutRight 0.3s ease-in forwards;
}

@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

.toast-icon {
  flex-shrink: 0;
  width: 24px;
  height: 24px;
}

.toast-content {
  flex: 1;
  font-size: 0.95rem;
  line-height: 1.5;
}

.toast-close {
  flex-shrink: 0;
  width: 20px;
  height: 20px;
  border: none;
  background: none;
  cursor: pointer;
  opacity: 0.6;
  transition: opacity 0.2s;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast-close:hover {
  opacity: 1;
}

/* Types de toast */
.toast.success {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
  color: white;
}

.toast.error {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
  color: white;
}

.toast.warning {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
  color: white;
}

.toast.info {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
  color: white;
}

/* Responsive */
@media (max-width: 640px) {
  .toast-container {
    top: 70px;
    right: 10px;
    left: 10px;
  }
  
  .toast {
    min-width: auto;
    max-width: none;
  }
}

/* ========================================
   SECTION COMMENTAIRES STICKY
   ======================================== */
.sticky-notes {
  position: -webkit-sticky !important; /* Safari */
  position: sticky !important;
  top: 90px !important;
  align-self: flex-start !important; /* Plus compatible que 'start' */
  max-height: calc(100vh - 110px);
  overflow-y: auto;
}

/* ========================================
   FIX CRITIQUE POUR LE STICKY
   ======================================== */
.sticky-notes.section {
  overflow: visible !important; /* EmpÃªche overflow:hidden de casser le sticky */
}

.sticky-notes .section-body {
  overflow: visible !important; /* Idem pour le body */
}

/* Force le comportement sticky sur la colonne droite */
.right-column {
  position: relative;
  z-index: 1;
}

.notes-textarea {
  width: 100%;
  min-height: 150px;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  color: var(--text);
  font-family: inherit;
  font-size: 0.95rem;
  resize: vertical;
  transition: all 0.2s ease;
}

.notes-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99,102,241,.1);
}

.notes-textarea::placeholder {
  color: var(--muted);
  opacity: 0.6;
}

.notes-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.75rem;
  justify-content: flex-end;
}

/* Responsive : dÃ©sactiver sticky sur mobile */
@media (max-width: 1024px) {
  .sticky-notes {
    position: static !important;
    max-height: none;
  }
}

    @media (max-width: 1024px){ 
      .main-content{ grid-template-columns: 1fr }
      .nav{ flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>manay</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}">Accueil</a>
        <a href="{% url 'operations' %}" class="active">OpÃ©rations</a>
        <a href="{% url 'clients' %}">Clients</a>
        <a href="{% url 'profil' %}">Profil</a>
      </nav>
      <div class="user">
        <span>{{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit">DÃ©connexion</button>
        </form>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'dashboard' %}">Accueil</a> / 
      <a href="{% url 'operations' %}">OpÃ©rations</a> / 
      {{ operation.id_operation }}
    </div>

    
{% if messages %}
<div id="django-messages" style="display:none">
  {% for message in messages %}
  <div data-type="{{ message.tags }}" data-message="{{ message }}"></div>
  {% endfor %}
</div>
{% endif %}



    <!-- âœ… NOUVEAU : En-tÃªte avec bouton de suppression -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; flex-wrap:wrap">
      <div>
        <h1>{{ operation.id_operation }} - {{ operation.type_prestation }}</h1>
        <span class="status-badge {{ operation.statut }}">{{ operation.get_statut_display }}</span>
      </div>
      
      <form method="POST" action="{% url 'operation_delete' operation.id %}" onsubmit="return confirmDeleteOperation()" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="force_delete" value="true">
        <button type="submit" class="btn danger" title="Supprimer l'opÃ©ration">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M9 7v12m6-12v12M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13M9 7l1-3h4l1 3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
          Supprimer l'opÃ©ration
        </button>
      </form>
    </div>

    <div class="workflow-steps">
      <div class="workflow-step {% if operation.statut == 'en_attente_devis' %}active{% endif %}">Devis</div>
      <div class="workflow-arrow">â†’</div>
      <div class="workflow-step {% if operation.statut == 'a_planifier' %}active{% endif %}">Ã€ planifier</div>
      <div class="workflow-arrow">â†’</div>
      <div class="workflow-step {% if operation.statut == 'planifie' %}active{% endif %}">PlanifiÃ©</div>
      <div class="workflow-arrow">â†’</div>
      <div class="workflow-step {% if operation.statut == 'realise' %}active{% endif %}">RÃ©alisÃ©</div>
      <div class="workflow-arrow">â†’</div>
      <div class="workflow-step {% if operation.statut == 'paye' %}active{% endif %}">PayÃ©</div>
    </div>

    <div class="main-content">
      <div class="left-column">
    <!-- ========================================
        INFORMATIONS GÃ‰NÃ‰RALES
        ======================================== -->
    <section class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
          Informations gÃ©nÃ©rales
          <span class="section-badge complete">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
            ComplÃ©tÃ©
          </span>
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="section-body">
        <div class="info-grid">
          <div class="info-card">
            <div class="label">Client</div>
            <div class="value">
              <strong>{{ operation.client.nom }} {{ operation.client.prenom }}</strong><br>
              <a href="{% url 'client_detail' client_id=operation.client.id %}" style="color:var(--primary); text-decoration:none">Voir le profil</a>
            </div>
          </div>
          <div class="info-card">
            <div class="label">Type de prestation</div>
            <div class="value">{{ operation.type_prestation }}</div>
          </div>
          <div class="info-card">
            <div class="label">Adresse</div>
            <div class="value">{{ operation.adresse_intervention }}</div>
          </div>
          <div class="info-card">
            <div class="label">Contact</div>
            <div class="value">
              <a href="tel:{{ operation.client.telephone }}" style="color:var(--primary); text-decoration:none">
                {{ operation.client.telephone }}
              </a>
              {% if operation.client.email %}
              <br><a href="mailto:{{ operation.client.email }}" style="color:var(--primary); text-decoration:none">
                {{ operation.client.email }}
              </a>
              {% endif %}
            </div>
          </div>
        </div>



      </div>
    </section>

    
  <!-- ========================================
      SECTION DEVIS - VERSION MULTI-DEVIS CONDENSÃ‰E
      ======================================== -->
  {% if operation.avec_devis %}
  <section class="section" id="section-devis">
    <div class="section-header" onclick="toggleSection(this)">
      <h2 class="section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" stroke="currentColor" stroke-width="1.6"/></svg>
        ğŸ“‹ Devis
        
        {% if nombre_devis > 0 %}
        <span class="section-badge complete">{{ nombre_devis }} devis</span>
        {% else %}
        <span class="section-badge pending">Aucun devis</span>
        {% endif %}
      </h2>
      <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    
    <div class="section-body">
      
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          BOUCLE SUR TOUS LES DEVIS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      {% for devis in devis_list %}
      <div class="devis-card" style="border: 2px solid {% if devis.statut == 'accepte' %}var(--success){% elif devis.statut == 'refuse' %}var(--danger){% elif devis.statut == 'envoye' %}var(--primary){% else %}var(--border){% endif %}; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; background: white;">
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            EN-TÃŠTE DU DEVIS (toujours visible, cliquable)
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="devis-header" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; cursor: pointer; padding-bottom: 1rem; border-bottom: 1px solid var(--border);" onclick="toggleDevis({{ devis.id }})">
          <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
            <h3 style="margin: 0; color: var(--text); font-size: 1.1rem; font-weight: 700;">
              Devis {{ devis.version }} - {{ devis.numero_devis }}
            </h3>
            
            <!-- Badge statut -->
            {% if devis.statut == 'brouillon' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(148,163,184,.1); color: var(--muted); border: 1px solid rgba(148,163,184,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              ğŸ“ Brouillon
            </span>

            {% elif devis.statut == 'pret' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(59,130,246,.1); color: #3b82f6; border: 1px solid rgba(59,130,246,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              ğŸ“„ PrÃªt (Ã  envoyer)
            </span>
            
            {% elif devis.statut == 'envoye' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(249,115,22,.1); color: #f97316; border: 1px solid rgba(249,115,22,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              {% if devis.est_expire_display %}
              âš ï¸ ExpirÃ©
              {% else %}
              ğŸ“¤ EnvoyÃ© (en attente)
              {% endif %}
            </span>
            
            {% elif devis.statut == 'accepte' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(34,197,94,.1); color: var(--success); border: 1px solid rgba(34,197,94,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              âœ… AcceptÃ©
            </span>
            
            {% elif devis.statut == 'refuse' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(239,68,68,.1); color: var(--danger); border: 1px solid rgba(239,68,68,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              âŒ RefusÃ©
            </span>
            {% endif %}
          </div>
          
          <div style="display: flex; align-items: center; gap: 1rem;">
            <span style="font-size: 1.2rem; font-weight: 700; color: var(--primary);">
              {{ devis.total_ttc|floatformat:2 }} â‚¬ TTC
            </span>
            <svg class="toggle-devis-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" style="transition: transform 0.3s ease; color: var(--muted);">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
        </div>
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            CORPS DU DEVIS (repliable)
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="devis-body" id="devis-body-{{ devis.id }}" style="max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.4s ease, opacity 0.3s ease, padding-top 0.3s ease;">
          
          <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              LIGNES DU DEVIS (version compacte)
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          {% if devis.lignes_list %}
          <div style="margin-top: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">Lignes du devis</h4>
            
            <!-- Lignes sous forme de liste compacte -->
            <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
              {% for ligne in devis.lignes_list %}
              <div style="display: grid; grid-template-columns: 1fr 80px 100px 120px 80px 120px {% if devis.statut == 'brouillon' %}40px{% endif %}; gap: 0.75rem; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border); background: {% cycle 'white' '#f9fafb' %};">
                <div style="font-size: 0.9rem; color: var(--text);">{{ ligne.description }}</div>
                <div style="text-align: center; font-size: 0.85rem;">{{ ligne.quantite|floatformat:"-2" }} {{ ligne.get_unite_display }}</div>
                <div style="text-align: right; font-weight: 600; font-size: 0.85rem;">{{ ligne.prix_unitaire_ht|floatformat:2 }} â‚¬</div>
                <div style="text-align: center; font-size: 0.85rem;">TVA {{ ligne.taux_tva|floatformat:0 }}%</div>
                <div style="text-align: right; font-weight: 600; font-size: 0.9rem; color: var(--primary);">{{ ligne.montant|floatformat:2 }} â‚¬</div>
                
                {% if devis.statut == 'brouillon' %}
                <form method="POST" style="display:inline; margin: 0;" onsubmit="return confirm('Supprimer cette ligne ?')">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete_ligne_devis">
                  <input type="hidden" name="ligne_id" value="{{ ligne.id }}">
                  <button type="submit" class="btn danger sm" style="padding: 0.3rem 0.6rem; font-size: 0.85rem; margin: 0;">Ã—</button>
                </form>
                {% endif %}
              </div>
              {% endfor %}
              
              <!-- Totaux -->
              <div style="background: #f8fafc; padding: 1rem; border-top: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span style="font-weight: 600; font-size: 0.9rem;">Sous-total HT</span>
                  <span style="font-weight: 700; font-size: 1rem;">{{ devis.sous_total_ht|floatformat:2 }} â‚¬</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span style="font-weight: 600; font-size: 0.9rem; color: var(--muted);">TVA</span>
                  <span style="font-weight: 600; font-size: 0.9rem; color: var(--muted);">{{ devis.total_tva|floatformat:2 }} â‚¬</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 2px solid var(--primary);">
                  <span style="font-weight: 700; font-size: 1.1rem;">TOTAL TTC</span>
                  <span style="font-weight: 700; font-size: 1.3rem; color: var(--primary);">{{ devis.total_ttc|floatformat:2 }} â‚¬</span>
                </div>
              </div>
            </div>
            
            <!-- Notes du devis (si prÃ©sentes) -->
            {% if devis.notes %}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border);">
              <strong style="font-size: 0.85rem; color: var(--muted);">ğŸ“ Notes :</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text); font-size: 0.9rem;">{{ devis.notes }}</p>
            </div>
            {% endif %}
          </div>
          {% endif %}
          <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    NOTES ET VALIDITÃ‰ (Ã‰DITABLE EN BROUILLON)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          {% if devis.statut == 'brouillon' %}
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px dashed var(--border);">
            <h5 style="margin: 0 0 0.75rem 0; color: var(--text); font-size: 0.9rem; font-weight: 600;">ğŸ“ Notes et validitÃ©</h5>
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_notes_validite_devis">
              <input type="hidden" name="devis_id" value="{{ devis.id }}">
              
              <!-- Notes -->
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.25rem; color: var(--muted); font-size: 0.8rem; font-weight: 600;">Notes (optionnel)</label>
                <textarea name="notes" class="input" rows="3" placeholder="Notes qui apparaÃ®tront sur le devis..." style="margin: 0;">{{ devis.notes }}</textarea>
              </div>
              
              <!-- ValiditÃ© -->
              <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: end;">
                <div>
                  <label style="display: block; margin-bottom: 0.25rem; color: var(--muted); font-size: 0.8rem; font-weight: 600;">ValiditÃ© (jours)</label>
                  <input type="number" name="validite_jours" class="input" value="{{ devis.validite_jours }}" min="1" max="365" style="margin: 0; text-align: center;">
                </div>
                <button type="submit" class="btn" style="margin: 0;">ğŸ’¾ Enregistrer</button>
              </div>
            </form>
          </div>
          {% endif %}
          <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              FORMULAIRE AJOUT LIGNE (inline compact)
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          {% if devis.statut == 'brouillon' %}
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px dashed var(--border);">
            <h5 style="margin: 0 0 0.75rem 0; color: var(--text); font-size: 0.9rem; font-weight: 600;">+ Ajouter une ligne</h5>
            <form method="POST" style="display: grid; grid-template-columns: 2fr 80px 120px 120px 100px 80px; gap: 0.5rem; align-items: end;">
              {% csrf_token %}
              <input type="hidden" name="action" value="add_ligne_devis">
              <input type="hidden" name="devis_id" value="{{ devis.id }}">
              
              <input type="text" name="description" class="input" placeholder="Description" style="margin: 0; font-size: 0.9rem;" required>
              <input type="number" name="quantite" class="input" value="1" step="0.01" min="0.01" style="margin: 0; text-align: center; font-size: 0.9rem;" required>
              <select name="unite" class="select" style="margin: 0; font-size: 0.85rem;">
                <option value="forfait" selected>Forfait</option>
                <option value="unite">UnitÃ©</option>
                <option value="heure">Heure</option>
                <option value="jour">Jour</option>
                <option value="m2">mÂ²</option>
                <option value="ml">ML</option>
              </select>
              <input type="number" name="prix_unitaire_ht" class="input" placeholder="Prix HT" step="0.01" min="0.01" style="margin: 0; text-align: right; font-size: 0.9rem;" required>
              <input type="number" name="taux_tva" class="input" value="10" step="0.01" min="0" style="margin: 0; text-align: center; font-size: 0.9rem;" required>
              <button type="submit" class="btn success" style="margin: 0; padding: 0.5rem; font-size: 0.9rem;">+ Ajouter</button>
            </form>
          </div>
          {% endif %}
          
          <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              ACTIONS SELON LE STATUT
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
            
            {% if devis.statut == 'brouillon' %}
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                BROUILLON : GÃ©nÃ©rer + Supprimer
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div style="display: flex; gap: 0.75rem;">
              <form method="POST" style="flex: 1;">
                {% csrf_token %}
                <input type="hidden" name="action" value="generer_pdf_devis">
                <input type="hidden" name="devis_id" value="{{ devis.id }}">
                <button type="submit" class="btn primary" style="width: 100%; padding: 0.75rem;">
                  ğŸ“„ Marquer comme prÃªt
                </button>
              </form>
              
              <form method="POST" onsubmit="return confirm('Supprimer ce devis brouillon ?')">
                {% csrf_token %}
                <input type="hidden" name="action" value="supprimer_devis">
                <input type="hidden" name="devis_id" value="{{ devis.id }}">
                <button type="submit" class="btn danger" style="padding: 0.75rem;">
                  ğŸ—‘ï¸
                </button>
              </form>
            </div>

            {% elif devis.statut == 'pret' %}
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                PRÃŠT : TÃ©lÃ©charger + Envoyer + Supprimer
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 1.5rem;">
              
              <!-- TÃ©lÃ©charger PDF -->
              <div style="margin-bottom: 1rem;">
                <a href="{% url 'telecharger_devis_pdf' devis.id %}" class="btn primary" style="width: 100%; text-decoration: none; text-align: center; padding: 0.75rem;">
                  ğŸ“¥ TÃ©lÃ©charger le PDF
                </a>
              </div>
              
              <!-- Enregistrer date d'envoi -->
              <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: #1e40af; font-size: 0.9rem; font-weight: 600;">
                  ğŸ“… Date d'envoi au client
                </label>
                <form method="POST" style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="enregistrer_date_envoi_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <input type="date" name="date_envoi" class="input" value="{{ now|date:'Y-m-d' }}" style="margin: 0;" required>
                  <button type="submit" class="btn success" style="margin: 0; white-space: nowrap;">âœ“ Marquer comme envoyÃ©</button>
                </form>
                <small style="display: block; margin-top: 0.5rem; color: #1e40af; font-size: 0.8rem;">
                  â³ ValiditÃ© : {{ devis.validite_jours }} jours
                </small>
              </div>
              
              <!-- Supprimer -->
              <form method="POST" onsubmit="return confirm('Supprimer ce devis ?')">
                {% csrf_token %}
                <input type="hidden" name="action" value="supprimer_devis">
                <input type="hidden" name="devis_id" value="{{ devis.id }}">
                <button type="submit" class="btn danger" style="width: 100%; padding: 0.75rem;">
                  ğŸ—‘ï¸ Supprimer ce devis
                </button>
              </form>
            </div>

            
            {% elif devis.statut == 'envoye' %}
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                ENVOYÃ‰ : Workflow 3 Ã©tapes (compact)
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 10px; padding: 1.5rem;">
              
              <!-- Ã‰tape 1 : TÃ©lÃ©charger PDF -->
              <div style="margin-bottom: 1rem;">
                <a href="{% url 'telecharger_devis_pdf' devis.id %}" class="btn primary" style="width: 100%; text-decoration: none; text-align: center; padding: 0.75rem;">
                  ğŸ“¥ TÃ©lÃ©charger le PDF
                </a>
              </div>
              
              <!-- Ã‰tape 2 : Date d'envoi -->
              {% if not devis.date_envoi %}
              <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: #1e40af; font-size: 0.9rem; font-weight: 600;">
                  ğŸ“… Date d'envoi au client
                </label>
                <form method="POST" style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="enregistrer_date_envoi_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <input type="date" name="date_envoi" class="input" value="{{ now|date:'Y-m-d' }}" style="margin: 0;" required>
                  <button type="submit" class="btn success" style="margin: 0; white-space: nowrap;">âœ“ Valider</button>
                </form>
                <small style="display: block; margin-top: 0.5rem; color: #1e40af; font-size: 0.8rem;">
                  â³ ValiditÃ© : {{ devis.validite_jours }} jours
                </small>
              </div>
              {% else %}
              <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                <div style="color: #065f46; font-size: 0.85rem;">
                  âœ… EnvoyÃ© le : <strong>{{ devis.date_envoi|date:"d/m/Y" }}</strong>
                </div>
                {% if devis.date_limite %}
                <div style="color: #065f46; font-size: 0.8rem; margin-top: 0.25rem;">
                  ğŸ“… Valable jusqu'au : {{ devis.date_limite|date:"d/m/Y" }}
                  {% if devis.est_expire_display %}
                  <span style="color: var(--danger); font-weight: 600;">âš ï¸ EXPIRÃ‰</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}
              
              <!-- Ã‰tape 3 : RÃ©ponse client -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                <form method="POST" id="form-accepter-{{ devis.id }}" onsubmit="return validateDateEnvoiDevis({{ devis.id }}, 'accepter')">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="accepter_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <button type="submit" class="btn success" style="width: 100%; padding: 0.75rem; font-size: 0.9rem;">
                    âœ… AcceptÃ©
                  </button>
                </form>
                
                <form method="POST" id="form-refuser-{{ devis.id }}" onsubmit="return validateDateEnvoiDevis({{ devis.id }}, 'refuser')">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="refuser_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <button type="submit" class="btn danger" style="width: 100%; padding: 0.75rem; font-size: 0.9rem;">
                    âŒ RefusÃ©
                  </button>
                </form>
              </div>
              
              <small style="display: block; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(59,130,246,0.2); color: #1e40af; font-size: 0.8rem; text-align: center;">
                ğŸ’¬ Enregistrez d'abord la date d'envoi avant de valider la rÃ©ponse
              </small>
            </div>
            
            {% elif devis.statut == 'accepte' %}
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                ACCEPTÃ‰ : Infos + TÃ©lÃ©charger
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 10px; padding: 1.5rem;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <div style="color: #065f46; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">ğŸ“… EnvoyÃ©</div>
                  <div style="color: #065f46; font-size: 0.95rem; font-weight: 700;">{{ devis.date_envoi|date:"d/m/Y" }}</div>
                </div>
                <div>
                  <div style="color: #065f46; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">âœ… AcceptÃ©</div>
                  <div style="color: #065f46; font-size: 0.95rem; font-weight: 700;">{{ devis.date_reponse|date:"d/m/Y" }}</div>
                </div>
                {% if devis.delai_reponse %}
                <div>
                  <div style="color: #065f46; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">â±ï¸ DÃ©lai</div>
                  <div style="color: #065f46; font-size: 0.95rem; font-weight: 700;">{{ devis.delai_reponse }} jour{{ devis.delai_reponse|pluralize }}</div>
                </div>
                {% endif %}
              </div>
              
              <a href="{% url 'telecharger_devis_pdf' devis.id %}" class="btn primary" style="width: 100%; text-decoration: none; text-align: center; padding: 0.75rem;">
                ğŸ“¥ TÃ©lÃ©charger le PDF
              </a>
            </div>
            
            {% elif devis.statut == 'refuse' %}
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                REFUSÃ‰ : Date + Supprimer
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 10px; padding: 1.5rem;">
              <div style="color: #991b1b; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem;">
                âŒ RefusÃ© le {{ devis.date_reponse|date:"d/m/Y" }}
              </div>
              <div style="color: #991b1b; font-size: 0.8rem; margin-bottom: 1rem;">
                ğŸ’¡ CrÃ©ez un nouveau devis modifiÃ© ou supprimez celui-ci
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem;">
                <a href="{% url 'telecharger_devis_pdf' devis.id %}" class="btn" style="text-decoration: none; text-align: center; padding: 0.75rem;">
                  ğŸ“¥ TÃ©lÃ©charger PDF
                </a>
                
                <form method="POST" onsubmit="return confirm('Supprimer dÃ©finitivement ce devis refusÃ© ?')">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="supprimer_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <button type="submit" class="btn danger" style="padding: 0.75rem;">
                    ğŸ—‘ï¸ Supprimer
                  </button>
                </form>
              </div>
            </div>
            {% endif %}
            
          </div>
          
        </div>
      </div>
      {% empty %}
      <!-- Aucun devis existant -->
      <div class="alert info">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
        <div>
          ğŸ’¡ Aucun devis crÃ©Ã© pour cette opÃ©ration. CrÃ©ez le premier devis ci-dessous.
        </div>
      </div>
      {% endfor %}
      
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          BOUTON : CRÃ‰ER UN NOUVEAU DEVIS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <form method="POST" style="margin-top: 1.5rem;">
        {% csrf_token %}
        <input type="hidden" name="action" value="creer_nouveau_devis">
        <button type="submit" class="btn primary" style="width: 100%; padding: 1rem; font-size: 1rem; font-weight: 600;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
          â• CrÃ©er un nouveau devis
        </button>
      </form>
      
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      SCRIPTS JAVASCRIPT
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ACCORDÃ‰ON DEVIS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleDevis(devisId) {
    const body = document.getElementById('devis-body-' + devisId);
    const header = body.previousElementSibling;
    const icon = header.querySelector('.toggle-devis-icon');
    
    if (body.style.maxHeight === '0px' || body.style.maxHeight === '') {
      // Ouvrir
      body.style.maxHeight = body.scrollHeight + 1000 + 'px'; // +1000 pour sÃ©curitÃ©
      body.style.opacity = '1';
      body.style.paddingTop = '1.5rem';
      icon.style.transform = 'rotate(180deg)';
    } else {
      // Fermer
      body.style.maxHeight = '0';
      body.style.opacity = '0';
      body.style.paddingTop = '0';
      icon.style.transform = 'rotate(0deg)';
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VALIDATION DATE D'ENVOI (pour accepter/refuser)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function validateDateEnvoiDevis(devisId, action) {
    // VÃ©rifier si la date d'envoi est enregistrÃ©e
    const devisBody = document.getElementById('devis-body-' + devisId);
    const dateEnvoiInput = devisBody.querySelector('input[name="date_envoi"]');
    
    // Si le champ existe encore, c'est que la date n'est pas enregistrÃ©e
    if (dateEnvoiInput) {
      alert('âš ï¸ Veuillez d\'abord enregistrer la date d\'envoi du devis avant de valider la rÃ©ponse du client.');
      
      // Scroll vers le formulaire et focus
      dateEnvoiInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      dateEnvoiInput.focus();
      dateEnvoiInput.style.border = '2px solid var(--danger)';
      setTimeout(() => {
        dateEnvoiInput.style.border = '';
      }, 2000);
      
      return false;
    }
    
    // Confirmation pour refus
    if (action === 'refuser') {
      return confirm('âš ï¸ Confirmer le refus du devis ?\n\nVous pourrez crÃ©er un nouveau devis modifiÃ© juste aprÃ¨s.');
    }
    
    return true;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ALERTE DATES PASSÃ‰ES (optionnel, Ã  activer si besoin)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('DOMContentLoaded', function() {
    // Parcourir tous les champs date d'envoi
    const dateInputs = document.querySelectorAll('input[type="date"][name="date_envoi"]');
    
    dateInputs.forEach(input => {
      input.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Si date dans le passÃ©, afficher un badge warning (optionnel)
        if (selectedDate < today) {
          const parent = this.parentElement;
          let alert = parent.querySelector('.date-passee-alert');
          
          if (!alert) {
            alert = document.createElement('small');
            alert.className = 'date-passee-alert';
            alert.style.cssText = 'display: block; margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; color: #991b1b; font-size: 0.8rem;';
            alert.textContent = 'âš ï¸ Attention : date dans le passÃ©';
            parent.appendChild(alert);
          }
        } else {
          // Supprimer l'alerte si elle existe
          const alert = this.parentElement.querySelector('.date-passee-alert');
          if (alert) alert.remove();
        }
      });
    });
  });
  </script>

  {% endif %}
  <!-- ========================================
      FIN SECTION DEVIS
      ======================================== -->



<!-- ========================================
    LIGNES D'INTERVENTION
    âš ï¸ AffichÃ©e UNIQUEMENT pour les opÃ©rations SANS DEVIS (parcours direct)
    ======================================== -->
    {% if not operation.avec_devis %}
    <section class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.6"/></svg>
          ğŸ”§ Lignes d'intervention
          
          {% if interventions %}
          <span class="section-badge complete">
            {{ interventions.count }} ligne{{ interventions.count|pluralize }}
          </span>
          {% else %}
          <span class="section-badge pending">Aucune ligne</span>
          {% endif %}
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      
      <div class="section-body">
        <!-- Verrouillage si dÃ©jÃ  payÃ©/rÃ©alisÃ© (optionnel) -->
        {% if operation.statut == 'paye' %}
        <div class="alert info" style="margin-bottom: 1rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="1.6"/><path d="M12 11V7a2 2 0 1 1 4 0v4m-8 0V7a2 2 0 0 1 2-2" stroke="currentColor" stroke-width="1.6"/></svg>
          <div>
            <strong>ğŸ”’ Montant verrouillÃ©</strong><br>
            L'opÃ©ration est payÃ©e, les lignes ne peuvent plus Ãªtre modifiÃ©es.
          </div>
        </div>
        {% endif %}
        
        {% if interventions %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th style="width:120px">Montant (â‚¬)</th>
                {% if operation.statut != 'paye' %}
                <th style="width:100px">Actions</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for intervention in interventions %}
              <tr>
                <td>{{ intervention.description }}</td>
                <td><strong>{{ intervention.montant }}</strong></td>
                {% if operation.statut != 'paye' %}
                <td>
                  <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette ligne ?')">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_intervention">
                    <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                    <button type="submit" class="btn danger sm">Supprimer</button>
                  </form>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td><strong>TOTAL</strong></td>
                <td><strong>{{ montant_total }} â‚¬</strong></td>
                {% if operation.statut != 'paye' %}
                <td></td>
                {% endif %}
              </tr>
            </tfoot>
          </table>
        </div>
        {% else %}
        <div class="alert info">Aucune ligne d'intervention</div>
        {% endif %}

        <!-- Formulaire ajout (masquÃ© si verrouillÃ©) -->
        {% if operation.statut != 'paye' %}
        <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border)">
          <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Ajouter une ligne</h4>
          <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_intervention">
            
            <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
              <div style="flex:1; min-width:250px">
                <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Description</label>
                <input type="text" name="description" class="input" placeholder="Ex: Main d'Å“uvre, Fournitures..." required>
              </div>
              
              <div style="flex:0 0 150px">
                <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Montant HT (â‚¬)</label>
                <input type="number" name="prix_unitaire_ht" class="input" placeholder="0.00" step="0.01" required>
              </div>
              
              <!-- âœ… NOUVEAU : Champs cachÃ©s pour quantitÃ©, unitÃ© et TVA -->
              <input type="hidden" name="quantite" value="1">
              <input type="hidden" name="unite" value="forfait">
              <input type="hidden" name="taux_tva" value="10">
              
              <button type="submit" class="btn success">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                Ajouter
              </button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>
    </section>
    {% endif %}

        <!-- ========================================
            PLANIFICATION - AVEC AFFICHAGE CONDITIONNEL
            ======================================== -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6"/></svg>
              Planification
              
              {% if operation.statut == 'realise' or operation.statut == 'paye' %}
                <span class="section-badge complete">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  RÃ©alisÃ©e
                </span>
              {% elif operation.date_prevue %}
                <span class="section-badge complete">
                  ğŸ“… {{ operation.date_prevue|date:"d/m/Y H:i" }}
                </span>
              {% else %}
                <span class="section-badge pending">Ã€ planifier</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            
            {% if operation.statut == 'realise' or operation.statut == 'paye' %}
            <!-- ========================================
                MODE 1 : AFFICHAGE RÃ‰ALISÃ‰E (LECTURE SEULE)
                ======================================== -->
            <div class="alert success" style="margin-bottom:1rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
              <div>
                <strong>âœ… Intervention rÃ©alisÃ©e</strong>
                {% if operation.date_realisation %}
                  <br>Date de rÃ©alisation : <strong>{{ operation.date_realisation|date:"d/m/Y Ã  H:i" }}</strong>
                {% endif %}
              </div>
            </div>
            
            <div class="info-grid">
              {% if operation.date_prevue %}
              <div class="info-card">
                <div class="label">ğŸ“… Date prÃ©vue initialement</div>
                <div class="value">{{ operation.date_prevue|date:"d/m/Y Ã  H:i" }}</div>
              </div>
              {% endif %}
              
              {% if operation.date_realisation %}
              <div class="info-card">
                <div class="label">âœ… Date de rÃ©alisation</div>
                <div class="value" style="color:var(--success); font-weight:700">
                  {{ operation.date_realisation|date:"d/m/Y Ã  H:i" }}
                </div>
              </div>
              {% endif %}
            </div>
            
            <!-- Bouton pour corriger si besoin -->
            <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border)">
              <button type="button" class="btn" onclick="toggleModificationDates()" style="width:100%">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="1.6"/></svg>
                Corriger les dates (si erreur)
              </button>
            </div>
            
            <!-- Formulaire de correction (cachÃ© par dÃ©faut) -->
            <div id="modification-dates-form" style="display:none; margin-top:1rem; padding:1rem; background:#fef3c7; border:1px solid #fde68a; border-radius:8px">
              <h4 style="margin-bottom:1rem; color:#92400e">âš ï¸ Correction des dates</h4>
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="corriger_dates_realisation">
                
                <div class="info-grid" style="margin-bottom:1rem">
                  <div class="info-card">
                    <div class="label">Date de rÃ©alisation</div>
                    <div class="value">
                      <input type="datetime-local" 
                            id="correction-date-realisation"
                            name="date_realisation" 
                            class="input" 
                            value="{% if operation.date_realisation %}{{ operation.date_realisation|date:'Y-m-d\TH:i' }}{% endif %}"
                            max="{{ now|date:'Y-m-d\TH:i' }}" 
                            required>
                    </div>
                  </div>
                </div>
                
                <div style="display:flex; gap:1rem">
                  <button type="button" class="btn" onclick="toggleModificationDates()" style="flex:1">Annuler</button>
                  <button type="submit" class="btn primary" style="flex:1">Enregistrer la correction</button>
                </div>
              </form>
            </div>
            
            {% else %}
            <!-- ========================================
                MODE 2 : PLANIFICATION ACTIVE (MODIFIABLE)
                ======================================== -->
            <form method="POST" id="planning-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_planning">
              
              <div class="info-card" style="margin-bottom:1rem">
                <div class="label">Date d'intervention prÃ©vue</div>
                <div class="value">
                  <input type="datetime-local" 
                        id="date-prevue-input" 
                        name="date_prevue" 
                        class="input" 
                        value="{% if operation.date_prevue %}{{ operation.date_prevue|date:'Y-m-d\TH:i' }}{% endif %}"
                        required>
                </div>
              </div>
              
              <!-- Alerte si date passÃ©e -->
              <div class="alert warning" id="date-passee-alert" style="display:none; margin-bottom:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0M12 3l9 18H3L12 3z" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>âš ï¸ Date dÃ©passÃ©e !</strong> La date prÃ©vue est dans le passÃ©. Validez la rÃ©alisation ou modifiez la date.</div>
              </div>
              
              <!-- Info replanification -->
              {% if operation.date_prevue and operation.statut == 'planifie' %}
              <div class="alert info" style="margin-bottom:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
                <div>ğŸ’¡ <strong>Actuellement planifiÃ© le {{ operation.date_prevue|date:"d/m/Y Ã  H:i" }}</strong><br>
                Modifiez la date ci-dessus pour replanifier.</div>
              </div>
              {% endif %}
              
              <div style="display:flex; gap:1rem; flex-wrap:wrap">
                <button type="submit" class="btn primary" style="flex:1">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  {% if operation.date_prevue %}Replanifier{% else %}Enregistrer la date{% endif %}
                </button>
                
                {% if operation.date_prevue %}
                <button type="button" class="btn success" style="flex:1" onclick="toggleRealisationForm()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  Valider la rÃ©alisation
                </button>
                {% endif %}
              </div>
            </form>
            
            <!-- Formulaire de validation rÃ©alisation (cachÃ© par dÃ©faut) -->
            <div id="realisation-form" style="display:none; margin-top:1.5rem; padding-top:1.5rem; border-top:2px solid var(--border)">
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="valider_realisation">
                
                <h4 style="margin-bottom:1rem; color:var(--success); font-size:1.1rem; display:flex; align-items:center; gap:.5rem">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  Validation de la rÃ©alisation
                </h4>
                
                <div class="info-card" style="margin-bottom:1rem">
                  <div class="label">Date de rÃ©alisation effective</div>
                  <div class="value">
                    <input type="datetime-local" 
                          id="date-realisation-input" 
                          name="date_realisation" 
                          class="input" 
                          max="{{ now|date:'Y-m-d\TH:i' }}"
                          required>
                    <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                      âš ï¸ La date ne peut pas Ãªtre dans le futur
                    </small>
                  </div>
                </div>
                
                <div style="display:flex; gap:1rem">
                  <button type="button" class="btn" onclick="toggleRealisationForm()" style="flex:1">
                    Annuler
                  </button>
                  <button type="submit" class="btn success" style="flex:1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    Confirmer la rÃ©alisation
                  </button>
                </div>
              </form>
            </div>
            {% endif %}
            
          </div>
        </section>

<!-- ========================================
    SECTION PAIEMENT & FACTURATION UNIFIÃ‰E
    ======================================== -->
{% if operation.devis_statut == 'accepte' or operation.statut == 'realise' or operation.statut == 'paye' %}
<section class="section">
  <div class="section-header" onclick="toggleSection(this)">
    <h2 class="section-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M2 8.5h20M2 12.5h20M6 16.5h8M6 20.5h8M6 4.5h8" stroke="currentColor" stroke-width="1.6"/>
      </svg>
      ğŸ’° Paiements & Facturation
      
      {% if operation.statut == 'paye' %}
      <span class="section-badge complete">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
        SoldÃ©
      </span>
      {% elif echeances %}
      <span class="section-badge pending">{{ total_echeances }} â‚¬ / {{ montant_total }} â‚¬</span>
      {% else %}
      <span class="section-badge disabled">Aucun paiement</span>
      {% endif %}
    </h2>
    <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>
  
  <div class="section-body">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        RÃ‰CAPITULATIF FINANCIER (IDENTIQUE Ã€ L'ANCIEN)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="payment-box" style="margin-bottom:1.5rem">
      <div class="info-grid">
        <div class="info-card">
          <div class="label">ğŸ’° Montant total</div>
          <div class="value" style="font-size:1.5rem; color:var(--primary); font-weight:700">
            {{ montant_total }} â‚¬
          </div>
        </div>
        
        <div class="info-card">
          <div class="label">âœ… PayÃ©</div>
          <div class="value" style="font-size:1.5rem; color:var(--success); font-weight:700">
            {{ total_echeances|default:0 }} â‚¬
          </div>
        </div>
        
        <div class="info-card">
          <div class="label">â³ En attente</div>
          <div class="value" style="font-size:1.2rem; color:var(--warning); font-weight:600">
            {{ total_echeances_prevus|default:0 }} â‚¬
          </div>
          <small style="color:var(--muted); font-size:0.8rem">PrÃ©vus non payÃ©s</small>
        </div>
        
        <div class="info-card">
          <div class="label">ğŸ¯ Reste Ã  enregistrer</div>
          <div class="value" style="font-size:1.5rem; font-weight:700; color:{% if reste_a_enregistrer == 0 %}var(--success){% elif reste_a_enregistrer < 0 %}var(--danger){% else %}var(--warning){% endif %}">
            {{ reste_a_enregistrer|default:montant_total }} â‚¬
          </div>
        </div>
      </div>
      
      <!-- Alerte si dÃ©passement (IDENTIQUE) -->
      {% if reste_a_enregistrer < 0 %}
      <div class="alert danger" style="margin-top:1rem">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="2"/></svg>
        <div>
          <strong>âš ï¸ ATTENTION : DÃ©passement de {{ reste_a_enregistrer_abs }} â‚¬ !</strong><br>
          Total enregistrÃ© ({{ total_echeances_tout }} â‚¬) > Montant opÃ©ration ({{ montant_total }} â‚¬)
        </div>
      </div>
      {% endif %}
      
      {% if reste_a_enregistrer == 0 and reste_a_payer == 0 %}
      <div class="alert success" style="margin-top:1rem">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
        <div><strong>ğŸ‰ OpÃ©ration soldÃ©e !</strong> Tous les paiements ont Ã©tÃ© reÃ§us.</div>
      </div>
      {% elif reste_a_enregistrer == 0 and reste_a_payer > 0 %}
      <div class="alert info" style="margin-top:1rem">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3" stroke="currentColor" stroke-width="1.6"/></svg>
        <div><strong>ğŸ’¡ Tous les paiements sont enregistrÃ©s</strong> - En attente de validation de {{ total_echeances_prevus }} â‚¬</div>
      </div>
      {% endif %}
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        LISTE DES PAIEMENTS (AVEC AJOUT FACTURE)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    {% if echeances %}
    <div class="payment-box" style="margin-bottom:1.5rem">
      <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem; display:flex; align-items:center; gap:.5rem">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4" stroke="currentColor" stroke-width="1.6"/></svg>
        Historique des paiements
      </h4>
      
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Montant</th>
              <th>Statut</th>
              <th>Facture</th> <!-- âœ… NOUVELLE COLONNE -->
              <th style="width:100px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for echeance in echeances %}
            <tr style="{% if echeance.paye %}background: #f0fdf4;{% elif echeance.date_echeance|date:'Y-m-d' < now|date:'Y-m-d' %}background: #fee2e2;{% endif %}">
              
              <!-- Date (IDENTIQUE) -->
              <td>
                <strong>{{ echeance.date_echeance|date:"d/m/Y" }}</strong>
                {% if echeance.date_echeance|date:'Y-m-d' < now|date:'Y-m-d' and not echeance.paye %}
                <br><small style="color:var(--danger)">âš ï¸ En retard</small>
                {% endif %}
              </td>
              
              <!-- Montant (IDENTIQUE) -->
              <td><strong>{{ echeance.montant }} â‚¬</strong></td>
              
              <!-- Statut (IDENTIQUE) -->
              <td>
                {% if echeance.paye %}
                  <span style="color:var(--success); font-weight:600; display:flex; align-items:center; gap:.3rem">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    PayÃ©
                  </span>
                {% else %}
                  <span style="color:var(--warning); font-weight:600; display:flex; align-items:center; gap:.3rem">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.6"/><path d="M12 8v4" stroke="currentColor" stroke-width="1.6"/></svg>
                    En attente
                  </span>
                {% endif %}
              </td>
              
              <!-- âœ… NOUVELLE COLONNE FACTURE -->
              <td>
                {% if echeance.facture_generee %}
                  <!-- Facture dÃ©jÃ  gÃ©nÃ©rÃ©e -->
                  <div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap">
                    <span style="color:var(--success); font-weight:600; font-size:.85rem">
                      ğŸ“„ {{ echeance.numero_facture }}
                    </span>
                    <a href="{% url 'telecharger_facture_pdf' echeance.id %}" 
                      class="btn primary sm" 
                      title="TÃ©lÃ©charger le PDF"
                      style="padding:0.2rem 0.4rem; text-decoration:none">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                      </svg>
                    </a>
                  </div>
                {% elif echeance.paye %}
                  <!-- PayÃ© mais pas encore facturÃ© -->
                  <span style="color:var(--warning); font-size:.85rem">âš ï¸ Non facturÃ©e</span>
                {% else %}
                  <!-- PrÃ©vu = pas encore de facture -->
                  <span style="color:var(--muted); font-size:.85rem">â€”</span>
                {% endif %}
              </td>
              
              <!-- Actions (IDENTIQUE avec ajout bouton facture) -->
              <td>
                <div style="display:flex; gap:.3rem">
                  
                  <!-- âœ… Marquer comme payÃ© (IDENTIQUE) -->
                  {% if not echeance.paye %}
                  <form method="POST" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="marquer_paye">
                    <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                    <button type="submit" class="btn success sm" title="Marquer comme payÃ©">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                  </form>
                  {% endif %}
                  
                  <!-- âœ… NOUVEAU : GÃ©nÃ©rer facture -->
                  {% if echeance.paye and not echeance.facture_generee %}
                  <form method="POST" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="generer_facture_echeance">
                    <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                    <button type="submit" class="btn primary sm" title="GÃ©nÃ©rer la facture">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                        <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4" stroke="currentColor" stroke-width="1.6"/>
                      </svg>
                    </button>
                  </form>
                  {% endif %}
                  
                  <!-- âœ… Supprimer (IDENTIQUE) -->
                  <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer ce paiement ?')">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_paiement">
                    <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                    <button type="submit" class="btn danger sm">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                  </form>
                  
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr style="background: #eef2ff; font-weight:700">
              <td><strong>TOTAL PAYÃ‰</strong></td>
              <td><strong>{{ total_echeances|default:0 }} â‚¬</strong></td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        FORMULAIRE D'AJOUT DE PAIEMENT (IDENTIQUE)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="payment-box">
      <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem; display:flex; align-items:center; gap:.5rem">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
        {% if echeances %}Ajouter un paiement{% else %}Enregistrer le premier paiement{% endif %}
      </h4>
      
      <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_paiement">
        
        <div class="info-grid" style="margin-bottom:1rem">
          <div class="info-card">
            <div class="label">ğŸ’µ Montant (â‚¬)</div>
            <div class="value">
              <!-- âœ… Container flex pour input + bouton -->
              <div style="display:flex; gap:0.5rem; align-items:center;">
                <input type="number" 
                      id="montant-paiement-input"
                      name="montant" 
                      class="input" 
                      placeholder="Ex: 500" 
                      step="0.01" 
                      min="0.01" 
                      max="{{ max_paiement }}"
                      style="flex:1; margin:0;"
                      required>
                
                <!-- âœ… NOUVEAU BOUTON -->
                {% if reste_a_enregistrer > 0 %}
                <button type="button" 
                        class="btn primary sm" 
                        id="btn-reste"
                        title="Remplir avec le reste Ã  enregistrer"
                        style="white-space:nowrap; padding:0.5rem 0.75rem;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                  Reste
                </button>

                <script>
                // Script exÃ©cutÃ© immÃ©diatement aprÃ¨s le bouton
                (function() {
                  const btn = document.getElementById('btn-reste');
                  const input = document.getElementById('montant-paiement-input');
                  const reste = parseFloat('{{ reste_a_enregistrer|floatformat:2|default:"0.00" }}');
                  
                  if (btn && input && reste > 0) {
                    btn.addEventListener('click', function() {
                      input.value = reste.toFixed(2);
                      input.style.background = '#d1fae5';
                      input.style.transition = 'background 0.3s ease';
                      
                      setTimeout(() => {
                        input.style.background = '';
                      }, 500);
                      
                      input.focus();
                      
                      // Toast optionnel
                      if (typeof showToast === 'function') {
                        showToast('âœ… Montant rempli : ' + reste.toFixed(2) + ' â‚¬', 'success', 2000);
                      }
                    });
                    
                    console.log('âœ… Bouton Reste initialisÃ© avec succÃ¨s - Montant:', reste);
                  } else {
                    console.error('âŒ Erreur initialisation bouton Reste:', { btn, input, reste });
                  }
                })();
                </script>
                {% endif %}
              </div>
              
              <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                {% if reste_a_enregistrer > 0 %}
                  ğŸ’¡ Reste Ã  enregistrer : <strong>{{ reste_a_enregistrer }} â‚¬</strong>
                {% elif reste_a_enregistrer == 0 %}
                  âœ… Tous les paiements sont enregistrÃ©s
                {% else %}
                  âš ï¸ DÃ©passement de {{ reste_a_enregistrer_abs }} â‚¬
                {% endif %}
              </small>
            </div>
          </div>
          
          <div class="info-card">
            <div class="label">ğŸ“… Date du paiement</div>
            <div class="value">
              <input type="date" 
                    name="date_paiement" 
                    class="input" 
                    value="{{ now|date:'Y-m-d' }}"
                    required>
              <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                ğŸ’¡ Date prÃ©vue ou effective
              </small>
            </div>
          </div>
          
          <div class="info-card">
            <div class="label">âœ… Statut</div>
            <div class="value">
              <select name="paye" class="select" id="paye-select">
                <option value="true">DÃ©jÃ  payÃ©</option>
                <option value="false">PrÃ©vu / Ã€ venir</option>
              </select>
              <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                ğŸ’¡ "DÃ©jÃ  payÃ©" = reÃ§u aujourd'hui<br>
                "PrÃ©vu" = attendu plus tard
              </small>
            </div>
          </div>
        </div>
        
        <!-- âœ… NOUVELLE OPTION : GÃ©nÃ©ration auto de facture -->
        <div id="facture-auto-option" style="display:none; margin-bottom:1rem; padding:1rem; background:#f0f9ff; border:1px solid #bfdbfe; border-radius:8px">
          <label style="display:flex; align-items:center; gap:.5rem; cursor:pointer">
            <input type="checkbox" name="generer_facture_auto" value="true" checked>
            <span style="font-weight:600; color:#1e40af">ğŸ“„ GÃ©nÃ©rer automatiquement la facture</span>
          </label>
          <small style="display:block; margin-top:.5rem; color:#1e40af; font-size:.85rem">
            ğŸ’¡ Gagne du temps en crÃ©ant la facture directement
          </small>
        </div>
        
        <button type="submit" class="btn success" style="width:100%">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
          Enregistrer ce paiement
        </button>
      </form>
    </div>
    
    <!-- Info aide (IDENTIQUE) -->
    {% if not echeances %}
    <div class="alert info" style="margin-top:1rem">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
      <div>
        <strong>ğŸ’¡ Comment Ã§a marche ?</strong><br>
        â€¢ Ajoutez un paiement quand vous voulez<br>
        â€¢ Vous pouvez enregistrer des acomptes, le solde, ou tout en une fois<br>
        â€¢ Marquez "DÃ©jÃ  payÃ©" si c'est reÃ§u, sinon "PrÃ©vu"<br>
        â€¢ Quand tout est payÃ©, l'opÃ©ration passe automatiquement en statut "PayÃ©"
      </div>
    </div>
    {% endif %}
    
  </div>
</section>

<!-- âœ… Script pour afficher/masquer l'option facture auto -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const payeSelect = document.getElementById('paye-select');
  const factureAutoOption = document.getElementById('facture-auto-option');
  
  if (payeSelect && factureAutoOption) {
    payeSelect.addEventListener('change', function() {
      // Afficher l'option seulement si "DÃ©jÃ  payÃ©"
      factureAutoOption.style.display = (this.value === 'true') ? 'block' : 'none';
    });
    
    // VÃ©rif initiale
    if (payeSelect.value === 'true') {
      factureAutoOption.style.display = 'block';
    }
  }
});
</script>
{% endif %}

</div> <!-- âœ… FIN DE .left-column -->
     

<!-- ========================================
     COLONNE DROITE - HISTORIQUE
     ======================================== -->
<div class="right-column">
  <section class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <h2 class="section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
        Historique
        {% if historique %}
        <span class="section-badge complete">
          {{ historique.count }} Ã©vÃ©nement{{ historique.count|pluralize }}
        </span>
        {% endif %}
      </h2>
      <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="section-body">
      {% if historique %}
      <div class="table-wrap">
        <table>
          <thead><tr><th>Date</th><th>Action</th></tr></thead>
          <tbody>
            {% for entry in historique %}
            <tr>
              <td style="font-size:.85rem">{{ entry.date|date:"d/m H:i" }}</td>
              <td style="font-size:.9rem">{{ entry.action }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert info">Aucun historique</div>
      {% endif %}
    </div>
  </section>

<!-- âœ… SECTION COMMENTAIRES (UN SEUL BLOC) -->
<section class="section sticky-notes">
  <div class="section-header" onclick="toggleSection(this)">
    <h2 class="section-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M7 8h10M7 12h4m1 8-4-4H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3l-4 4Z" stroke="currentColor" stroke-width="1.6"/>
      </svg>
      Commentaires
    </h2>
    <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>
  
  <div class="section-body">
    <form method="POST" id="commentaires-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_commentaires">
      
      <textarea 
        id="commentaires-textarea" 
        name="commentaires" 
        class="notes-textarea" 
        rows="6" 
        placeholder=""
      >{{ operation.commentaires|default:'' }}</textarea>
      
      <div class="notes-actions">
        <button type="submit" class="btn success" title="Enregistrer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m5 12 4 4 10-10"/>
          </svg>
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</section>
</div> <!-- âœ… FIN DE .right-column (ICI, APRÃˆS LES COMMENTAIRES) -->
</div> <!-- âœ… FIN DE .main-content -->

<div style="margin-top:1.5rem">
  <a href="{% url 'operations' %}" class="btn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5"/></svg>
    Retour aux opÃ©rations
  </a>
</div>
</div> <!-- âœ… FIN DE .container -->

<script>
// ========================================
// âœ… FONCTIONS GLOBALES (DOIVENT ÃŠTRE EN PREMIER)
// ========================================

// Fonction de confirmation de suppression
function confirmDeleteOperation() {
  const id = '{{ operation.id_operation }}';
  const type = '{{ operation.type_prestation|escapejs }}';
  const client = '{{ operation.client.nom }} {{ operation.client.prenom }}';
  const interventions = {{ interventions.count|default:0 }};
  const echeances = {{ echeances.count|default:0 }};
  
  let message = 'âš ï¸ ATTENTION : Supprimer l\'opÃ©ration ' + id + ' ?\n\n';
  message += 'ğŸ“‹ Type : ' + type + '\n';
  message += 'ğŸ‘¤ Client : ' + client + '\n';
  
  if (interventions > 0) {
    message += '\nğŸ”¸ ' + interventions + ' ligne(s) d\'intervention seront supprimÃ©e(s)';
  }
  
  if (echeances > 0) {
    message += '\nğŸ’° ' + echeances + ' Ã©chÃ©ance(s) de paiement seront supprimÃ©e(s)';
  }
  
  message += '\n\nğŸš¨ Cette action est IRRÃ‰VERSIBLE !';
  
  return confirm(message);
}

// Fonction de toggle des sections
function toggleSection(header) {
  const section = header.closest('.section');
  const body = section.querySelector('.section-body');
  
  header.classList.toggle('collapsed');
  body.classList.toggle('collapsed');
  
  const sectionTitle = header.querySelector('.section-title').textContent.trim();
  const isCollapsed = body.classList.contains('collapsed');
  localStorage.setItem(`section-${sectionTitle}`, isCollapsed ? 'collapsed' : 'expanded');
}

// ========================================
// SYSTÃˆME DE NOTIFICATIONS TOAST
// ========================================
function showToast(message, type = 'info', duration = 5000) {
  const container = document.getElementById('toast-container');
  if (!container) return;
  
  // CrÃ©er le toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  // IcÃ´ne selon le type
  let icon = '';
  switch(type) {
    case 'success':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m5 12 4 4 10-10"/></svg>';
      break;
    case 'error':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6m0-6 6 6"/></svg>';
      break;
    case 'warning':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4m0 4h0M12 3l9 18H3L12 3z"/></svg>';
      break;
    case 'info':
    default:
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h0"/></svg>';
      break;
  }
  
  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-content">${message}</div>
    <button class="toast-close" onclick="dismissToast(this)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6 6 18M6 6l12 12"/>
      </svg>
    </button>
  `;
  
  container.appendChild(toast);
  
  // Auto-dismiss
  setTimeout(() => {
    dismissToast(toast.querySelector('.toast-close'));
  }, duration);
}

function dismissToast(button) {
  const toast = button.closest('.toast');
  if (!toast) return;
  
  toast.classList.add('hiding');
  setTimeout(() => {
    toast.remove();
  }, 300);
}

// Afficher les messages Django au chargement
window.addEventListener('DOMContentLoaded', function() {
  const messagesContainer = document.getElementById('django-messages');
  if (messagesContainer) {
    const messages = messagesContainer.querySelectorAll('[data-message]');
    messages.forEach((msg, index) => {
      setTimeout(() => {
        const type = msg.dataset.type || 'info';
        const message = msg.dataset.message;
        showToast(message, type);
      }, index * 200); // DÃ©lai entre chaque toast
    });
  }
});

// ========================================
// âœ… FONCTION GLOBALE POUR LA PLANIFICATION
// ========================================
window.toggleRealisationForm = function() {
  const realisationForm = document.getElementById('realisation-form');
  const dateRealisationInput = document.getElementById('date-realisation-input');
  const datePrevueInput = document.getElementById('date-prevue-input');
  
  if (!realisationForm) return;
  
  const isVisible = realisationForm.style.display !== 'none';
  
  if (isVisible) {
    // Fermer
    realisationForm.style.display = 'none';
  } else {
    // Ouvrir et prÃ©-remplir avec la date de planification (ou maintenant si pas de date prÃ©vue)
    realisationForm.style.display = 'block';
    if (dateRealisationInput) {
      // âœ… NOUVEAU : Utiliser la date prÃ©vue si elle existe, sinon la date actuelle
      if (datePrevueInput && datePrevueInput.value) {
        dateRealisationInput.value = datePrevueInput.value;
      } else {
        const now = new Date();
        const pad = n => String(n).padStart(2, '0');
        dateRealisationInput.value = now.getFullYear() + '-' + 
                                      pad(now.getMonth() + 1) + '-' + 
                                      pad(now.getDate()) + 'T' + 
                                      pad(now.getHours()) + ':' + 
                                      pad(now.getMinutes());
      }
    }
    // Scroll smooth vers le formulaire
    realisationForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ========================================
// âœ… FONCTION POUR CORRIGER LES DATES (RÃ‰ALISÃ‰)
// ========================================
window.toggleModificationDates = function() {
  const modificationForm = document.getElementById('modification-dates-form');
  if (!modificationForm) return;
  
  const isVisible = modificationForm.style.display !== 'none';
  modificationForm.style.display = isVisible ? 'none' : 'block';
  
  if (!isVisible) {
    modificationForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ========================================
// INITIALISATION AU CHARGEMENT DE LA PAGE
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  
  // Fonctions utilitaires
  function getNowFormatted() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
  }

  function getTodayDate() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate());
  }

  function formatMontant(montant) {
    return new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2}).format(montant) + ' â‚¬';
  }

  // Gestion du statut du devis
  const devisCreeSelect = document.getElementById('devis-cree');
  const devisDetails = document.getElementById('devis-details');
  const noDevisAlert = document.getElementById('no-devis-alert');
  const devisStatutSelect = document.getElementById('devis-statut');

  function updateDevisDisplay() {
    const isCreated = devisCreeSelect.value === 'oui';
    
    const devisDetails = document.getElementById('devis-details');
    const noDevisSection = document.getElementById('no-devis-section');
    
    if (devisDetails) {
      if (isCreated) {
        devisDetails.classList.remove('hidden');
        devisDetails.style.display = 'block';
      } else {
        devisDetails.classList.add('hidden');
        devisDetails.style.display = 'none';
      }
    }
    
    if (noDevisSection) {
      noDevisSection.style.display = isCreated ? 'none' : 'block';
    }
    
    if (isCreated && devisStatutSelect) {
      updateDevisAlerts();
    } else {
      hideAllDevisAlerts();
    }
  }

  function updateDevisAlerts() {
    if (!devisStatutSelect) return;
    
    const statut = devisStatutSelect.value;
    
    const alerts = {
      'devis-accepte-alert': statut === 'accepte',
      'devis-refuse-alert': statut === 'refuse',
      'devis-attente-alert': false,
      'devis-relance-alert': statut === 'relance'
    };
    
    Object.keys(alerts).forEach(alertId => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.display = alerts[alertId] ? 'flex' : 'none';
      }
    });
  }

  function hideAllDevisAlerts() {
    ['devis-accepte-alert', 'devis-refuse-alert', 'devis-attente-alert', 'devis-relance-alert'].forEach(alertId => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.display = 'none';
      }
    });
  }

  if (devisCreeSelect) {
    devisCreeSelect.addEventListener('change', updateDevisDisplay);
    updateDevisDisplay();
  }

  if (devisStatutSelect) {
    devisStatutSelect.addEventListener('change', updateDevisAlerts);
    if (devisCreeSelect && devisCreeSelect.value === 'oui') {
      updateDevisAlerts();
    }
  }

// ========================================
// GESTION PLANIFICATION SIMPLIFIÃ‰E
// ========================================
const datePrevueInput = document.getElementById('date-prevue-input');
const dateRealisationInput = document.getElementById('date-realisation-input');
const datePasseeAlert = document.getElementById('date-passee-alert');

// VÃ©rifier si date passÃ©e
function checkDatePassee() {
  if (!datePrevueInput || !datePasseeAlert) return;
  
  if (datePrevueInput.value) {
    const dateSelectionnee = new Date(datePrevueInput.value);
    const maintenant = new Date();
    
    datePasseeAlert.style.display = (dateSelectionnee < maintenant) ? 'flex' : 'none';
  } else {
    datePasseeAlert.style.display = 'none';
  }
}

// Validation date rÃ©alisation (pas dans le futur)
if (dateRealisationInput) {
  dateRealisationInput.addEventListener('change', function() {
    const dateSelectionnee = new Date(this.value);
    const maintenant = new Date();
    
    if (dateSelectionnee > maintenant) {
      showToast("âŒ La date de rÃ©alisation ne peut pas Ãªtre dans le futur !", 'error');
      this.value = getNowFormatted();
    }
  });
}

// Ã‰couter les changements de date prÃ©vue
if (datePrevueInput) {
  datePrevueInput.addEventListener('change', checkDatePassee);
  checkDatePassee(); // VÃ©rif initiale
}
  // Gestion des commentaires
  const commentairesTextarea = document.getElementById('commentaires-textarea');
  const commentairesForm = document.getElementById('commentaires-form');
  let originalCommentaires = commentairesTextarea ? commentairesTextarea.value : '';

  window.resetCommentaires = function() {
    if (commentairesTextarea) {
      commentairesTextarea.value = originalCommentaires;
    }
  }

  if (commentairesForm) {
    commentairesForm.addEventListener('submit', function() {
      originalCommentaires = commentairesTextarea.value;
    });
  }

  // Gestion date de rÃ©ponse
  const dateEnvoiInput = document.getElementById('devis-date-envoi');
  const dateReponseInput = document.getElementById('devis-date-reponse');
  const dateReponseCard = document.getElementById('date-reponse-card');
  const delaiReponseInfo = document.getElementById('delai-reponse-info');
  const delaiReponseText = document.getElementById('delai-reponse-text');

  function updateDateReponseVisibility() {
    if (!devisStatutSelect || !dateReponseCard) return;
    const statut = devisStatutSelect.value;
    const shouldShow = statut === 'accepte' || statut === 'refuse';
    dateReponseCard.style.display = shouldShow ? 'block' : 'none';
    if (shouldShow) calculateDelai();
    else if (delaiReponseInfo) delaiReponseInfo.style.display = 'none';
  }

  function calculateDelai() {
    if (!dateEnvoiInput || !dateReponseInput || !delaiReponseInfo || !delaiReponseText) return;
    
    const dateEnvoi = dateEnvoiInput.value;
    const dateReponse = dateReponseInput.value;
    
    if (dateEnvoi && dateReponse) {
      const d1 = new Date(dateEnvoi);
      const d2 = new Date(dateReponse);
      const diffDays = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
      
      if (diffDays >= 0) {
        let message = `<strong>DÃ©lai de rÃ©ponse : ${diffDays} jour${diffDays > 1 ? 's' : ''}</strong>`;
        delaiReponseText.innerHTML = message;
        delaiReponseInfo.style.display = 'flex';
      } else {
        delaiReponseInfo.style.display = 'none';
      }
    } else {
      delaiReponseInfo.style.display = 'none';
    }
  }

  if (devisStatutSelect) {
    const originalChange = devisStatutSelect.onchange;
    devisStatutSelect.addEventListener('change', function() {
      if (originalChange) originalChange.call(this);
      updateDateReponseVisibility();
    });
    updateDateReponseVisibility();
  }

  if (dateEnvoiInput) dateEnvoiInput.addEventListener('change', calculateDelai);
  if (dateReponseInput) dateReponseInput.addEventListener('change', calculateDelai);

// Gestion mode paiement
const modePaiementSelect = document.getElementById('mode-paiement-select');
const comptantSection = document.getElementById('comptant-section');
const echelonneSection = document.getElementById('echelonne-section');
const datePaiementComptant = document.getElementById('date-paiement-comptant');

if (modePaiementSelect) {
  modePaiementSelect.addEventListener('change', function() {
    const mode = this.value;
    
    if (comptantSection) comptantSection.style.display = 'none';
    if (echelonneSection) echelonneSection.style.display = 'none';
    
    if (mode === 'comptant' && comptantSection) {
      comptantSection.style.display = 'block';
      // âœ… CORRECTION : Ne remplir la date QUE si le champ est vide
      if (datePaiementComptant && !datePaiementComptant.value) {
        datePaiementComptant.value = getTodayDate();
      }
    } else if (mode === 'echelonne' && echelonneSection) {
      // âœ… AJOUT : espace entre } et else
      echelonneSection.style.display = 'block';
    }
  });
  
  // Initialisation au chargement
  if (modePaiementSelect.value) {
    modePaiementSelect.dispatchEvent(new Event('change'));
  }
}

  // Initialisation des dates
  const devisDateEnvoi = document.getElementById('devis-date-envoi');
  if (devisDateEnvoi && !devisDateEnvoi.value) {
    devisDateEnvoi.value = getTodayDate();
  }

  // Gestion des sections repliables
  const statut = '{{ operation.statut }}';
  const operationId = '{{ operation.id }}';
  const storageKey = `operation-${operationId}-sections-initialized`;
  const isFirstVisit = !localStorage.getItem(storageKey);
  
  const sections = document.querySelectorAll('.section');
  let sectionToScrollTo = null;
  
  sections.forEach((section) => {
    const header = section.querySelector('.section-header');
    const body = section.querySelector('.section-body');
    
    if (!header || !body) return;
    
    const titleElement = header.querySelector('.section-title');
    if (!titleElement) return;
    
    const title = titleElement.textContent.trim();
    const savedState = localStorage.getItem(`section-${title}`);
    
    if (savedState && !isFirstVisit) {
      if (savedState === 'collapsed') {
        header.classList.add('collapsed');
        body.classList.add('collapsed');
      }
    } else {
      header.classList.add('collapsed');
      body.classList.add('collapsed');
      
      let shouldOpen = false;
      
      // âœ… NOUVEAU : Logique d'ouverture des sections selon le statut
      const devisStatut = '{{ operation.devis_statut }}';
      
      switch(statut) {
        case 'en_attente_devis':
          shouldOpen = title.includes('Devis');
          break;
        case 'a_planifier':
          // âœ… Si devis acceptÃ©, ouvrir la section Devis + Planification
          if (devisStatut === 'accepte') {
            shouldOpen = title.includes('Devis') || title.includes('Planification');
          } else {
            shouldOpen = title.includes('Planification');
          }
          break;
        case 'planifie':
          shouldOpen = title.includes('Planification');
          break;
        case 'realise':
          shouldOpen = title.includes('Facture') || title.includes('Paiement');
          break;
        case 'paye':
          shouldOpen = title.includes('Paiement');
          break;
        case 'devis_refuse':
          shouldOpen = title.includes('Devis');
          break;
        default:
          shouldOpen = title.includes('Informations gÃ©nÃ©rales');
      }
      
      if (shouldOpen) {
        header.classList.remove('collapsed');
        body.classList.remove('collapsed');
        if (!sectionToScrollTo) {
          sectionToScrollTo = section;
        }
      }
    }
  });
  
  if (isFirstVisit) {
    localStorage.setItem(storageKey, 'true');
  }



  // DÃ©tection Safari et ajout de placeholders
if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) {
  document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
    input.placeholder = "JJ/MM/AAAA HH:MM";
    input.style.minWidth = "200px";
  });
}

// ========================================
// VALIDATION : EmpÃªcher dates futures UNIQUEMENT pour rÃ©alisation
// ========================================
const realisationDateInput = document.getElementById('realisation-date');

if (realisationDateInput) {
  // âœ… Validation UNIQUEMENT sur le champ de rÃ©alisation
  realisationDateInput.addEventListener('change', function() {
    const dateSelectionnee = new Date(this.value);
    const maintenant = new Date();
    
    if (dateSelectionnee > maintenant) {
      showToast("âŒ La date de rÃ©alisation ne peut pas Ãªtre dans le futur !", 'error');
      this.value = getNowFormatted();
    }
  });
  
  // âœ… Attribut max UNIQUEMENT sur le champ de rÃ©alisation
  realisationDateInput.setAttribute('max', getNowFormatted());
}

// âš ï¸ NE PAS appliquer de validation sur les autres champs datetime-local
// Les champs de planification (planning-date, replanification-date) doivent accepter les dates futures

// ========================================
// SAUVEGARDE DE LA POSITION DE SCROLL
// ========================================

// Sauvegarder la position avant soumission de formulaire
document.querySelectorAll('form').forEach(form => {
  form.addEventListener('submit', function() {
    sessionStorage.setItem('scrollPosition', window.scrollY);
  });
});

// Restaurer la position aprÃ¨s rechargement
const savedScrollPosition = sessionStorage.getItem('scrollPosition');
if (savedScrollPosition !== null) {
  window.scrollTo(0, parseInt(savedScrollPosition));
  sessionStorage.removeItem('scrollPosition');
}

  console.log('âœ… JavaScript CRM Artisans initialisÃ©');
});

// ========================================
// FEEDBACK VISUEL SOUMISSIONS
// ========================================
document.getElementById('form-realisation').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Validation...
  `;
});

document.getElementById('form-replanification').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Replanification...
  `;
});

document.getElementById('form-commentaires').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Enregistrement...
  `;
});

// Animation spin
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

</script>

<script>
// ========================================
// SYNCHRONISATION NOTES & VALIDITÃ‰
// ========================================

function syncNotesValidite() {
  const notes = document.getElementById('devis-notes-temp')?.value || '';
  const validite = document.getElementById('devis-validite-temp')?.value || 30;
  
  // Synchroniser avec les champs cachÃ©s du formulaire d'ajout
  const hiddenNotes = document.getElementById('hidden-notes');
  const hiddenValidite = document.getElementById('hidden-validite');
  
  if (hiddenNotes) hiddenNotes.value = notes;
  if (hiddenValidite) hiddenValidite.value = validite;
  
  console.log('âœ… Sync avant soumission:', { notes, validite });
}

function syncNotesValiditeForDelete(interventionId) {
  const notes = document.getElementById('devis-notes-temp')?.value || '';
  const validite = document.getElementById('devis-validite-temp')?.value || 30;
  
  // Synchroniser avec les champs cachÃ©s du formulaire de suppression
  const hiddenNotes = document.getElementById(`hidden-notes-del-${interventionId}`);
  const hiddenValidite = document.getElementById(`hidden-validite-del-${interventionId}`);
  
  if (hiddenNotes) hiddenNotes.value = notes;
  if (hiddenValidite) hiddenValidite.value = validite;
}

// ========================================
// SYNCHRONISATION DONNÃ‰ES FACTURE
// ========================================

function syncFactureData() {
  const dateEmission = document.getElementById('facture-date-emission-temp')?.value;
  const notes = document.getElementById('facture-notes-temp')?.value || '';
  
  // Synchroniser avec les champs cachÃ©s
  const hiddenDate = document.getElementById('facture-date-hidden');
  const hiddenNotes = document.getElementById('facture-notes-hidden');
  
  if (hiddenDate) hiddenDate.value = dateEmission;
  if (hiddenNotes) hiddenNotes.value = notes;
  
  console.log('âœ… DonnÃ©es facture synchronisÃ©es:', { dateEmission, notes });
  
  return true; // Permet la soumission du formulaire
}

// ========================================
// FONCTION : REMPLIR LE RESTE Ã€ ENREGISTRER
// ========================================
function remplirReste() {
  const montantInput = document.getElementById('montant-paiement-input');
  const resteAEnregistrer = {{ reste_a_enregistrer|default:0 }};
  
  if (montantInput && resteAEnregistrer > 0) {
    // Arrondir Ã  2 dÃ©cimales
    montantInput.value = resteAEnregistrer.toFixed(2);
    
    // Animation visuelle
    montantInput.style.background = '#d1fae5';
    montantInput.style.transition = 'background 0.3s ease';
    
    setTimeout(() => {
      montantInput.style.background = '';
    }, 500);
    
    // Focus sur le champ
    montantInput.focus();
    
    // Toast de confirmation
    showToast(`âœ… Montant rempli : ${resteAEnregistrer.toFixed(2)} â‚¬`, 'success', 2000);
  }
}

// ========================================
// SCROLL AUTOMATIQUE VERS LA SECTION DEVIS
// ========================================

window.addEventListener('DOMContentLoaded', function() {
  // Si un message de succÃ¨s pour ligne ajoutÃ©e/supprimÃ©e, scroller vers le devis
  const messages = document.getElementById('django-messages');
  if (messages) {
    const hasLineMessage = Array.from(messages.querySelectorAll('[data-message]'))
      .some(msg => msg.dataset.message.includes('Ligne'));
    
    if (hasLineMessage) {
      const devisSection = document.getElementById('section-devis');
      if (devisSection) {
        setTimeout(() => {
          devisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    }
  }
});
</script>

<script>
function validateDevisGeneration() {
  const interventionsCount = {{ interventions.count|default:0 }};
  
  if (interventionsCount === 0) {
    const confirmer = confirm('âš ï¸ ATTENTION : Vous allez gÃ©nÃ©rer un devis SANS lignes.\n\n' +
                              'ğŸ’¡ Conseil : Ajoutez des lignes avant de l\'envoyer au client.\n\n' +
                              'Continuer quand mÃªme ?');
    return confirmer;
  }
  
  return true;
}
</script>
</body>
</html>