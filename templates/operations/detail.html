<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ operation.id_operation }} - {{ operation.type_prestation }} – CRM Artisans</title>
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: var(--bg);
      color: var(--text); 
      line-height: 1.6; 
      padding-bottom:3rem;
    }

    .header{ 
      position: sticky; top: 0; z-index: 40; 
      background: white;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .header-inner{ 
      max-width:1280px; margin:0 auto; padding:.85rem 1rem; 
      display:flex; align-items:center; gap:1rem; justify-content:space-between 
    }
    .brand{ display:flex; align-items:center; gap:.75rem; font-weight:700; letter-spacing:.2px; color: var(--text); }
    .logo{ 
      width:34px; height:34px; border-radius:10px; 
      background:linear-gradient(145deg, var(--primary), var(--accent)); 
      box-shadow: var(--shadow); display:grid; place-items:center 
    }
    .logo svg{ width:18px; height:18px; color:white }

    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    
    h1{ font-size:1.8rem; font-weight:800; margin-bottom:.5rem; color: var(--text); }
    .breadcrumb{ color:var(--muted); font-size:.9rem; margin-bottom:1rem }
    .breadcrumb a{ color:var(--muted); text-decoration:none }
    .breadcrumb a:hover{ color:var(--text) }

    .status-badge{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; 
      border-radius:20px; font-size:.85rem; font-weight:600; border:1px solid;
    }
    .status-badge::before{ content:''; width:8px; height:8px; border-radius:50%; background:currentColor }
    .status-badge.en_attente_devis{ color:#f59e0b; background: rgba(245,158,11,.1); border-color: rgba(245,158,11,.3); }
    .status-badge.a_planifier{ color:#3b82f6; background: rgba(59,130,246,.1); border-color: rgba(59,130,246,.3); }
    .status-badge.planifie{ color:#8b5cf6; background: rgba(139,92,246,.1); border-color: rgba(139,92,246,.3); }
    .status-badge.realise{ color:#22c55e; background: rgba(34,197,94,.1); border-color: rgba(34,197,94,.3); }
    .status-badge.paye{ color:#10b981; background: rgba(16,185,129,.1); border-color: rgba(16,185,129,.3); }
    .status-badge.devis_refuse{ color:#ef4444; background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.3); }
    
    .section{ 
      background: white;
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:1.5rem; 
      box-shadow: var(--shadow); 
      margin-bottom:1.5rem 
    }
    .section-header{ 
      display:flex; align-items:center; justify-content:space-between; gap:1rem; 
      padding-bottom:1rem; border-bottom:1px solid var(--border); margin-bottom:1rem;
    }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700; color: var(--text); }

    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem }
    .info-card{
      background: #f8fafc;
      border:1px solid var(--border); 
      border-radius:10px; 
      padding:1rem; 
      transition: all 0.2s ease;
    }
    .info-card:hover{ background: #f1f5f9; border-color: #cbd5e1; }
    .info-card .label{
      display:flex; align-items:center; gap:.5rem; color:var(--muted); 
      font-size:.85rem; font-weight:600; text-transform:uppercase; 
      letter-spacing:.05rem; margin-bottom:.75rem
    }
    .info-card .value{ color: var(--text); font-weight: 600; font-size: 1rem; line-height: 1.4 }

    .input, .select{ 
      width:100%; padding:.65rem .8rem; border-radius:8px; border:1px solid var(--border); 
      background: white; color: var(--text); font:inherit 
    }
    .input:focus, .select:focus{ 
      outline:none; 
      box-shadow: 0 0 0 3px rgba(99,102,241,.1); 
      border-color: var(--primary);
    }

    .btn{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; 
      border-radius:8px; border:1px solid var(--border); 
      background:white; color:var(--text); cursor:pointer; font:inherit; text-decoration:none;
      transition: all 0.2s;
    }
    .btn:hover{ background:#f8fafc; border-color: #cbd5e1; }
    .btn.success{ 
      background:var(--success); 
      border-color: var(--success); 
      color: white;
    }
    .btn.success:hover{ background:#16a34a; }
    .btn.primary{ 
      background:var(--primary);
      border-color: var(--primary); 
      color: white;
    }
    .btn.primary:hover{ background:#4f46e5; }
    .btn.danger{ 
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }
    .btn.danger:hover{ background:#dc2626; }
    .btn.sm{ padding:.4rem .6rem; border-radius:6px; font-size:.9rem }

    .alert{ 
      padding:.75rem 1rem; border-radius:8px; margin-top:1rem; 
      display:flex; align-items:center; gap:.5rem; font-size:.9rem;
    }
    .alert.warning{ background: #fef3c7; color: #92400e; border:1px solid #fde68a; }
    .alert.danger, .alert.error{ background: #fee2e2; color: #991b1b; border:1px solid #fecaca; }
    .alert.success{ background: #d1fae5; color: #065f46; border:1px solid #a7f3d0; }
    .alert.info{ background: #dbeafe; color: #1e40af; border:1px solid #bfdbfe; }

    .radio-option{ 
      display:flex; align-items:center; gap:.5rem; padding:.6rem 1rem; 
      border:2px solid var(--border); border-radius:8px; cursor:pointer; 
      transition: all .2s; margin-bottom:.5rem; background: white;
    }
    .radio-option:hover{ border-color:var(--primary); background:#f8fafc; }
    .radio-option.selected{ border-color:var(--primary); background:#eef2ff; box-shadow: 0 0 0 3px rgba(99,102,241,.1); }
    .radio-option input[type="radio"]{ width:auto; margin:0; cursor:pointer }
    .radio-option label{ margin:0; cursor:pointer; font-weight:500; flex:1 }

    .payment-box{ background: #f8fafc; border:1px solid var(--border); border-radius:10px; padding:1rem; margin-top:1rem }

    .table-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--border); margin-top:1rem; background: white; }
    table{ width:100%; border-collapse: collapse }
    thead th{ 
      background: #f8fafc;
      color:var(--muted); 
      text-transform:uppercase; letter-spacing:.08rem; 
      font-size:.75rem; 
      text-align:left; padding:.9rem .85rem; 
      border-bottom:1px solid var(--border)
    }
    tbody td{ padding:.9rem .85rem; border-bottom:1px solid var(--border); }
    tbody tr:hover{ background: #f8fafc; }
    .echeance-row{ background: #f0fdf4; }
    .reste-row{ background: #fef3c7; font-weight:700; color:#92400e; }
    .total-row{ background: #eef2ff; font-weight:700; }

    .workflow-steps{
      display:flex; align-items:center; gap:.5rem; margin-top:1rem; padding:1rem; 
      background:white; border-radius:10px; flex-wrap:wrap; border:1px solid var(--border);
    }
    .workflow-step{
      padding:.4rem .8rem; background:#f1f5f9; 
      border-radius:6px; font-size:.8rem; color:var(--muted); font-weight:600;
    }
    .workflow-step.active{ background:var(--primary); color:white; }
    .workflow-arrow{ color:var(--muted); font-weight:bold }

    .main-content{ display:grid; grid-template-columns:2fr 1fr; gap:2rem; align-items:start }

    @media (max-width: 1024px){ 
      .main-content{ grid-template-columns: 1fr }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/></svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav style="display:flex; gap:1rem">
        <a href="{% url 'dashboard' %}" style="color:var(--muted); text-decoration:none">Accueil</a>
        <a href="{% url 'operations' %}" style="color:var(--muted); text-decoration:none">Opérations</a>
        <a href="{% url 'clients' %}" style="color:var(--muted); text-decoration:none">Clients</a>
      </nav>
      <div style="color:var(--muted); font-size:.9rem">{{ user.username }}</div>
    </div>
  </header>

  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'dashboard' %}">Accueil</a> / 
      <a href="{% url 'operations' %}">Opérations</a> / 
      {{ operation.id_operation }}
    </div>

    <h1>{{ operation.id_operation }} - {{ operation.type_prestation }}</h1>
    <span class="status-badge {{ operation.statut }}">{{ operation.get_statut_display }}</span>

    {% if messages %}
    {% for message in messages %}
    <div class="alert {{ message.tags }}">
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <div class="workflow-steps">
      <div class="workflow-step {% if operation.statut == 'en_attente_devis' %}active{% endif %}">Devis</div>
      <div class="workflow-arrow">→</div>
      <div class="workflow-step {% if operation.statut == 'a_planifier' %}active{% endif %}">À planifier</div>
      <div class="workflow-arrow">→</div>
      <div class="workflow-step {% if operation.statut == 'planifie' %}active{% endif %}">Planifié</div>
      <div class="workflow-arrow">→</div>
      <div class="workflow-step {% if operation.statut == 'realise' %}active{% endif %}">Réalisé</div>
      <div class="workflow-arrow">→</div>
      <div class="workflow-step {% if operation.statut == 'paye' %}active{% endif %}">Payé</div>
    </div>

    <div class="main-content">
      <div class="left-column">
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Informations générales</h2>
          </div>
          <div class="info-grid">
            <div class="info-card">
              <div class="label">Client</div>
              <div class="value">
                <strong>{{ operation.client.nom }} {{ operation.client.prenom }}</strong><br>
                <a href="{% url 'client_detail' client_id=operation.client.id %}" style="color:var(--primary); text-decoration:none">Voir le profil</a>
              </div>
            </div>
            <div class="info-card">
              <div class="label">Type de prestation</div>
              <div class="value">{{ operation.type_prestation }}</div>
            </div>
            <div class="info-card">
              <div class="label">Adresse</div>
              <div class="value">{{ operation.adresse_intervention }}</div>
            </div>
            <div class="info-card">
              <div class="label">Contact</div>
              <div class="value">
                <a href="tel:{{ operation.client.telephone }}" style="color:var(--primary); text-decoration:none">
                  {{ operation.client.telephone }}
                </a>
                {% if operation.client.email %}
                <br><a href="mailto:{{ operation.client.email }}" style="color:var(--primary); text-decoration:none">
                  {{ operation.client.email }}
                </a>
                {% endif %}
              </div>
            </div>
          </div>
        </section>

        <!-- Statut du devis -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" stroke="currentColor" stroke-width="1.6"/></svg>
              Statut du devis
            </h2>
          </div>
          
          <form method="POST" id="devis-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_devis_status">
            
            <div class="info-card">
              <div class="label">Avez-vous créé un devis ?</div>
              <div class="value">
                <select id="devis-cree" name="devis_cree" class="select" style="max-width:200px">
                  <option value="non" {% if not operation.devis_cree %}selected{% endif %}>Non</option>
                  <option value="oui" {% if operation.devis_cree %}selected{% endif %}>Oui</option>
                </select>
              </div>
            </div>

            <!-- CETTE DIV S'AFFICHE UNIQUEMENT SI OUI -->
            <div id="devis-details" style="margin-top:1rem; display:none">
              <div class="info-grid">
                <div class="info-card">
                  <div class="label">Date d'envoi au client</div>
                  <div class="value">
                    <input type="date" id="devis-date-envoi" name="devis_date_envoi" class="input"
                          value="{% if operation.devis_date_envoi %}{{ operation.devis_date_envoi|date:'Y-m-d' }}{% endif %}">
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">Réponse du client</div>
                  <div class="value">
                    <select id="devis-statut" name="devis_statut" class="select">
                      <option value="en_attente" {% if operation.devis_statut == 'en_attente' %}selected{% endif %}>En attente de réponse</option>
                      <option value="accepte" {% if operation.devis_statut == 'accepte' %}selected{% endif %}>Devis accepté</option>
                      <option value="refuse" {% if operation.devis_statut == 'refuse' %}selected{% endif %}>Devis refusé</option>
                      <option value="relance" {% if operation.devis_statut == 'relance' %}selected{% endif %}>À relancer</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Alertes selon statut -->
              <div id="devis-accepte-alert" class="alert success" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                <div><strong>Devis accepté !</strong> Vous pouvez maintenant planifier l'intervention.</div>
              </div>

              <div id="devis-refuse-alert" class="alert danger" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="2"/></svg>
                <div><strong>Devis refusé</strong> - L'opération ne peut pas progresser.</div>
              </div>

              <div id="devis-attente-alert" class="alert info" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>En attente de réponse</strong> - Le client n'a pas encore répondu.</div>
              </div>

              <div id="devis-relance-alert" class="alert warning" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>À relancer</strong> - Pensez à relancer le client.</div>
              </div>

              <button type="submit" class="btn success" style="margin-top:1rem">Enregistrer le statut du devis</button>
            </div>

            <!-- ALERTE SI NON -->
            <div id="no-devis-alert" class="alert info" style="display:none">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="1.6"/></svg>
              <div><strong>Aucun devis créé</strong> - Créez les lignes ci-dessous puis générez le PDF.</div>
            </div>
          </form>
        </section>

        <!-- Lignes du devis -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.6"/></svg>
              Devis / Opération - Lignes
            </h2>
            <button class="btn primary" onclick="alert('Fonctionnalité PDF en développement')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6" stroke="currentColor" stroke-width="1.5"/></svg>
              Générer PDF
            </button>
          </div>
          
          {% if interventions %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Description</th>
                  <th style="width:120px">Montant (€)</th>
                  <th style="width:100px">Actions</th>
                </tr>
              </thead>
              <tbody id="lignes-devis">
                {% for intervention in interventions %}
                <tr data-id="{{ intervention.id }}">
                  <td>{{ intervention.description }}</td>
                  <td><strong>{{ intervention.montant }}</strong></td>
                  <td>
                    <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette ligne ?')">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_intervention">
                      <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                      <button type="submit" class="btn danger sm">Supprimer</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>TOTAL</strong></td>
                  <td><strong id="total-devis">{{ montant_total }} €</strong></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          {% else %}
          <div class="alert info">Aucune ligne ajoutée au devis</div>
          {% endif %}

          <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border)">
            <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Ajouter une ligne</h4>
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="add_intervention">
              <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
                <div style="flex:1; min-width:250px">
                  <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Description</label>
                  <input type="text" name="description" class="input" placeholder="Ex: Main d'œuvre, Fournitures..." required>
                </div>
                <div style="flex:0 0 150px">
                  <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Montant (€)</label>
                  <input type="number" name="montant" class="input" placeholder="0.00" step="0.01" required>
                </div>
                <button type="submit" class="btn success">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                  Ajouter
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- Planification -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Planification</h2>
          </div>
          
          <form method="POST" id="planning-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_planning">
            
            <div class="info-card" style="margin-bottom:1rem">
              <div class="label">Cette opération est-elle :</div>
              <div class="value">
                <select id="planification-type" name="planning_type" class="select" style="max-width:300px">
                  <option value="a_planifier">À planifier (intervention future)</option>
                  <option value="deja_realise">Déjà réalisée (saisie après coup)</option>
                </select>
              </div>
            </div>

            <div id="planning-section">
              <div class="alert warning" id="date-passee-alert" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0M12 3l9 18H3L12 3z" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>Date dépassée !</strong> La date prévue est passée. Confirmez la réalisation ou replanifiez.</div>
              </div>
              
              <div class="info-grid">
                <div class="info-card">
                  <div class="label">Date prévue d'intervention</div>
                  <div class="value">
                    <input type="datetime-local" id="planning-date" name="date_prevue" class="input" 
                           value="{% if operation.date_prevue %}{{ operation.date_prevue|date:'Y-m-d\TH:i' }}{% endif %}">
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">Actions</div>
                  <div class="value">
                    <button type="submit" class="btn success" style="width:100%; margin-bottom:.5rem">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                      Enregistrer la planification
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="deja-realise-section" style="display:none">
              <div class="info-grid">
                <div class="info-card">
                  <div class="label">Date de réalisation</div>
                  <div class="value">
                    <input type="datetime-local" id="realisation-date" name="date_realisation" class="input"
                           value="{% if operation.date_realisation %}{{ operation.date_realisation|date:'Y-m-d\TH:i' }}{% endif %}">
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">Actions</div>
                  <div class="value">
                    <button type="submit" class="btn success" style="width:100%">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                      Valider la réalisation
                    </button>
                  </div>
                </div>
              </div>
              <p style="margin-top:.5rem; color:var(--muted); font-size:.85rem">
                Utilisez cette option si l'intervention a déjà eu lieu et que vous souhaitez la saisir dans le système.
              </p>
            </div>
          </form>
        </section>

        <!-- Paiement -->
        {% if operation.statut == 'realise' or operation.statut == 'paye' %}
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Paiement</h2>
            <button class="btn primary" onclick="alert('Fonctionnalité en développement')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6" stroke="currentColor" stroke-width="1.5"/></svg>
              Générer facture
            </button>
          </div>
          
          <form method="POST" id="paiement-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_mode_paiement">
            
            <div class="radio-option {% if operation.mode_paiement == 'comptant' %}selected{% endif %}" id="option-comptant">
              <input type="radio" name="mode_paiement" value="comptant" id="radio-comptant" {% if operation.mode_paiement == 'comptant' %}checked{% endif %}>
              <label for="radio-comptant">Comptant</label>
            </div>
            <div class="radio-option {% if operation.mode_paiement == 'echelonne' %}selected{% endif %}" id="option-echelonne">
              <input type="radio" name="mode_paiement" value="echelonne" id="radio-echelonne" {% if operation.mode_paiement == 'echelonne' %}checked{% endif %}>
              <label for="radio-echelonne">Échelonné</label>
            </div>

            <div id="comptant-fields" class="payment-box" {% if operation.mode_paiement != 'comptant' %}style="display:none"{% endif %}>
              <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Date paiement</label>
              <input type="date" id="date-paiement" name="date_paiement_comptant" class="input"
                     value="{% if operation.date_paiement %}{{ operation.date_paiement|date:'Y-m-d' }}{% endif %}">
            </div>

            <div id="echelonne-fields" class="payment-box" {% if operation.mode_paiement != 'echelonne' %}style="display:none"{% endif %}>
              {% if echeances %}
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr><th>Échéance</th><th>Montant</th><th>Date</th><th style="width:80px"></th></tr>
                  </thead>
                  <tbody id="echeances-list">
                    {% for echeance in echeances %}
                    <tr class="echeance-row">
                      <td>Éch. {{ echeance.numero }}</td>
                      <td>{{ echeance.montant }} €</td>
                      <td>{{ echeance.date_echeance|date:"d/m/Y" }}</td>
                      <td>
                        <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette échéance ?')">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="delete_echeance">
                          <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                          <button type="submit" class="btn sm">×</button>
                        </form>
                      </td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                      <td colspan="2"><strong>Total échéances</strong></td>
                      <td colspan="2"><strong id="total-echeances">{{ total_echeances }} €</strong></td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr class="reste-row">
                      <td colspan="2"><strong>Reste à planifier</strong></td>
                      <td colspan="2"><strong id="reste-calcul">{{ reste_a_payer }} €</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              {% else %}
              <div class="alert info">Aucune échéance définie</div>
              {% endif %}
              
              <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border)">
                <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Ajouter une échéance</h4>
                <form method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_echeance">
                  <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
                    <div style="flex:0 0 100px">
                      <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">N°</label>
                      <input type="number" name="numero" class="input" placeholder="1" min="1" required>
                    </div>
                    <div style="flex:0 0 150px">
                      <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Montant (€)</label>
                      <input type="number" name="montant" class="input" placeholder="0.00" step="0.01" required>
                    </div>
                    <div style="flex:1; min-width:180px">
                      <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Date échéance</label>
                      <input type="date" name="date_echeance" class="input" required>
                    </div>
                    <button type="submit" class="btn success">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                      Ajouter
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <button type="submit" class="btn success" style="width:100%; margin-top:1rem">Enregistrer le mode de paiement</button>
          </form>
        </section>
      </div>

      <div class="right-column">
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Historique</h2>
          </div>
          {% if historique %}
          <div class="table-wrap">
            <table>
              <thead><tr><th>Date</th><th>Action</th></tr></thead>
              <tbody>
                {% for entry in historique %}
                <tr>
                  <td style="font-size:.85rem">{{ entry.date|date:"d/m H:i" }}</td>
                  <td style="font-size:.9rem">{{ entry.action }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert info">Aucun historique</div>
          {% endif %}
        </section>
      </div>
    </div>

    <div style="margin-top:1.5rem">
      <a href="{% url 'operations' %}" class="btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5"/></svg>
        Retour aux opérations
      </a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let MONTANT_TOTAL = {{ montant_total|default:0 }};
      
      function getNowFormatted() {
        const now = new Date();
        const pad = n => String(n).padStart(2, '0');
        return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
      }

      function getTodayDate() {
        const now = new Date();
        const pad = n => String(n).padStart(2, '0');
        return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate());
      }

// Gestion du statut du devis
const devisCreeSelect = document.getElementById('devis-cree');
const devisDetails = document.getElementById('devis-details');
const noDevisAlert = document.getElementById('no-devis-alert');
const devisStatutSelect = document.getElementById('devis-statut');

function updateDevisDisplay() {
  const isCreated = devisCreeSelect.value === 'oui';
  
  if (devisDetails) {
    devisDetails.style.display = isCreated ? 'block' : 'none';
  }
  
  if (noDevisAlert) {
    noDevisAlert.style.display = isCreated ? 'none' : 'flex';
  }
  
  if (isCreated && devisStatutSelect) {
    updateDevisAlerts();
  }
}

function updateDevisAlerts() {
  if (!devisStatutSelect) return;
  
  const statut = devisStatutSelect.value;
  
  const alerts = {
    'devis-accepte-alert': statut === 'accepte',
    'devis-refuse-alert': statut === 'refuse',
    'devis-attente-alert': statut === 'en_attente',
    'devis-relance-alert': statut === 'relance'
  };
  
  Object.keys(alerts).forEach(alertId => {
    const alertElement = document.getElementById(alertId);
    if (alertElement) {
      alertElement.style.display = alerts[alertId] ? 'flex' : 'none';
    }
  });
}

if (devisCreeSelect) {
  devisCreeSelect.addEventListener('change', updateDevisDisplay);
  
  // IMPORTANT : Appeler au chargement pour afficher l'état initial
  updateDevisDisplay();
}

if (devisStatutSelect) {
  devisStatutSelect.addEventListener('change', updateDevisAlerts);
}

      // Gestion de la planification
      const planificationType = document.getElementById('planification-type');
      const planningSection = document.getElementById('planning-section');
      const dejaRealiseSection = document.getElementById('deja-realise-section');
      const planningDate = document.getElementById('planning-date');
      const realisationDate = document.getElementById('realisation-date');
      const datePasseeAlert = document.getElementById('date-passee-alert');

      function updatePlanningDisplay() {
        const type = planificationType.value;
        if (type === 'a_planifier') {
          planningSection.style.display = 'block';
          dejaRealiseSection.style.display = 'none';
          checkDatePassee();
        } else {
          planningSection.style.display = 'none';
          dejaRealiseSection.style.display = 'block';
          if (!realisationDate.value) {
            realisationDate.value = getNowFormatted();
          }
        }
      }

      function checkDatePassee() {
        if (planningDate.value) {
          const dateSelectionnee = new Date(planningDate.value);
          const maintenant = new Date();
          if (dateSelectionnee < maintenant) {
            datePasseeAlert.style.display = 'flex';
          } else {
            datePasseeAlert.style.display = 'none';
          }
        }
      }

      if (planificationType) {
        planificationType.addEventListener('change', updatePlanningDisplay);
        updatePlanningDisplay();
      }

      if (planningDate) {
        planningDate.addEventListener('change', checkDatePassee);
        checkDatePassee();
      }

      // Gestion des paiements
      const optComptant = document.getElementById('option-comptant');
      const optEchelonne = document.getElementById('option-echelonne');
      const radioComptant = document.getElementById('radio-comptant');
      const radioEchelonne = document.getElementById('radio-echelonne');

      function toggleModePaiement() {
        if (!radioComptant || !radioEchelonne) return;
        
        const isComptant = radioComptant.checked;
        
        if (optComptant) optComptant.classList.toggle('selected', isComptant);
        if (optEchelonne) optEchelonne.classList.toggle('selected', !isComptant);
        
        const comptantFields = document.getElementById('comptant-fields');
        const echelonneFields = document.getElementById('echelonne-fields');
        
        if (comptantFields) comptantFields.style.display = isComptant ? 'block' : 'none';
        if (echelonneFields) echelonneFields.style.display = isComptant ? 'none' : 'block';
      }

      if (optComptant && optEchelonne && radioComptant && radioEchelonne) {
        optComptant.addEventListener('click', () => {
          radioComptant.checked = true;
          toggleModePaiement();
        });
        
        optEchelonne.addEventListener('click', () => {
          radioEchelonne.checked = true;
          toggleModePaiement();
        });
        
        radioComptant.addEventListener('change', toggleModePaiement);
        radioEchelonne.addEventListener('change', toggleModePaiement);
        
        toggleModePaiement();
      }

      // Initialisation des dates
      const datePaiementInput = document.getElementById('date-paiement');
      if (datePaiementInput && !datePaiementInput.value) {
        datePaiementInput.value = getTodayDate();
      }

      const devisDateEnvoi = document.getElementById('devis-date-envoi');
      if (devisDateEnvoi && !devisDateEnvoi.value) {
        devisDateEnvoi.value = getTodayDate();
      }

      console.log('✅ JavaScript initialisé - Montant total:', MONTANT_TOTAL);
    });
  </script>
</body>
</html>