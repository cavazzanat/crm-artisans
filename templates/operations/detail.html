<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ operation.id_operation }} - {{ operation.type_prestation }} – CRM Artisans</title>
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
      --ring: rgba(99,102,241,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: var(--bg);
      color: var(--text); 
      line-height: 1.6; 
      padding-bottom:3rem;
    }

    /* ========================================
       EN-TÊTE MODERNE (DASHBOARD STYLE)
       ======================================== */
    .header{ 
      position: sticky; 
      top: 0; 
      z-index: 40;
      backdrop-filter: saturate(180%) blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .header-inner{ 
      max-width:1280px; 
      margin:0 auto; 
      padding:.85rem 1rem; 
      display:flex; 
      align-items:center; 
      gap:1rem; 
      justify-content:space-between;
    }
    .brand{ 
      display:flex; 
      align-items:center; 
      gap:.75rem; 
      font-weight:700; 
      letter-spacing:.2px; 
      color: var(--text); 
    }
    .logo{ 
      width:34px; 
      height:34px; 
      border-radius:10px; 
      background:linear-gradient(145deg, var(--primary), var(--accent)); 
      box-shadow: var(--shadow); 
      display:grid; 
      place-items:center;
    }
    .logo svg{ width:18px; height:18px; color:white }

    .nav{ 
      display: flex; 
      gap: .25rem; 
      align-items: center;
    }
    .nav a{ 
      text-decoration: none; 
      color: var(--muted); 
      padding: .55rem .8rem; 
      border-radius: 10px; 
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }
    .nav a:hover{ 
      color: var(--text); 
      background: rgba(148,163,184,.08); 
      border-color: var(--border);
    }
    .nav a.active{ 
      color: white; 
      background: rgba(99,102,241,.18); 
      border-color: rgba(99,102,241,.35); 
      box-shadow: 0 0 0 2px var(--ring);
    }

    .user{ 
      display: flex; 
      align-items: center; 
      gap: .75rem; 
      color: var(--muted); 
      font-size: .95rem;
    }
    .user form button{ 
      background: none; 
      border: none; 
      color: var(--muted); 
      cursor: pointer; 
      text-decoration: underline; 
      font: inherit; 
      padding: 0;
    }
    .user form button:hover{ color: var(--text); }

    /* ========================================
       RESTE DU STYLE
       ======================================== */
    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    
    h1{ font-size:1.8rem; font-weight:800; margin-bottom:.5rem; color: var(--text); }
    .breadcrumb{ color:var(--muted); font-size:.9rem; margin-bottom:1rem }
    .breadcrumb a{ color:var(--muted); text-decoration:none }
    .breadcrumb a:hover{ color:var(--text) }

    .status-badge{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; 
      border-radius:20px; font-size:.85rem; font-weight:600; border:1px solid;
    }
    .status-badge::before{ content:''; width:8px; height:8px; border-radius:50%; background:currentColor }
    .status-badge.en_attente_devis{ color:#f59e0b; background: rgba(245,158,11,.1); border-color: rgba(245,158,11,.3); }
    .status-badge.a_planifier{ color:#3b82f6; background: rgba(59,130,246,.1); border-color: rgba(59,130,246,.3); }
    .status-badge.planifie{ color:#8b5cf6; background: rgba(139,92,246,.1); border-color: rgba(139,92,246,.3); }
    .status-badge.realise{ color:#22c55e; background: rgba(34,197,94,.1); border-color: rgba(34,197,94,.3); }
    .status-badge.paye{ color:#10b981; background: rgba(16,185,129,.1); border-color: rgba(16,185,129,.3); }
    .status-badge.devis_refuse{ color:#ef4444; background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.3); }
    
    .section{ 
      background: white;
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:1.5rem; 
      box-shadow: var(--shadow); 
      margin-bottom:1.5rem 
    }
    .section-header{ 
      display:flex; align-items:center; justify-content:space-between; gap:1rem; 
      padding-bottom:1rem; border-bottom:1px solid var(--border); margin-bottom:1rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }
    .section-header:hover {
      background: rgba(148,163,184,.03);
      border-radius: 8px;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700; color: var(--text); }

    /* ========================================
       SECTIONS REPLIABLES (ACCORDÉON)
       ======================================== */
    .section-header .toggle-icon {
      transition: transform 0.3s ease;
      color: var(--muted);
      flex-shrink: 0;
    }

    .section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .section-body {
      max-height: 5000px;
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
      opacity: 1;
    }

    .section-body.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    /* Badge indicateur sur les sections */
    .section-badge {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .2rem .5rem;
      border-radius: 12px;
      font-size: .75rem;
      font-weight: 600;
      margin-left: .5rem;
    }

    .section-badge.complete {
      background: rgba(34,197,94,.1);
      color: var(--success);
      border: 1px solid rgba(34,197,94,.2);
    }

    .section-badge.pending {
      background: rgba(245,158,11,.1);
      color: var(--warning);
      border: 1px solid rgba(245,158,11,.2);
    }

    .section-badge.disabled {
      background: rgba(148,163,184,.1);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,.2);
    }

    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem }
    .info-card{
      background: #f8fafc;
      border:1px solid var(--border); 
      border-radius:10px; 
      padding:1rem; 
      transition: all 0.2s ease;
    }
    .info-card:hover{ background: #f1f5f9; border-color: #cbd5e1; }
    .info-card .label{
      display:flex; align-items:center; gap:.5rem; color:var(--muted); 
      font-size:.85rem; font-weight:600; text-transform:uppercase; 
      letter-spacing:.05rem; margin-bottom:.75rem
    }
    .info-card .value{ color: var(--text); font-weight: 600; font-size: 1rem; line-height: 1.4 }

    .input, .select{ 
      width:100%; padding:.65rem .8rem; border-radius:8px; border:1px solid var(--border); 
      background: white; color: var(--text); font:inherit 
    }
    .input:focus, .select:focus{ 
      outline:none; 
      box-shadow: 0 0 0 3px rgba(99,102,241,.1); 
      border-color: var(--primary);
    }

    .btn{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; 
      border-radius:8px; border:1px solid var(--border); 
      background:white; color:var(--text); cursor:pointer; font:inherit; text-decoration:none;
      transition: all 0.2s;
    }
    .btn:hover{ background:#f8fafc; border-color: #cbd5e1; }
    .btn.success{ background:var(--success); border-color: var(--success); color: white; }
    .btn.success:hover{ background:#16a34a; }
    .btn.primary{ background:var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover{ background:#4f46e5; }
    .btn.danger{ background: var(--danger); border-color: var(--danger); color: white; }
    .btn.danger:hover{ background:#dc2626; }
    .btn.sm{ padding:.4rem .6rem; border-radius:6px; font-size:.9rem }

    .alert{ 
      padding:.75rem 1rem; border-radius:8px; margin-top:1rem; 
      display:flex; align-items:center; gap:.5rem; font-size:.9rem;
    }
    .alert.warning{ background: #fef3c7; color: #92400e; border:1px solid #fde68a; }
    .alert.danger, .alert.error{ background: #fee2e2; color: #991b1b; border:1px solid #fecaca; }
    .alert.success{ background: #d1fae5; color: #065f46; border:1px solid #a7f3d0; }
    .alert.info{ background: #dbeafe; color: #1e40af; border:1px solid #bfdbfe; }

    .radio-option{ 
      display:flex; align-items:center; gap:.5rem; padding:.6rem 1rem; 
      border:2px solid var(--border); border-radius:8px; cursor:pointer; 
      transition: all .2s; margin-bottom:.5rem; background: white;
    }
    .radio-option:hover{ border-color:var(--primary); background:#f8fafc; }
    .radio-option.selected{ border-color:var(--primary); background:#eef2ff; box-shadow: 0 0 0 3px rgba(99,102,241,.1); }
    .radio-option input[type="radio"]{ width:auto; margin:0; cursor:pointer }
    .radio-option label{ margin:0; cursor:pointer; font-weight:500; flex:1 }

    .payment-box{ background: #f8fafc; border:1px solid var(--border); border-radius:10px; padding:1rem; margin-top:1rem }

    .table-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--border); margin-top:1rem; background: white; }
    table{ width:100%; border-collapse: collapse }
    thead th{ 
      background: #f8fafc; color:var(--muted); text-transform:uppercase; letter-spacing:.08rem; 
      font-size:.75rem; text-align:left; padding:.9rem .85rem; border-bottom:1px solid var(--border)
    }
    tbody td{ padding:.9rem .85rem; border-bottom:1px solid var(--border); }
    tbody tr:hover{ background: #f8fafc; }
    .echeance-row{ background: #f0fdf4; }
    .reste-row{ background: #fef3c7; font-weight:700; color:#92400e; }
    .total-row{ background: #eef2ff; font-weight:700; }

    .workflow-steps{
      display:flex; align-items:center; gap:.5rem; margin-top:1rem; padding:1rem; 
      background:white; border-radius:10px; flex-wrap:wrap; border:1px solid var(--border);
    }
    .workflow-step{
      padding:.4rem .8rem; background:#f1f5f9; 
      border-radius:6px; font-size:.8rem; color:var(--muted); font-weight:600;
    }
    .workflow-step.active{ background:var(--primary); color:white; }
    .workflow-arrow{ color:var(--muted); font-weight:bold }

    .main-content{ display:grid; grid-template-columns:2fr 1fr; gap:2rem; align-items:start }
    .hidden { display: none !important; }

    /* ========================================
   NOTIFICATIONS TOAST
   ======================================== */
.toast-container {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}

.toast {
  min-width: 320px;
  max-width: 420px;
  padding: 1rem 1.25rem;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,.15), 0 4px 12px rgba(0,0,0,.1);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  pointer-events: auto;
  animation: slideInRight 0.3s ease-out;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,.2);
}

.toast.hiding {
  animation: slideOutRight 0.3s ease-in forwards;
}

@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

.toast-icon {
  flex-shrink: 0;
  width: 24px;
  height: 24px;
}

.toast-content {
  flex: 1;
  font-size: 0.95rem;
  line-height: 1.5;
}

.toast-close {
  flex-shrink: 0;
  width: 20px;
  height: 20px;
  border: none;
  background: none;
  cursor: pointer;
  opacity: 0.6;
  transition: opacity 0.2s;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast-close:hover {
  opacity: 1;
}

/* Types de toast */
.toast.success {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
  color: white;
}

.toast.error {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
  color: white;
}

.toast.warning {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
  color: white;
}

.toast.info {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
  color: white;
}

/* Responsive */
@media (max-width: 640px) {
  .toast-container {
    top: 70px;
    right: 10px;
    left: 10px;
  }
  
  .toast {
    min-width: auto;
    max-width: none;
  }
}

    @media (max-width: 1024px){ 
      .main-content{ grid-template-columns: 1fr }
      .nav{ flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}">Accueil</a>
        <a href="{% url 'operations' %}" class="active">Opérations</a>
        <a href="{% url 'clients' %}">Clients</a>
      </nav>
      <div class="user">
        <span>{{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}" style="display:inline">
          {% csrf_token %}
          <button type="submit">Déconnexion</button>
        </form>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'dashboard' %}">Accueil</a> / 
      <a href="{% url 'operations' %}">Opérations</a> / 
      {{ operation.id_operation }}
    </div>

    
{% if messages %}
<div id="django-messages" style="display:none">
  {% for message in messages %}
  <div data-type="{{ message.tags }}" data-message="{{ message }}"></div>
  {% endfor %}
</div>
{% endif %}



    <!-- ✅ NOUVEAU : En-tête avec bouton de suppression -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; flex-wrap:wrap">
      <div>
        <h1>{{ operation.id_operation }} - {{ operation.type_prestation }}</h1>
        <span class="status-badge {{ operation.statut }}">{{ operation.get_statut_display }}</span>
      </div>
      
      <form method="POST" action="{% url 'operation_delete' operation.id %}" onsubmit="return confirmDeleteOperation()" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="force_delete" value="true">
        <button type="submit" class="btn danger" title="Supprimer l'opération">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M9 7v12m6-12v12M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13M9 7l1-3h4l1 3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
          Supprimer l'opération
        </button>
      </form>
    </div>

    <div class="workflow-steps">
      <div class="workflow-step {% if operation.statut == 'en_attente_devis' %}active{% endif %}">Devis</div>
      <div class="workflow-arrow">→</div>
      <div class="workflow-step {% if operation.statut == 'a_planifier' %}active{% endif %}">À planifier</div>
      <div class="workflow-arrow">→</div>
      <div class="workflow-step {% if operation.statut == 'planifie' %}active{% endif %}">Planifié</div>
      <div class="workflow-arrow">→</div>
      <div class="workflow-step {% if operation.statut == 'realise' %}active{% endif %}">Réalisé</div>
      <div class="workflow-arrow">→</div>
      <div class="workflow-step {% if operation.statut == 'paye' %}active{% endif %}">Payé</div>
    </div>

    <div class="main-content">
      <div class="left-column">
    <!-- ========================================
        INFORMATIONS GÉNÉRALES
        ======================================== -->
    <section class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
          Informations générales
          <span class="section-badge complete">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
            Complété
          </span>
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="section-body">
        <div class="info-grid">
          <div class="info-card">
            <div class="label">Client</div>
            <div class="value">
              <strong>{{ operation.client.nom }} {{ operation.client.prenom }}</strong><br>
              <a href="{% url 'client_detail' client_id=operation.client.id %}" style="color:var(--primary); text-decoration:none">Voir le profil</a>
            </div>
          </div>
          <div class="info-card">
            <div class="label">Type de prestation</div>
            <div class="value">{{ operation.type_prestation }}</div>
          </div>
          <div class="info-card">
            <div class="label">Adresse</div>
            <div class="value">{{ operation.adresse_intervention }}</div>
          </div>
          <div class="info-card">
            <div class="label">Contact</div>
            <div class="value">
              <a href="tel:{{ operation.client.telephone }}" style="color:var(--primary); text-decoration:none">
                {{ operation.client.telephone }}
              </a>
              {% if operation.client.email %}
              <br><a href="mailto:{{ operation.client.email }}" style="color:var(--primary); text-decoration:none">
                {{ operation.client.email }}
              </a>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- ✅ NOUVEAU : Section Commentaires -->
        <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border)">
          <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem; display:flex; align-items:center; gap:.5rem">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M8 9h8M8 13h6M7 17l-4 4V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7Z" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            Commentaires / Notes
          </h4>
          
          <form method="POST" id="commentaires-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_commentaires">
            
            <textarea 
              id="commentaires-textarea" 
              name="commentaires" 
              class="input" 
              rows="4" 
              placeholder="Ajoutez des remarques, notes ou informations importantes sur cette opération..."
              style="resize:vertical; min-height:100px; font-family: inherit;">{{ operation.commentaires|default:'' }}</textarea>
            
            <div style="display:flex; gap:.75rem; margin-top:1rem; justify-content:flex-end">
              <button type="button" class="btn" onclick="resetCommentaires()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="M4 12h16M12 4v16" stroke="currentColor" stroke-width="2" transform="rotate(45 12 12)"/>
                </svg>
                Annuler
              </button>
              <button type="submit" class="btn success">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/>
                </svg>
                Enregistrer les commentaires
              </button>
            </div>
          </form>
          
          {% if operation.commentaires %}
          <div class="alert info" style="margin-top:1rem">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <div><strong>Note :</strong> Les commentaires sont privés et visibles uniquement par vous.</div>
          </div>
          {% endif %}
        </div>
      </div>
    </section>


        <!-- ========================================
        STATUT DU DEVIS
        ======================================== -->
    <section class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" stroke="currentColor" stroke-width="1.6"/></svg>
          Statut du devis
          {% if operation.devis_cree %}
            {% if operation.devis_statut == 'accepte' %}
            <span class="section-badge complete">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
              Accepté
            </span>
            {% elif operation.devis_statut == 'refuse' %}
            <span class="section-badge" style="background: rgba(239,68,68,.1); color: var(--danger); border: 1px solid rgba(239,68,68,.2);">
              ✗ Refusé
            </span>
            {% else %}
            <span class="section-badge pending">
              {{ operation.get_devis_statut_display }}
            </span>
            {% endif %}
          {% else %}
          <span class="section-badge pending">⏳ En attente</span>
          {% endif %}
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      
      <div class="section-body">
        <form method="POST" id="devis-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_devis_status">
          
          <div class="info-card">
            <div class="label">Avez-vous créé un devis ?</div>
            <div class="value">
              <select id="devis-cree" name="devis_cree" class="select" style="max-width:200px">
                <option value="non" {% if not operation.devis_cree %}selected{% endif %}>Non</option>
                <option value="oui" {% if operation.devis_cree %}selected{% endif %}>Oui</option>
              </select>
            </div>
          </div>

          <div id="devis-details" class="{% if not operation.devis_cree %}hidden{% endif %}" style="margin-top:1rem">
            <div class="info-grid">
              <div class="info-card">
                <div class="label">Date d'envoi au client</div>
                <div class="value">
                  <input type="date" id="devis-date-envoi" name="devis_date_envoi" class="input"
                        value="{% if operation.devis_date_envoi %}{{ operation.devis_date_envoi|date:'Y-m-d' }}{% endif %}">
                </div>
              </div>
              
              <div class="info-card">
                <div class="label">Réponse du client</div>
                <div class="value">
                  <select id="devis-statut" name="devis_statut" class="select">
                    <option value="en_attente" {% if operation.devis_statut == 'en_attente' %}selected{% endif %}>En attente de réponse</option>
                    <option value="accepte" {% if operation.devis_statut == 'accepte' %}selected{% endif %}>Devis accepté</option>
                    <option value="refuse" {% if operation.devis_statut == 'refuse' %}selected{% endif %}>Devis refusé</option>
                    <option value="relance" {% if operation.devis_statut == 'relance' %}selected{% endif %}>À relancer</option>
                  </select>
                </div>
              </div>
              
              <!-- ✅ NOUVEAU : Date de réponse client -->
              <div class="info-card" id="date-reponse-card" style="display:none">
                <div class="label">Date de réponse client</div>
                <div class="value">
                  <input type="date" id="devis-date-reponse" name="devis_date_reponse" class="input"
                        value="{% if operation.devis_date_reponse %}{{ operation.devis_date_reponse|date:'Y-m-d' }}{% endif %}">
                </div>
              </div>
            </div>

            <!-- ✅ NOUVEAU : Affichage du délai -->
            <div id="delai-reponse-info" class="alert info" style="display:none; margin-top:1rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              <div id="delai-reponse-text"></div>
            </div>

            <div id="devis-accepte-alert" class="alert success" style="display:none">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
              <div><strong>Devis accepté !</strong> Vous pouvez maintenant planifier l'intervention.</div>
            </div>

            <div id="devis-refuse-alert" class="alert danger" style="display:none">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="2"/></svg>
              <div>
                <strong>Devis refusé</strong> - L'opération a été annulée automatiquement.
                <br>
                <small>Statut de l'opération : <strong>Devis refusé / Opération annulée</strong></small>
              </div>
            </div>

            <div id="devis-attente-alert" class="alert info" style="display:none">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3" stroke="currentColor" stroke-width="1.6"/></svg>
              <div><strong>En attente de réponse</strong> - Le client n'a pas encore répondu.</div>
            </div>

            <div id="devis-relance-alert" class="alert warning" style="display:none">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="1.6"/></svg>
              <div><strong>À relancer</strong> - Pensez à relancer le client.</div>
            </div>

            <button type="submit" class="btn success" style="margin-top:1rem">Enregistrer le statut du devis</button>
          </div>

          <div id="no-devis-alert" class="alert info" style="display:none">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="1.6"/></svg>
            <div><strong>Aucun devis créé</strong> - Créez les lignes ci-dessous puis générez le PDF.</div>
          </div>
        </form>
      </div>
    </section>
        <!-- ========================================
             LIGNES DU DEVIS
             ======================================== -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.6"/></svg>
              Devis / Opération - Lignes
              {% if interventions %}
              <span class="section-badge complete">
                {{ interventions.count }} ligne{{ interventions.count|pluralize }}
              </span>
              {% else %}
              <span class="section-badge pending">Aucune ligne</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            {% if interventions %}
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Description</th>
                    <th style="width:120px">Montant (€)</th>
                    <th style="width:100px">Actions</th>
                  </tr>
                </thead>
                <tbody id="lignes-devis">
                  {% for intervention in interventions %}
                  <tr data-id="{{ intervention.id }}">
                    <td>{{ intervention.description }}</td>
                    <td><strong>{{ intervention.montant }}</strong></td>
                    <td>
                      <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette ligne ?')">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_intervention">
                        <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                        <button type="submit" class="btn danger sm">Supprimer</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr class="total-row">
                    <td><strong>TOTAL</strong></td>
                    <td><strong id="total-devis">{{ montant_total }} €</strong></td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            {% else %}
            <div class="alert info">Aucune ligne ajoutée au devis</div>
            {% endif %}

            <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border)">
              <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Ajouter une ligne</h4>
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_intervention">
                <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
                  <div style="flex:1; min-width:250px">
                    <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Description</label>
                    <input type="text" name="description" class="input" placeholder="Ex: Main d'œuvre, Fournitures..." required>
                  </div>
                  <div style="flex:0 0 150px">
                    <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Montant (€)</label>
                    <input type="number" name="montant" class="input" placeholder="0.00" step="0.01" required>
                  </div>
                  <button type="submit" class="btn success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                    Ajouter
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>

        <!-- ========================================
            PLANIFICATION
            ======================================== -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6"/></svg>
              Planification
              {% if operation.date_prevue %}
              <span class="section-badge complete">
                📅 {{ operation.date_prevue|date:"d/m/Y H:i" }}
              </span>
              {% elif operation.statut == 'en_attente_devis' %}
              <span class="section-badge disabled">Non applicable</span>
              {% else %}
              <span class="section-badge pending">À planifier</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            <form method="POST" id="planning-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_planning">
              
              <div class="info-card" style="margin-bottom:1rem">
                <div class="label">Que souhaitez-vous faire ?</div>
                <div class="value">
                  <select id="planification-type" name="planning_type" class="select" style="max-width:400px">
                    <option value="a_planifier">Planifier une intervention future</option>
                    <option value="replanifier">Replanifier (reporter à une nouvelle date)</option>
                    <option value="deja_realise">Déjà réalisée (saisie après coup)</option>
                  </select>
                </div>
              </div>

              <!-- ===== À PLANIFIER ===== -->
              <div id="planning-section">
                <div class="alert warning" id="date-passee-alert" style="display:none">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0M12 3l9 18H3L12 3z" stroke="currentColor" stroke-width="1.6"/></svg>
                  <div><strong>Date dépassée !</strong> La date prévue est passée. Confirmez la réalisation ou replanifiez.</div>
                </div>
                
                <div class="info-grid">
                  <div class="info-card">
                    <div class="label">Date prévue d'intervention</div>
                    <div class="value">
                      <input type="datetime-local" id="planning-date" name="date_prevue" class="input" 
                            value="{% if operation.date_prevue %}{{ operation.date_prevue|date:'Y-m-d\TH:i' }}{% endif %}">
                    </div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">Actions</div>
                    <div class="value">
                      <button type="submit" class="btn success" style="width:100%">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                        Enregistrer la planification
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ===== REPLANIFIER ===== -->
              <div id="replanifier-section" style="display:none">
                <div class="info-grid">
                  <div class="info-card">
                    <div class="label">Nouvelle date d'intervention</div>
                    <div class="value">
                      <input type="datetime-local" id="replanification-date" name="date_prevue" class="input" 
                            value="{% if operation.date_prevue %}{{ operation.date_prevue|date:'Y-m-d\TH:i' }}{% endif %}">
                    </div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">Actions</div>
                    <div class="value">
                      <button type="submit" class="btn primary" style="width:100%">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
                        Confirmer la replanification
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ===== DÉJÀ RÉALISÉE ===== -->
              <div id="deja-realise-section" style="display:none">
                <div class="info-grid">
                  <div class="info-card">
                    <div class="label">Date de réalisation</div>
                    <div class="value">
                      <input type="datetime-local" id="realisation-date" name="date_realisation" class="input"
                            value="{% if operation.date_realisation %}{{ operation.date_realisation|date:'Y-m-d\TH:i' }}{% endif %}">
                    </div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">Actions</div>
                    <div class="value">
                      <button type="submit" class="btn success" style="width:100%">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                        Valider la réalisation
                      </button>
                    </div>
                  </div>
                </div>
                <p style="margin-top:.5rem; color:var(--muted); font-size:.85rem">
                  Utilisez cette option si l'intervention a déjà eu lieu et que vous souhaitez la saisir dans le système.
                </p>
              </div>
            </form>
          </div>
        </section>


        <!-- ========================================
             PAIEMENT
             ======================================== -->
        {% if operation.devis_statut == 'accepte' or operation.statut == 'realise' or operation.statut == 'paye' %}
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 8.5h20M2 12.5h20M6 16.5h8M6 20.5h8M6 4.5h8" stroke="currentColor" stroke-width="1.6"/></svg>
              Paiement
              {% if operation.statut == 'paye' %}
              <span class="section-badge complete">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                Payé
              </span>
              {% elif operation.mode_paiement %}
              <span class="section-badge pending">{{ operation.get_mode_paiement_display }}</span>
              {% else %}
              <span class="section-badge disabled">Non configuré</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            {% if operation.statut != 'realise' and operation.statut != 'paye' %}
            <div class="alert info" style="margin-bottom:1rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              <div>Vous pouvez enregistrer des acomptes avant la réalisation (arrhes, avances).</div>
            </div>
            {% endif %}
            
            <!-- Choix du mode de paiement -->
            <div class="info-card" style="margin-bottom:1.5rem">
              <div class="label">Mode de paiement</div>
              <div class="value">
                <select id="mode-paiement-select" class="select" style="max-width:300px">
                  <option value="">-- Sélectionnez --</option>
                  <option value="comptant" {% if operation.mode_paiement == 'comptant' %}selected{% endif %}>Paiement comptant</option>
                  <option value="echelonne" {% if operation.mode_paiement == 'echelonne' %}selected{% endif %}>Paiement en plusieurs fois</option>
                </select>
              </div>
            </div>

            <!-- ===== PAIEMENT COMPTANT ===== -->
            <div id="comptant-section" style="display:none">
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="paiement_comptant">
                
                <div class="payment-box">
                  <div class="info-grid">
                    <div class="info-card">
                      <div class="label">Montant total</div>
                      <div class="value" style="font-size:1.4rem; color:var(--primary)">{{ montant_total }} €</div>
                    </div>
                    
                    <div class="info-card">
                      <div class="label">Date de paiement</div>
                      <div class="value">
                        <input type="date" name="date_paiement" class="input" id="date-paiement-comptant" 
                              value="{% if operation.date_paiement %}{{ operation.date_paiement|date:'Y-m-d' }}{% endif %}"
                              required>
                      </div>
                    </div>
                  </div>
                  
                  <button type="submit" class="btn success" style="width:100%; margin-top:1rem">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    Valider le paiement comptant
                  </button>
                </div>
              </form>
            </div>

            <!-- ===== PAIEMENT ÉCHELONNÉ ===== -->
            <div id="echelonne-section" style="display:none">
              
              <!-- Récapitulatif financier -->
              <div class="payment-box" style="margin-bottom:1.5rem">
                <div class="info-grid">
                  <div class="info-card">
                    <div class="label">Montant total</div>
                    <div class="value" style="font-size:1.4rem; color:var(--primary)">{{ montant_total }} €</div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">Total payé</div>
                    <div class="value" style="font-size:1.4rem; color:var(--success)">
                      <span id="total-paye">{{ total_echeances|default:0 }}</span> €
                    </div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">Reste à payer</div>
                    <div class="value" style="font-size:1.4rem; color:var(--warning)">
                      <span id="reste-a-payer">{{ reste_a_payer|default:montant_total }}</span> €
                    </div>
                  </div>
                  <div class="info-card">
                    <div class="label">Total planifié</div>
                    <div class="value" style="font-size:1.2rem; color:var(--muted)">
                      {{ total_echeances_prevu }} €
                    </div>
                  </div>
                </div>
              </div>

              <!-- Liste des paiements enregistrés -->
              {% if echeances %}
              <div class="payment-box" style="margin-bottom:1.5rem">
                <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Paiements enregistrés</h4>
                <div class="table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th>N°</th>
                        <th>Montant</th>
                        <th>Date prévue</th>
                        <th>Statut</th>
                        <th style="width:120px">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for echeance in echeances %}
                      <tr class="echeance-row" style="{% if echeance.statut_display == 'retard' %}background: #fee2e2;{% endif %}">
                        <td><strong>Paiement {{ echeance.numero }}</strong></td>
                        <td>{{ echeance.montant }} €</td>
                        <td>{{ echeance.date_echeance|date:"d/m/Y" }}</td>
                        <td>
                          {% if echeance.paye %}
                            <span style="color:var(--success); font-weight:600">✓ Payé</span>
                          {% else %}
                            {% now "Y-m-d" as today %}
                            {% if echeance.date_echeance|date:"Y-m-d" < today %}
                              <span style="color:var(--danger); font-weight:600">⚠ En retard</span>
                            {% else %}
                              <span style="color:var(--warning); font-weight:600">⏳ En attente</span>
                            {% endif %}
                          {% endif %}
                        </td>
                        <td>
                          {% if not echeance.paye %}
                          <form method="POST" style="display:inline; margin-right:.5rem">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="marquer_paye_echeance">
                            <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                            <button type="submit" class="btn success sm" title="Marquer comme payé">✓</button>
                          </form>
                          {% endif %}
                          <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer ce paiement ?')">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_echeance">
                            <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                            <button type="submit" class="btn danger sm">×</button>
                          </form>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% endif %}

              <!-- Formulaire d'ajout de paiement -->
              <div class="payment-box">
                <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">
                  {% if echeances %}Ajouter un paiement supplémentaire{% else %}Enregistrer le premier paiement{% endif %}
                </h4>
                
                <form method="POST" id="form-add-echeance">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_echeance">
                  
                  <div class="info-grid" style="margin-bottom:1rem">
                    <div class="info-card">
                      <div class="label">Montant (€)</div>
                      <div class="value">
                        <input type="number" name="montant" class="input" placeholder="Ex: 500" step="0.01" min="0.01" max="{{ reste_a_payer|default:montant_total }}" required>
                      </div>
                    </div>
                    
                    <div class="info-card">
                      <div class="label">Date prévue</div>
                      <div class="value">
                        <input type="date" name="date_echeance" class="input" required>
                      </div>
                    </div>
                  </div>
                  
                  <button type="submit" class="btn success" style="width:100%">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                    Enregistrer ce paiement
                  </button>
                </form>
              </div>
              
              <!-- Bouton de validation finale -->
              {% if echeances %}
              <form method="POST" style="margin-top:1rem">
                {% csrf_token %}
                <input type="hidden" name="action" value="valider_echelonnement">
                <button type="submit" class="btn primary" style="width:100%">
                  Valider le plan de paiement échelonné
                </button>
              </form>
              {% endif %}
            </div>
            
          </div>
        </section>
        {% endif %}
      </div>

      <!-- ========================================
           COLONNE DROITE - HISTORIQUE
           ======================================== -->
      <div class="right-column">
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              Historique
              {% if historique %}
              <span class="section-badge complete">
                {{ historique.count }} événement{{ historique.count|pluralize }}
              </span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="section-body">
            {% if historique %}
            <div class="table-wrap">
              <table>
                <thead><tr><th>Date</th><th>Action</th></tr></thead>
                <tbody>
                  {% for entry in historique %}
                  <tr>
                    <td style="font-size:.85rem">{{ entry.date|date:"d/m H:i" }}</td>
                    <td style="font-size:.9rem">{{ entry.action }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert info">Aucun historique</div>
            {% endif %}
          </div>
        </section>
      </div>
    </div>

    <div style="margin-top:1.5rem">
      <a href="{% url 'operations' %}" class="btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5"/></svg>
        Retour aux opérations
      </a>
    </div>
  </div>


<script>
// ========================================
// ✅ FONCTIONS GLOBALES (DOIVENT ÊTRE EN PREMIER)
// ========================================

// Fonction de confirmation de suppression
function confirmDeleteOperation() {
  const id = '{{ operation.id_operation }}';
  const type = '{{ operation.type_prestation|escapejs }}';
  const client = '{{ operation.client.nom }} {{ operation.client.prenom }}';
  const interventions = {{ interventions.count|default:0 }};
  const echeances = {{ echeances.count|default:0 }};
  
  let message = '⚠️ ATTENTION : Supprimer l\'opération ' + id + ' ?\n\n';
  message += '📋 Type : ' + type + '\n';
  message += '👤 Client : ' + client + '\n';
  
  if (interventions > 0) {
    message += '\n🔸 ' + interventions + ' ligne(s) d\'intervention seront supprimée(s)';
  }
  
  if (echeances > 0) {
    message += '\n💰 ' + echeances + ' échéance(s) de paiement seront supprimée(s)';
  }
  
  message += '\n\n🚨 Cette action est IRRÉVERSIBLE !';
  
  return confirm(message);
}

// Fonction de toggle des sections
function toggleSection(header) {
  const section = header.closest('.section');
  const body = section.querySelector('.section-body');
  
  header.classList.toggle('collapsed');
  body.classList.toggle('collapsed');
  
  const sectionTitle = header.querySelector('.section-title').textContent.trim();
  const isCollapsed = body.classList.contains('collapsed');
  localStorage.setItem(`section-${sectionTitle}`, isCollapsed ? 'collapsed' : 'expanded');
}

// ========================================
// SYSTÈME DE NOTIFICATIONS TOAST
// ========================================
function showToast(message, type = 'info', duration = 5000) {
  const container = document.getElementById('toast-container');
  if (!container) return;
  
  // Créer le toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  // Icône selon le type
  let icon = '';
  switch(type) {
    case 'success':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m5 12 4 4 10-10"/></svg>';
      break;
    case 'error':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6m0-6 6 6"/></svg>';
      break;
    case 'warning':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4m0 4h0M12 3l9 18H3L12 3z"/></svg>';
      break;
    case 'info':
    default:
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h0"/></svg>';
      break;
  }
  
  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-content">${message}</div>
    <button class="toast-close" onclick="dismissToast(this)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6 6 18M6 6l12 12"/>
      </svg>
    </button>
  `;
  
  container.appendChild(toast);
  
  // Auto-dismiss
  setTimeout(() => {
    dismissToast(toast.querySelector('.toast-close'));
  }, duration);
}

function dismissToast(button) {
  const toast = button.closest('.toast');
  if (!toast) return;
  
  toast.classList.add('hiding');
  setTimeout(() => {
    toast.remove();
  }, 300);
}

// Afficher les messages Django au chargement
window.addEventListener('DOMContentLoaded', function() {
  const messagesContainer = document.getElementById('django-messages');
  if (messagesContainer) {
    const messages = messagesContainer.querySelectorAll('[data-message]');
    messages.forEach((msg, index) => {
      setTimeout(() => {
        const type = msg.dataset.type || 'info';
        const message = msg.dataset.message;
        showToast(message, type);
      }, index * 200); // Délai entre chaque toast
    });
  }
});

// ========================================
// INITIALISATION AU CHARGEMENT DE LA PAGE
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  
  // Fonctions utilitaires
  function getNowFormatted() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
  }

  function getTodayDate() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate());
  }

  function formatMontant(montant) {
    return new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2}).format(montant) + ' €';
  }

  // Gestion du statut du devis
  const devisCreeSelect = document.getElementById('devis-cree');
  const devisDetails = document.getElementById('devis-details');
  const noDevisAlert = document.getElementById('no-devis-alert');
  const devisStatutSelect = document.getElementById('devis-statut');

  function updateDevisDisplay() {
    const isCreated = devisCreeSelect.value === 'oui';
    
    if (devisDetails) {
      if (isCreated) {
        devisDetails.classList.remove('hidden');
        devisDetails.style.display = 'block';
      } else {
        devisDetails.classList.add('hidden');
        devisDetails.style.display = 'none';
      }
    }
    
    if (noDevisAlert) {
      noDevisAlert.style.display = isCreated ? 'none' : 'flex';
    }
    
    if (isCreated && devisStatutSelect) {
      updateDevisAlerts();
    } else {
      hideAllDevisAlerts();
    }
  }

  function updateDevisAlerts() {
    if (!devisStatutSelect) return;
    
    const statut = devisStatutSelect.value;
    
    const alerts = {
      'devis-accepte-alert': statut === 'accepte',
      'devis-refuse-alert': statut === 'refuse',
      'devis-attente-alert': false,
      'devis-relance-alert': statut === 'relance'
    };
    
    Object.keys(alerts).forEach(alertId => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.display = alerts[alertId] ? 'flex' : 'none';
      }
    });
  }

  function hideAllDevisAlerts() {
    ['devis-accepte-alert', 'devis-refuse-alert', 'devis-attente-alert', 'devis-relance-alert'].forEach(alertId => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.display = 'none';
      }
    });
  }

  if (devisCreeSelect) {
    devisCreeSelect.addEventListener('change', updateDevisDisplay);
    updateDevisDisplay();
  }

  if (devisStatutSelect) {
    devisStatutSelect.addEventListener('change', updateDevisAlerts);
    if (devisCreeSelect && devisCreeSelect.value === 'oui') {
      updateDevisAlerts();
    }
  }

  // Gestion de la planification
// Gestion de la planification
const planificationType = document.getElementById('planification-type');
const planningSection = document.getElementById('planning-section');
const replanifierSection = document.getElementById('replanifier-section');  // ✅ NOUVEAU
const dejaRealiseSection = document.getElementById('deja-realise-section');
const planningDate = document.getElementById('planning-date');
const realisationDate = document.getElementById('realisation-date');
const datePasseeAlert = document.getElementById('date-passee-alert');

function updatePlanningDisplay() {
  if (!planificationType) return;
  
  const type = planificationType.value;
  
  // Cacher toutes les sections
  if (planningSection) planningSection.style.display = 'none';
  if (replanifierSection) replanifierSection.style.display = 'none';
  if (dejaRealiseSection) dejaRealiseSection.style.display = 'none';
  
  if (type === 'a_planifier') {
    // Mode "À planifier"
    if (planningSection) planningSection.style.display = 'block';
    checkDatePassee();
    
  } else if (type === 'replanifier') {
    // Mode "Replanifier"
    if (replanifierSection) replanifierSection.style.display = 'block';
    const replanificationDate = document.getElementById('replanification-date');
    
    // Si pas de date, proposer demain à 9h00
    if (replanificationDate && !replanificationDate.value) {
      const demain = new Date();
      demain.setDate(demain.getDate() + 1);
      demain.setHours(9, 0, 0, 0);
      const pad = n => String(n).padStart(2, '0');
      replanificationDate.value = demain.getFullYear() + '-' + 
                                   pad(demain.getMonth() + 1) + '-' + 
                                   pad(demain.getDate()) + 'T09:00';
    }
    
  } else {
    // Mode "Déjà réalisée"
    if (dejaRealiseSection) dejaRealiseSection.style.display = 'block';
    
    // ✅ Pré-remplir intelligemment
    if (realisationDate && !realisationDate.value) {
      const datePlanifiee = planningDate ? planningDate.value : null;
      realisationDate.value = datePlanifiee || getNowFormatted();
    }
  }
}

  function checkDatePassee() {
    if (!planningDate || !datePasseeAlert) return;
    
    if (planningDate.value) {
      const dateSelectionnee = new Date(planningDate.value);
      const maintenant = new Date();
      
      if (dateSelectionnee < maintenant) {
        datePasseeAlert.style.display = 'flex';
      } else {
        datePasseeAlert.style.display = 'none';
      }
    } else {
      datePasseeAlert.style.display = 'none';
    }
  }

  if (planificationType) {
    planificationType.addEventListener('change', updatePlanningDisplay);
    updatePlanningDisplay();
  }

  if (planningDate) {
    planningDate.addEventListener('change', checkDatePassee);
    checkDatePassee();
  }

  // Gestion des commentaires
  const commentairesTextarea = document.getElementById('commentaires-textarea');
  const commentairesForm = document.getElementById('commentaires-form');
  let originalCommentaires = commentairesTextarea ? commentairesTextarea.value : '';

  window.resetCommentaires = function() {
    if (commentairesTextarea) {
      commentairesTextarea.value = originalCommentaires;
    }
  }

  if (commentairesForm) {
    commentairesForm.addEventListener('submit', function() {
      originalCommentaires = commentairesTextarea.value;
    });
  }

  // Gestion date de réponse
  const dateEnvoiInput = document.getElementById('devis-date-envoi');
  const dateReponseInput = document.getElementById('devis-date-reponse');
  const dateReponseCard = document.getElementById('date-reponse-card');
  const delaiReponseInfo = document.getElementById('delai-reponse-info');
  const delaiReponseText = document.getElementById('delai-reponse-text');

  function updateDateReponseVisibility() {
    if (!devisStatutSelect || !dateReponseCard) return;
    const statut = devisStatutSelect.value;
    const shouldShow = statut === 'accepte' || statut === 'refuse';
    dateReponseCard.style.display = shouldShow ? 'block' : 'none';
    if (shouldShow) calculateDelai();
    else if (delaiReponseInfo) delaiReponseInfo.style.display = 'none';
  }

  function calculateDelai() {
    if (!dateEnvoiInput || !dateReponseInput || !delaiReponseInfo || !delaiReponseText) return;
    
    const dateEnvoi = dateEnvoiInput.value;
    const dateReponse = dateReponseInput.value;
    
    if (dateEnvoi && dateReponse) {
      const d1 = new Date(dateEnvoi);
      const d2 = new Date(dateReponse);
      const diffDays = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
      
      if (diffDays >= 0) {
        let message = `<strong>Délai de réponse : ${diffDays} jour${diffDays > 1 ? 's' : ''}</strong>`;
        delaiReponseText.innerHTML = message;
        delaiReponseInfo.style.display = 'flex';
      } else {
        delaiReponseInfo.style.display = 'none';
      }
    } else {
      delaiReponseInfo.style.display = 'none';
    }
  }

  if (devisStatutSelect) {
    const originalChange = devisStatutSelect.onchange;
    devisStatutSelect.addEventListener('change', function() {
      if (originalChange) originalChange.call(this);
      updateDateReponseVisibility();
    });
    updateDateReponseVisibility();
  }

  if (dateEnvoiInput) dateEnvoiInput.addEventListener('change', calculateDelai);
  if (dateReponseInput) dateReponseInput.addEventListener('change', calculateDelai);

// Gestion mode paiement
const modePaiementSelect = document.getElementById('mode-paiement-select');
const comptantSection = document.getElementById('comptant-section');
const echelonneSection = document.getElementById('echelonne-section');
const datePaiementComptant = document.getElementById('date-paiement-comptant');

if (modePaiementSelect) {
  modePaiementSelect.addEventListener('change', function() {
    const mode = this.value;
    
    if (comptantSection) comptantSection.style.display = 'none';
    if (echelonneSection) echelonneSection.style.display = 'none';
    
    if (mode === 'comptant' && comptantSection) {
      comptantSection.style.display = 'block';
      // ✅ CORRECTION : Ne remplir la date QUE si le champ est vide
      if (datePaiementComptant && !datePaiementComptant.value) {
        datePaiementComptant.value = getTodayDate();
      }
    } else if (mode === 'echelonne' && echelonneSection) {
      // ✅ AJOUT : espace entre } et else
      echelonneSection.style.display = 'block';
    }
  });
  
  // Initialisation au chargement
  if (modePaiementSelect.value) {
    modePaiementSelect.dispatchEvent(new Event('change'));
  }
}

  // Initialisation des dates
  const devisDateEnvoi = document.getElementById('devis-date-envoi');
  if (devisDateEnvoi && !devisDateEnvoi.value) {
    devisDateEnvoi.value = getTodayDate();
  }

  // Gestion des sections repliables
  const statut = '{{ operation.statut }}';
  const operationId = '{{ operation.id }}';
  const storageKey = `operation-${operationId}-sections-initialized`;
  const isFirstVisit = !localStorage.getItem(storageKey);
  
  const sections = document.querySelectorAll('.section');
  let sectionToScrollTo = null;
  
  sections.forEach((section) => {
    const header = section.querySelector('.section-header');
    const body = section.querySelector('.section-body');
    
    if (!header || !body) return;
    
    const titleElement = header.querySelector('.section-title');
    if (!titleElement) return;
    
    const title = titleElement.textContent.trim();
    const savedState = localStorage.getItem(`section-${title}`);
    
    if (savedState && !isFirstVisit) {
      if (savedState === 'collapsed') {
        header.classList.add('collapsed');
        body.classList.add('collapsed');
      }
    } else {
      header.classList.add('collapsed');
      body.classList.add('collapsed');
      
      let shouldOpen = false;
      
      switch(statut) {
        case 'en_attente_devis':
          shouldOpen = title.includes('Statut du devis');
          break;
        case 'a_planifier':
          shouldOpen = title.includes('Devis / Opération - Lignes') || title.includes('Planification');
          break;
        case 'planifie':
          shouldOpen = title.includes('Planification');
          break;
        case 'realise':
          shouldOpen = title.includes('Paiement');
          break;
        case 'paye':
          shouldOpen = title.includes('Paiement');
          break;
        case 'devis_refuse':
          shouldOpen = title.includes('Statut du devis');
          break;
        default:
          shouldOpen = title.includes('Informations générales');
      }
      
      if (shouldOpen) {
        header.classList.remove('collapsed');
        body.classList.remove('collapsed');
        if (!sectionToScrollTo) {
          sectionToScrollTo = section;
        }
      }
    }
  });
  
  if (isFirstVisit) {
    localStorage.setItem(storageKey, 'true');
  }



  // Détection Safari et ajout de placeholders
if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) {
  document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
    input.placeholder = "JJ/MM/AAAA HH:MM";
    input.style.minWidth = "200px";
  });
}

  console.log('✅ JavaScript CRM Artisans initialisé');
});
</script>
</body>
</html>