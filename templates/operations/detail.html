<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ operation.id_operation }} - {{ operation.type_prestation }} ‚Äì CRM Artisans</title>
    {% load static %}
  <link rel="icon" type="image/png" href="/static/core/image/favicon.png">
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
      --ring: rgba(99,102,241,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: var(--bg);
      color: var(--text); 
      line-height: 1.6; 
      padding-bottom:3rem;
    }

    /* ========================================
       EN-T√äTE MODERNE (DASHBOARD STYLE)
       ======================================== */
    .header{ 
      position: sticky; 
      top: 0; 
      z-index: 40;
      backdrop-filter: saturate(180%) blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .header-inner{ 
      max-width:1280px; 
      margin:0 auto; 
      padding:.85rem 1rem; 
      display:flex; 
      align-items:center; 
      gap:1rem; 
      justify-content:space-between;
    }
    .brand{ 
      display:flex; 
      align-items:center; 
      gap:.75rem; 
      font-weight:700; 
      letter-spacing:.2px; 
      color: var(--text); 
    }
    .logo{ 
      width:34px; 
      height:34px; 
      border-radius:10px; 
      background:linear-gradient(145deg, var(--primary), var(--accent)); 
      box-shadow: var(--shadow); 
      display:grid; 
      place-items:center;
    }
    .logo svg{ width:18px; height:18px; color:white }

    .nav{ 
      display: flex; 
      gap: .25rem; 
      align-items: center;
    }
    .nav a{ 
      text-decoration: none; 
      color: var(--muted); 
      padding: .55rem .8rem; 
      border-radius: 10px; 
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }
    .nav a:hover{ 
      color: var(--text); 
      background: rgba(148,163,184,.08); 
      border-color: var(--border);
    }
    .nav a.active{ 
      color: white; 
      background: rgba(99,102,241,.18); 
      border-color: rgba(99,102,241,.35); 
      box-shadow: 0 0 0 2px var(--ring);
    }

    .user{ 
      display: flex; 
      align-items: center; 
      gap: .75rem; 
      color: var(--muted); 
      font-size: .95rem;
    }
    .user form button{ 
      background: none; 
      border: none; 
      color: var(--muted); 
      cursor: pointer; 
      text-decoration: underline; 
      font: inherit; 
      padding: 0;
    }
    .user form button:hover{ color: var(--text); }

    /* ========================================
       RESTE DU STYLE
       ======================================== */
    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    
    h1{ font-size:1.8rem; font-weight:800; margin-bottom:.5rem; color: var(--text); }
    .breadcrumb{ color:var(--muted); font-size:.9rem; margin-bottom:1rem }
    .breadcrumb a{ color:var(--muted); text-decoration:none }
    .breadcrumb a:hover{ color:var(--text) }

    .status-badge{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; 
      border-radius:20px; font-size:.85rem; font-weight:600; border:1px solid;
    }
    .status-badge::before{ content:''; width:8px; height:8px; border-radius:50%; background:currentColor }
    .status-badge.en_attente_devis{ color:#f59e0b; background: rgba(245,158,11,.1); border-color: rgba(245,158,11,.3); }
    .status-badge.a_planifier{ color:#3b82f6; background: rgba(59,130,246,.1); border-color: rgba(59,130,246,.3); }
    .status-badge.planifie{ color:#8b5cf6; background: rgba(139,92,246,.1); border-color: rgba(139,92,246,.3); }
    .status-badge.realise{ color:#22c55e; background: rgba(34,197,94,.1); border-color: rgba(34,197,94,.3); }
    .status-badge.paye{ color:#10b981; background: rgba(16,185,129,.1); border-color: rgba(16,185,129,.3); }
    .status-badge.devis_refuse{ color:#ef4444; background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.3); }
    
    .section{ 
      background: white;
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:1.5rem; 
      box-shadow: var(--shadow); 
      margin-bottom:1.5rem 
    }
    .section-header{ 
      display:flex; align-items:center; justify-content:space-between; gap:1rem; 
      padding-bottom:1rem; border-bottom:1px solid var(--border); margin-bottom:1rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }
    .section-header:hover {
      background: rgba(148,163,184,.03);
      border-radius: 8px;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700; color: var(--text); }

    /* ========================================
       SECTIONS REPLIABLES (ACCORD√âON)
       ======================================== */
    .section-header .toggle-icon {
      transition: transform 0.3s ease;
      color: var(--muted);
      flex-shrink: 0;
    }

    .section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .section-body {
      max-height: 5000px;
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
      opacity: 1;
    }

    .section-body.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    /* Badge indicateur sur les sections */
    .section-badge {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .2rem .5rem;
      border-radius: 12px;
      font-size: .75rem;
      font-weight: 600;
      margin-left: .5rem;
    }

    .section-badge.complete {
      background: rgba(34,197,94,.1);
      color: var(--success);
      border: 1px solid rgba(34,197,94,.2);
    }

    .section-badge.pending {
      background: rgba(245,158,11,.1);
      color: var(--warning);
      border: 1px solid rgba(245,158,11,.2);
    }

    .section-badge.disabled {
      background: rgba(148,163,184,.1);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,.2);
    }

    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem }
    .info-card{
      background: #f8fafc;
      border:1px solid var(--border); 
      border-radius:10px; 
      padding:1rem; 
      transition: all 0.2s ease;
    }
    .info-card:hover{ background: #f1f5f9; border-color: #cbd5e1; }
    .info-card .label{
      display:flex; align-items:center; gap:.5rem; color:var(--muted); 
      font-size:.85rem; font-weight:600; text-transform:uppercase; 
      letter-spacing:.05rem; margin-bottom:.75rem
    }
    .info-card .value{ color: var(--text); font-weight: 600; font-size: 1rem; line-height: 1.4 }

    .input, .select{ 
      width:100%; padding:.65rem .8rem; border-radius:8px; border:1px solid var(--border); 
      background: white; color: var(--text); font:inherit 
    }
    .input:focus, .select:focus{ 
      outline:none; 
      box-shadow: 0 0 0 3px rgba(99,102,241,.1); 
      border-color: var(--primary);
    }

    .btn{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; 
      border-radius:8px; border:1px solid var(--border); 
      background:white; color:var(--text); cursor:pointer; font:inherit; text-decoration:none;
      transition: all 0.2s;
    }
    .btn:hover{ background:#f8fafc; border-color: #cbd5e1; }
    .btn.success{ background:var(--success); border-color: var(--success); color: white; }
    .btn.success:hover{ background:#16a34a; }
    .btn.primary{ background:var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover{ background:#4f46e5; }
    .btn.danger{ background: var(--danger); border-color: var(--danger); color: white; }
    .btn.danger:hover{ background:#dc2626; }
    .btn.sm{ padding:.4rem .6rem; border-radius:6px; font-size:.9rem }

    .alert{ 
      padding:.75rem 1rem; border-radius:8px; margin-top:1rem; 
      display:flex; align-items:center; gap:.5rem; font-size:.9rem;
    }
    .alert.warning{ background: #fef3c7; color: #92400e; border:1px solid #fde68a; }
    .alert.danger, .alert.error{ background: #fee2e2; color: #991b1b; border:1px solid #fecaca; }
    .alert.success{ background: #d1fae5; color: #065f46; border:1px solid #a7f3d0; }
    .alert.info{ background: #dbeafe; color: #1e40af; border:1px solid #bfdbfe; }

    .radio-option{ 
      display:flex; align-items:center; gap:.5rem; padding:.6rem 1rem; 
      border:2px solid var(--border); border-radius:8px; cursor:pointer; 
      transition: all .2s; margin-bottom:.5rem; background: white;
    }
    .radio-option:hover{ border-color:var(--primary); background:#f8fafc; }
    .radio-option.selected{ border-color:var(--primary); background:#eef2ff; box-shadow: 0 0 0 3px rgba(99,102,241,.1); }
    .radio-option input[type="radio"]{ width:auto; margin:0; cursor:pointer }
    .radio-option label{ margin:0; cursor:pointer; font-weight:500; flex:1 }

    .payment-box{ background: #f8fafc; border:1px solid var(--border); border-radius:10px; padding:1rem; margin-top:1rem }

    .table-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--border); margin-top:1rem; background: white; }
    table{ width:100%; border-collapse: collapse }
    thead th{ 
      background: #f8fafc; color:var(--muted); text-transform:uppercase; letter-spacing:.08rem; 
      font-size:.75rem; text-align:left; padding:.9rem .85rem; border-bottom:1px solid var(--border)
    }
    tbody td{ padding:.9rem .85rem; border-bottom:1px solid var(--border); }
    tbody tr:hover{ background: #f8fafc; }
    .echeance-row{ background: #f0fdf4; }
    .reste-row{ background: #fef3c7; font-weight:700; color:#92400e; }
    .total-row{ background: #eef2ff; font-weight:700; }

    .workflow-steps{
      display:flex; align-items:center; gap:.5rem; margin-top:1rem; padding:1rem; 
      background:white; border-radius:10px; flex-wrap:wrap; border:1px solid var(--border);
    }
    .workflow-step{
      padding:.4rem .8rem; background:#f1f5f9; 
      border-radius:6px; font-size:.8rem; color:var(--muted); font-weight:600;
    }
    .workflow-step.active{ background:var(--primary); color:white; }
    .workflow-arrow{ color:var(--muted); font-weight:bold }

    .main-content{ 
      display: grid; 
      grid-template-columns: 2fr 1fr; 
      gap: 2rem; 
      align-items: start; /* ‚Üê AJOUTEZ CETTE LIGNE */
    }
    .hidden { display: none !important; }

    /* ========================================
   NOTIFICATIONS TOAST
   ======================================== */
.toast-container {
  position: fixed;
  top: 80px; /* ‚Üê Chang√© de 20px √† 80px pour √™tre sous le header */
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
  align-items: center;
}

.toast {
  min-width: 320px;
  max-width: 420px;
  padding: 1rem 1.25rem;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,.15), 0 4px 12px rgba(0,0,0,.1);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  pointer-events: auto;
  animation: slideInRight 0.3s ease-out;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,.2);
}

.toast.hiding {
  animation: slideOutRight 0.3s ease-in forwards;
}

@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

.toast-icon {
  flex-shrink: 0;
  width: 24px;
  height: 24px;
}

.toast-content {
  flex: 1;
  font-size: 0.95rem;
  line-height: 1.5;
}

.toast-close {
  flex-shrink: 0;
  width: 20px;
  height: 20px;
  border: none;
  background: none;
  cursor: pointer;
  opacity: 0.6;
  transition: opacity 0.2s;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast-close:hover {
  opacity: 1;
}

/* Types de toast */
.toast.success {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
  color: white;
}

.toast.error {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
  color: white;
}

.toast.warning {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
  color: white;
}

.toast.info {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
  color: white;
}

/* Responsive */
@media (max-width: 640px) {
  .toast-container {
    top: 70px;
    right: 10px;
    left: 10px;
  }
  
  .toast {
    min-width: auto;
    max-width: none;
  }
}

/* ========================================
   SECTION COMMENTAIRES STICKY
   ======================================== */
.sticky-notes {
  position: -webkit-sticky !important; /* Safari */
  position: sticky !important;
  top: 90px !important;
  align-self: flex-start !important; /* Plus compatible que 'start' */
  max-height: calc(100vh - 110px);
  overflow-y: auto;
}

/* ========================================
   FIX CRITIQUE POUR LE STICKY
   ======================================== */
.sticky-notes.section {
  overflow: visible !important; /* Emp√™che overflow:hidden de casser le sticky */
}

.sticky-notes .section-body {
  overflow: visible !important; /* Idem pour le body */
}

/* Force le comportement sticky sur la colonne droite */
.right-column {
  position: relative;
  z-index: 1;
}

.notes-textarea {
  width: 100%;
  min-height: 150px;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  color: var(--text);
  font-family: inherit;
  font-size: 0.95rem;
  resize: vertical;
  transition: all 0.2s ease;
}

.notes-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99,102,241,.1);
}

.notes-textarea::placeholder {
  color: var(--muted);
  opacity: 0.6;
}

.notes-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.75rem;
  justify-content: flex-end;
}

/* Responsive : d√©sactiver sticky sur mobile */
@media (max-width: 1024px) {
  .sticky-notes {
    position: static !important;
    max-height: none;
  }
}

    @media (max-width: 1024px){ 
      .main-content{ grid-template-columns: 1fr }
      .nav{ flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>manay</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}">Accueil</a>
        <a href="{% url 'operations' %}" class="active">Op√©rations</a>
        <a href="{% url 'clients' %}">Clients</a>
        <a href="{% url 'profil' %}">Profil</a>
      </nav>
      <div class="user">
        <span>{{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit">D√©connexion</button>
        </form>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'dashboard' %}">Accueil</a> / 
      <a href="{% url 'operations' %}">Op√©rations</a> / 
      {{ operation.id_operation }}
    </div>

    
{% if messages %}
<div id="django-messages" style="display:none">
  {% for message in messages %}
  <div data-type="{{ message.tags }}" data-message="{{ message }}"></div>
  {% endfor %}
</div>
{% endif %}



    <!-- ‚úÖ NOUVEAU : En-t√™te avec bouton de suppression -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; flex-wrap:wrap">
      <div>
        <h1>{{ operation.id_operation }} - {{ operation.type_prestation }}</h1>
        <span class="status-badge {{ operation.statut }}">{{ operation.get_statut_display }}</span>
      </div>
      
      <form method="POST" action="{% url 'operation_delete' operation.id %}" onsubmit="return confirmDeleteOperation()" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="force_delete" value="true">
        <button type="submit" class="btn danger" title="Supprimer l'op√©ration">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M9 7v12m6-12v12M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13M9 7l1-3h4l1 3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
          Supprimer l'op√©ration
        </button>
      </form>
    </div>

    <div class="workflow-steps">
      <div class="workflow-step {% if operation.statut == 'en_attente_devis' %}active{% endif %}">Devis</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'a_planifier' %}active{% endif %}">√Ä planifier</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'planifie' %}active{% endif %}">Planifi√©</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'realise' %}active{% endif %}">R√©alis√©</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'paye' %}active{% endif %}">Pay√©</div>
    </div>

    <div class="main-content">
      <div class="left-column">
    <!-- ========================================
        INFORMATIONS G√âN√âRALES
        ======================================== -->
    <section class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
          Informations g√©n√©rales
          <span class="section-badge complete">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
            Compl√©t√©
          </span>
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="section-body">
        <div class="info-grid">
          <div class="info-card">
            <div class="label">Client</div>
            <div class="value">
              <strong>{{ operation.client.nom }} {{ operation.client.prenom }}</strong><br>
              <a href="{% url 'client_detail' client_id=operation.client.id %}" style="color:var(--primary); text-decoration:none">Voir le profil</a>
            </div>
          </div>
          <div class="info-card">
            <div class="label">Type de prestation</div>
            <div class="value">{{ operation.type_prestation }}</div>
          </div>
          <div class="info-card">
            <div class="label">Adresse</div>
            <div class="value">{{ operation.adresse_intervention }}</div>
          </div>
          <div class="info-card">
            <div class="label">Contact</div>
            <div class="value">
              <a href="tel:{{ operation.client.telephone }}" style="color:var(--primary); text-decoration:none">
                {{ operation.client.telephone }}
              </a>
              {% if operation.client.email %}
              <br><a href="mailto:{{ operation.client.email }}" style="color:var(--primary); text-decoration:none">
                {{ operation.client.email }}
              </a>
              {% endif %}
            </div>
          </div>
        </div>



      </div>
    </section>

    
  <!-- ========================================
      SECTION DEVIS - VERSION MULTI-DEVIS CONDENS√âE
      ======================================== -->
  {% if operation.avec_devis %}
  <section class="section" id="section-devis">
    <div class="section-header" onclick="toggleSection(this)">
      <h2 class="section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" stroke="currentColor" stroke-width="1.6"/></svg>
        üìã Devis
        
        {% if nombre_devis > 0 %}
        <span class="section-badge complete">{{ nombre_devis }} devis</span>
        {% else %}
        <span class="section-badge pending">Aucun devis</span>
        {% endif %}
      </h2>
      <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    
    <div class="section-body">
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          BOUCLE SUR TOUS LES DEVIS
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      {% for devis in devis_list %}
      <div class="devis-card" style="border: 2px solid {% if devis.statut == 'accepte' %}var(--success){% elif devis.statut == 'refuse' %}var(--danger){% elif devis.statut == 'envoye' %}var(--primary){% else %}var(--border){% endif %}; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; background: white;">
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            EN-T√äTE DU DEVIS (toujours visible, cliquable)
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="devis-header" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; cursor: pointer; padding-bottom: 1rem; border-bottom: 1px solid var(--border);" onclick="toggleDevis({{ devis.id }})">
          <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
            <h3 style="margin: 0; color: var(--text); font-size: 1.1rem; font-weight: 700;">
              Devis {{ devis.version }} - {{ devis.numero_devis }}
            </h3>
            
            <!-- Badge statut -->
            {% if devis.statut == 'brouillon' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(148,163,184,.1); color: var(--muted); border: 1px solid rgba(148,163,184,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              üìù Brouillon
            </span>

            {% elif devis.statut == 'pret' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(59,130,246,.1); color: #3b82f6; border: 1px solid rgba(59,130,246,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              üìÑ Pr√™t (√† envoyer)
            </span>
            
            {% elif devis.statut == 'envoye' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(249,115,22,.1); color: #f97316; border: 1px solid rgba(249,115,22,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              {% if devis.est_expire %}
              ‚ö†Ô∏è Expir√©
              {% else %}
              üì§ Envoy√© (en attente)
              {% endif %}
            </span>
            
            {% elif devis.statut == 'accepte' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(34,197,94,.1); color: var(--success); border: 1px solid rgba(34,197,94,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              ‚úÖ Accept√©
            </span>
            
            {% elif devis.statut == 'refuse' %}
            <span style="padding: 0.3rem 0.75rem; background: rgba(239,68,68,.1); color: var(--danger); border: 1px solid rgba(239,68,68,.2); border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
              ‚ùå Refus√©
            </span>
            {% endif %}
          </div>
          
          <div style="display: flex; align-items: center; gap: 1rem;">
            <span style="font-size: 1.2rem; font-weight: 700; color: var(--primary);">
              {{ devis.total_ttc|floatformat:2 }} ‚Ç¨ TTC
            </span>
            <svg class="toggle-devis-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" style="transition: transform 0.3s ease; color: var(--muted);">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            CORPS DU DEVIS (repliable)
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="devis-body" id="devis-body-{{ devis.id }}" style="max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.4s ease, opacity 0.3s ease, padding-top 0.3s ease;">
          
          <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              LIGNES DU DEVIS (version compacte)
              ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <!-- ‚úÖ CONTAINER TOUJOURS PR√âSENT (m√™me si vide) -->
          <div style="margin-top: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">Lignes du devis</h4>
            
            <!-- ‚úÖ Container des lignes (TOUJOURS cr√©√©) -->
            <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;" id="lignes-container-{{ devis.id }}">
              
              {% if devis.lignes_list %}
                <!-- Lignes existantes -->
                {% for ligne in devis.lignes_list %}
                <div style="display: grid; grid-template-columns: 1fr 80px 100px 120px 80px 120px 40px; gap: 0.75rem; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border); background: {% cycle 'white' '#f9fafb' %};">
                  <div style="font-size: 0.9rem; color: var(--text);">{{ ligne.description }}</div>
                  <div style="text-align: center; font-size: 0.85rem;">{{ ligne.quantite|floatformat:"-2" }} {{ ligne.get_unite_display }}</div>
                  <div style="text-align: right; font-weight: 600; font-size: 0.85rem;">{{ ligne.prix_unitaire_ht|floatformat:2 }} ‚Ç¨</div>
                  <div style="text-align: center; font-size: 0.85rem;">TVA {{ ligne.taux_tva|floatformat:0 }}%</div>
                  <div style="text-align: right; font-weight: 600; font-size: 0.9rem; color: var(--primary);">{{ ligne.montant|floatformat:2 }} ‚Ç¨</div>
                  
                  {% if devis.statut == 'brouillon' %}
                    <form 
                      class="form-delete-ligne-ajax" 
                      data-ligne-id="{{ ligne.id }}"
                      data-devis-id="{{ devis.id }}"
                      data-operation-id="{{ operation.id }}"
                      style="display:inline; margin: 0;">
                      {% csrf_token %}
                      <button type="submit" class="btn danger sm" style="padding: 0.3rem 0.6rem; font-size: 0.85rem; margin: 0;">√ó</button>
                    </form>
                  {% else %}
                    <div></div>
                  {% endif %}
                </div>
                {% endfor %}
              {% else %}
                <!-- ‚úÖ Message si aucune ligne -->
                <div style="padding: 2rem; text-align: center; color: var(--muted); font-size: 0.9rem;">
                  üìù Aucune ligne ajout√©e pour le moment
                </div>
              {% endif %}
              
              <!-- ‚úÖ Totaux (TOUJOURS pr√©sents) -->
              <div style="background: #f8fafc; padding: 1rem; border-top: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span style="font-weight: 600; font-size: 0.9rem;">Sous-total HT</span>
                  <span class="sous-total-ht" style="font-weight: 700; font-size: 1rem;">{{ devis.sous_total_ht|floatformat:2 }} ‚Ç¨</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span style="font-weight: 600; font-size: 0.9rem; color: var(--muted);">TVA</span>
                  <span class="total-tva" style="font-weight: 600; font-size: 0.9rem; color: var(--muted);">{{ devis.total_tva|floatformat:2 }} ‚Ç¨</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 2px solid var(--primary);">
                  <span style="font-weight: 700; font-size: 1.1rem;">TOTAL TTC</span>
                  <span class="total-ttc" style="font-weight: 700; font-size: 1.3rem; color: var(--primary);">{{ devis.total_ttc|floatformat:2 }} ‚Ç¨</span>
                </div>
              </div>
            </div>
            
            <!-- Notes du devis (si pr√©sentes) -->
            {% if devis.notes %}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border);">
              <strong style="font-size: 0.85rem; color: var(--muted);">üìù Notes :</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text); font-size: 0.9rem;">{{ devis.notes }}</p>
            </div>
            {% endif %}
          </div>

          <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              FORMULAIRE AJOUT LIGNE (inline compact)
              ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          {% if devis.statut == 'brouillon' %}
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px dashed var(--border);">
            <h5 style="margin: 0 0 0.75rem 0; color: var(--text); font-size: 0.9rem; font-weight: 600;">+ Ajouter une ligne</h5>
            <form 
              class="form-add-ligne-ajax"
              data-devis-id="{{ devis.id }}"
              data-operation-id="{{ operation.id }}"
              style="display: grid; grid-template-columns: 2fr 80px 120px 120px 100px 80px; gap: 0.5rem; align-items: end;">
              
              {% csrf_token %}
              
              <input type="text" name="description" class="input input-description" placeholder="Description" style="margin: 0; font-size: 0.9rem;" required>
              <input type="number" name="quantite" class="input" value="1" step="0.01" min="0.01" style="margin: 0; text-align: center; font-size: 0.9rem;" required>
              <select name="unite" class="select" style="margin: 0; font-size: 0.85rem;">
                <option value="forfait" selected>Forfait</option>
                <option value="unite">Unit√©</option>
                <option value="heure">Heure</option>
                <option value="jour">Jour</option>
                <option value="m2">m¬≤</option>
                <option value="ml">ML</option>
              </select>
              <input type="number" name="prix_unitaire_ht" class="input" placeholder="Prix HT" step="0.01" min="0.01" style="margin: 0; text-align: right; font-size: 0.9rem;" required>
              <input type="number" name="taux_tva" class="input" value="10" step="0.01" min="0" style="margin: 0; text-align: center; font-size: 0.9rem;" required>
              <button type="submit" class="btn success btn-add-ligne" style="margin: 0; padding: 0.5rem; font-size: 0.9rem;">+ Ajouter</button>
            </form>
          </div>
          {% endif %}

          {% if devis.statut == 'brouillon' %}
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              NOTES, VALIDIT√â ET ACTIONS (TOUT INT√âGR√â)
              ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px dashed var(--border);">
            
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="generer_pdf_devis">
              <input type="hidden" name="devis_id" value="{{ devis.id }}">

              <!-- ‚úÖ NOUVEAU : Champs cach√©s pour la ligne optionnelle -->
              <input type="hidden" name="ligne_description" id="hidden-ligne-description-{{ devis.id }}">
              <input type="hidden" name="ligne_quantite" id="hidden-ligne-quantite-{{ devis.id }}">
              <input type="hidden" name="ligne_unite" id="hidden-ligne-unite-{{ devis.id }}">
              <input type="hidden" name="ligne_prix_ht" id="hidden-ligne-prix-ht-{{ devis.id }}">
              <input type="hidden" name="ligne_tva" id="hidden-ligne-tva-{{ devis.id }}">
              
              <!-- Notes et Validit√© -->
              <div style="display: grid; grid-template-columns: 2fr 150px; gap: 1rem; align-items: start; margin-bottom: 1rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--muted); font-size: 0.85rem; font-weight: 600;">üí¨ Notes (optionnel)</label>
                  <textarea name="notes" class="input" rows="2" placeholder="Conditions particuli√®res..." style="margin: 0; resize: vertical;">{{ devis.notes }}</textarea>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--muted); font-size: 0.85rem; font-weight: 600;">‚è≥ Validit√©</label>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="number" name="validite_jours" class="input" value="{{ devis.validite_jours }}" min="1" max="365" style="width: 80px; text-align: center; margin: 0;">
                    <span style="color: var(--muted); font-size: 0.85rem;">jours</span>
                  </div>
                </div>
              </div>
              
              <!-- Bouton principal -->
              <button type="submit" class="btn primary" style="width: 100%; padding: 0.75rem; margin-bottom: 0.5rem;">
                üìÑ Marquer comme pr√™t
              </button>
            </form>

            <script>
            // ‚úÖ Copier les valeurs des champs visibles vers les champs cach√©s avant soumission
            document.getElementById('form-marquer-pret-{{ devis.id }}').addEventListener('submit', function(e) {
              // Trouver les champs dans la m√™me section devis
              const devisBody = document.getElementById('devis-body-{{ devis.id }}');
              if (devisBody) {
                const notesField = devisBody.querySelector('textarea[name="notes"]');
                const validiteField = devisBody.querySelector('input[name="validite_jours"]');
                
                if (notesField) {
                  document.getElementById('hidden-notes-{{ devis.id }}').value = notesField.value;
                }
                if (validiteField) {
                  document.getElementById('hidden-validite-{{ devis.id }}').value = validiteField.value;
                }
              }
            });
            </script>
            
            <!-- Supprimer (formulaire s√©par√©) -->
            <form method="POST" onsubmit="return confirm('Supprimer ce devis brouillon ?')">
              {% csrf_token %}
              <input type="hidden" name="action" value="supprimer_devis">
              <input type="hidden" name="devis_id" value="{{ devis.id }}">
              <button type="submit" class="btn danger" style="width: 100%; padding: 0.75rem;">üóëÔ∏è Supprimer ce brouillon</button>
            </form>
          </div>
          {% endif %}

          <!-- ‚úÖ Script pour copier les valeurs avant soumission -->
          <script>
          document.addEventListener('DOMContentLoaded', function() {
            const devisId = {{ devis.id }};
            const devisBody = document.getElementById('devis-body-' + devisId);
            
            if (devisBody) {
              const form = devisBody.querySelector('form[action*="generer_pdf_devis"]') || 
                          devisBody.querySelector('input[value="generer_pdf_devis"]')?.closest('form');
              
              if (form) {
                form.addEventListener('submit', function(e) {
                  // R√©cup√©rer les champs de la ligne en cours de saisie (dans le formulaire d'ajout)
                  const ligneForm = devisBody.querySelector('.form-add-ligne-ajax');
                  
                  if (ligneForm) {
                    const description = ligneForm.querySelector('[name="description"]')?.value || '';
                    const quantite = ligneForm.querySelector('[name="quantite"]')?.value || '';
                    const unite = ligneForm.querySelector('[name="unite"]')?.value || '';
                    const prix_ht = ligneForm.querySelector('[name="prix_unitaire_ht"]')?.value || '';
                    const tva = ligneForm.querySelector('[name="taux_tva"]')?.value || '';
                    
                    // Copier dans les champs cach√©s
                    document.getElementById('hidden-ligne-description-' + devisId).value = description;
                    document.getElementById('hidden-ligne-quantite-' + devisId).value = quantite;
                    document.getElementById('hidden-ligne-unite-' + devisId).value = unite;
                    document.getElementById('hidden-ligne-prix-ht-' + devisId).value = prix_ht;
                    document.getElementById('hidden-ligne-tva-' + devisId).value = tva;
                  }
                });
              }
            }
          });
          </script>
          

          
          <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              ACTIONS SELON LE STATUT (SAUF BROUILLON)
              ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          {% if devis.statut != 'brouillon' %}
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
            
            {% if devis.statut == 'pret' %}
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                PR√äT : T√©l√©charger + Envoyer + Supprimer
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 1.5rem;">
              
              <!-- T√©l√©charger PDF -->
              <div style="margin-bottom: 1rem;">
                <a href="{% url 'telecharger_devis_pdf' devis.id %}" class="btn primary" style="width: 100%; text-decoration: none; text-align: center; padding: 0.75rem;">
                  üì• T√©l√©charger le PDF
                </a>
              </div>
              
              <!-- Enregistrer date d'envoi -->
              <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: #1e40af; font-size: 0.9rem; font-weight: 600;">
                  üìÖ Date d'envoi au client
                </label>
                <form method="POST" style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="enregistrer_date_envoi_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <input type="date" name="date_envoi" class="input" value="{{ now|date:'Y-m-d' }}" style="margin: 0;" required>
                  <button type="submit" class="btn success" style="margin: 0; white-space: nowrap;">‚úì Marquer comme envoy√©</button>
                </form>
                <small style="display: block; margin-top: 0.5rem; color: #1e40af; font-size: 0.8rem;">
                  ‚è≥ Validit√© : {{ devis.validite_jours }} jours
                </small>
              </div>
              
              <!-- Supprimer -->
              <form method="POST" onsubmit="return confirm('Supprimer ce devis ?')">
                {% csrf_token %}
                <input type="hidden" name="action" value="supprimer_devis">
                <input type="hidden" name="devis_id" value="{{ devis.id }}">
                <button type="submit" class="btn danger" style="width: 100%; padding: 0.75rem;">
                  üóëÔ∏è Supprimer ce devis
                </button>
              </form>
            </div>

            
            {% elif devis.statut == 'envoye' %}
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ENVOY√â : Workflow 3 √©tapes (compact)
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 10px; padding: 1.5rem;">
              
              <!-- √âtape 1 : T√©l√©charger PDF -->
              <div style="margin-bottom: 1rem;">
                <a href="{% url 'telecharger_devis_pdf' devis.id %}" class="btn primary" style="width: 100%; text-decoration: none; text-align: center; padding: 0.75rem;">
                  üì• T√©l√©charger le PDF
                </a>
              </div>
              
              <!-- √âtape 2 : Date d'envoi -->
              {% if not devis.date_envoi %}
              <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: #1e40af; font-size: 0.9rem; font-weight: 600;">
                  üìÖ Date d'envoi au client
                </label>
                <form method="POST" style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="enregistrer_date_envoi_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <input type="date" name="date_envoi" class="input" value="{{ now|date:'Y-m-d' }}" style="margin: 0;" required>
                  <button type="submit" class="btn success" style="margin: 0; white-space: nowrap;">‚úì Valider</button>
                </form>
                <small style="display: block; margin-top: 0.5rem; color: #1e40af; font-size: 0.8rem;">
                  ‚è≥ Validit√© : {{ devis.validite_jours }} jours
                </small>
              </div>
              {% else %}
              <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                <div style="color: #065f46; font-size: 0.85rem;">
                  ‚úÖ Envoy√© le : <strong>{{ devis.date_envoi|date:"d/m/Y" }}</strong>
                </div>
                {% if devis.date_limite %}
                <div style="color: #065f46; font-size: 0.8rem; margin-top: 0.25rem;">
                  üìÖ Valable jusqu'au : {{ devis.date_limite|date:"d/m/Y" }}
                  {% if devis.est_expire %}
                  <span style="color: var(--danger); font-weight: 600;">‚ö†Ô∏è EXPIR√â</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}
              
              <!-- √âtape 3 : R√©ponse client -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                <form method="POST" id="form-accepter-{{ devis.id }}" onsubmit="return validateDateEnvoiDevis({{ devis.id }}, 'accepter')">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="accepter_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <button type="submit" class="btn success" style="width: 100%; padding: 0.75rem; font-size: 0.9rem;">
                    ‚úÖ Accept√©
                  </button>
                </form>
                
                <form method="POST" id="form-refuser-{{ devis.id }}" onsubmit="return validateDateEnvoiDevis({{ devis.id }}, 'refuser')">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="refuser_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <button type="submit" class="btn danger" style="width: 100%; padding: 0.75rem; font-size: 0.9rem;">
                    ‚ùå Refus√©
                  </button>
                </form>
              </div>
              
              <small style="display: block; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(59,130,246,0.2); color: #1e40af; font-size: 0.8rem; text-align: center;">
                üí¨ Enregistrez d'abord la date d'envoi avant de valider la r√©ponse
              </small>
            </div>
            
            {% elif devis.statut == 'accepte' %}
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ACCEPT√â : Infos + T√©l√©charger
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 10px; padding: 1.5rem;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <div style="color: #065f46; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">üìÖ Envoy√©</div>
                  <div style="color: #065f46; font-size: 0.95rem; font-weight: 700;">{{ devis.date_envoi|date:"d/m/Y" }}</div>
                </div>
                <div>
                  <div style="color: #065f46; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">‚úÖ Accept√©</div>
                  <div style="color: #065f46; font-size: 0.95rem; font-weight: 700;">{{ devis.date_reponse|date:"d/m/Y" }}</div>
                </div>
                {% if devis.delai_reponse %}
                <div>
                  <div style="color: #065f46; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">‚è±Ô∏è D√©lai</div>
                  <div style="color: #065f46; font-size: 0.95rem; font-weight: 700;">{{ devis.delai_reponse }} jour{{ devis.delai_reponse|pluralize }}</div>
                </div>
                {% endif %}
              </div>
              
              <a href="{% url 'telecharger_devis_pdf' devis.id %}" class="btn primary" style="width: 100%; text-decoration: none; text-align: center; padding: 0.75rem;">
                üì• T√©l√©charger le PDF
              </a>
            </div>
            
            {% elif devis.statut == 'refuse' %}
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                REFUS√â : Date + Supprimer
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 10px; padding: 1.5rem;">
              <div style="color: #991b1b; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem;">
                ‚ùå Refus√© le {{ devis.date_reponse|date:"d/m/Y" }}
              </div>
              <div style="color: #991b1b; font-size: 0.8rem; margin-bottom: 1rem;">
                üí° Cr√©ez un nouveau devis modifi√© ou supprimez celui-ci
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem;">
                <a href="{% url 'telecharger_devis_pdf' devis.id %}" class="btn" style="text-decoration: none; text-align: center; padding: 0.75rem;">
                  üì• T√©l√©charger PDF
                </a>
                
                <form method="POST" onsubmit="return confirm('Supprimer d√©finitivement ce devis refus√© ?')">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="supprimer_devis">
                  <input type="hidden" name="devis_id" value="{{ devis.id }}">
                  <button type="submit" class="btn danger" style="padding: 0.75rem;">
                    üóëÔ∏è Supprimer
                  </button>
                </form>
              </div>
            </div>
            {% endif %}
            
          </div>
          {% endif %}
          
        </div>
      </div>
      {% empty %}
      <!-- Aucun devis existant -->
      <div class="alert info">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
        <div>
          üí° Aucun devis cr√©√© pour cette op√©ration. Cr√©ez le premier devis ci-dessous.
        </div>
      </div>
      {% endfor %}
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          BOUTON : CR√âER UN NOUVEAU DEVIS
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <form method="POST" style="margin-top: 1.5rem;">
        {% csrf_token %}
        <input type="hidden" name="action" value="creer_nouveau_devis">
        <button type="submit" class="btn primary" style="width: 100%; padding: 1rem; font-size: 1rem; font-weight: 600;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
          ‚ûï Cr√©er un nouveau devis
        </button>
      </form>
      
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      SCRIPTS JAVASCRIPT
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ACCORD√âON DEVIS
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleDevis(devisId) {
    const body = document.getElementById('devis-body-' + devisId);
    const header = body.previousElementSibling;
    const icon = header.querySelector('.toggle-devis-icon');
    
    if (body.style.maxHeight === '0px' || body.style.maxHeight === '') {
      // Ouvrir
      body.style.maxHeight = body.scrollHeight + 1000 + 'px'; // +1000 pour s√©curit√©
      body.style.opacity = '1';
      body.style.paddingTop = '1.5rem';
      icon.style.transform = 'rotate(180deg)';
    } else {
      // Fermer
      body.style.maxHeight = '0';
      body.style.opacity = '0';
      body.style.paddingTop = '0';
      icon.style.transform = 'rotate(0deg)';
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // VALIDATION DATE D'ENVOI (pour accepter/refuser)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function validateDateEnvoiDevis(devisId, action) {
    // V√©rifier si la date d'envoi est enregistr√©e
    const devisBody = document.getElementById('devis-body-' + devisId);
    const dateEnvoiInput = devisBody.querySelector('input[name="date_envoi"]');
    
    // Si le champ existe encore, c'est que la date n'est pas enregistr√©e
    if (dateEnvoiInput) {
      alert('‚ö†Ô∏è Veuillez d\'abord enregistrer la date d\'envoi du devis avant de valider la r√©ponse du client.');
      
      // Scroll vers le formulaire et focus
      dateEnvoiInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      dateEnvoiInput.focus();
      dateEnvoiInput.style.border = '2px solid var(--danger)';
      setTimeout(() => {
        dateEnvoiInput.style.border = '';
      }, 2000);
      
      return false;
    }
    
    // Confirmation pour refus
    if (action === 'refuser') {
      return confirm('‚ö†Ô∏è Confirmer le refus du devis ?\n\nVous pourrez cr√©er un nouveau devis modifi√© juste apr√®s.');
    }
    
    return true;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ALERTE DATES PASS√âES (optionnel, √† activer si besoin)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', function() {
    // Parcourir tous les champs date d'envoi
    const dateInputs = document.querySelectorAll('input[type="date"][name="date_envoi"]');
    
    dateInputs.forEach(input => {
      input.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Si date dans le pass√©, afficher un badge warning (optionnel)
        if (selectedDate < today) {
          const parent = this.parentElement;
          let alert = parent.querySelector('.date-passee-alert');
          
          if (!alert) {
            alert = document.createElement('small');
            alert.className = 'date-passee-alert';
            alert.style.cssText = 'display: block; margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; color: #991b1b; font-size: 0.8rem;';
            alert.textContent = '‚ö†Ô∏è Attention : date dans le pass√©';
            parent.appendChild(alert);
          }
        } else {
          // Supprimer l'alerte si elle existe
          const alert = this.parentElement.querySelector('.date-passee-alert');
          if (alert) alert.remove();
        }
      });
    });
  });
  </script>

  {% endif %}
  <!-- ========================================
      FIN SECTION DEVIS
      ======================================== -->



<!-- ========================================
    LIGNES D'INTERVENTION
    ‚ö†Ô∏è Affich√©e UNIQUEMENT pour les op√©rations SANS DEVIS (parcours direct)
    ======================================== -->
    {% if not operation.avec_devis %}
    <section class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.6"/></svg>
          üîß Lignes d'intervention
          
          {% if interventions %}
          <span class="section-badge complete">
            {{ interventions.count }} ligne{{ interventions.count|pluralize }}
          </span>
          {% else %}
          <span class="section-badge pending">Aucune ligne</span>
          {% endif %}
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      
      <div class="section-body">
        <!-- Verrouillage si d√©j√† pay√©/r√©alis√© (optionnel) -->
        {% if operation.statut == 'paye' %}
        <div class="alert info" style="margin-bottom: 1rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="1.6"/><path d="M12 11V7a2 2 0 1 1 4 0v4m-8 0V7a2 2 0 0 1 2-2" stroke="currentColor" stroke-width="1.6"/></svg>
          <div>
            <strong>üîí Montant verrouill√©</strong><br>
            L'op√©ration est pay√©e, les lignes ne peuvent plus √™tre modifi√©es.
          </div>
        </div>
        {% endif %}
        
        {% if interventions %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th style="width:120px">Montant (‚Ç¨)</th>
                {% if operation.statut != 'paye' %}
                <th style="width:100px">Actions</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for intervention in interventions %}
              <tr>
                <td>{{ intervention.description }}</td>
                <td><strong>{{ intervention.montant }}</strong></td>
                {% if operation.statut != 'paye' %}
                <td>
                  <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette ligne ?')">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_intervention">
                    <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                    <button type="submit" class="btn danger sm">Supprimer</button>
                  </form>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td><strong>TOTAL</strong></td>
                <td><strong>{{ montant_total }} ‚Ç¨</strong></td>
                {% if operation.statut != 'paye' %}
                <td></td>
                {% endif %}
              </tr>
            </tfoot>
          </table>
        </div>
        {% else %}
        <div class="alert info">Aucune ligne d'intervention</div>
        {% endif %}

        <!-- Formulaire ajout (masqu√© si verrouill√©) -->
        {% if operation.statut != 'paye' %}
        <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border)">
          <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Ajouter une ligne</h4>
          <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_intervention">
            
            <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
              <div style="flex:1; min-width:250px">
                <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Description</label>
                <input type="text" name="description" class="input" placeholder="Ex: Main d'≈ìuvre, Fournitures..." required>
              </div>
              
              <div style="flex:0 0 150px">
                <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Montant HT (‚Ç¨)</label>
                <input type="number" name="prix_unitaire_ht" class="input" placeholder="0.00" step="0.01" required>
              </div>
              
              <!-- ‚úÖ NOUVEAU : Champs cach√©s pour quantit√©, unit√© et TVA -->
              <input type="hidden" name="quantite" value="1">
              <input type="hidden" name="unite" value="forfait">
              <input type="hidden" name="taux_tva" value="10">
              
              <button type="submit" class="btn success">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                Ajouter
              </button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>
    </section>
    {% endif %}

    
<!-- üìÖ PASSAGES PLANIFI√âS -->
<section class="section">
  <div class="section-header" onclick="toggleSection(this)">
    <h2 class="section-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="1.6"/>
      </svg>
      Passages planifi√©s
      
      {% if operation.passages.exists %}
      <span class="section-badge complete">
        {{ operation.passages.count }} passage{{ operation.passages.count|pluralize }}
      </span>
      {% else %}
      <span class="section-badge disabled">Aucun passage</span>
      {% endif %}
    </h2>
    <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>

  <div class="section-body">
    
    <!-- Bouton ajout -->
    <div style="display:flex; justify-content:flex-end; margin-bottom:1rem">
      <button 
        onclick="document.getElementById('modal-add-passage').style.display='flex'" 
        class="btn success"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Ajouter un passage
      </button>
    </div>

    {% if operation.passages.exists %}
      <!-- ‚úÖ GRILLE SIMPLE (pas de tableau qui d√©cale) -->
      <div style="display:grid; gap:1rem">
        {% for passage in operation.passages.all %}
        <div class="info-card" style="position:relative">
          
          <!-- En-t√™te passage -->
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding-bottom:1rem; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:.5rem">
            
            <!-- Num√©ro + Statut -->
            <div style="display:flex; align-items:center; gap:1rem">
              <div style="
                display:inline-flex;
                align-items:center;
                justify-content:center;
                width:36px;
                height:36px;
                border-radius:8px;
                font-weight:700;
                font-size:1rem;
                background: {% if passage.est_en_retard %}rgba(245,158,11,.15){% elif passage.realise %}rgba(34,197,94,.15){% elif passage.est_planifie %}rgba(99,102,241,.15){% else %}rgba(148,163,184,.15){% endif %};
                color: {% if passage.est_en_retard %}#f59e0b{% elif passage.realise %}#22c55e{% elif passage.est_planifie %}#6366f1{% else %}#64748b{% endif %};
              ">
                {{ passage.numero }}
              </div>
              
              <span style="
                display:inline-flex;
                align-items:center;
                gap:.3rem;
                padding:.35rem .75rem;
                border-radius:999px;
                font-size:.8rem;
                font-weight:600;
                background: {% if passage.est_en_retard %}rgba(245,158,11,.1){% elif passage.realise %}rgba(34,197,94,.1){% elif passage.est_planifie %}rgba(99,102,241,.1){% else %}rgba(148,163,184,.1){% endif %};
                color: {% if passage.est_en_retard %}#f59e0b{% elif passage.realise %}#22c55e{% elif passage.est_planifie %}#6366f1{% else %}#64748b{% endif %};
                border: 1px solid {% if passage.est_en_retard %}rgba(245,158,11,.3){% elif passage.realise %}rgba(34,197,94,.3){% elif passage.est_planifie %}rgba(99,102,241,.3){% else %}rgba(148,163,184,.3){% endif %};
              ">
                {% if passage.est_en_retard %}üü†{% elif passage.realise %}üü¢{% elif passage.est_planifie %}üîµ{% else %}‚ö™{% endif %}
                {{ passage.statut_display }}
              </span>
            </div>
            
            <!-- Boutons action -->
            <div style="display:flex; gap:.5rem; flex-wrap:wrap">
              <button 
                onclick="toggleFormPassage('planif-{{ passage.id }}')"
                class="btn primary sm"
              >
                üìÖ {% if passage.date_prevue %}Replanifier{% else %}Planifier{% endif %}
              </button>
              
              <form method="POST" action="{% url 'marquer_passage_realise' operation.id passage.id %}" style="margin:0">
                {% csrf_token %}
                <button type="submit" class="btn {% if passage.realise %}sm{% else %}success sm{% endif %}">
                  {% if passage.realise %}‚Ü©Ô∏è Annuler{% else %}‚úÖ R√©aliser{% endif %}
                </button>
              </form>
              
              <button 
                onclick="toggleFormPassage('comment-{{ passage.id }}')"
                class="btn sm"
              >
                üí¨
              </button>
              
              <form method="POST" action="{% url 'supprimer_passage_operation' operation.id passage.id %}" style="margin:0" onsubmit="return confirm('Supprimer ce passage ?')">
                {% csrf_token %}
                <button type="submit" class="btn danger sm">üóëÔ∏è</button>
              </form>
            </div>
          </div>
          
          <!-- Infos passage -->
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1rem">
            <div>
              <div class="label">üìÖ Date planifi√©e</div>
              <div class="value" style="font-size:.95rem">
                {% if passage.date_prevue %}
                  {{ passage.date_prevue|date:"d/m/Y √† H:i" }}
                {% else %}
                  <span style="color:var(--muted); font-style:italic">Non planifi√©</span>
                {% endif %}
              </div>
            </div>
            
            <div>
              <div class="label">‚úÖ Date r√©alis√©e</div>
              <div class="value" style="font-size:.95rem">
                {% if passage.date_realisation %}
                  <span style="color:var(--success)">{{ passage.date_realisation|date:"d/m/Y √† H:i" }}</span>
                {% else %}
                  <span style="color:var(--muted)">‚Äî</span>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Commentaire visible -->
          {% if passage.commentaire %}
          <div style="background:#f8fafc; padding:.75rem; border-radius:8px; border-left:3px solid var(--primary)">
            <div style="font-size:.75rem; font-weight:600; color:var(--muted); margin-bottom:.25rem">üí¨ COMMENTAIRE</div>
            <div style="font-size:.9rem; color:var(--text)">{{ passage.commentaire }}</div>
          </div>
          {% endif %}
          
          <!-- ‚úÖ FORMULAIRE PLANIFICATION (cach√© par d√©faut) -->
          <div id="planif-{{ passage.id }}" class="form-passage-inline" style="display:none; margin-top:1rem; padding-top:1rem; border-top:2px dashed var(--border)">
            <form method="POST" action="{% url 'planifier_passage_operation' operation.id passage.id %}" onsubmit="return validateDatePlanification(this)">
              {% csrf_token %}
              <div style="display:flex; gap:.5rem; align-items:end; flex-wrap:wrap">
                <div style="flex:1; min-width:200px">
                  <label style="display:block; margin-bottom:.3rem; font-size:.75rem; font-weight:600; color:var(--muted)">
                    üìÖ Date et heure
                  </label>
                  <input 
                    type="datetime-local" 
                    name="date_prevue" 
                    class="input input-date-planification"
                    value="{% if passage.date_prevue %}{{ passage.date_prevue|date:'Y-m-d\TH:i' }}{% endif %}"
                    style="margin:0"
                    required
                  >
                </div>
                <button type="submit" class="btn primary">Valider</button>
                <button type="button" onclick="toggleFormPassage('planif-{{ passage.id }}')" class="btn">Annuler</button>
              </div>
              <!-- Warning date pass√©e -->
              <div class="warning-date-passee" style="display:none; margin-top:.5rem; padding:.5rem; background:#fee2e2; border:1px solid #fecaca; border-radius:6px; color:#991b1b; font-size:.85rem">
                ‚ö†Ô∏è Cette date est dans le pass√©
              </div>
            </form>
          </div>
          
          <!-- ‚úÖ FORMULAIRE COMMENTAIRE (cach√© par d√©faut) -->
          <div id="comment-{{ passage.id }}" class="form-passage-inline" style="display:none; margin-top:1rem; padding-top:1rem; border-top:2px dashed var(--border)">
            <form method="POST" action="{% url 'ajouter_commentaire_passage' operation.id passage.id %}">
              {% csrf_token %}
              <div style="display:flex; flex-direction:column; gap:.5rem">
                <label style="font-size:.75rem; font-weight:600; color:var(--muted)">üí¨ Commentaire</label>
                <textarea 
                  name="commentaire" 
                  rows="3"
                  class="input"
                  placeholder="Note pour ce passage..."
                  style="margin:0; resize:vertical"
                >{% if passage.commentaire %}{{ passage.commentaire }}{% endif %}</textarea>
                <div style="display:flex; gap:.5rem">
                  <button type="submit" class="btn primary">Enregistrer</button>
                  <button type="button" onclick="toggleFormPassage('comment-{{ passage.id }}')" class="btn">Annuler</button>
                </div>
              </div>
            </form>
          </div>
          
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="text-align:center; padding:3rem 1rem; color:var(--muted)">
        <div style="font-size:3rem; margin-bottom:1rem">üìÖ</div>
        <p style="font-size:1rem; margin:0">Aucun passage planifi√©</p>
        <p style="font-size:.9rem; margin:.5rem 0 0 0">Cliquez sur "Ajouter un passage" pour commencer</p>
      </div>
    {% endif %}
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL AJOUT PASSAGE
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="modal-add-passage" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); z-index:9999; align-items:center; justify-content:center">
  <div style="background:white; border-radius:12px; padding:2rem; max-width:500px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,.3)">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem">
      <h3 style="margin:0; color:var(--text); font-size:1.3rem">‚ûï Ajouter un passage</h3>
      <button onclick="closeModalAddPassage()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--muted)">&times;</button>
    </div>
    
    <form method="POST" action="{% url 'ajouter_passage_operation' operation.id %}" id="form-add-passage" onsubmit="return validateAddPassage()">
      {% csrf_token %}
      
      <div style="margin-bottom:1.5rem">
        <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">
          üìÖ Date et heure (optionnel)
        </label>
        <input 
          type="datetime-local" 
          name="date_prevue" 
          id="add-passage-date"
          class="input"
          style="margin:0"
        >
        <small style="display:block; margin-top:.5rem; color:var(--muted); font-size:.85rem">
          üí° Laissez vide pour cr√©er un passage non planifi√©
        </small>
        <div id="add-passage-warning" style="display:none; margin-top:.5rem; padding:.5rem; background:#fee2e2; border:1px solid #fecaca; border-radius:6px; color:#991b1b; font-size:.85rem">
          ‚ö†Ô∏è Cette date est dans le pass√©
        </div>
      </div>
      
      <div style="margin-bottom:1.5rem">
        <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">
          üí¨ Commentaire (optionnel)
        </label>
        <textarea 
          name="commentaire" 
          rows="3"
          class="input"
          placeholder="Note pour ce passage..."
          style="margin:0; resize:vertical"
        ></textarea>
      </div>
      
      <div style="display:flex; gap:.5rem; justify-content:flex-end">
        <button type="button" onclick="closeModalAddPassage()" class="btn">Annuler</button>
        <button type="submit" class="btn success">‚úÖ Cr√©er le passage</button>
      </div>
    </form>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GESTION PASSAGES PLANIFI√âS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Toggle formulaires inline (planification / commentaire)
function toggleFormPassage(formId) {
  const form = document.getElementById(formId);
  if (!form) return;
  
  // Fermer tous les autres formulaires
  document.querySelectorAll('.form-passage-inline').forEach(f => {
    if (f.id !== formId) {
      f.style.display = 'none';
    }
  });
  
  // Toggle le formulaire actuel
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

// Fermer modal ajout passage
function closeModalAddPassage() {
  const modal = document.getElementById('modal-add-passage');
  if (modal) {
    modal.style.display = 'none';
    const form = document.getElementById('form-add-passage');
    if (form) form.reset();
    const warning = document.getElementById('add-passage-warning');
    if (warning) warning.style.display = 'none';
  }
}

// Fermer modal en cliquant dehors
document.getElementById('modal-add-passage')?.addEventListener('click', function(e) {
  if (e.target === this) closeModalAddPassage();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VALIDATION DATES PLANIFICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Validation pour l'ajout de passage (modal)
function validateAddPassage() {
  const dateInput = document.getElementById('add-passage-date');
  
  // Si pas de date, OK (passage non planifi√©)
  if (!dateInput || !dateInput.value) return true;
  
  const dateSelectionnee = new Date(dateInput.value);
  const maintenant = new Date();
  
  if (dateSelectionnee < maintenant) {
    showToast('‚ùå Impossible de planifier dans le pass√© !', 'error', 3000);
    dateInput.focus();
    return false;
  }
  
  return true;
}

// Validation pour les formulaires inline de planification
function validateDatePlanification(form) {
  const dateInput = form.querySelector('input[name="date_prevue"]');
  
  if (!dateInput || !dateInput.value) {
    showToast('‚ö†Ô∏è Veuillez s√©lectionner une date', 'warning', 3000);
    return false;
  }
  
  const dateSelectionnee = new Date(dateInput.value);
  const maintenant = new Date();
  
  if (dateSelectionnee < maintenant) {
    showToast('‚ùå Impossible de planifier dans le pass√© !', 'error', 3000);
    dateInput.focus();
    dateInput.style.border = '2px solid var(--danger)';
    setTimeout(() => { dateInput.style.border = ''; }, 2000);
    return false;
  }
  
  return true;
}

// Avertissement live sur date ajout (modal)
document.getElementById('add-passage-date')?.addEventListener('change', function() {
  const warning = document.getElementById('add-passage-warning');
  if (!this.value || !warning) return;
  
  const dateSelectionnee = new Date(this.value);
  const maintenant = new Date();
  
  if (dateSelectionnee < maintenant) {
    warning.style.display = 'block';
    this.style.border = '2px solid var(--warning)';
  } else {
    warning.style.display = 'none';
    this.style.border = '';
  }
});

// Avertissement live sur tous les inputs de planification inline
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.input-date-planification').forEach(input => {
    input.addEventListener('change', function() {
      const warningDiv = this.closest('form').querySelector('.warning-date-passee');
      if (!this.value) {
        if (warningDiv) warningDiv.style.display = 'none';
        this.style.border = '';
        return;
      }
      
      const dateSelectionnee = new Date(this.value);
      const maintenant = new Date();
      
      if (dateSelectionnee < maintenant) {
        if (warningDiv) warningDiv.style.display = 'block';
        this.style.border = '2px solid var(--warning)';
        showToast('‚ö†Ô∏è Attention : cette date est dans le pass√©', 'warning', 2000);
      } else {
        if (warningDiv) warningDiv.style.display = 'none';
        this.style.border = '';
      }
    });
  });
  
  console.log('‚úÖ Validation dates passages activ√©e');
});
</script>

<script>
function toggleForm(formId) {
  const form = document.getElementById(formId);
  if (!form) return;
  
  // Fermer tous les autres formulaires
  document.querySelectorAll('[id^="planif-"], [id^="comment-"]').forEach(f => {
    if (f.id !== formId) {
      f.style.display = 'none';
    }
  });
  
  // Toggle le formulaire actuel
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}
</script>

<!-- ========================================
    SECTION PAIEMENT & FACTURATION UNIFI√âE
    ======================================== -->
<section class="section">
  <div class="section-header" onclick="toggleSection(this)">
    <h2 class="section-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M2 8.5h20M2 12.5h20M6 16.5h8M6 20.5h8M6 4.5h8" stroke="currentColor" stroke-width="1.6"/>
      </svg>
      üí∞ Paiements & Facturation
      
      {% if operation.statut == 'paye' %}
      <span class="section-badge complete">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
        Sold√©
      </span>
      {% elif echeances %}
      <span class="section-badge pending">{{ total_echeances }} ‚Ç¨ / {{ montant_total }} ‚Ç¨</span>
      {% else %}
      <span class="section-badge disabled">Aucun paiement</span>
      {% endif %}
    </h2>
    <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>
  
  <div class="section-body">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        R√âCAPITULATIF FINANCIER (IDENTIQUE √Ä L'ANCIEN)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="payment-box" style="margin-bottom:1.5rem">
      <div class="info-grid">
        <div class="info-card">
          <div class="label">üí∞ Montant total</div>
          <div class="value" style="font-size:1.5rem; color:var(--primary); font-weight:700">
            {{ montant_total }} ‚Ç¨
          </div>
        </div>
        
        <div class="info-card">
          <div class="label">‚úÖ Pay√©</div>
          <div class="value" style="font-size:1.5rem; color:var(--success); font-weight:700">
            {{ total_echeances|default:0 }} ‚Ç¨
          </div>
        </div>
        
        <div class="info-card">
          <div class="label">‚è≥ En attente</div>
          <div class="value" style="font-size:1.2rem; color:var(--warning); font-weight:600">
            {{ total_echeances_prevus|default:0 }} ‚Ç¨
          </div>
          <small style="color:var(--muted); font-size:0.8rem">Pr√©vus non pay√©s</small>
        </div>
        
        <div class="info-card">
          <div class="label">üéØ Reste √† enregistrer</div>
          <div class="value" style="font-size:1.5rem; font-weight:700; color:{% if reste_a_enregistrer == 0 %}var(--success){% elif reste_a_enregistrer < 0 %}var(--danger){% else %}var(--warning){% endif %}">
            {{ reste_a_enregistrer|default:montant_total }} ‚Ç¨
          </div>
        </div>
      </div>
      
      <!-- Alerte si d√©passement (IDENTIQUE) -->
      {% if reste_a_enregistrer < 0 %}
      <div class="alert danger" style="margin-top:1rem">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="2"/></svg>
        <div>
          <strong>‚ö†Ô∏è ATTENTION : D√©passement de {{ reste_a_enregistrer_abs }} ‚Ç¨ !</strong><br>
          Total enregistr√© ({{ total_echeances_tout }} ‚Ç¨) > Montant op√©ration ({{ montant_total }} ‚Ç¨)
        </div>
      </div>
      {% endif %}
      
      {% if reste_a_enregistrer == 0 and reste_a_payer == 0 %}
      <div class="alert success" style="margin-top:1rem">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
        <div><strong>üéâ Op√©ration sold√©e !</strong> Tous les paiements ont √©t√© re√ßus.</div>
      </div>
      {% elif reste_a_enregistrer == 0 and reste_a_payer > 0 %}
      <div class="alert info" style="margin-top:1rem">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3" stroke="currentColor" stroke-width="1.6"/></svg>
        <div><strong>üí° Tous les paiements sont enregistr√©s</strong> - En attente de validation de {{ total_echeances_prevus }} ‚Ç¨</div>
      </div>
      {% endif %}
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        LISTE DES PAIEMENTS (AVEC AJOUT FACTURE)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    {% if echeances %}
    <div class="payment-box" style="margin-bottom:1.5rem">
      <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem; display:flex; align-items:center; gap:.5rem">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4" stroke="currentColor" stroke-width="1.6"/></svg>
        Historique des paiements
      </h4>
      
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Montant</th>
              <th>Statut</th>
              <th>Facture</th> <!-- ‚úÖ NOUVELLE COLONNE -->
              <th style="width:100px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for echeance in echeances %}
            <tr style="{% if echeance.paye %}background: #f0fdf4;{% elif echeance.date_echeance|date:'Y-m-d' < now|date:'Y-m-d' %}background: #fee2e2;{% endif %}">
              
              <!-- Date (IDENTIQUE) -->
              <td>
                <strong>{{ echeance.date_echeance|date:"d/m/Y" }}</strong>
                {% if echeance.date_echeance|date:'Y-m-d' < now|date:'Y-m-d' and not echeance.paye %}
                <br><small style="color:var(--danger)">‚ö†Ô∏è En retard</small>
                {% endif %}
              </td>
              
              <!-- Montant (IDENTIQUE) -->
              <td><strong>{{ echeance.montant }} ‚Ç¨</strong></td>
              
              <!-- Statut (IDENTIQUE) -->
              <td>
                {% if echeance.paye %}
                  <span style="color:var(--success); font-weight:600; display:flex; align-items:center; gap:.3rem">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    Pay√©
                  </span>
                {% else %}
                  <span style="color:var(--warning); font-weight:600; display:flex; align-items:center; gap:.3rem">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.6"/><path d="M12 8v4" stroke="currentColor" stroke-width="1.6"/></svg>
                    En attente
                  </span>
                {% endif %}
              </td>
              
              <!-- ‚úÖ NOUVELLE COLONNE FACTURE -->
              <td>
                {% if echeance.facture_generee %}
                  <!-- Facture d√©j√† g√©n√©r√©e -->
                  <div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap">
                    <span style="color:var(--success); font-weight:600; font-size:.85rem">
                      üìÑ {{ echeance.numero_facture }}
                    </span>
                    <a href="{% url 'telecharger_facture_pdf' echeance.id %}" 
                      class="btn primary sm" 
                      title="T√©l√©charger le PDF"
                      style="padding:0.2rem 0.4rem; text-decoration:none">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                      </svg>
                    </a>
                  </div>
                {% elif echeance.paye %}
                  <!-- Pay√© mais pas encore factur√© -->
                  <span style="color:var(--warning); font-size:.85rem">‚ö†Ô∏è Non factur√©e</span>
                {% else %}
                  <!-- Pr√©vu = pas encore de facture -->
                  <span style="color:var(--muted); font-size:.85rem">‚Äî</span>
                {% endif %}
              </td>
              
              <!-- Actions (IDENTIQUE avec ajout bouton facture) -->
              <td>
                <div style="display:flex; gap:.3rem">
                  
                  <!-- ‚úÖ Marquer comme pay√© (IDENTIQUE) -->
                  {% if not echeance.paye %}
                  <form method="POST" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="marquer_paye">
                    <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                    <button type="submit" class="btn success sm" title="Marquer comme pay√©">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                  </form>
                  {% endif %}
                  
                  <!-- ‚úÖ NOUVEAU : G√©n√©rer facture -->
                  {% if echeance.paye and not echeance.facture_generee %}
                  <form method="POST" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="generer_facture_echeance">
                    <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                    <button type="submit" class="btn primary sm" title="G√©n√©rer la facture">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                        <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4" stroke="currentColor" stroke-width="1.6"/>
                      </svg>
                    </button>
                  </form>
                  {% endif %}
                  
                  <!-- ‚úÖ Supprimer (IDENTIQUE) -->
                  <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer ce paiement ?')">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_paiement">
                    <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                    <button type="submit" class="btn danger sm">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                  </form>
                  
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr style="background: #eef2ff; font-weight:700">
              <td><strong>TOTAL PAY√â</strong></td>
              <td><strong>{{ total_echeances|default:0 }} ‚Ç¨</strong></td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        FORMULAIRE D'AJOUT DE PAIEMENT (IDENTIQUE)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="payment-box">
      <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem; display:flex; align-items:center; gap:.5rem">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
        {% if echeances %}Ajouter un paiement{% else %}Enregistrer le premier paiement{% endif %}
      </h4>
      
      <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_paiement">
        
        <div class="info-grid" style="margin-bottom:1rem">
          <div class="info-card">
            <div class="label">üíµ Montant (‚Ç¨)</div>
            <div class="value">
              <!-- ‚úÖ Container flex pour input + bouton -->
              <div style="display:flex; gap:0.5rem; align-items:center;">
                <input type="number" 
                      id="montant-paiement-input"
                      name="montant" 
                      class="input" 
                      placeholder="Ex: 500" 
                      step="0.01" 
                      min="0.01" 
                      max="{{ max_paiement }}"
                      style="flex:1; margin:0;"
                      required>
                
                <!-- ‚úÖ NOUVEAU BOUTON -->
                {% if reste_a_enregistrer > 0 %}
                <button type="button" 
                        class="btn primary sm" 
                        id="btn-reste"
                        title="Remplir avec le reste √† enregistrer"
                        style="white-space:nowrap; padding:0.5rem 0.75rem;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                  Reste
                </button>

                <script>
                // Script ex√©cut√© imm√©diatement apr√®s le bouton
                (function() {
                  const btn = document.getElementById('btn-reste');
                  const input = document.getElementById('montant-paiement-input');
                  const reste = parseFloat('{{ reste_a_enregistrer|floatformat:2|default:"0.00" }}');
                  
                  if (btn && input && reste > 0) {
                    btn.addEventListener('click', function() {
                      input.value = reste.toFixed(2);
                      input.style.background = '#d1fae5';
                      input.style.transition = 'background 0.3s ease';
                      
                      setTimeout(() => {
                        input.style.background = '';
                      }, 500);
                      
                      input.focus();
                      
                      // Toast optionnel
                      if (typeof showToast === 'function') {
                        showToast('‚úÖ Montant rempli : ' + reste.toFixed(2) + ' ‚Ç¨', 'success', 2000);
                      }
                    });
                    
                    console.log('‚úÖ Bouton Reste initialis√© avec succ√®s - Montant:', reste);
                  } else {
                    console.error('‚ùå Erreur initialisation bouton Reste:', { btn, input, reste });
                  }
                })();
                </script>
                {% endif %}
              </div>
              
              <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                {% if reste_a_enregistrer > 0 %}
                  üí° Reste √† enregistrer : <strong>{{ reste_a_enregistrer }} ‚Ç¨</strong>
                {% elif reste_a_enregistrer == 0 %}
                  ‚úÖ Tous les paiements sont enregistr√©s
                {% else %}
                  ‚ö†Ô∏è D√©passement de {{ reste_a_enregistrer_abs }} ‚Ç¨
                {% endif %}
              </small>
            </div>
          </div>
          
          <div class="info-card">
            <div class="label">üìÖ Date du paiement</div>
            <div class="value">
              <input type="date" 
                    name="date_paiement" 
                    class="input" 
                    value="{{ now|date:'Y-m-d' }}"
                    required>
              <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                üí° Date pr√©vue ou effective
              </small>
            </div>
          </div>
          
          <div class="info-card">
            <div class="label">‚úÖ Statut</div>
            <div class="value">
              <select name="paye" class="select" id="paye-select">
                <option value="true">D√©j√† pay√©</option>
                <option value="false">Pr√©vu / √Ä venir</option>
              </select>
              <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                üí° "D√©j√† pay√©" = re√ßu aujourd'hui<br>
                "Pr√©vu" = attendu plus tard
              </small>
            </div>
          </div>
        </div>
        
        <!-- ‚úÖ NOUVELLE OPTION : G√©n√©ration auto de facture -->
        <div id="facture-auto-option" style="display:none; margin-bottom:1rem; padding:1rem; background:#f0f9ff; border:1px solid #bfdbfe; border-radius:8px">
          <label style="display:flex; align-items:center; gap:.5rem; cursor:pointer">
            <input type="checkbox" name="generer_facture_auto" value="true" checked>
            <span style="font-weight:600; color:#1e40af">üìÑ G√©n√©rer automatiquement la facture</span>
          </label>
          <small style="display:block; margin-top:.5rem; color:#1e40af; font-size:.85rem">
            üí° Gagne du temps en cr√©ant la facture directement
          </small>
        </div>
        
        <button type="submit" class="btn success" style="width:100%">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
          Enregistrer ce paiement
        </button>
      </form>
    </div>
    
    <!-- Info aide (IDENTIQUE) -->
    {% if not echeances %}
    <div class="alert info" style="margin-top:1rem">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
      <div>
        <strong>üí° Comment √ßa marche ?</strong><br>
        ‚Ä¢ Ajoutez un paiement quand vous voulez<br>
        ‚Ä¢ Vous pouvez enregistrer des acomptes, le solde, ou tout en une fois<br>
        ‚Ä¢ Marquez "D√©j√† pay√©" si c'est re√ßu, sinon "Pr√©vu"<br>
        ‚Ä¢ Quand tout est pay√©, l'op√©ration passe automatiquement en statut "Pay√©"
      </div>
    </div>
    {% endif %}
    
  </div>
</section>

<!-- ‚úÖ Script pour afficher/masquer l'option facture auto -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const payeSelect = document.getElementById('paye-select');
  const factureAutoOption = document.getElementById('facture-auto-option');
  
  if (payeSelect && factureAutoOption) {
    payeSelect.addEventListener('change', function() {
      // Afficher l'option seulement si "D√©j√† pay√©"
      factureAutoOption.style.display = (this.value === 'true') ? 'block' : 'none';
    });
    
    // V√©rif initiale
    if (payeSelect.value === 'true') {
      factureAutoOption.style.display = 'block';
    }
  }
});
</script>


</div> <!-- ‚úÖ FIN DE .left-column -->
     

<!-- ========================================
     COLONNE DROITE - HISTORIQUE
     ======================================== -->
<div class="right-column">
  <section class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <h2 class="section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
        Historique
        {% if historique %}
        <span class="section-badge complete">
          {{ historique.count }} √©v√©nement{{ historique.count|pluralize }}
        </span>
        {% endif %}
      </h2>
      <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="section-body">
      {% if historique %}
      <div class="table-wrap">
        <table>
          <thead><tr><th>Date</th><th>Action</th></tr></thead>
          <tbody>
            {% for entry in historique %}
            <tr>
              <td style="font-size:.85rem">{{ entry.date|date:"d/m H:i" }}</td>
              <td style="font-size:.9rem">{{ entry.action }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert info">Aucun historique</div>
      {% endif %}
    </div>
  </section>

<!-- ‚úÖ SECTION COMMENTAIRES (UN SEUL BLOC) -->
<section class="section sticky-notes">
  <div class="section-header" onclick="toggleSection(this)">
    <h2 class="section-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M7 8h10M7 12h4m1 8-4-4H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3l-4 4Z" stroke="currentColor" stroke-width="1.6"/>
      </svg>
      Commentaires
    </h2>
    <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>
  
  <div class="section-body">
    <form method="POST" id="commentaires-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_commentaires">
      
      <textarea 
        id="commentaires-textarea" 
        name="commentaires" 
        class="notes-textarea" 
        rows="6" 
        placeholder=""
      >{{ operation.commentaires|default:'' }}</textarea>
      
      <div class="notes-actions">
        <button type="submit" class="btn success" title="Enregistrer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m5 12 4 4 10-10"/>
          </svg>
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</section>
</div> <!-- ‚úÖ FIN DE .right-column (ICI, APR√àS LES COMMENTAIRES) -->
</div> <!-- ‚úÖ FIN DE .main-content -->

<div style="margin-top:1.5rem">
  <a href="{% url 'operations' %}" class="btn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5"/></svg>
    Retour aux op√©rations
  </a>
</div>
</div> <!-- ‚úÖ FIN DE .container -->




<script>
// ========================================
// ‚úÖ FONCTIONS GLOBALES (DOIVENT √äTRE EN PREMIER)
// ========================================

// Fonction de confirmation de suppression
function confirmDeleteOperation() {
  const id = '{{ operation.id_operation }}';
  const type = '{{ operation.type_prestation|escapejs }}';
  const client = '{{ operation.client.nom }} {{ operation.client.prenom }}';
  const interventions = {{ interventions.count|default:0 }};
  const echeances = {{ echeances.count|default:0 }};
  
  let message = '‚ö†Ô∏è ATTENTION : Supprimer l\'op√©ration ' + id + ' ?\n\n';
  message += 'üìã Type : ' + type + '\n';
  message += 'üë§ Client : ' + client + '\n';
  
  if (interventions > 0) {
    message += '\nüî∏ ' + interventions + ' ligne(s) d\'intervention seront supprim√©e(s)';
  }
  
  if (echeances > 0) {
    message += '\nüí∞ ' + echeances + ' √©ch√©ance(s) de paiement seront supprim√©e(s)';
  }
  
  message += '\n\nüö® Cette action est IRR√âVERSIBLE !';
  
  return confirm(message);
}

// Fonction de toggle des sections
function toggleSection(header) {
  const section = header.closest('.section');
  const body = section.querySelector('.section-body');
  
  header.classList.toggle('collapsed');
  body.classList.toggle('collapsed');
  
  const sectionTitle = header.querySelector('.section-title').textContent.trim();
  const isCollapsed = body.classList.contains('collapsed');
  localStorage.setItem(`section-${sectionTitle}`, isCollapsed ? 'collapsed' : 'expanded');
}

// ========================================
// SYST√àME DE NOTIFICATIONS TOAST
// ========================================
function showToast(message, type = 'info', duration = 5000) {
  const container = document.getElementById('toast-container');
  if (!container) return;
  
  // Cr√©er le toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  // Ic√¥ne selon le type
  let icon = '';
  switch(type) {
    case 'success':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m5 12 4 4 10-10"/></svg>';
      break;
    case 'error':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6m0-6 6 6"/></svg>';
      break;
    case 'warning':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4m0 4h0M12 3l9 18H3L12 3z"/></svg>';
      break;
    case 'info':
    default:
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h0"/></svg>';
      break;
  }
  
  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-content">${message}</div>
    <button class="toast-close" onclick="dismissToast(this)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6 6 18M6 6l12 12"/>
      </svg>
    </button>
  `;
  
  container.appendChild(toast);
  
  // Auto-dismiss
  setTimeout(() => {
    dismissToast(toast.querySelector('.toast-close'));
  }, duration);
}

function dismissToast(button) {
  const toast = button.closest('.toast');
  if (!toast) return;
  
  toast.classList.add('hiding');
  setTimeout(() => {
    toast.remove();
  }, 300);
}

// Afficher les messages Django au chargement
window.addEventListener('DOMContentLoaded', function() {
  const messagesContainer = document.getElementById('django-messages');
  if (messagesContainer) {
    const messages = messagesContainer.querySelectorAll('[data-message]');
    messages.forEach((msg, index) => {
      setTimeout(() => {
        const type = msg.dataset.type || 'info';
        const message = msg.dataset.message;
        showToast(message, type);
      }, index * 200); // D√©lai entre chaque toast
    });
  }
});

// ========================================
// ‚úÖ FONCTION GLOBALE POUR LA PLANIFICATION
// ========================================
window.toggleRealisationForm = function() {
  const realisationForm = document.getElementById('realisation-form');
  const dateRealisationInput = document.getElementById('date-realisation-input');
  const datePrevueInput = document.getElementById('date-prevue-input');
  
  if (!realisationForm) return;
  
  const isVisible = realisationForm.style.display !== 'none';
  
  if (isVisible) {
    // Fermer
    realisationForm.style.display = 'none';
  } else {
    // Ouvrir et pr√©-remplir avec la date de planification (ou maintenant si pas de date pr√©vue)
    realisationForm.style.display = 'block';
    if (dateRealisationInput) {
      // ‚úÖ NOUVEAU : Utiliser la date pr√©vue si elle existe, sinon la date actuelle
      if (datePrevueInput && datePrevueInput.value) {
        dateRealisationInput.value = datePrevueInput.value;
      } else {
        const now = new Date();
        const pad = n => String(n).padStart(2, '0');
        dateRealisationInput.value = now.getFullYear() + '-' + 
                                      pad(now.getMonth() + 1) + '-' + 
                                      pad(now.getDate()) + 'T' + 
                                      pad(now.getHours()) + ':' + 
                                      pad(now.getMinutes());
      }
    }
    // Scroll smooth vers le formulaire
    realisationForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ========================================
// ‚úÖ FONCTION POUR CORRIGER LES DATES (R√âALIS√â)
// ========================================
window.toggleModificationDates = function() {
  const modificationForm = document.getElementById('modification-dates-form');
  if (!modificationForm) return;
  
  const isVisible = modificationForm.style.display !== 'none';
  modificationForm.style.display = isVisible ? 'none' : 'block';
  
  if (!isVisible) {
    modificationForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ========================================
// INITIALISATION AU CHARGEMENT DE LA PAGE
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  
  // Fonctions utilitaires
  function getNowFormatted() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
  }

  function getTodayDate() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate());
  }

  function formatMontant(montant) {
    return new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2}).format(montant) + ' ‚Ç¨';
  }

  // Gestion du statut du devis
  const devisCreeSelect = document.getElementById('devis-cree');
  const devisDetails = document.getElementById('devis-details');
  const noDevisAlert = document.getElementById('no-devis-alert');
  const devisStatutSelect = document.getElementById('devis-statut');

  function updateDevisDisplay() {
    const isCreated = devisCreeSelect.value === 'oui';
    
    const devisDetails = document.getElementById('devis-details');
    const noDevisSection = document.getElementById('no-devis-section');
    
    if (devisDetails) {
      if (isCreated) {
        devisDetails.classList.remove('hidden');
        devisDetails.style.display = 'block';
      } else {
        devisDetails.classList.add('hidden');
        devisDetails.style.display = 'none';
      }
    }
    
    if (noDevisSection) {
      noDevisSection.style.display = isCreated ? 'none' : 'block';
    }
    
    if (isCreated && devisStatutSelect) {
      updateDevisAlerts();
    } else {
      hideAllDevisAlerts();
    }
  }

  function updateDevisAlerts() {
    if (!devisStatutSelect) return;
    
    const statut = devisStatutSelect.value;
    
    const alerts = {
      'devis-accepte-alert': statut === 'accepte',
      'devis-refuse-alert': statut === 'refuse',
      'devis-attente-alert': false,
      'devis-relance-alert': statut === 'relance'
    };
    
    Object.keys(alerts).forEach(alertId => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.display = alerts[alertId] ? 'flex' : 'none';
      }
    });
  }

  function hideAllDevisAlerts() {
    ['devis-accepte-alert', 'devis-refuse-alert', 'devis-attente-alert', 'devis-relance-alert'].forEach(alertId => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.display = 'none';
      }
    });
  }

  if (devisCreeSelect) {
    devisCreeSelect.addEventListener('change', updateDevisDisplay);
    updateDevisDisplay();
  }

  if (devisStatutSelect) {
    devisStatutSelect.addEventListener('change', updateDevisAlerts);
    if (devisCreeSelect && devisCreeSelect.value === 'oui') {
      updateDevisAlerts();
    }
  }

// ========================================
// GESTION PLANIFICATION SIMPLIFI√âE
// ========================================
const datePrevueInput = document.getElementById('date-prevue-input');
const dateRealisationInput = document.getElementById('date-realisation-input');
const datePasseeAlert = document.getElementById('date-passee-alert');

// V√©rifier si date pass√©e
function checkDatePassee() {
  if (!datePrevueInput || !datePasseeAlert) return;
  
  if (datePrevueInput.value) {
    const dateSelectionnee = new Date(datePrevueInput.value);
    const maintenant = new Date();
    
    datePasseeAlert.style.display = (dateSelectionnee < maintenant) ? 'flex' : 'none';
  } else {
    datePasseeAlert.style.display = 'none';
  }
}

// Validation date r√©alisation (pas dans le futur)
if (dateRealisationInput) {
  dateRealisationInput.addEventListener('change', function() {
    const dateSelectionnee = new Date(this.value);
    const maintenant = new Date();
    
    if (dateSelectionnee > maintenant) {
      showToast("‚ùå La date de r√©alisation ne peut pas √™tre dans le futur !", 'error');
      this.value = getNowFormatted();
    }
  });
}

// √âcouter les changements de date pr√©vue
if (datePrevueInput) {
  datePrevueInput.addEventListener('change', checkDatePassee);
  checkDatePassee(); // V√©rif initiale
}
  // Gestion des commentaires
  const commentairesTextarea = document.getElementById('commentaires-textarea');
  const commentairesForm = document.getElementById('commentaires-form');
  let originalCommentaires = commentairesTextarea ? commentairesTextarea.value : '';

  window.resetCommentaires = function() {
    if (commentairesTextarea) {
      commentairesTextarea.value = originalCommentaires;
    }
  }

  if (commentairesForm) {
    commentairesForm.addEventListener('submit', function() {
      originalCommentaires = commentairesTextarea.value;
    });
  }

  // Gestion date de r√©ponse
  const dateEnvoiInput = document.getElementById('devis-date-envoi');
  const dateReponseInput = document.getElementById('devis-date-reponse');
  const dateReponseCard = document.getElementById('date-reponse-card');
  const delaiReponseInfo = document.getElementById('delai-reponse-info');
  const delaiReponseText = document.getElementById('delai-reponse-text');

  function updateDateReponseVisibility() {
    if (!devisStatutSelect || !dateReponseCard) return;
    const statut = devisStatutSelect.value;
    const shouldShow = statut === 'accepte' || statut === 'refuse';
    dateReponseCard.style.display = shouldShow ? 'block' : 'none';
    if (shouldShow) calculateDelai();
    else if (delaiReponseInfo) delaiReponseInfo.style.display = 'none';
  }

  function calculateDelai() {
    if (!dateEnvoiInput || !dateReponseInput || !delaiReponseInfo || !delaiReponseText) return;
    
    const dateEnvoi = dateEnvoiInput.value;
    const dateReponse = dateReponseInput.value;
    
    if (dateEnvoi && dateReponse) {
      const d1 = new Date(dateEnvoi);
      const d2 = new Date(dateReponse);
      const diffDays = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
      
      if (diffDays >= 0) {
        let message = `<strong>D√©lai de r√©ponse : ${diffDays} jour${diffDays > 1 ? 's' : ''}</strong>`;
        delaiReponseText.innerHTML = message;
        delaiReponseInfo.style.display = 'flex';
      } else {
        delaiReponseInfo.style.display = 'none';
      }
    } else {
      delaiReponseInfo.style.display = 'none';
    }
  }

  if (devisStatutSelect) {
    const originalChange = devisStatutSelect.onchange;
    devisStatutSelect.addEventListener('change', function() {
      if (originalChange) originalChange.call(this);
      updateDateReponseVisibility();
    });
    updateDateReponseVisibility();
  }

  if (dateEnvoiInput) dateEnvoiInput.addEventListener('change', calculateDelai);
  if (dateReponseInput) dateReponseInput.addEventListener('change', calculateDelai);

// Gestion mode paiement
const modePaiementSelect = document.getElementById('mode-paiement-select');
const comptantSection = document.getElementById('comptant-section');
const echelonneSection = document.getElementById('echelonne-section');
const datePaiementComptant = document.getElementById('date-paiement-comptant');

if (modePaiementSelect) {
  modePaiementSelect.addEventListener('change', function() {
    const mode = this.value;
    
    if (comptantSection) comptantSection.style.display = 'none';
    if (echelonneSection) echelonneSection.style.display = 'none';
    
    if (mode === 'comptant' && comptantSection) {
      comptantSection.style.display = 'block';
      // ‚úÖ CORRECTION : Ne remplir la date QUE si le champ est vide
      if (datePaiementComptant && !datePaiementComptant.value) {
        datePaiementComptant.value = getTodayDate();
      }
    } else if (mode === 'echelonne' && echelonneSection) {
      // ‚úÖ AJOUT : espace entre } et else
      echelonneSection.style.display = 'block';
    }
  });
  
  // Initialisation au chargement
  if (modePaiementSelect.value) {
    modePaiementSelect.dispatchEvent(new Event('change'));
  }
}

  // Initialisation des dates
  const devisDateEnvoi = document.getElementById('devis-date-envoi');
  if (devisDateEnvoi && !devisDateEnvoi.value) {
    devisDateEnvoi.value = getTodayDate();
  }

  // Gestion des sections repliables
  const statut = '{{ operation.statut }}';
  const operationId = '{{ operation.id }}';
  const storageKey = `operation-${operationId}-sections-initialized`;
  const isFirstVisit = !localStorage.getItem(storageKey);
  
  const sections = document.querySelectorAll('.section');
  let sectionToScrollTo = null;
  
  sections.forEach((section) => {
    const header = section.querySelector('.section-header');
    const body = section.querySelector('.section-body');
    
    if (!header || !body) return;
    
    const titleElement = header.querySelector('.section-title');
    if (!titleElement) return;
    
    const title = titleElement.textContent.trim();
    const savedState = localStorage.getItem(`section-${title}`);
    
    if (savedState && !isFirstVisit) {
      if (savedState === 'collapsed') {
        header.classList.add('collapsed');
        body.classList.add('collapsed');
      }
    } else {
      header.classList.add('collapsed');
      body.classList.add('collapsed');
      
      let shouldOpen = false;
      
      // ‚úÖ NOUVEAU : Logique d'ouverture des sections selon le statut
      const devisStatut = '{{ operation.devis_statut }}';
      
      switch(statut) {
        case 'en_attente_devis':
          shouldOpen = title.includes('Devis');
          break;
        case 'a_planifier':
          // ‚úÖ Si devis accept√©, ouvrir la section Devis + Passages planifi√©s
          if (devisStatut === 'accepte') {
            shouldOpen = title.includes('Devis') || title.includes('Passages planifi√©s');
          } else {
            shouldOpen = title.includes('Passages planifi√©s');
          }
          break;
        case 'planifie':
          shouldOpen = title.includes('Passages planifi√©s');
          break;
        case 'realise':
          // ‚úÖ MODIFI√â : Plus d'ouverture auto des Paiements
          shouldOpen = false;
          break;
        case 'paye':
          // ‚úÖ MODIFI√â : Plus d'ouverture auto des Paiements m√™me si pay√©
          shouldOpen = false;
          break;
        case 'devis_refuse':
          shouldOpen = title.includes('Devis');
          break;
        default:
          shouldOpen = title.includes('Informations g√©n√©rales');
      }
      
      if (shouldOpen) {
        header.classList.remove('collapsed');
        body.classList.remove('collapsed');
        if (!sectionToScrollTo) {
          sectionToScrollTo = section;
        }
      }
    }
  });
  
  if (isFirstVisit) {
    localStorage.setItem(storageKey, 'true');
  }



  // D√©tection Safari et ajout de placeholders
if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) {
  document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
    input.placeholder = "JJ/MM/AAAA HH:MM";
    input.style.minWidth = "200px";
  });
}

// ========================================
// VALIDATION : Emp√™cher dates futures UNIQUEMENT pour r√©alisation
// ========================================
const realisationDateInput = document.getElementById('realisation-date');

if (realisationDateInput) {
  // ‚úÖ Validation UNIQUEMENT sur le champ de r√©alisation
  realisationDateInput.addEventListener('change', function() {
    const dateSelectionnee = new Date(this.value);
    const maintenant = new Date();
    
    if (dateSelectionnee > maintenant) {
      showToast("‚ùå La date de r√©alisation ne peut pas √™tre dans le futur !", 'error');
      this.value = getNowFormatted();
    }
  });
  
  // ‚úÖ Attribut max UNIQUEMENT sur le champ de r√©alisation
  realisationDateInput.setAttribute('max', getNowFormatted());
}

// ‚ö†Ô∏è NE PAS appliquer de validation sur les autres champs datetime-local
// Les champs de planification (planning-date, replanification-date) doivent accepter les dates futures

// ========================================
// SAUVEGARDE DE LA POSITION DE SCROLL
// ========================================

// Sauvegarder la position avant soumission de formulaire
document.querySelectorAll('form').forEach(form => {
  form.addEventListener('submit', function() {
    sessionStorage.setItem('scrollPosition', window.scrollY);
  });
});

// Restaurer la position apr√®s rechargement
const savedScrollPosition = sessionStorage.getItem('scrollPosition');
if (savedScrollPosition !== null) {
  window.scrollTo(0, parseInt(savedScrollPosition));
  sessionStorage.removeItem('scrollPosition');
}

  console.log('‚úÖ JavaScript CRM Artisans initialis√©');
});

// ========================================
// FEEDBACK VISUEL SOUMISSIONS
// ========================================
document.getElementById('form-realisation').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Validation...
  `;
});

document.getElementById('form-replanification').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Replanification...
  `;
});

document.getElementById('form-commentaires').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Enregistrement...
  `;
});

// Animation spin
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

</script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GESTION AJAX DES LIGNES DE DEVIS (VERSION FINALE)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', function() {
  
  console.log('üöÄ Script AJAX devis charg√©');
  
  function getCsrfToken() {
    return document.querySelector('[name="csrfmiddlewaretoken"]')?.value || '';
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // AJOUT DE LIGNE EN AJAX
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const forms = document.querySelectorAll('.form-add-ligne-ajax');
  console.log('üìù Formulaires trouv√©s:', forms.length);
  
  forms.forEach((form, index) => {
    console.log(`üìã Formulaire ${index + 1}:`, {
      devisId: form.dataset.devisId,
      operationId: form.dataset.operationId
    });
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const devisId = this.dataset.devisId;
      const operationId = this.dataset.operationId;
      const submitBtn = this.querySelector('.btn-add-ligne');
      const btnOriginalText = submitBtn.innerHTML;
      
      console.log('üîÑ Soumission formulaire:', { devisId, operationId });
      
      const formData = new FormData(this);
      formData.append('devis_id', devisId);
      
      // Debug : afficher les donn√©es
      console.log('üì§ Donn√©es envoy√©es:');
      for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
      }
      
      // D√©sactiver le bouton
      submitBtn.disabled = true;
      submitBtn.innerHTML = '‚è≥ Envoi...';
      
      // Envoyer en AJAX
      fetch(`/operations/${operationId}/ajax/add-ligne-devis/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        console.log('üì• R√©ponse re√ßue:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('‚úÖ Donn√©es re√ßues:', data);
        
        if (data.success) {
          console.log('üéâ Succ√®s ! Ajout de la ligne dans le DOM...');
          
          // ‚úÖ FORCER L'OUVERTURE DU DEVIS
          const devisBody = document.getElementById(`devis-body-${devisId}`);
          if (devisBody) {
            const header = devisBody.previousElementSibling;
            const icon = header ? header.querySelector('.toggle-devis-icon') : null;
            
            console.log('üîì V√©rification √©tat devis:', {
              maxHeight: devisBody.style.maxHeight,
              opacity: devisBody.style.opacity,
              isClosed: devisBody.style.maxHeight === '0px' || devisBody.style.maxHeight === ''
            });
            
            // Si ferm√©, ouvrir
            if (devisBody.style.maxHeight === '0px' || devisBody.style.maxHeight === '') {
              console.log('üîì Ouverture forc√©e du devis...');
              devisBody.style.maxHeight = (devisBody.scrollHeight + 2000) + 'px';
              devisBody.style.opacity = '1';
              devisBody.style.paddingTop = '1.5rem';
              if (icon) icon.style.transform = 'rotate(180deg)';
            } else {
              console.log('‚úÖ Devis d√©j√† ouvert');
            }
          }
          
          // ‚úÖ Ajouter la ligne dans le DOM
          ajouterLigneDansContainer(devisId, data.ligne, operationId);
          
          // Mettre √† jour les totaux
          updateTotaux(devisId, data.totaux);
          
          // R√©initialiser le formulaire
          this.reset();
          this.querySelector('[name="quantite"]').value = '1';
          this.querySelector('[name="taux_tva"]').value = '10';
          this.querySelector('.input-description').focus();
          
          // Toast
          showToast('‚úÖ Ligne ajout√©e', 'success', 2000);
          
        } else {
          console.error('‚ùå Erreur:', data.error);
          showToast(`‚ùå ${data.error}`, 'error', 3000);
        }
      })
      .catch(error => {
        console.error('üí• Erreur r√©seau:', error);
        showToast('‚ùå Erreur r√©seau: ' + error.message, 'error', 3000);
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = btnOriginalText;
        console.log('üèÅ Fin du traitement');
      });
    });
  });
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // FONCTION : Ajouter ligne dans le container
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function ajouterLigneDansContainer(devisId, ligne, operationId) {
    console.log('‚ûï Ajout ligne dans container:', { devisId, ligneId: ligne.id });
    
    const container = document.getElementById(`lignes-container-${devisId}`);
    
    if (!container) {
      console.error('‚ùå Container introuvable:', `lignes-container-${devisId}`);
      return;
    }
    
    console.log('‚úÖ Container trouv√©:', container);
    
    // Cr√©er la div de la ligne
    const ligneDiv = document.createElement('div');
    ligneDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 80px 100px 120px 80px 120px 40px; gap: 0.75rem; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border); background: white;';
    ligneDiv.setAttribute('data-ligne-id', ligne.id);
    
    ligneDiv.innerHTML = `
      <div style="font-size: 0.9rem; color: var(--text);">${ligne.description}</div>
      <div style="text-align: center; font-size: 0.85rem;">${ligne.quantite.toFixed(2)} ${ligne.unite_display}</div>
      <div style="text-align: right; font-weight: 600; font-size: 0.85rem;">${ligne.prix_unitaire_ht.toFixed(2)} ‚Ç¨</div>
      <div style="text-align: center; font-size: 0.85rem;">TVA ${ligne.taux_tva.toFixed(0)}%</div>
      <div style="text-align: right; font-weight: 600; font-size: 0.9rem; color: var(--primary);">${ligne.montant.toFixed(2)} ‚Ç¨</div>
      <div></div>
      <form class="form-delete-ligne-ajax" data-ligne-id="${ligne.id}" data-devis-id="${devisId}" data-operation-id="${operationId}" style="display:inline; margin: 0;">
        <input type="hidden" name="csrfmiddlewaretoken" value="${getCsrfToken()}">
        <button type="submit" class="btn danger sm" style="padding: 0.3rem 0.6rem; font-size: 0.85rem; margin: 0;">√ó</button>
      </form>
    `;
    
    // Trouver la div des totaux et ins√©rer avant
    const totauxDiv = container.querySelector('[style*="background: #f8fafc"]');
    
    if (totauxDiv) {
      console.log('‚úÖ Insertion avant totaux');
      container.insertBefore(ligneDiv, totauxDiv);
    } else {
      console.log('‚ö†Ô∏è Totaux introuvables, ajout √† la fin');
      container.appendChild(ligneDiv);
    }
    
    // Animation
    ligneDiv.style.animation = 'slideIn 0.3s ease';
    
    console.log('‚úÖ Ligne ajout√©e au DOM');
    
    // Attacher le listener de suppression
    attachDeleteListener(ligneDiv.querySelector('.form-delete-ligne-ajax'));
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // SUPPRESSION EN AJAX
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function attachDeleteListener(form) {
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!confirm('Supprimer cette ligne ?')) return;
      
      const ligneId = this.dataset.ligneId;
      const devisId = this.dataset.devisId;
      const operationId = this.dataset.operationId;
      
      console.log('üóëÔ∏è Suppression ligne:', { ligneId, devisId, operationId });
      
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', getCsrfToken());
      formData.append('ligne_id', ligneId);
      
      fetch(`/operations/${operationId}/ajax/delete-ligne-devis/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log('üì• R√©ponse suppression:', data);
        
        if (data.success) {
          // Supprimer du DOM
          const ligneDiv = document.querySelector(`[data-ligne-id="${ligneId}"]`);
          if (ligneDiv) {
            ligneDiv.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
              ligneDiv.remove();
              console.log('‚úÖ Ligne supprim√©e du DOM');
            }, 300);
          }
          
          // Mettre √† jour totaux
          updateTotaux(devisId, data.totaux);
          
          showToast('‚úÖ Ligne supprim√©e', 'success', 2000);
        } else {
          console.error('‚ùå Erreur suppression:', data.error);
          showToast(`‚ùå ${data.error}`, 'error', 3000);
        }
      })
      .catch(error => {
        console.error('üí• Erreur r√©seau suppression:', error);
        showToast('‚ùå Erreur r√©seau', 'error', 3000);
      });
    });
  }
  
  // Attacher aux formulaires existants
  document.querySelectorAll('.form-delete-ligne-ajax').forEach(attachDeleteListener);
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // UTILITAIRES
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateTotaux(devisId, totaux) {
    console.log('üí∞ Mise √† jour totaux:', { devisId, totaux });
    
    const container = document.getElementById(`devis-body-${devisId}`);
    if (!container) {
      console.error('‚ùå Container body introuvable');
      return;
    }
    
    const stElement = container.querySelector('.sous-total-ht');
    if (stElement) {
      stElement.textContent = `${totaux.sous_total_ht.toFixed(2)} ‚Ç¨`;
      console.log('‚úÖ Sous-total HT mis √† jour');
    }
    
    const tvaElement = container.querySelector('.total-tva');
    if (tvaElement) {
      tvaElement.textContent = `${totaux.total_tva.toFixed(2)} ‚Ç¨`;
      console.log('‚úÖ TVA mise √† jour');
    }
    
    const ttcElements = container.querySelectorAll('.total-ttc');
    ttcElements.forEach(el => {
      el.textContent = `${totaux.total_ttc.toFixed(2)} ‚Ç¨`;
    });
    console.log('‚úÖ Total TTC mis √† jour');
  }
  
  console.log('‚úÖ Script AJAX devis pr√™t');
});

// Animations
const styleAnimations = document.createElement('style');
styleAnimations.textContent = `
  @keyframes slideIn {
    from { transform: translateX(30px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(-30px); opacity: 0; }
  }
`;
document.head.appendChild(styleAnimations);
</script>
</body>
</html>