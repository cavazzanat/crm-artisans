<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ operation.id_operation }} - {{ operation.type_prestation }} ‚Äì CRM Artisans</title>
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
      --ring: rgba(99,102,241,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: var(--bg);
      color: var(--text); 
      line-height: 1.6; 
      padding-bottom:3rem;
    }

    /* ========================================
       EN-T√äTE MODERNE (DASHBOARD STYLE)
       ======================================== */
    .header{ 
      position: sticky; 
      top: 0; 
      z-index: 40;
      backdrop-filter: saturate(180%) blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .header-inner{ 
      max-width:1280px; 
      margin:0 auto; 
      padding:.85rem 1rem; 
      display:flex; 
      align-items:center; 
      gap:1rem; 
      justify-content:space-between;
    }
    .brand{ 
      display:flex; 
      align-items:center; 
      gap:.75rem; 
      font-weight:700; 
      letter-spacing:.2px; 
      color: var(--text); 
    }
    .logo{ 
      width:34px; 
      height:34px; 
      border-radius:10px; 
      background:linear-gradient(145deg, var(--primary), var(--accent)); 
      box-shadow: var(--shadow); 
      display:grid; 
      place-items:center;
    }
    .logo svg{ width:18px; height:18px; color:white }

    .nav{ 
      display: flex; 
      gap: .25rem; 
      align-items: center;
    }
    .nav a{ 
      text-decoration: none; 
      color: var(--muted); 
      padding: .55rem .8rem; 
      border-radius: 10px; 
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }
    .nav a:hover{ 
      color: var(--text); 
      background: rgba(148,163,184,.08); 
      border-color: var(--border);
    }
    .nav a.active{ 
      color: white; 
      background: rgba(99,102,241,.18); 
      border-color: rgba(99,102,241,.35); 
      box-shadow: 0 0 0 2px var(--ring);
    }

    .user{ 
      display: flex; 
      align-items: center; 
      gap: .75rem; 
      color: var(--muted); 
      font-size: .95rem;
    }
    .user form button{ 
      background: none; 
      border: none; 
      color: var(--muted); 
      cursor: pointer; 
      text-decoration: underline; 
      font: inherit; 
      padding: 0;
    }
    .user form button:hover{ color: var(--text); }

    /* ========================================
       RESTE DU STYLE
       ======================================== */
    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    
    h1{ font-size:1.8rem; font-weight:800; margin-bottom:.5rem; color: var(--text); }
    .breadcrumb{ color:var(--muted); font-size:.9rem; margin-bottom:1rem }
    .breadcrumb a{ color:var(--muted); text-decoration:none }
    .breadcrumb a:hover{ color:var(--text) }

    .status-badge{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; 
      border-radius:20px; font-size:.85rem; font-weight:600; border:1px solid;
    }
    .status-badge::before{ content:''; width:8px; height:8px; border-radius:50%; background:currentColor }
    .status-badge.en_attente_devis{ color:#f59e0b; background: rgba(245,158,11,.1); border-color: rgba(245,158,11,.3); }
    .status-badge.a_planifier{ color:#3b82f6; background: rgba(59,130,246,.1); border-color: rgba(59,130,246,.3); }
    .status-badge.planifie{ color:#8b5cf6; background: rgba(139,92,246,.1); border-color: rgba(139,92,246,.3); }
    .status-badge.realise{ color:#22c55e; background: rgba(34,197,94,.1); border-color: rgba(34,197,94,.3); }
    .status-badge.paye{ color:#10b981; background: rgba(16,185,129,.1); border-color: rgba(16,185,129,.3); }
    .status-badge.devis_refuse{ color:#ef4444; background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.3); }
    
    .section{ 
      background: white;
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:1.5rem; 
      box-shadow: var(--shadow); 
      margin-bottom:1.5rem 
    }
    .section-header{ 
      display:flex; align-items:center; justify-content:space-between; gap:1rem; 
      padding-bottom:1rem; border-bottom:1px solid var(--border); margin-bottom:1rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }
    .section-header:hover {
      background: rgba(148,163,184,.03);
      border-radius: 8px;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700; color: var(--text); }

    /* ========================================
       SECTIONS REPLIABLES (ACCORD√âON)
       ======================================== */
    .section-header .toggle-icon {
      transition: transform 0.3s ease;
      color: var(--muted);
      flex-shrink: 0;
    }

    .section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .section-body {
      max-height: 5000px;
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
      opacity: 1;
    }

    .section-body.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    /* Badge indicateur sur les sections */
    .section-badge {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .2rem .5rem;
      border-radius: 12px;
      font-size: .75rem;
      font-weight: 600;
      margin-left: .5rem;
    }

    .section-badge.complete {
      background: rgba(34,197,94,.1);
      color: var(--success);
      border: 1px solid rgba(34,197,94,.2);
    }

    .section-badge.pending {
      background: rgba(245,158,11,.1);
      color: var(--warning);
      border: 1px solid rgba(245,158,11,.2);
    }

    .section-badge.disabled {
      background: rgba(148,163,184,.1);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,.2);
    }

    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem }
    .info-card{
      background: #f8fafc;
      border:1px solid var(--border); 
      border-radius:10px; 
      padding:1rem; 
      transition: all 0.2s ease;
    }
    .info-card:hover{ background: #f1f5f9; border-color: #cbd5e1; }
    .info-card .label{
      display:flex; align-items:center; gap:.5rem; color:var(--muted); 
      font-size:.85rem; font-weight:600; text-transform:uppercase; 
      letter-spacing:.05rem; margin-bottom:.75rem
    }
    .info-card .value{ color: var(--text); font-weight: 600; font-size: 1rem; line-height: 1.4 }

    .input, .select{ 
      width:100%; padding:.65rem .8rem; border-radius:8px; border:1px solid var(--border); 
      background: white; color: var(--text); font:inherit 
    }
    .input:focus, .select:focus{ 
      outline:none; 
      box-shadow: 0 0 0 3px rgba(99,102,241,.1); 
      border-color: var(--primary);
    }

    .btn{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; 
      border-radius:8px; border:1px solid var(--border); 
      background:white; color:var(--text); cursor:pointer; font:inherit; text-decoration:none;
      transition: all 0.2s;
    }
    .btn:hover{ background:#f8fafc; border-color: #cbd5e1; }
    .btn.success{ background:var(--success); border-color: var(--success); color: white; }
    .btn.success:hover{ background:#16a34a; }
    .btn.primary{ background:var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover{ background:#4f46e5; }
    .btn.danger{ background: var(--danger); border-color: var(--danger); color: white; }
    .btn.danger:hover{ background:#dc2626; }
    .btn.sm{ padding:.4rem .6rem; border-radius:6px; font-size:.9rem }

    .alert{ 
      padding:.75rem 1rem; border-radius:8px; margin-top:1rem; 
      display:flex; align-items:center; gap:.5rem; font-size:.9rem;
    }
    .alert.warning{ background: #fef3c7; color: #92400e; border:1px solid #fde68a; }
    .alert.danger, .alert.error{ background: #fee2e2; color: #991b1b; border:1px solid #fecaca; }
    .alert.success{ background: #d1fae5; color: #065f46; border:1px solid #a7f3d0; }
    .alert.info{ background: #dbeafe; color: #1e40af; border:1px solid #bfdbfe; }

    .radio-option{ 
      display:flex; align-items:center; gap:.5rem; padding:.6rem 1rem; 
      border:2px solid var(--border); border-radius:8px; cursor:pointer; 
      transition: all .2s; margin-bottom:.5rem; background: white;
    }
    .radio-option:hover{ border-color:var(--primary); background:#f8fafc; }
    .radio-option.selected{ border-color:var(--primary); background:#eef2ff; box-shadow: 0 0 0 3px rgba(99,102,241,.1); }
    .radio-option input[type="radio"]{ width:auto; margin:0; cursor:pointer }
    .radio-option label{ margin:0; cursor:pointer; font-weight:500; flex:1 }

    .payment-box{ background: #f8fafc; border:1px solid var(--border); border-radius:10px; padding:1rem; margin-top:1rem }

    .table-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--border); margin-top:1rem; background: white; }
    table{ width:100%; border-collapse: collapse }
    thead th{ 
      background: #f8fafc; color:var(--muted); text-transform:uppercase; letter-spacing:.08rem; 
      font-size:.75rem; text-align:left; padding:.9rem .85rem; border-bottom:1px solid var(--border)
    }
    tbody td{ padding:.9rem .85rem; border-bottom:1px solid var(--border); }
    tbody tr:hover{ background: #f8fafc; }
    .echeance-row{ background: #f0fdf4; }
    .reste-row{ background: #fef3c7; font-weight:700; color:#92400e; }
    .total-row{ background: #eef2ff; font-weight:700; }

    .workflow-steps{
      display:flex; align-items:center; gap:.5rem; margin-top:1rem; padding:1rem; 
      background:white; border-radius:10px; flex-wrap:wrap; border:1px solid var(--border);
    }
    .workflow-step{
      padding:.4rem .8rem; background:#f1f5f9; 
      border-radius:6px; font-size:.8rem; color:var(--muted); font-weight:600;
    }
    .workflow-step.active{ background:var(--primary); color:white; }
    .workflow-arrow{ color:var(--muted); font-weight:bold }

    .main-content{ 
      display: grid; 
      grid-template-columns: 2fr 1fr; 
      gap: 2rem; 
      align-items: start; /* ‚Üê AJOUTEZ CETTE LIGNE */
    }
    .hidden { display: none !important; }

    /* ========================================
   NOTIFICATIONS TOAST
   ======================================== */
.toast-container {
  position: fixed;
  top: 80px; /* ‚Üê Chang√© de 20px √† 80px pour √™tre sous le header */
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
  align-items: center;
}

.toast {
  min-width: 320px;
  max-width: 420px;
  padding: 1rem 1.25rem;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,.15), 0 4px 12px rgba(0,0,0,.1);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  pointer-events: auto;
  animation: slideInRight 0.3s ease-out;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,.2);
}

.toast.hiding {
  animation: slideOutRight 0.3s ease-in forwards;
}

@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

.toast-icon {
  flex-shrink: 0;
  width: 24px;
  height: 24px;
}

.toast-content {
  flex: 1;
  font-size: 0.95rem;
  line-height: 1.5;
}

.toast-close {
  flex-shrink: 0;
  width: 20px;
  height: 20px;
  border: none;
  background: none;
  cursor: pointer;
  opacity: 0.6;
  transition: opacity 0.2s;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast-close:hover {
  opacity: 1;
}

/* Types de toast */
.toast.success {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
  color: white;
}

.toast.error {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
  color: white;
}

.toast.warning {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
  color: white;
}

.toast.info {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
  color: white;
}

/* Responsive */
@media (max-width: 640px) {
  .toast-container {
    top: 70px;
    right: 10px;
    left: 10px;
  }
  
  .toast {
    min-width: auto;
    max-width: none;
  }
}

/* ========================================
   SECTION COMMENTAIRES STICKY
   ======================================== */
.sticky-notes {
  position: -webkit-sticky !important; /* Safari */
  position: sticky !important;
  top: 90px !important;
  align-self: flex-start !important; /* Plus compatible que 'start' */
  max-height: calc(100vh - 110px);
  overflow-y: auto;
}

/* ========================================
   FIX CRITIQUE POUR LE STICKY
   ======================================== */
.sticky-notes.section {
  overflow: visible !important; /* Emp√™che overflow:hidden de casser le sticky */
}

.sticky-notes .section-body {
  overflow: visible !important; /* Idem pour le body */
}

/* Force le comportement sticky sur la colonne droite */
.right-column {
  position: relative;
  z-index: 1;
}

.notes-textarea {
  width: 100%;
  min-height: 150px;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  color: var(--text);
  font-family: inherit;
  font-size: 0.95rem;
  resize: vertical;
  transition: all 0.2s ease;
}

.notes-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99,102,241,.1);
}

.notes-textarea::placeholder {
  color: var(--muted);
  opacity: 0.6;
}

.notes-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.75rem;
  justify-content: flex-end;
}

/* Responsive : d√©sactiver sticky sur mobile */
@media (max-width: 1024px) {
  .sticky-notes {
    position: static !important;
    max-height: none;
  }
}

    @media (max-width: 1024px){ 
      .main-content{ grid-template-columns: 1fr }
      .nav{ flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}">Accueil</a>
        <a href="{% url 'operations' %}" class="active">Op√©rations</a>
        <a href="{% url 'clients' %}">Clients</a>
      </nav>
      <div class="user">
        <span>{{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit">D√©connexion</button>
        </form>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'dashboard' %}">Accueil</a> / 
      <a href="{% url 'operations' %}">Op√©rations</a> / 
      {{ operation.id_operation }}
    </div>

    
{% if messages %}
<div id="django-messages" style="display:none">
  {% for message in messages %}
  <div data-type="{{ message.tags }}" data-message="{{ message }}"></div>
  {% endfor %}
</div>
{% endif %}



    <!-- ‚úÖ NOUVEAU : En-t√™te avec bouton de suppression -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; flex-wrap:wrap">
      <div>
        <h1>{{ operation.id_operation }} - {{ operation.type_prestation }}</h1>
        <span class="status-badge {{ operation.statut }}">{{ operation.get_statut_display }}</span>
      </div>
      
      <form method="POST" action="{% url 'operation_delete' operation.id %}" onsubmit="return confirmDeleteOperation()" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="force_delete" value="true">
        <button type="submit" class="btn danger" title="Supprimer l'op√©ration">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M9 7v12m6-12v12M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13M9 7l1-3h4l1 3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
          Supprimer l'op√©ration
        </button>
      </form>
    </div>

    <div class="workflow-steps">
      <div class="workflow-step {% if operation.statut == 'en_attente_devis' %}active{% endif %}">Devis</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'a_planifier' %}active{% endif %}">√Ä planifier</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'planifie' %}active{% endif %}">Planifi√©</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'realise' %}active{% endif %}">R√©alis√©</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'paye' %}active{% endif %}">Pay√©</div>
    </div>

    <div class="main-content">
      <div class="left-column">
    <!-- ========================================
        INFORMATIONS G√âN√âRALES
        ======================================== -->
    <section class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
          Informations g√©n√©rales
          <span class="section-badge complete">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
            Compl√©t√©
          </span>
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="section-body">
        <div class="info-grid">
          <div class="info-card">
            <div class="label">Client</div>
            <div class="value">
              <strong>{{ operation.client.nom }} {{ operation.client.prenom }}</strong><br>
              <a href="{% url 'client_detail' client_id=operation.client.id %}" style="color:var(--primary); text-decoration:none">Voir le profil</a>
            </div>
          </div>
          <div class="info-card">
            <div class="label">Type de prestation</div>
            <div class="value">{{ operation.type_prestation }}</div>
          </div>
          <div class="info-card">
            <div class="label">Adresse</div>
            <div class="value">{{ operation.adresse_intervention }}</div>
          </div>
          <div class="info-card">
            <div class="label">Contact</div>
            <div class="value">
              <a href="tel:{{ operation.client.telephone }}" style="color:var(--primary); text-decoration:none">
                {{ operation.client.telephone }}
              </a>
              {% if operation.client.email %}
              <br><a href="mailto:{{ operation.client.email }}" style="color:var(--primary); text-decoration:none">
                {{ operation.client.email }}
              </a>
              {% endif %}
            </div>
          </div>
        </div>



      </div>
    </section>

    
    <!-- ========================================
        SECTION DEVIS - VERSION FINALE SIMPLIFI√âE
        ======================================== -->
    {% if operation.avec_devis %}
    <section class="section" id="section-devis">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" stroke="currentColor" stroke-width="1.6"/></svg>
          Devis
          
          {% if operation.devis_statut == 'accepte' %}
            <span class="section-badge complete">‚úÖ Accept√©</span>
          {% elif operation.devis_statut == 'refuse' %}
            <span class="section-badge" style="background: rgba(239,68,68,.1); color: var(--danger); border: 1px solid rgba(239,68,68,.2);">‚ùå Refus√©</span>
          {% elif operation.numero_devis %}
            <span class="section-badge pending">‚è≥ En attente</span>
          {% else %}
            <span class="section-badge pending">√Ä cr√©er</span>
          {% endif %}
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      
      <div class="section-body">
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            √âTAT 1 : CR√âATION DU DEVIS (avant g√©n√©ration)
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        {% if not operation.numero_devis %}
        
        <div style="border: 2px solid var(--border); border-radius: 12px; padding: 2rem; background: white;">
          
          <!-- En-t√™te -->
          <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);">
            <h3 style="margin: 0; color: var(--muted); font-size: 1.1rem; font-weight: 600;">
              Devis N¬∞ <span style="color: var(--muted); font-style: italic; font-weight: 400;">(sera g√©n√©r√© automatiquement)</span>
            </h3>
          </div>
          
          <!-- Lignes du devis -->
          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">Lignes du devis</h4>
            
            <!-- Tableau des lignes existantes -->
            {% if interventions %}
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem;">
              <thead>
                <tr style="border-bottom: 2px solid var(--border);">
                  <th style="text-align: left; padding: 0.75rem 0.5rem; font-size: 0.85rem; color: var(--muted); font-weight: 600; text-transform: uppercase;">Description</th>
                  <th style="text-align: right; padding: 0.75rem 0.5rem; font-size: 0.85rem; color: var(--muted); font-weight: 600; text-transform: uppercase; width: 120px;">Montant</th>
                  <th style="width: 80px;"></th>
                </tr>
              </thead>
              <tbody>
                {% for intervention in interventions %}
                <tr style="border-bottom: 1px solid var(--border);">
                  <td style="padding: 0.75rem 0.5rem;">{{ intervention.description }}</td>
                  <td style="padding: 0.75rem 0.5rem; text-align: right; font-weight: 600;">{{ intervention.montant }} ‚Ç¨</td>
                  <td style="padding: 0.75rem 0.5rem; text-align: center;">
                    <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette ligne ?')">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_intervention">
                      <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                      <button type="submit" class="btn danger sm" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">√ó</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr style="border-top: 2px solid var(--border);">
                  <td style="padding: 1rem 0.5rem; font-weight: 700; font-size: 1rem;">MONTANT TOTAL</td>
                  <td style="padding: 1rem 0.5rem; text-align: right; font-size: 1.3rem; font-weight: 700; color: var(--primary);">{{ montant_total }} ‚Ç¨</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
            {% endif %}
            
            <!-- Formulaire "+ Ajouter une ligne" -->
            <div style="{% if interventions %}border-top: 2px dashed var(--border); padding-top: 1.5rem;{% endif %}">
              <h5 style="margin: 0 0 0.75rem 0; color: var(--text); font-size: 0.9rem; font-weight: 600;">+ Ajouter une ligne</h5>
              <form method="POST" onsubmit="syncNotesValidite()">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_intervention">
                
                <!-- ‚úÖ NOUVEAUX CHAMPS CACH√âS : Notes et Validit√© -->
                <input type="hidden" name="devis_notes_temp" id="hidden-notes">
                <input type="hidden" name="devis_validite_temp" id="hidden-validite">
                
                <div style="display: grid; grid-template-columns: 1fr 150px 100px; gap: 0.75rem; align-items: center;">
                  <input type="text" 
                        name="description" 
                        class="input" 
                        placeholder="Description" 
                        style="margin: 0;"
                        required>
                  <input type="number" 
                        name="montant" 
                        class="input" 
                        placeholder="Montant" 
                        step="0.01" 
                        min="0.01"
                        style="margin: 0; text-align: right;"
                        required>
                  <button type="submit" class="btn success" style="width: 100%; margin: 0; white-space: nowrap;">Ajouter</button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Notes -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-size: 0.9rem; font-weight: 600;">Notes :</label>
            <textarea name="devis_notes_temp" 
                      id="devis-notes-temp"
                      class="input" 
                      rows="3" 
                      placeholder="Notes optionnelles (ex: Devis valable sous r√©serve de disponibilit√©)"
                      style="resize: vertical;">{{ operation.devis_notes|default:'' }}</textarea>
          </div>
          
          <!-- Validit√© -->
          <div style="margin-bottom: 2rem;">
            <label style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--text); font-size: 0.9rem; font-weight: 600;">
              Validit√© : 
              <input type="number" 
                    id="devis-validite-temp"
                    value="{{ operation.devis_validite_jours|default:30 }}" 
                    min="1" 
                    max="365"
                    style="width: 70px; padding: 0.4rem; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-weight: 600;"> 
              jours
            </label>
          </div>
          
          <!-- Bouton G√©n√©rer le devis -->
          <form method="POST" id="form-generer-devis" onsubmit="return validateDevisGeneration()">
            {% csrf_token %}
            <input type="hidden" name="action" value="generer_devis">
            <input type="hidden" name="devis_notes" id="devis-notes-hidden">
            <input type="hidden" name="devis_validite_jours" id="devis-validite-hidden">
            <button type="submit" class="btn primary" style="width: 100%; padding: 1rem; font-size: 1.05rem; font-weight: 600;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" stroke="currentColor" stroke-width="2"/></svg>
              üìã G√©n√©rer le devis
            </button>
          </form>



          {% if not interventions %}
          <div class="alert info" style="margin-top: 1rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
            <div>
              üí° <strong>Astuce :</strong> Vous pouvez g√©n√©rer le devis sans lignes, puis les ajouter avant l'envoi.
            </div>
          </div>
          {% endif %}
          
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            √âTAT 2 : DEVIS G√âN√âR√â - Validation client
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        {% elif operation.numero_devis and operation.devis_statut != 'accepte' and operation.devis_statut != 'refuse' %}
        
        <div style="border: 2px solid var(--primary); border-radius: 12px; padding: 2rem; background: white;">
          
          <!-- Num√©ro de devis -->
          <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);">
            <h3 style="margin: 0; color: var(--primary); font-size: 1.3rem; font-weight: 700;">
              Devis N¬∞ {{ operation.numero_devis }}
            </h3>
          </div>
          
          <!-- Lignes (lecture seule) -->
          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">Lignes du devis</h4>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid var(--border);">
                  <th style="text-align: left; padding: 0.75rem 0.5rem; font-size: 0.85rem; color: var(--muted); font-weight: 600; text-transform: uppercase;">Description</th>
                  <th style="text-align: right; padding: 0.75rem 0.5rem; font-size: 0.85rem; color: var(--muted); font-weight: 600; text-transform: uppercase;">Montant</th>
                </tr>
              </thead>
                <tbody>
                  {% for intervention in interventions %}
                  <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 0.75rem 0.5rem;">{{ intervention.description }}</td>
                    <td style="padding: 0.75rem 0.5rem; text-align: right; font-weight: 600;">{{ intervention.montant }} ‚Ç¨</td>
                    <td style="padding: 0.75rem 0.5rem; text-align: center;">
                      <form method="POST" style="display:inline" onsubmit="syncNotesValidite(); return confirm('Supprimer cette ligne ?')">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_intervention">
                        <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                        
                        <!-- ‚úÖ NOUVEAUX CHAMPS CACH√âS -->
                        <input type="hidden" name="devis_notes_temp" id="hidden-notes-del-{{ intervention.id }}">
                        <input type="hidden" name="devis_validite_temp" id="hidden-validite-del-{{ intervention.id }}">
                        
                        <button type="submit" class="btn danger sm" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="syncNotesValiditeForDelete({{ intervention.id }})">√ó</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              <tfoot>
                <tr style="border-top: 2px solid var(--border);">
                  <td style="padding: 1rem 0.5rem; font-weight: 700; font-size: 1rem;">MONTANT TOTAL</td>
                  <td style="padding: 1rem 0.5rem; text-align: right; font-size: 1.3rem; font-weight: 700; color: var(--primary);">{{ montant_total }} ‚Ç¨</td>
                </tr>
              </tfoot>
            </table>
            
            {% if operation.devis_notes %}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border);">
              <strong style="font-size: 0.85rem; color: var(--muted);">üìù Notes :</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text); font-size: 0.9rem;">{{ operation.devis_notes }}</p>
            </div>
            {% endif %}
          </div>
          
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            SECTION GESTION DU DEVIS - VERSION CLAIRE
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
          
          <!-- En-t√™te -->
          <h4 style="margin: 0 0 1.5rem 0; color: #1e40af; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2"/>
            </svg>
            Gestion du devis
          </h4>

          <!-- ============================
              √âTAPE 1 : T√âL√âCHARGER LE PDF
              ============================ -->
          <div style="background: white; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #bfdbfe;">
            <h5 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700;">1</span>
              T√©l√©charger le devis PDF
            </h5>
            <p style="margin: 0 0 1rem 0; color: #1e40af; font-size: 0.9rem;">
              üí° T√©l√©chargez le devis au format PDF pour l'envoyer √† votre client.
            </p>
            <button type="button" class="btn primary" style="width: 100%; padding: 0.85rem;" onclick="alert('‚ö†Ô∏è Fonctionnalit√© PDF en cours de d√©veloppement (Phase 4)')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
              </svg>
              üì• T√©l√©charger le PDF
            </button>
          </div>

        <!-- ============================
            √âTAPE 2 : ENREGISTRER L'ENVOI
            ============================ -->
        <div style="background: white; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #bfdbfe;">
          <h5 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700;">2</span>
            Enregistrer la date d'envoi au client
          </h5>
          <p style="margin: 0 0 1rem 0; color: #1e40af; font-size: 0.9rem;">
            üí° Une fois le devis envoy√© au client (email, courrier, etc.), enregistrez la date d'envoi.
          </p>
          
          {% if not operation.devis_date_envoi %}
          <!-- Formulaire d'enregistrement de la date -->
          <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="action" value="enregistrer_date_envoi">
            
          <div style="display: grid; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: #1e40af; font-size: 0.9rem; font-weight: 600;">
                üìÖ Date d'envoi au client <span style="color: #ef4444;">*</span>
              </label>
              
              <div style="position: relative;">
                <input type="date" 
                      id="devis-date-envoi-temp" 
                      name="devis_date_envoi"
                      class="input" 
                      value="{{ now|date:'Y-m-d' }}"
                      style="background: white;"
                      required>
                
                <!-- ‚úÖ NOUVEAU : Alerte date pass√©e -->
                <div id="alerte-date-passee" style="display: none; margin-top: 0.5rem; padding: 0.5rem 0.75rem; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                    <path d="M12 9v4m0 4h0M12 3l9 18H3L12 3z"/>
                  </svg>
                  <span style="color: #991b1b; font-size: 0.85rem; font-weight: 600;">‚ö†Ô∏è Attention : date dans le pass√©</span>
                </div>
              </div>
              
              <small style="display: block; margin-top: 0.5rem; color: #1e40af; font-size: 0.85rem;">
                ‚ÑπÔ∏è Date √† laquelle vous envoyez le devis au client
              </small>
            </div>
            
            <!-- ‚úÖ RAPPEL : Rappel de la validit√© -->
            <div style="background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; padding: 1rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
                <strong style="color: #1e40af; font-size: 0.9rem;">Rappel - Validit√© du devis</strong>
              </div>
              <p style="margin: 0; color: #1e40af; font-size: 0.95rem;">
                ‚è≥ Ce devis est valable <strong>{{ operation.devis_validite_jours|default:30 }} jours</strong>
              </p>
              <small style="display: block; margin-top: 0.5rem; color: #1e40af; font-size: 0.85rem; opacity: 0.8;">
                üí° Le client aura jusqu'au <strong id="date-expiration-preview">...</strong> pour r√©pondre
              </small>
            </div>
          </div>


          <!-- Script pour calculer la date d'expiration + v√©rifier si date pass√©e (UNIQUEMENT √† la cr√©ation) -->
          <script>
          (function() {
            const dateInput = document.getElementById('devis-date-envoi-temp');
            const expirationPreview = document.getElementById('date-expiration-preview');
            const alertePassee = document.getElementById('alerte-date-passee');
            const validiteJours = {{ operation.devis_validite_jours|default:30 }};
            
            // ‚úÖ V√âRIFIER SI LA DATE EST D√âJ√Ä ENREGISTR√âE EN BASE
            const dateDejaEnregistree = {% if operation.devis_date_envoi %}true{% else %}false{% endif %};
            
            function updateAll() {
              if (!dateInput.value) return;
              
              const dateSelectionnee = new Date(dateInput.value);
              const aujourdhui = new Date();
              aujourdhui.setHours(0, 0, 0, 0); // R√©initialiser l'heure pour comparer seulement la date
              
              // ‚úÖ AFFICHER L'ALERTE UNIQUEMENT SI :
              // 1. La date n'est PAS d√©j√† enregistr√©e en base (premi√®re saisie)
              // 2. ET la date s√©lectionn√©e est dans le pass√©
              if (!dateDejaEnregistree && dateSelectionnee < aujourdhui) {
                alertePassee.style.display = 'flex';
              } else {
                alertePassee.style.display = 'none';
              }
              
              // ‚úÖ CALCULER DATE EXPIRATION
              const dateExpiration = new Date(dateSelectionnee);
              dateExpiration.setDate(dateExpiration.getDate() + validiteJours);
              
              const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
              expirationPreview.textContent = dateExpiration.toLocaleDateString('fr-FR', options);
            }
            
            // Calculer au chargement
            updateAll();
            
            // Recalculer quand la date change
            dateInput.addEventListener('change', updateAll);
            dateInput.addEventListener('input', updateAll); // Pour la mise √† jour en temps r√©el
          })();
          </script>


            <button type="submit" class="btn success" style="width: 100%; margin-top: 1rem; padding: 0.85rem; font-weight: 600;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m5 12 4 4 10-10"/>
              </svg>
              ‚úÖ Valider la date d'envoi
            </button>
          </form>
          
          {% else %}
          <!-- Date d√©j√† enregistr√©e -->
          <div style="display: grid; gap: 1rem;">
            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 1rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                  <path d="m5 12 4 4 10-10"/>
                </svg>
                <strong style="color: #22c55e; font-size: 0.95rem;">Date d'envoi enregistr√©e</strong>
              </div>
              <div style="color: #065f46; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem;">
                üìÖ {{ operation.devis_date_envoi|date:"d/m/Y" }}
              </div>
              
              <!-- Calcul de l'expiration -->
              {% if date_expiration_devis %}
              <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(34,197,94,0.2);">
                <div style="font-size: 0.85rem; color: #065f46;">
                  ‚è≥ Validit√© : {{ operation.devis_validite_jours }} jours
                </div>
                <div style="font-size: 0.85rem; {% if devis_expire %}color: #ef4444;{% else %}color: #065f46;{% endif %} margin-top: 0.25rem;">
                  üìÖ Date d'expiration : {{ date_expiration_devis|date:"d/m/Y" }}
                  
                  {% if devis_expire %}
                  <br><strong style="color: #ef4444;">‚ö†Ô∏è Devis expir√© !</strong>
                  {% else %}
                  <br><span style="color: #22c55e;">‚úÖ Devis valide</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>

          <!-- ============================
            √âTAPE 3 : R√âPONSE DU CLIENT
            ============================ -->
        <div style="background: white; border-radius: 10px; padding: 1.5rem; border: 1px solid #bfdbfe;">
          <h5 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700;">3</span>
            Enregistrer la r√©ponse du client
          </h5>
          <p style="margin: 0 0 1rem 0; color: #1e40af; font-size: 0.9rem;">
            üí° Une fois que le client a r√©pondu, cliquez sur le bouton correspondant.
          </p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <!-- ‚úÖ BOUTON ACCEPT√â -->
            <form method="POST" onsubmit="return validateDateEnvoi('accepter')">
              {% csrf_token %}
              <input type="hidden" name="action" value="accepter_devis">
              <button type="submit" class="btn success" style="width: 100%; padding: 1rem; font-weight: 600; font-size: 0.95rem;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="m5 12 4 4 10-10"/>
                </svg>
                ‚úÖ Accept√© par le client
              </button>
            </form>
            
            <!-- ‚ùå BOUTON REFUS√â -->
            <form method="POST" onsubmit="return validateDateEnvoi('refuser')">
              {% csrf_token %}
              <input type="hidden" name="action" value="refuser_devis">
              <button type="submit" class="btn danger" style="width: 100%; padding: 1rem; font-weight: 600; font-size: 0.95rem;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6 6 18M6 6l12 12"/>
                </svg>
                ‚ùå Refus√© par le client
              </button>
            </form>
          </div>
          
          <!-- ‚ÑπÔ∏è INFO CLIENT NE R√âPOND PAS -->
          <div style="margin-top: 1rem; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
            <small style="color: #64748b; font-size: 0.85rem; display: block;">
              üí¨ <strong>Le client ne r√©pond pas ?</strong><br>
              Relancez-le par t√©l√©phone ou email. Si le devis est abandonn√©, cliquez sur "‚ùå Refus√©".
            </small>
          </div>
        </div>
        </div>

          <script>
          // ‚úÖ VALIDATION SIMPLIFI√âE (2 boutons seulement)
          function validateDateEnvoi(action) {
            {% if not operation.devis_date_envoi %}
            // ‚ö†Ô∏è Si pas de date d'envoi, bloquer
            showToast('‚ö†Ô∏è Veuillez d\'abord enregistrer la date d\'envoi du devis', 'warning');
            
            // Scroll vers le formulaire de date d'envoi
            const dateEnvoiSection = document.querySelector('[name="devis_date_envoi"]');
            if (dateEnvoiSection) {
              dateEnvoiSection.closest('.info-card, div').scrollIntoView({ behavior: 'smooth', block: 'center' });
              dateEnvoiSection.focus();
              dateEnvoiSection.style.border = '2px solid var(--danger)';
              setTimeout(() => {
                dateEnvoiSection.style.border = '';
              }, 2000);
            }
            
            return false;
            {% endif %}
            
            // Confirmation pour refus
            if (action === 'refuser') {
              return confirm('‚ö†Ô∏è Confirmer le refus du devis ?\n\nVous pourrez cr√©er un nouveau devis modifi√© juste apr√®s.');
            }
            
            return true;
          }
          </script>

        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            √âTAT 3 : DEVIS ACCEPT√â (RESTE OUVERT)
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        {% elif operation.devis_statut == 'accepte' %}
        
        <div style="border: 2px solid var(--success); border-radius: 12px; padding: 2rem; background: white;">
          
          <!-- En-t√™te avec badge accept√© -->
          <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
            <h3 style="margin: 0; color: var(--success); font-size: 1.3rem; font-weight: 700;">
              Devis N¬∞ {{ operation.numero_devis }}
            </h3>
            <div style="background: var(--success); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m5 12 4 4 10-10"/>
              </svg>
              Accept√© le {{ operation.devis_date_reponse|date:"d/m/Y" }}
            </div>
          </div>
          
          <!-- Lignes du devis (lecture seule) -->
          <div style="margin-bottom: 2rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">Lignes du devis</h4>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid var(--border);">
                  <th style="text-align: left; padding: 0.75rem 0.5rem; font-size: 0.85rem; color: var(--muted); font-weight: 600; text-transform: uppercase;">Description</th>
                  <th style="text-align: right; padding: 0.75rem 0.5rem; font-size: 0.85rem; color: var(--muted); font-weight: 600; text-transform: uppercase;">Montant</th>
                </tr>
              </thead>
              <tbody>
                {% for intervention in interventions %}
                <tr style="border-bottom: 1px solid var(--border);">
                  <td style="padding: 0.75rem 0.5rem;">{{ intervention.description }}</td>
                  <td style="padding: 0.75rem 0.5rem; text-align: right; font-weight: 600;">{{ intervention.montant }} ‚Ç¨</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr style="border-top: 2px solid var(--border); background: #f0fdf4;">
                  <td style="padding: 1rem 0.5rem; font-weight: 700; font-size: 1rem; color: var(--success);">MONTANT TOTAL üîí</td>
                  <td style="padding: 1rem 0.5rem; text-align: right; font-size: 1.3rem; font-weight: 700; color: var(--success);">{{ montant_total }} ‚Ç¨</td>
                </tr>
              </tfoot>
            </table>
            
            {% if operation.devis_notes %}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border);">
              <strong style="font-size: 0.85rem; color: var(--muted);">üìù Notes :</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text); font-size: 0.9rem;">{{ operation.devis_notes }}</p>
            </div>
            {% endif %}
          </div>
          
          <!-- Informations acceptation -->
          <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid var(--success); border-radius: 10px; padding: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              
              <div>
                <div style="color: var(--success); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">üìÖ Date d'envoi</div>
                <div style="color: #065f46; font-size: 1rem; font-weight: 700;">{{ operation.devis_date_envoi|date:"d/m/Y" }}</div>
              </div>
              
              <div>
                <div style="color: var(--success); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">‚úÖ Date d'acceptation</div>
                <div style="color: #065f46; font-size: 1rem; font-weight: 700;">{{ operation.devis_date_reponse|date:"d/m/Y" }}</div>
              </div>
              
              {% if operation.devis_date_envoi and operation.devis_date_reponse %}
              <div>
                <div style="color: var(--success); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">‚è±Ô∏è D√©lai de r√©ponse</div>
                <div style="color: #065f46; font-size: 1rem; font-weight: 700;">
                  {% widthratio operation.devis_date_reponse|date:"U" 1 1 as date_reponse_unix %}
                  {% widthratio operation.devis_date_envoi|date:"U" 1 1 as date_envoi_unix %}
                  {% widthratio date_reponse_unix|add:"-"|add:date_envoi_unix 86400 1 as delai_jours %}
                  {{ delai_jours }} jour{{ delai_jours|pluralize }}
                </div>
              </div>
              {% endif %}
              
              <div>
                <div style="color: var(--success); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">üîí Statut</div>
                <div style="color: #065f46; font-size: 1rem; font-weight: 700;">Montant verrouill√©</div>
              </div>
              
            </div>
            
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(34,197,94,0.2); color: #065f46; font-size: 0.85rem;">
              ‚ÑπÔ∏è Le statut de l'op√©ration est pass√© automatiquement √† <strong>"√Ä planifier"</strong>
            </div>
          </div>
          
        </div>
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            √âTAT 4 : DEVIS REFUS√â
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        {% elif operation.devis_statut == 'refuse' %}

        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 2rem;">
          
          <!-- Alerte refus -->
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="width: 48px; height: 48px; background: #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M18 6 6 18M6 6l12 12"/>
              </svg>
            </div>
            <div>
              <h3 style="margin: 0; color: #92400e; font-size: 1.2rem; font-weight: 700;">
                Devis {{ operation.numero_devis }} refus√©
              </h3>
              <p style="margin: 0.25rem 0 0 0; color: #92400e; font-size: 0.9rem;">
                Montant : {{ montant_total }} ‚Ç¨ ‚Ä¢ Date de refus : {{ operation.devis_date_reponse|date:"d/m/Y" }}
              </p>
            </div>
          </div>
          
          <!-- Options -->
          <div style="background: white; border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem;">
            <h4 style="margin: 0 0 1rem 0; color: #92400e; font-size: 1rem; font-weight: 600;">
              üîÑ Que souhaitez-vous faire ?
            </h4>
            
            <div style="display: grid; gap: 1rem;">
              <!-- Option 1 : Cr√©er nouveau devis -->
              {% if operation.peut_creer_nouveau_devis %}
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="creer_nouveau_devis">
                <button type="submit" class="btn primary" style="width: 100%; padding: 1rem; justify-content: center;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                  üìù Cr√©er un nouveau devis modifi√©
                </button>
              </form>
              <small style="color: #92400e; font-size: 0.85rem; text-align: center; display: block; margin-top: -0.5rem;">
                üí° Vous pourrez modifier les lignes et le montant
              </small>
              {% endif %}
              
              <!-- Option 2 : Abandonner -->
              <a href="{% url 'operations' %}" class="btn" style="width: 100%; padding: 1rem; justify-content: center; text-decoration: none;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Retour aux op√©rations (abandonner)
              </a>
            </div>
          </div>
          
          <!-- Archive ancien devis -->
          {% if operation.devis_historique_numeros %}
          <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 1rem;">
            <small style="color: #92400e; font-size: 0.85rem;">
              üì¶ <strong>Historique :</strong> {{ operation.devis_historique_numeros }}
            </small>
          </div>
          {% endif %}
        </div>
        
        {% endif %}
        
      </div>
    </section>
    {% endif %}

    <!-- ========================================
        FIN SECTION DEVIS
        ======================================== -->

<!-- ‚úÖ SCRIPT DE SYNCHRONISATION (D√âPLAC√â ICI POUR √äTRE S√õR QU'IL S'EX√âCUTE) -->
<script>
(function() {
  // Attendre que tout le DOM soit charg√©
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSyncDevis);
  } else {
    initSyncDevis();
  }
  
function initSyncDevis() {
  const formGenererDevis = document.getElementById('form-generer-devis');
  
  if (formGenererDevis) {
    console.log('‚úÖ Formulaire trouv√©, installation du listener...');
    
    formGenererDevis.addEventListener('submit', function(e) {
      console.log('üì§ Formulaire soumis - Synchronisation en cours...');
      
      // ‚úÖ SYNCHRONISATION FINALE (par s√©curit√©)
      syncNotesValidite();
      
      // 1Ô∏è‚É£ Copier les NOTES
      const notesTemp = document.getElementById('devis-notes-temp');
      const notesHidden = document.getElementById('devis-notes-hidden');
      
      if (notesTemp && notesHidden) {
        notesHidden.value = notesTemp.value;
        console.log('‚úÖ Notes copi√©es:', notesTemp.value);
      }
      
      // 2Ô∏è‚É£ Copier la VALIDIT√â
      const validiteTemp = document.getElementById('devis-validite-temp');
      const validiteHidden = document.getElementById('devis-validite-hidden');
      
      if (validiteTemp && validiteHidden) {
        validiteHidden.value = validiteTemp.value;
        console.log('‚úÖ Validit√© copi√©e:', validiteTemp.value);
      }
    });
    
    console.log('‚úÖ Listener install√© avec succ√®s');
  }
}
})();
</script>

    <!-- ========================================
        LIGNES DU DEVIS (visible seulement si devis envoy√© OU pas de devis)
        ‚ö†Ô∏è MASQU√â si le devis est accept√© (pour √©viter le doublon)
        ======================================== -->
    {% if operation.devis_statut != 'accepte' %}
    <section class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.6"/></svg>
          {% if operation.avec_devis %}
            üìã Lignes du devis
          {% else %}
            üîß Lignes d'intervention
          {% endif %}
          
          {% if interventions %}
          <span class="section-badge complete">
            {{ interventions.count }} ligne{{ interventions.count|pluralize }}
          </span>
          {% else %}
          <span class="section-badge pending">Aucune ligne</span>
          {% endif %}
        </h2>
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      
      <div class="section-body">
        <!-- Verrouillage si devis accept√© -->
        {% if operation.devis_statut == 'accepte' %}
        <div class="alert info" style="margin-bottom: 1rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="1.6"/><path d="M12 11V7a2 2 0 1 1 4 0v4m-8 0V7a2 2 0 0 1 2-2" stroke="currentColor" stroke-width="1.6"/></svg>
          <div>
            <strong>üîí Montant verrouill√©</strong><br>
            Le devis a √©t√© accept√©, les lignes ne peuvent plus √™tre modifi√©es.
          </div>
        </div>
        {% endif %}
        
        {% if interventions %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th style="width:120px">Montant (‚Ç¨)</th>
                {% if operation.devis_statut != 'accepte' %}
                <th style="width:100px">Actions</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for intervention in interventions %}
              <tr>
                <td>{{ intervention.description }}</td>
                <td><strong>{{ intervention.montant }}</strong></td>
                {% if operation.devis_statut != 'accepte' %}
                <td>
                  <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette ligne ?')">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_intervention">
                    <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                    <button type="submit" class="btn danger sm">Supprimer</button>
                  </form>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td><strong>TOTAL</strong></td>
                <td><strong>{{ montant_total }} ‚Ç¨</strong></td>
                {% if operation.devis_statut != 'accepte' %}
                <td></td>
                {% endif %}
              </tr>
            </tfoot>
          </table>
        </div>
        {% else %}
        <div class="alert info">Aucune ligne</div>
        {% endif %}

        <!-- Formulaire ajout (masqu√© si verrouill√©) -->
        {% if operation.devis_statut != 'accepte' %}
        <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border)">
          <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Ajouter une ligne</h4>
          <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_intervention">
            <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
              <div style="flex:1; min-width:250px">
                <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Description</label>
                <input type="text" name="description" class="input" placeholder="Ex: Main d'≈ìuvre, Fournitures..." required>
              </div>
              <div style="flex:0 0 150px">
                <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Montant (‚Ç¨)</label>
                <input type="number" name="montant" class="input" placeholder="0.00" step="0.01" required>
              </div>
              <button type="submit" class="btn success">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                Ajouter
              </button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>
    </section>
    {% endif %}


        <!-- ========================================
            PLANIFICATION - AVEC AFFICHAGE CONDITIONNEL
            ======================================== -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6"/></svg>
              Planification
              
              {% if operation.statut == 'realise' or operation.statut == 'paye' %}
                <span class="section-badge complete">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  R√©alis√©e
                </span>
              {% elif operation.date_prevue %}
                <span class="section-badge complete">
                  üìÖ {{ operation.date_prevue|date:"d/m/Y H:i" }}
                </span>
              {% else %}
                <span class="section-badge pending">√Ä planifier</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            
            {% if operation.statut == 'realise' or operation.statut == 'paye' %}
            <!-- ========================================
                MODE 1 : AFFICHAGE R√âALIS√âE (LECTURE SEULE)
                ======================================== -->
            <div class="alert success" style="margin-bottom:1rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
              <div>
                <strong>‚úÖ Intervention r√©alis√©e</strong>
                {% if operation.date_realisation %}
                  <br>Date de r√©alisation : <strong>{{ operation.date_realisation|date:"d/m/Y √† H:i" }}</strong>
                {% endif %}
              </div>
            </div>
            
            <div class="info-grid">
              {% if operation.date_prevue %}
              <div class="info-card">
                <div class="label">üìÖ Date pr√©vue initialement</div>
                <div class="value">{{ operation.date_prevue|date:"d/m/Y √† H:i" }}</div>
              </div>
              {% endif %}
              
              {% if operation.date_realisation %}
              <div class="info-card">
                <div class="label">‚úÖ Date de r√©alisation</div>
                <div class="value" style="color:var(--success); font-weight:700">
                  {{ operation.date_realisation|date:"d/m/Y √† H:i" }}
                </div>
              </div>
              {% endif %}
            </div>
            
            <!-- Bouton pour corriger si besoin -->
            <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border)">
              <button type="button" class="btn" onclick="toggleModificationDates()" style="width:100%">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="1.6"/></svg>
                Corriger les dates (si erreur)
              </button>
            </div>
            
            <!-- Formulaire de correction (cach√© par d√©faut) -->
            <div id="modification-dates-form" style="display:none; margin-top:1rem; padding:1rem; background:#fef3c7; border:1px solid #fde68a; border-radius:8px">
              <h4 style="margin-bottom:1rem; color:#92400e">‚ö†Ô∏è Correction des dates</h4>
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="corriger_dates_realisation">
                
                <div class="info-grid" style="margin-bottom:1rem">
                  <div class="info-card">
                    <div class="label">Date de r√©alisation</div>
                    <div class="value">
                      <input type="datetime-local" 
                            id="correction-date-realisation"
                            name="date_realisation" 
                            class="input" 
                            value="{% if operation.date_realisation %}{{ operation.date_realisation|date:'Y-m-d\TH:i' }}{% endif %}"
                            max="{{ now|date:'Y-m-d\TH:i' }}" 
                            required>
                    </div>
                  </div>
                </div>
                
                <div style="display:flex; gap:1rem">
                  <button type="button" class="btn" onclick="toggleModificationDates()" style="flex:1">Annuler</button>
                  <button type="submit" class="btn primary" style="flex:1">Enregistrer la correction</button>
                </div>
              </form>
            </div>
            
            {% else %}
            <!-- ========================================
                MODE 2 : PLANIFICATION ACTIVE (MODIFIABLE)
                ======================================== -->
            <form method="POST" id="planning-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_planning">
              
              <div class="info-card" style="margin-bottom:1rem">
                <div class="label">Date d'intervention pr√©vue</div>
                <div class="value">
                  <input type="datetime-local" 
                        id="date-prevue-input" 
                        name="date_prevue" 
                        class="input" 
                        value="{% if operation.date_prevue %}{{ operation.date_prevue|date:'Y-m-d\TH:i' }}{% endif %}"
                        required>
                </div>
              </div>
              
              <!-- Alerte si date pass√©e -->
              <div class="alert warning" id="date-passee-alert" style="display:none; margin-bottom:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0M12 3l9 18H3L12 3z" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>‚ö†Ô∏è Date d√©pass√©e !</strong> La date pr√©vue est dans le pass√©. Validez la r√©alisation ou modifiez la date.</div>
              </div>
              
              <!-- Info replanification -->
              {% if operation.date_prevue and operation.statut == 'planifie' %}
              <div class="alert info" style="margin-bottom:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
                <div>üí° <strong>Actuellement planifi√© le {{ operation.date_prevue|date:"d/m/Y √† H:i" }}</strong><br>
                Modifiez la date ci-dessus pour replanifier.</div>
              </div>
              {% endif %}
              
              <div style="display:flex; gap:1rem; flex-wrap:wrap">
                <button type="submit" class="btn primary" style="flex:1">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  {% if operation.date_prevue %}Replanifier{% else %}Enregistrer la date{% endif %}
                </button>
                
                {% if operation.date_prevue %}
                <button type="button" class="btn success" style="flex:1" onclick="toggleRealisationForm()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  Valider la r√©alisation
                </button>
                {% endif %}
              </div>
            </form>
            
            <!-- Formulaire de validation r√©alisation (cach√© par d√©faut) -->
            <div id="realisation-form" style="display:none; margin-top:1.5rem; padding-top:1.5rem; border-top:2px solid var(--border)">
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="valider_realisation">
                
                <h4 style="margin-bottom:1rem; color:var(--success); font-size:1.1rem; display:flex; align-items:center; gap:.5rem">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  Validation de la r√©alisation
                </h4>
                
                <div class="info-card" style="margin-bottom:1rem">
                  <div class="label">Date de r√©alisation effective</div>
                  <div class="value">
                    <input type="datetime-local" 
                          id="date-realisation-input" 
                          name="date_realisation" 
                          class="input" 
                          max="{{ now|date:'Y-m-d\TH:i' }}"
                          required>
                    <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                      ‚ö†Ô∏è La date ne peut pas √™tre dans le futur
                    </small>
                  </div>
                </div>
                
                <div style="display:flex; gap:1rem">
                  <button type="button" class="btn" onclick="toggleRealisationForm()" style="flex:1">
                    Annuler
                  </button>
                  <button type="submit" class="btn success" style="flex:1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    Confirmer la r√©alisation
                  </button>
                </div>
              </form>
            </div>
            {% endif %}
            
          </div>
        </section>


        <!-- ========================================
            PAIEMENT - VERSION SIMPLIFI√âE
            ======================================== -->
        {% if operation.devis_statut == 'accepte' or operation.statut == 'realise' or operation.statut == 'paye' %}
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 8.5h20M2 12.5h20M6 16.5h8M6 20.5h8M6 4.5h8" stroke="currentColor" stroke-width="1.6"/></svg>
              Paiement
              {% if operation.statut == 'paye' %}
              <span class="section-badge complete">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                Sold√©
              </span>
              {% elif echeances %}
              <span class="section-badge pending">{{ total_echeances }} ‚Ç¨ / {{ montant_total }} ‚Ç¨</span>
              {% else %}
              <span class="section-badge disabled">Aucun paiement</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">

            <!-- ========================================
                R√âCAPITULATIF FINANCIER AM√âLIOR√â
                ======================================== -->
            <div class="payment-box" style="margin-bottom:1.5rem">
              <div class="info-grid">
                <div class="info-card">
                  <div class="label">üí∞ Montant total</div>
                  <div class="value" style="font-size:1.5rem; color:var(--primary); font-weight:700">
                    {{ montant_total }} ‚Ç¨
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">‚úÖ Pay√©</div>
                  <div class="value" style="font-size:1.5rem; color:var(--success); font-weight:700">
                    {{ total_echeances|default:0 }} ‚Ç¨
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">‚è≥ En attente</div>
                  <div class="value" style="font-size:1.2rem; color:var(--warning); font-weight:600">
                    {{ total_echeances_prevus|default:0 }} ‚Ç¨
                  </div>
                  <small style="color:var(--muted); font-size:0.8rem">Pr√©vus non pay√©s</small>
                </div>
                
                <div class="info-card">
                  <div class="label">üéØ Reste √† enregistrer</div>
                  <div class="value" style="font-size:1.5rem; font-weight:700; color:{% if reste_a_enregistrer == 0 %}var(--success){% elif reste_a_enregistrer < 0 %}var(--danger){% else %}var(--warning){% endif %}">
                    {{ reste_a_enregistrer|default:montant_total }} ‚Ç¨
                  </div>
                </div>
              </div>
              
              <!-- Alerte si d√©passement -->
              {% if reste_a_enregistrer < 0 %}
              <div class="alert danger" style="margin-top:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="2"/></svg>
                <div>
                  <strong>‚ö†Ô∏è ATTENTION : D√©passement de {{ reste_a_enregistrer_abs }} ‚Ç¨ !</strong><br>
                  Total enregistr√© ({{ total_echeances_tout }} ‚Ç¨) > Montant op√©ration ({{ montant_total }} ‚Ç¨)
                </div>
              </div>
              {% endif %}
              
              {% if reste_a_enregistrer == 0 and reste_a_payer == 0 %}
              <div class="alert success" style="margin-top:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                <div><strong>üéâ Op√©ration sold√©e !</strong> Tous les paiements ont √©t√© re√ßus.</div>
              </div>
              {% elif reste_a_enregistrer == 0 and reste_a_payer > 0 %}
              <div class="alert info" style="margin-top:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>üí° Tous les paiements sont enregistr√©s</strong> - En attente de validation de {{ total_echeances_prevus }} ‚Ç¨</div>
              </div>
              {% endif %}
            </div>

            <!-- ========================================
                LISTE DES PAIEMENTS
                ======================================== -->
            {% if echeances %}
            <div class="payment-box" style="margin-bottom:1.5rem">
              <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem; display:flex; align-items:center; gap:.5rem">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4" stroke="currentColor" stroke-width="1.6"/></svg>
                Historique des paiements
              </h4>
              
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Montant</th>
                      <th>Statut</th>
                      <th style="width:100px">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for echeance in echeances %}
                    <tr style="{% if echeance.paye %}background: #f0fdf4;{% elif echeance.date_echeance|date:'Y-m-d' < now|date:'Y-m-d' %}background: #fee2e2;{% endif %}">
                      <td>
                        <strong>{{ echeance.date_echeance|date:"d/m/Y" }}</strong>
                        {% if echeance.date_echeance|date:'Y-m-d' < now|date:'Y-m-d' and not echeance.paye %}
                        <br><small style="color:var(--danger)">‚ö†Ô∏è En retard</small>
                        {% endif %}
                      </td>
                      <td><strong>{{ echeance.montant }} ‚Ç¨</strong></td>
                      <td>
                        {% if echeance.paye %}
                          <span style="color:var(--success); font-weight:600; display:flex; align-items:center; gap:.3rem">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                            Pay√©
                          </span>
                        {% else %}
                          <span style="color:var(--warning); font-weight:600; display:flex; align-items:center; gap:.3rem">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.6"/><path d="M12 8v4" stroke="currentColor" stroke-width="1.6"/></svg>
                            En attente
                          </span>
                        {% endif %}
                      </td>
                      <td>
                        <div style="display:flex; gap:.3rem">
                          {% if not echeance.paye %}
                          <form method="POST" style="display:inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="marquer_paye">
                            <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                            <button type="submit" class="btn success sm" title="Marquer comme pay√©">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                          </form>
                          {% endif %}
                          
                          <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer ce paiement ?')">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_paiement">
                            <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                            <button type="submit" class="btn danger sm">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr style="background: #eef2ff; font-weight:700">
                      <td><strong>TOTAL PAY√â</strong></td>
                      <td><strong>{{ total_echeances|default:0 }} ‚Ç¨</strong></td>
                      <td colspan="2"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            {% endif %}

            <!-- ========================================
                FORMULAIRE D'AJOUT DE PAIEMENT
                ======================================== -->
            <div class="payment-box">
              <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem; display:flex; align-items:center; gap:.5rem">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                {% if echeances %}Ajouter un paiement{% else %}Enregistrer le premier paiement{% endif %}
              </h4>
              
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_paiement">
                
                <div class="info-grid" style="margin-bottom:1rem">
                  <div class="info-card">
                    <div class="label">üíµ Montant (‚Ç¨)</div>
                    <div class="value">
                      <input type="number" 
                            name="montant" 
                            class="input" 
                            placeholder="Ex: 500" 
                            step="0.01" 
                            min="0.01" 
                            max="{{ max_paiement }}"
                            required>
                      <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                        {% if reste_a_enregistrer > 0 %}
                          üí° Reste √† enregistrer : <strong>{{ reste_a_enregistrer }} ‚Ç¨</strong>
                        {% elif reste_a_enregistrer == 0 %}
                          ‚úÖ Tous les paiements sont enregistr√©s
                        {% else %}
                          ‚ö†Ô∏è D√©passement de {{ reste_a_enregistrer_abs }} ‚Ç¨
                        {% endif %}
                      </small>
                    </div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">üìÖ Date du paiement</div>
                    <div class="value">
                      <input type="date" 
                            name="date_paiement" 
                            class="input" 
                            value="{{ now|date:'Y-m-d' }}"
                            required>
                      <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                        üí° Date pr√©vue ou effective
                      </small>
                    </div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">‚úÖ Statut</div>
                    <div class="value">
                      <select name="paye" class="select">
                        <option value="true">D√©j√† pay√©</option>
                        <option value="false">Pr√©vu / √Ä venir</option>
                      </select>
                      <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                        üí° "D√©j√† pay√©" = re√ßu aujourd'hui<br>
                        "Pr√©vu" = attendu plus tard
                      </small>
                    </div>
                  </div>
                </div>
                
                <button type="submit" class="btn success" style="width:100%">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                  Enregistrer ce paiement
                </button>
              </form>
            </div>
            
            <!-- Info aide -->
            {% if not echeances %}
            <div class="alert info" style="margin-top:1rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              <div>
                <strong>üí° Comment √ßa marche ?</strong><br>
                ‚Ä¢ Ajoutez un paiement quand vous voulez<br>
                ‚Ä¢ Vous pouvez enregistrer des acomptes, le solde, ou tout en une fois<br>
                ‚Ä¢ Marquez "D√©j√† pay√©" si c'est re√ßu, sinon "Pr√©vu"<br>
                ‚Ä¢ Quand tout est pay√©, l'op√©ration passe automatiquement en statut "Pay√©"
              </div>
            </div>
            {% endif %}
            
          </div>
        </section>
        {% endif %}
      </div>

      <!-- ========================================
     COLONNE DROITE - HISTORIQUE
     ======================================== -->
<div class="right-column">
  <section class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <h2 class="section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
        Historique
        {% if historique %}
        <span class="section-badge complete">
          {{ historique.count }} √©v√©nement{{ historique.count|pluralize }}
        </span>
        {% endif %}
      </h2>
      <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="section-body">
      {% if historique %}
      <div class="table-wrap">
        <table>
          <thead><tr><th>Date</th><th>Action</th></tr></thead>
          <tbody>
            {% for entry in historique %}
            <tr>
              <td style="font-size:.85rem">{{ entry.date|date:"d/m H:i" }}</td>
              <td style="font-size:.9rem">{{ entry.action }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert info">Aucun historique</div>
      {% endif %}
    </div>
  </section>

<!-- ‚úÖ SECTION COMMENTAIRES (UN SEUL BLOC) -->
<section class="section sticky-notes">
  <div class="section-header" onclick="toggleSection(this)">
    <h2 class="section-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M7 8h10M7 12h4m1 8-4-4H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3l-4 4Z" stroke="currentColor" stroke-width="1.6"/>
      </svg>
      Commentaires
    </h2>
    <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>
  
  <div class="section-body">
    <form method="POST" id="commentaires-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_commentaires">
      
      <textarea 
        id="commentaires-textarea" 
        name="commentaires" 
        class="notes-textarea" 
        rows="6" 
        placeholder=""
      >{{ operation.commentaires|default:'' }}</textarea>
      
      <div class="notes-actions">
        <button type="submit" class="btn success" title="Enregistrer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m5 12 4 4 10-10"/>
          </svg>
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</section>
</div> <!-- ‚úÖ FIN DE .right-column (ICI, APR√àS LES COMMENTAIRES) -->
</div> <!-- ‚úÖ FIN DE .main-content -->

<div style="margin-top:1.5rem">
  <a href="{% url 'operations' %}" class="btn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5"/></svg>
    Retour aux op√©rations
  </a>
</div>
</div> <!-- ‚úÖ FIN DE .container -->

<script>
// ========================================
// ‚úÖ FONCTIONS GLOBALES (DOIVENT √äTRE EN PREMIER)
// ========================================

// Fonction de confirmation de suppression
function confirmDeleteOperation() {
  const id = '{{ operation.id_operation }}';
  const type = '{{ operation.type_prestation|escapejs }}';
  const client = '{{ operation.client.nom }} {{ operation.client.prenom }}';
  const interventions = {{ interventions.count|default:0 }};
  const echeances = {{ echeances.count|default:0 }};
  
  let message = '‚ö†Ô∏è ATTENTION : Supprimer l\'op√©ration ' + id + ' ?\n\n';
  message += 'üìã Type : ' + type + '\n';
  message += 'üë§ Client : ' + client + '\n';
  
  if (interventions > 0) {
    message += '\nüî∏ ' + interventions + ' ligne(s) d\'intervention seront supprim√©e(s)';
  }
  
  if (echeances > 0) {
    message += '\nüí∞ ' + echeances + ' √©ch√©ance(s) de paiement seront supprim√©e(s)';
  }
  
  message += '\n\nüö® Cette action est IRR√âVERSIBLE !';
  
  return confirm(message);
}

// Fonction de toggle des sections
function toggleSection(header) {
  const section = header.closest('.section');
  const body = section.querySelector('.section-body');
  
  header.classList.toggle('collapsed');
  body.classList.toggle('collapsed');
  
  const sectionTitle = header.querySelector('.section-title').textContent.trim();
  const isCollapsed = body.classList.contains('collapsed');
  localStorage.setItem(`section-${sectionTitle}`, isCollapsed ? 'collapsed' : 'expanded');
}

// ========================================
// SYST√àME DE NOTIFICATIONS TOAST
// ========================================
function showToast(message, type = 'info', duration = 5000) {
  const container = document.getElementById('toast-container');
  if (!container) return;
  
  // Cr√©er le toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  // Ic√¥ne selon le type
  let icon = '';
  switch(type) {
    case 'success':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m5 12 4 4 10-10"/></svg>';
      break;
    case 'error':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6m0-6 6 6"/></svg>';
      break;
    case 'warning':
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4m0 4h0M12 3l9 18H3L12 3z"/></svg>';
      break;
    case 'info':
    default:
      icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h0"/></svg>';
      break;
  }
  
  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-content">${message}</div>
    <button class="toast-close" onclick="dismissToast(this)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6 6 18M6 6l12 12"/>
      </svg>
    </button>
  `;
  
  container.appendChild(toast);
  
  // Auto-dismiss
  setTimeout(() => {
    dismissToast(toast.querySelector('.toast-close'));
  }, duration);
}

function dismissToast(button) {
  const toast = button.closest('.toast');
  if (!toast) return;
  
  toast.classList.add('hiding');
  setTimeout(() => {
    toast.remove();
  }, 300);
}

// Afficher les messages Django au chargement
window.addEventListener('DOMContentLoaded', function() {
  const messagesContainer = document.getElementById('django-messages');
  if (messagesContainer) {
    const messages = messagesContainer.querySelectorAll('[data-message]');
    messages.forEach((msg, index) => {
      setTimeout(() => {
        const type = msg.dataset.type || 'info';
        const message = msg.dataset.message;
        showToast(message, type);
      }, index * 200); // D√©lai entre chaque toast
    });
  }
});

// ========================================
// ‚úÖ FONCTION GLOBALE POUR LA PLANIFICATION
// ========================================
window.toggleRealisationForm = function() {
  const realisationForm = document.getElementById('realisation-form');
  const dateRealisationInput = document.getElementById('date-realisation-input');
  const datePrevueInput = document.getElementById('date-prevue-input');
  
  if (!realisationForm) return;
  
  const isVisible = realisationForm.style.display !== 'none';
  
  if (isVisible) {
    // Fermer
    realisationForm.style.display = 'none';
  } else {
    // Ouvrir et pr√©-remplir avec la date de planification (ou maintenant si pas de date pr√©vue)
    realisationForm.style.display = 'block';
    if (dateRealisationInput) {
      // ‚úÖ NOUVEAU : Utiliser la date pr√©vue si elle existe, sinon la date actuelle
      if (datePrevueInput && datePrevueInput.value) {
        dateRealisationInput.value = datePrevueInput.value;
      } else {
        const now = new Date();
        const pad = n => String(n).padStart(2, '0');
        dateRealisationInput.value = now.getFullYear() + '-' + 
                                      pad(now.getMonth() + 1) + '-' + 
                                      pad(now.getDate()) + 'T' + 
                                      pad(now.getHours()) + ':' + 
                                      pad(now.getMinutes());
      }
    }
    // Scroll smooth vers le formulaire
    realisationForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ========================================
// ‚úÖ FONCTION POUR CORRIGER LES DATES (R√âALIS√â)
// ========================================
window.toggleModificationDates = function() {
  const modificationForm = document.getElementById('modification-dates-form');
  if (!modificationForm) return;
  
  const isVisible = modificationForm.style.display !== 'none';
  modificationForm.style.display = isVisible ? 'none' : 'block';
  
  if (!isVisible) {
    modificationForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ========================================
// INITIALISATION AU CHARGEMENT DE LA PAGE
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  
  // Fonctions utilitaires
  function getNowFormatted() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
  }

  function getTodayDate() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate());
  }

  function formatMontant(montant) {
    return new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2}).format(montant) + ' ‚Ç¨';
  }

  // Gestion du statut du devis
  const devisCreeSelect = document.getElementById('devis-cree');
  const devisDetails = document.getElementById('devis-details');
  const noDevisAlert = document.getElementById('no-devis-alert');
  const devisStatutSelect = document.getElementById('devis-statut');

  function updateDevisDisplay() {
    const isCreated = devisCreeSelect.value === 'oui';
    
    const devisDetails = document.getElementById('devis-details');
    const noDevisSection = document.getElementById('no-devis-section');
    
    if (devisDetails) {
      if (isCreated) {
        devisDetails.classList.remove('hidden');
        devisDetails.style.display = 'block';
      } else {
        devisDetails.classList.add('hidden');
        devisDetails.style.display = 'none';
      }
    }
    
    if (noDevisSection) {
      noDevisSection.style.display = isCreated ? 'none' : 'block';
    }
    
    if (isCreated && devisStatutSelect) {
      updateDevisAlerts();
    } else {
      hideAllDevisAlerts();
    }
  }

  function updateDevisAlerts() {
    if (!devisStatutSelect) return;
    
    const statut = devisStatutSelect.value;
    
    const alerts = {
      'devis-accepte-alert': statut === 'accepte',
      'devis-refuse-alert': statut === 'refuse',
      'devis-attente-alert': false,
      'devis-relance-alert': statut === 'relance'
    };
    
    Object.keys(alerts).forEach(alertId => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.display = alerts[alertId] ? 'flex' : 'none';
      }
    });
  }

  function hideAllDevisAlerts() {
    ['devis-accepte-alert', 'devis-refuse-alert', 'devis-attente-alert', 'devis-relance-alert'].forEach(alertId => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.display = 'none';
      }
    });
  }

  if (devisCreeSelect) {
    devisCreeSelect.addEventListener('change', updateDevisDisplay);
    updateDevisDisplay();
  }

  if (devisStatutSelect) {
    devisStatutSelect.addEventListener('change', updateDevisAlerts);
    if (devisCreeSelect && devisCreeSelect.value === 'oui') {
      updateDevisAlerts();
    }
  }

// ========================================
// GESTION PLANIFICATION SIMPLIFI√âE
// ========================================
const datePrevueInput = document.getElementById('date-prevue-input');
const dateRealisationInput = document.getElementById('date-realisation-input');
const datePasseeAlert = document.getElementById('date-passee-alert');

// V√©rifier si date pass√©e
function checkDatePassee() {
  if (!datePrevueInput || !datePasseeAlert) return;
  
  if (datePrevueInput.value) {
    const dateSelectionnee = new Date(datePrevueInput.value);
    const maintenant = new Date();
    
    datePasseeAlert.style.display = (dateSelectionnee < maintenant) ? 'flex' : 'none';
  } else {
    datePasseeAlert.style.display = 'none';
  }
}

// Validation date r√©alisation (pas dans le futur)
if (dateRealisationInput) {
  dateRealisationInput.addEventListener('change', function() {
    const dateSelectionnee = new Date(this.value);
    const maintenant = new Date();
    
    if (dateSelectionnee > maintenant) {
      showToast("‚ùå La date de r√©alisation ne peut pas √™tre dans le futur !", 'error');
      this.value = getNowFormatted();
    }
  });
}

// √âcouter les changements de date pr√©vue
if (datePrevueInput) {
  datePrevueInput.addEventListener('change', checkDatePassee);
  checkDatePassee(); // V√©rif initiale
}
  // Gestion des commentaires
  const commentairesTextarea = document.getElementById('commentaires-textarea');
  const commentairesForm = document.getElementById('commentaires-form');
  let originalCommentaires = commentairesTextarea ? commentairesTextarea.value : '';

  window.resetCommentaires = function() {
    if (commentairesTextarea) {
      commentairesTextarea.value = originalCommentaires;
    }
  }

  if (commentairesForm) {
    commentairesForm.addEventListener('submit', function() {
      originalCommentaires = commentairesTextarea.value;
    });
  }

  // Gestion date de r√©ponse
  const dateEnvoiInput = document.getElementById('devis-date-envoi');
  const dateReponseInput = document.getElementById('devis-date-reponse');
  const dateReponseCard = document.getElementById('date-reponse-card');
  const delaiReponseInfo = document.getElementById('delai-reponse-info');
  const delaiReponseText = document.getElementById('delai-reponse-text');

  function updateDateReponseVisibility() {
    if (!devisStatutSelect || !dateReponseCard) return;
    const statut = devisStatutSelect.value;
    const shouldShow = statut === 'accepte' || statut === 'refuse';
    dateReponseCard.style.display = shouldShow ? 'block' : 'none';
    if (shouldShow) calculateDelai();
    else if (delaiReponseInfo) delaiReponseInfo.style.display = 'none';
  }

  function calculateDelai() {
    if (!dateEnvoiInput || !dateReponseInput || !delaiReponseInfo || !delaiReponseText) return;
    
    const dateEnvoi = dateEnvoiInput.value;
    const dateReponse = dateReponseInput.value;
    
    if (dateEnvoi && dateReponse) {
      const d1 = new Date(dateEnvoi);
      const d2 = new Date(dateReponse);
      const diffDays = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
      
      if (diffDays >= 0) {
        let message = `<strong>D√©lai de r√©ponse : ${diffDays} jour${diffDays > 1 ? 's' : ''}</strong>`;
        delaiReponseText.innerHTML = message;
        delaiReponseInfo.style.display = 'flex';
      } else {
        delaiReponseInfo.style.display = 'none';
      }
    } else {
      delaiReponseInfo.style.display = 'none';
    }
  }

  if (devisStatutSelect) {
    const originalChange = devisStatutSelect.onchange;
    devisStatutSelect.addEventListener('change', function() {
      if (originalChange) originalChange.call(this);
      updateDateReponseVisibility();
    });
    updateDateReponseVisibility();
  }

  if (dateEnvoiInput) dateEnvoiInput.addEventListener('change', calculateDelai);
  if (dateReponseInput) dateReponseInput.addEventListener('change', calculateDelai);

// Gestion mode paiement
const modePaiementSelect = document.getElementById('mode-paiement-select');
const comptantSection = document.getElementById('comptant-section');
const echelonneSection = document.getElementById('echelonne-section');
const datePaiementComptant = document.getElementById('date-paiement-comptant');

if (modePaiementSelect) {
  modePaiementSelect.addEventListener('change', function() {
    const mode = this.value;
    
    if (comptantSection) comptantSection.style.display = 'none';
    if (echelonneSection) echelonneSection.style.display = 'none';
    
    if (mode === 'comptant' && comptantSection) {
      comptantSection.style.display = 'block';
      // ‚úÖ CORRECTION : Ne remplir la date QUE si le champ est vide
      if (datePaiementComptant && !datePaiementComptant.value) {
        datePaiementComptant.value = getTodayDate();
      }
    } else if (mode === 'echelonne' && echelonneSection) {
      // ‚úÖ AJOUT : espace entre } et else
      echelonneSection.style.display = 'block';
    }
  });
  
  // Initialisation au chargement
  if (modePaiementSelect.value) {
    modePaiementSelect.dispatchEvent(new Event('change'));
  }
}

  // Initialisation des dates
  const devisDateEnvoi = document.getElementById('devis-date-envoi');
  if (devisDateEnvoi && !devisDateEnvoi.value) {
    devisDateEnvoi.value = getTodayDate();
  }

  // Gestion des sections repliables
  const statut = '{{ operation.statut }}';
  const operationId = '{{ operation.id }}';
  const storageKey = `operation-${operationId}-sections-initialized`;
  const isFirstVisit = !localStorage.getItem(storageKey);
  
  const sections = document.querySelectorAll('.section');
  let sectionToScrollTo = null;
  
  sections.forEach((section) => {
    const header = section.querySelector('.section-header');
    const body = section.querySelector('.section-body');
    
    if (!header || !body) return;
    
    const titleElement = header.querySelector('.section-title');
    if (!titleElement) return;
    
    const title = titleElement.textContent.trim();
    const savedState = localStorage.getItem(`section-${title}`);
    
    if (savedState && !isFirstVisit) {
      if (savedState === 'collapsed') {
        header.classList.add('collapsed');
        body.classList.add('collapsed');
      }
    } else {
      header.classList.add('collapsed');
      body.classList.add('collapsed');
      
      let shouldOpen = false;
      
      // ‚úÖ NOUVEAU : Logique d'ouverture des sections selon le statut
      const devisStatut = '{{ operation.devis_statut }}';
      
      switch(statut) {
        case 'en_attente_devis':
          shouldOpen = title.includes('Devis');
          break;
        case 'a_planifier':
          // ‚úÖ Si devis accept√©, ouvrir la section Devis + Planification
          if (devisStatut === 'accepte') {
            shouldOpen = title.includes('Devis') || title.includes('Planification');
          } else {
            shouldOpen = title.includes('Planification');
          }
          break;
        case 'planifie':
          shouldOpen = title.includes('Planification');
          break;
        case 'realise':
          shouldOpen = title.includes('Paiement');
          break;
        case 'paye':
          shouldOpen = title.includes('Paiement');
          break;
        case 'devis_refuse':
          shouldOpen = title.includes('Devis');
          break;
        default:
          shouldOpen = title.includes('Informations g√©n√©rales');
      }
      
      if (shouldOpen) {
        header.classList.remove('collapsed');
        body.classList.remove('collapsed');
        if (!sectionToScrollTo) {
          sectionToScrollTo = section;
        }
      }
    }
  });
  
  if (isFirstVisit) {
    localStorage.setItem(storageKey, 'true');
  }



  // D√©tection Safari et ajout de placeholders
if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) {
  document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
    input.placeholder = "JJ/MM/AAAA HH:MM";
    input.style.minWidth = "200px";
  });
}

// ========================================
// VALIDATION : Emp√™cher dates futures UNIQUEMENT pour r√©alisation
// ========================================
const realisationDateInput = document.getElementById('realisation-date');

if (realisationDateInput) {
  // ‚úÖ Validation UNIQUEMENT sur le champ de r√©alisation
  realisationDateInput.addEventListener('change', function() {
    const dateSelectionnee = new Date(this.value);
    const maintenant = new Date();
    
    if (dateSelectionnee > maintenant) {
      showToast("‚ùå La date de r√©alisation ne peut pas √™tre dans le futur !", 'error');
      this.value = getNowFormatted();
    }
  });
  
  // ‚úÖ Attribut max UNIQUEMENT sur le champ de r√©alisation
  realisationDateInput.setAttribute('max', getNowFormatted());
}

// ‚ö†Ô∏è NE PAS appliquer de validation sur les autres champs datetime-local
// Les champs de planification (planning-date, replanification-date) doivent accepter les dates futures

// ========================================
// SAUVEGARDE DE LA POSITION DE SCROLL
// ========================================

// Sauvegarder la position avant soumission de formulaire
document.querySelectorAll('form').forEach(form => {
  form.addEventListener('submit', function() {
    sessionStorage.setItem('scrollPosition', window.scrollY);
  });
});

// Restaurer la position apr√®s rechargement
const savedScrollPosition = sessionStorage.getItem('scrollPosition');
if (savedScrollPosition !== null) {
  window.scrollTo(0, parseInt(savedScrollPosition));
  sessionStorage.removeItem('scrollPosition');
}

  console.log('‚úÖ JavaScript CRM Artisans initialis√©');
});

// ========================================
// FEEDBACK VISUEL SOUMISSIONS
// ========================================
document.getElementById('form-realisation').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Validation...
  `;
});

document.getElementById('form-replanification').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Replanification...
  `;
});

document.getElementById('form-commentaires').addEventListener('submit', function() {
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="animation: spin 1s linear infinite">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>
    Enregistrement...
  `;
});

// Animation spin
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

</script>

<script>
// ========================================
// SYNCHRONISATION NOTES & VALIDIT√â
// ========================================

function syncNotesValidite() {
  const notes = document.getElementById('devis-notes-temp')?.value || '';
  const validite = document.getElementById('devis-validite-temp')?.value || 30;
  
  // Synchroniser avec les champs cach√©s du formulaire d'ajout
  const hiddenNotes = document.getElementById('hidden-notes');
  const hiddenValidite = document.getElementById('hidden-validite');
  
  if (hiddenNotes) hiddenNotes.value = notes;
  if (hiddenValidite) hiddenValidite.value = validite;
  
  console.log('‚úÖ Sync avant soumission:', { notes, validite });
}

function syncNotesValiditeForDelete(interventionId) {
  const notes = document.getElementById('devis-notes-temp')?.value || '';
  const validite = document.getElementById('devis-validite-temp')?.value || 30;
  
  // Synchroniser avec les champs cach√©s du formulaire de suppression
  const hiddenNotes = document.getElementById(`hidden-notes-del-${interventionId}`);
  const hiddenValidite = document.getElementById(`hidden-validite-del-${interventionId}`);
  
  if (hiddenNotes) hiddenNotes.value = notes;
  if (hiddenValidite) hiddenValidite.value = validite;
}

// ========================================
// SCROLL AUTOMATIQUE VERS LA SECTION DEVIS
// ========================================

window.addEventListener('DOMContentLoaded', function() {
  // Si un message de succ√®s pour ligne ajout√©e/supprim√©e, scroller vers le devis
  const messages = document.getElementById('django-messages');
  if (messages) {
    const hasLineMessage = Array.from(messages.querySelectorAll('[data-message]'))
      .some(msg => msg.dataset.message.includes('Ligne'));
    
    if (hasLineMessage) {
      const devisSection = document.getElementById('section-devis');
      if (devisSection) {
        setTimeout(() => {
          devisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    }
  }
});
</script>

<script>
function validateDevisGeneration() {
  const interventionsCount = {{ interventions.count|default:0 }};
  
  if (interventionsCount === 0) {
    const confirmer = confirm('‚ö†Ô∏è ATTENTION : Vous allez g√©n√©rer un devis SANS lignes.\n\n' +
                              'üí° Conseil : Ajoutez des lignes avant de l\'envoyer au client.\n\n' +
                              'Continuer quand m√™me ?');
    return confirmer;
  }
  
  return true;
}
</script>
</body>
</html>