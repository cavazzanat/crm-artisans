<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ operation.id_operation }} - {{ operation.type_prestation }} ‚Äì CRM Artisans</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --ring: rgba(99,102,241,.35);
      --border: rgba(148,163,184,.15);
      --shadow: 0 10px 25px rgba(2,6,23,.3), 0 1px 0 rgba(255,255,255,.03) inset;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.12), transparent 40%),
                  radial-gradient(1000px 600px at 80% 10%, rgba(139,92,246,.12), transparent 40%),
                  var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding-bottom:3rem;
    }

    /* ========================================
       HEADER
       ======================================== */
    .header{ 
      position: sticky; top: 0; z-index: 40; 
      backdrop-filter: saturate(180%) blur(8px); 
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.65)); 
      border-bottom: 1px solid var(--border) 
    }
    .header-inner{ 
      max-width:1280px; margin:0 auto; padding:.85rem 1rem; 
      display:flex; align-items:center; gap:1rem; justify-content:space-between 
    }
    .brand{ display:flex; align-items:center; gap:.75rem; font-weight:700; letter-spacing:.2px }
    .logo{ 
      width:34px; height:34px; border-radius:10px; 
      background:linear-gradient(145deg, var(--primary), var(--accent)); 
      box-shadow: var(--shadow); display:grid; place-items:center 
    }
    .logo svg{ width:18px; height:18px; color:white }
    .nav{ display:flex; gap:.25rem; align-items:center }
    .nav a{ 
      text-decoration:none; color:var(--muted); padding:.55rem .8rem; 
      border-radius:10px; border:1px solid transparent 
    }
    .nav a:hover{ color:var(--text); background:rgba(148,163,184,.08); border-color:var(--border) }
    .nav a.active{ 
      color:white; background:rgba(99,102,241,.18); 
      border-color: rgba(99,102,241,.35); box-shadow: 0 0 0 2px var(--ring) 
    }
    .user{ display:flex; align-items:center; gap:.75rem; color:var(--muted); font-size:.95rem }

    /* ========================================
       LAYOUT
       ======================================== */
    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    
    h1{ font-size:1.8rem; font-weight:800; margin-bottom:.5rem; color: var(--text); }
    .breadcrumb{ color:var(--muted); font-size:.9rem; margin-bottom:1rem }
    .breadcrumb a{ color:var(--muted); text-decoration:none }
    .breadcrumb a:hover{ color:var(--text) }

    .status-badge{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; 
      border-radius:20px; font-size:.85rem; font-weight:600; border:1px solid;
    }
    .status-badge::before{ content:''; width:8px; height:8px; border-radius:50%; background:currentColor }
    .status-badge.en_attente_devis{ color:#f59e0b; background: rgba(245,158,11,.1); border-color: rgba(245,158,11,.3); }
    .status-badge.a_planifier{ color:#3b82f6; background: rgba(59,130,246,.1); border-color: rgba(59,130,246,.3); }
    .status-badge.planifie{ color:#8b5cf6; background: rgba(139,92,246,.1); border-color: rgba(139,92,246,.3); }
    .status-badge.realise{ color:#22c55e; background: rgba(34,197,94,.1); border-color: rgba(34,197,94,.3); }
    .status-badge.paye{ color:#10b981; background: rgba(16,185,129,.1); border-color: rgba(16,185,129,.3); }
    .status-badge.devis_refuse{ color:#ef4444; background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.3); }
    
    .section{ 
      background: linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,.4));
      border:1px solid var(--border); 
      border-radius:16px; 
      padding:1.5rem; 
      box-shadow: var(--shadow); 
      margin-bottom:1.5rem 
    }
    .section-header{ 
      display:flex; align-items:center; justify-content:space-between; gap:1rem; 
      padding-bottom:1rem; border-bottom:1px solid var(--border); margin-bottom:1rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }
    .section-header:hover {
      background: rgba(148,163,184,.03);
      border-radius: 8px;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700; color: var(--text); }

    /* ========================================
       SECTIONS REPLIABLES
       ======================================== */
    .section-header .toggle-icon {
      transition: transform 0.3s ease;
      color: var(--muted);
      flex-shrink: 0;
    }

    .section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .section-body {
      max-height: 5000px;
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
      opacity: 1;
    }

    .section-body.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    /* Badge indicateur sur les sections */
    .section-badge {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .2rem .5rem;
      border-radius: 12px;
      font-size: .75rem;
      font-weight: 600;
      margin-left: .5rem;
    }

    .section-badge.complete {
      background: rgba(34,197,94,.1);
      color: var(--success);
      border: 1px solid rgba(34,197,94,.2);
    }

    .section-badge.pending {
      background: rgba(245,158,11,.1);
      color: var(--warning);
      border: 1px solid rgba(245,158,11,.2);
    }

    .section-badge.disabled {
      background: rgba(148,163,184,.1);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,.2);
    }

    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem }
    .info-card{
      background: rgba(148,163,184,.03);
      border:1px solid var(--border); 
      border-radius:10px; 
      padding:1rem; 
      transition: all 0.2s ease;
    }
    .info-card:hover{ background: rgba(148,163,184,.08); border-color: rgba(99,102,241,.2); }
    .info-card .label{
      display:flex; align-items:center; gap:.5rem; color:var(--muted); 
      font-size:.85rem; font-weight:600; text-transform:uppercase; 
      letter-spacing:.05rem; margin-bottom:.75rem
    }
    .info-card .value{ color: var(--text); font-weight: 600; font-size: 1rem; line-height: 1.4 }

    .input, .select, .textarea{ 
      width:100%; padding:.65rem .8rem; border-radius:10px; border:1px solid var(--border); 
      background: rgba(2,6,23,.35); color: var(--text); font:inherit 
    }
    .textarea{ resize:vertical; min-height:80px }
    .input:focus, .select:focus, .textarea:focus{ 
      outline:none; box-shadow: 0 0 0 2px var(--ring); border-color: rgba(99,102,241,.35) 
    }

    .btn{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; 
      border-radius:10px; border:1px solid var(--border); 
      background:rgba(148,163,184,.07); color:var(--text); cursor:pointer; font:inherit; text-decoration:none;
      transition: all 0.2s;
    }
    .btn:hover{ background:rgba(148,163,184,.12); transform: translateY(-1px) }
    .btn.success{ background:var(--success); border-color: var(--success); color: white; }
    .btn.success:hover{ background:#16a34a; }
    .btn.primary{ background:var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover{ background:#4f46e5; }
    .btn.danger{ background: var(--danger); border-color: var(--danger); color: white; }
    .btn.danger:hover{ background:#dc2626; }
    .btn.sm{ padding:.4rem .6rem; border-radius:8px; font-size:.9rem }

    .alert{ 
      padding:.75rem 1rem; border-radius:10px; margin-top:1rem; 
      display:flex; align-items:center; gap:.5rem; font-size:.9rem;
    }
    .alert.warning{ background: rgba(245,158,11,.1); color: #f59e0b; border:1px solid rgba(245,158,11,.2); }
    .alert.danger, .alert.error{ background: rgba(239,68,68,.1); color: #ef4444; border:1px solid rgba(239,68,68,.2); }
    .alert.success{ background: rgba(34,197,94,.1); color: var(--success); border:1px solid rgba(34,197,94,.2); }
    .alert.info{ background: rgba(59,130,246,.1); color: #3b82f6; border:1px solid rgba(59,130,246,.2); }

    .hidden{ display: none !important }

    .table-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--border); margin-top:1rem; background: rgba(2,6,23,.35); }
    table{ width:100%; border-collapse: collapse }
    thead th{ 
      background: rgba(148,163,184,.03); color:var(--muted); text-transform:uppercase; letter-spacing:.08rem; 
      font-size:.75rem; text-align:left; padding:.9rem .85rem; border-bottom:1px solid var(--border)
    }
    tbody td{ padding:.9rem .85rem; border-bottom:1px solid var(--border); }
    tbody tr:hover{ background: rgba(148,163,184,.05); }
    .total-row{ background: rgba(99,102,241,.08); font-weight:700; }

    .workflow-steps{
      display:flex; align-items:center; gap:.5rem; margin-top:1rem; padding:1rem; 
      background: rgba(2,6,23,.4); border-radius:12px; flex-wrap:wrap; border:1px solid var(--border);
    }
    .workflow-step{
      padding:.4rem .8rem; background:rgba(148,163,184,.05); 
      border-radius:8px; font-size:.8rem; color:var(--muted); font-weight:600;
    }
    .workflow-step.active{ background:var(--primary); color:white; }
    .workflow-arrow{ color:var(--muted); font-weight:bold }

    .main-content{ 
      display: grid; 
      grid-template-columns: 2fr 1fr; 
      gap: 2rem; 
      align-items: start;
    }

    /* ========================================
       NOTIFICATIONS TOAST
       ======================================== */
    .toast-container {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
      align-items: center;
    }

    .toast {
      min-width: 320px;
      max-width: 420px;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,.3), 0 4px 12px rgba(0,0,0,.2);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      pointer-events: auto;
      animation: slideInRight 0.3s ease-out;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.1);
    }

    .toast.hiding {
      animation: slideOutRight 0.3s ease-in forwards;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
    }

    .toast-content {
      flex: 1;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .toast-close {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      border: none;
      background: none;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast-close:hover {
      opacity: 1;
    }

    .toast.success {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
      color: white;
    }

    .toast.error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
      color: white;
    }

    .toast.warning {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
      color: white;
    }

    .toast.info {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
      color: white;
    }

    /* ========================================
       SECTION COMMENTAIRES STICKY
       ======================================== */
    .sticky-notes {
      position: sticky !important;
      top: 90px !important;
      align-self: flex-start !important;
      max-height: calc(100vh - 110px);
      overflow-y: auto;
    }

    .notes-textarea {
      width: 100%;
      min-height: 150px;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(2,6,23,.35);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
      resize: vertical;
      transition: all 0.2s ease;
    }

    .notes-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--ring);
    }

    .notes-textarea::placeholder {
      color: var(--muted);
      opacity: 0.6;
    }

    .notes-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      justify-content: flex-end;
    }

    @media (max-width: 1024px){ 
      .main-content{ grid-template-columns: 1fr }
      .sticky-notes {
        position: static !important;
        max-height: none;
      }
    }

    @media (max-width: 640px) {
      .toast-container {
        top: 70px;
        right: 10px;
        left: 10px;
      }
      
      .toast {
        min-width: auto;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>
  
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}">Accueil</a>
        <a href="{% url 'operations' %}" class="active">Op√©rations</a>
        <a href="{% url 'clients' %}">Clients</a>
      </nav>
      <div class="user">
        <span>{{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}" style="display:inline">
          {% csrf_token %}
          <button type="submit" style="background:none; border:none; color:var(--muted); cursor:pointer; text-decoration:underline; font:inherit">
            D√©connexion
          </button>
        </form>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'dashboard' %}">Accueil</a> / 
      <a href="{% url 'operations' %}">Op√©rations</a> / 
      {{ operation.id_operation }}
    </div>

    {% if messages %}
    <div id="django-messages" style="display:none">
      {% for message in messages %}
      <div data-type="{{ message.tags }}" data-message="{{ message }}"></div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- En-t√™te avec bouton suppression -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; flex-wrap:wrap">
      <div>
        <h1>{{ operation.id_operation }} - {{ operation.type_prestation }}</h1>
        <span class="status-badge {{ operation.statut }}">{{ operation.get_statut_display }}</span>
      </div>
      
      <form method="POST" action="{% url 'operation_delete' operation.id %}" onsubmit="return confirmDeleteOperation()" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="force_delete" value="true">
        <button type="submit" class="btn danger" title="Supprimer l'op√©ration">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M9 7v12m6-12v12M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13M9 7l1-3h4l1 3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
          Supprimer l'op√©ration
        </button>
      </form>
    </div>

    <div class="workflow-steps">
      <div class="workflow-step {% if operation.statut == 'en_attente_devis' %}active{% endif %}">Devis</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'a_planifier' %}active{% endif %}">√Ä planifier</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'planifie' %}active{% endif %}">Planifi√©</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'realise' %}active{% endif %}">R√©alis√©</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'paye' %}active{% endif %}">Pay√©</div>
    </div>

    <div class="main-content">
      <div class="left-column">
        
        <!-- INFORMATIONS G√âN√âRALES -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              Informations g√©n√©rales
              <span class="section-badge complete">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                Compl√©t√©
              </span>
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="section-body">
            <div class="info-grid">
              <div class="info-card">
                <div class="label">üë§ Client</div>
                <div class="value">
                  <strong>{{ operation.client.nom }} {{ operation.client.prenom }}</strong><br>
                  <a href="{% url 'client_detail' client_id=operation.client.id %}" style="color:var(--primary); text-decoration:none">Voir le profil</a>
                </div>
              </div>
              <div class="info-card">
                <div class="label">üìã Type de prestation</div>
                <div class="value">{{ operation.type_prestation }}</div>
              </div>
              <div class="info-card">
                <div class="label">üìç Adresse</div>
                <div class="value">{{ operation.adresse_intervention }}</div>
              </div>
              <div class="info-card">
                <div class="label">üìû Contact</div>
                <div class="value">
                  <a href="tel:{{ operation.client.telephone }}" style="color:var(--primary); text-decoration:none">
                    {{ operation.client.telephone }}
                  </a>
                  {% if operation.client.email %}
                  <br><a href="mailto:{{ operation.client.email }}" style="color:var(--primary); text-decoration:none">
                    {{ operation.client.email }}
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION DEVIS (uniquement si avec_devis = True) -->
        {% if operation.avec_devis %}
        <section class="section" id="section-devis">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" stroke="currentColor" stroke-width="1.6"/></svg>
              Devis
              
              {% if not operation.numero_devis %}
                {% if not interventions %}
                <span class="section-badge pending">‚ö†Ô∏è Vide</span>
                {% else %}
                <span class="section-badge pending">üìù Pr√™t √† g√©n√©rer</span>
                {% endif %}
              {% elif operation.devis_statut == 'accepte' %}
                <span class="section-badge complete">‚úÖ {{ operation.numero_devis }}</span>
              {% elif operation.devis_statut == 'refuse' %}
                <span class="section-badge" style="background: rgba(239,68,68,.1); color: var(--danger); border: 1px solid rgba(239,68,68,.2);">‚ùå {{ operation.numero_devis }}</span>
              {% else %}
                <span class="section-badge pending">‚è≥ {{ operation.numero_devis }}</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            <!-- √âTAT A : Devis vide -->
            {% if not operation.numero_devis and not interventions %}
            <div class="alert warning">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="2"/></svg>
              <div><strong>‚ö†Ô∏è Le devis est vide</strong><br>
              Ajoutez des lignes dans la section ci-dessous puis revenez ici pour g√©n√©rer le PDF.</div>
            </div>
            
            <!-- √âTAT B : Pr√™t √† g√©n√©rer -->
            {% elif not operation.numero_devis and interventions %}
            <div style="background: rgba(148,163,184,.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
              <div class="info-card" style="margin-bottom: 1rem;">
                <div class="label">üí∞ Montant total du devis</div>
                <div class="value" style="font-size: 1.5rem; color: var(--primary); font-weight: 700;">
                  {{ montant_total|floatformat:2 }} ‚Ç¨
                </div>
              </div>
              
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="generer_devis">
                
                <div class="form-group" style="margin-bottom: 1rem;">
                  <label style="display:block; color:var(--muted); font-size:.9rem; font-weight:600; margin-bottom:.5rem">
                    Notes du devis (optionnel)
                  </label>
                  <textarea name="devis_notes" class="textarea" placeholder="Ex: Acompte 30% √† la commande...">{{ operation.devis_notes|default:'' }}</textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                  <label style="display:block; color:var(--muted); font-size:.9rem; font-weight:600; margin-bottom:.5rem">
                    Validit√© (jours)
                  </label>
                  <input type="number" name="devis_validite_jours" class="input" value="{{ operation.devis_validite_jours|default:30 }}" style="max-width: 150px;">
                </div>
                
                <button type="submit" class="btn success" style="width:100%">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6" stroke="currentColor" stroke-width="1.6"/></svg>
                  üìÑ G√©n√©rer le PDF du devis
                </button>
                
                <p style="margin-top: .75rem; font-size: .85rem; color: var(--muted); text-align: center;">
                  üí° Le PDF sera automatiquement t√©l√©charg√©. Vous pourrez ensuite l'envoyer √† votre client.
                </p>
              </form>
            </div>
            
            <!-- √âTAT C : Devis envoy√©, en attente -->
            {% elif operation.numero_devis and not operation.devis_statut %}
            <div class="info-grid" style="margin-bottom: 1.5rem;">
              <div class="info-card">
                <div class="label">üìÑ Num√©ro</div>
                <div class="value">{{ operation.numero_devis }}</div>
              </div>
              <div class="info-card">
                <div class="label">üìÖ Date d'envoi</div>
                <div class="value">{{ operation.devis_date_envoi|date:"d/m/Y" }}</div>
              </div>
              <div class="info-card">
                <div class="label">üí∞ Montant</div>
                <div class="value">{{ montant_total|floatformat:2 }} ‚Ç¨</div>
              </div>
            </div>
            
            <div class="alert info" style="margin-bottom: 1.5rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3" stroke="currentColor" stroke-width="1.6"/></svg>
              <div><strong>‚è≥ En attente de r√©ponse client</strong></div>
            </div>
            
            <div style="background: rgba(148,163,184,.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
              <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">üéØ Actions rapides</h4>
              
              <form method="POST" style="margin-bottom: 1rem;">
                {% csrf_token %}
                <input type="hidden" name="action" value="accepter_devis">
                <label style="display:block; color:var(--muted); font-size:.9rem; font-weight:600; margin-bottom:.5rem">
                  Date d'acceptation
                </label>
                <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
                  <input type="date" name="devis_date_reponse" class="input" value="{{ now|date:'Y-m-d' }}" style="flex:1; min-width:200px">
                  <button type="submit" class="btn success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    ‚úÖ ACCEPTER LE DEVIS
                  </button>
                </div>
              </form>
              
              <form method="POST" style="margin-bottom: 1rem;">
                {% csrf_token %}
                <input type="hidden" name="action" value="refuser_devis">
                <label style="display:block; color:var(--muted); font-size:.9rem; font-weight:600; margin-bottom:.5rem">
                  Date de refus
                </label>
                <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
                  <input type="date" name="devis_date_reponse" class="input" value="{{ now|date:'Y-m-d' }}" style="flex:1; min-width:200px">
                  <button type="submit" class="btn danger">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/></svg>
                    ‚ùå REFUSER LE DEVIS
                  </button>
                </div>
              </form>
              
              <a href="#" class="btn" style="width:100%; justify-content:center" onclick="alert('T√©l√©chargement du PDF (√† impl√©menter)'); return false;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="1.6"/></svg>
                üìÑ T√©l√©charger le PDF
              </a>
            </div>
            
            <!-- √âTAT D : Devis accept√© -->
            {% elif operation.devis_statut == 'accepte' %}
            <div class="alert success" style="margin-bottom: 1.5rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
              <div><strong>‚úÖ DEVIS ACCEPT√â le {{ operation.devis_date_reponse|date:"d/m/Y" }}</strong></div>
            </div>
            
            <div class="info-grid" style="margin-bottom: 1.5rem;">
              <div class="info-card">
                <div class="label">üìÑ Num√©ro</div>
                <div class="value">{{ operation.numero_devis }}</div>
              </div>
              <div class="info-card">
                <div class="label">üîí Montant verrouill√©</div>
                <div class="value" style="color: var(--success); font-size: 1.2rem;">{{ montant_total|floatformat:2 }} ‚Ç¨</div>
              </div>
              {% if operation.delai_reponse_client %}
              <div class="info-card">
                <div class="label">‚è±Ô∏è D√©lai de r√©ponse</div>
                <div class="value">{{ operation.delai_reponse_client }} jour{{ operation.delai_reponse_client|pluralize }}</div>
              </div>
              {% endif %}
            </div>
            
            <div class="alert info">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              <div><strong>‚ú® Le statut de l'op√©ration est pass√© automatiquement √† "√Ä planifier"</strong><br>
              ‚û°Ô∏è Vous pouvez maintenant planifier l'intervention</div>
            </div>
            
            <!-- √âTAT F : Devis refus√© + option nouveau devis -->
            {% elif operation.devis_statut == 'refuse' %}
            <div class="alert danger" style="margin-bottom: 1.5rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="2"/></svg>
              <div><strong>‚ùå DEVIS REFUS√â le {{ operation.devis_date_reponse|date:"d/m/Y" }}</strong><br>
              Montant refus√© : {{ montant_total|floatformat:2 }} ‚Ç¨</div>
            </div>
            
            <div style="background: rgba(148,163,184,.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
              <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">üîÑ Voulez-vous cr√©er un nouveau devis ?</h4>
              
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="creer_nouveau_devis">
                <button type="submit" class="btn primary" style="width:100%; margin-bottom:1rem" onclick="return confirm('Cr√©er un nouveau devis ? L\'ancien restera archiv√© dans l\'historique.')">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                  üìù Cr√©er un nouveau devis
                </button>
              </form>
              
              <div class="alert info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
                <div style="font-size:.85rem">
                  <strong>üí° Cela va :</strong><br>
                  ‚Ä¢ D√©verrouiller les lignes d'intervention<br>
                  ‚Ä¢ Permettre de modifier les montants<br>
                  ‚Ä¢ R√©initialiser le statut du devis<br>
                  ‚Ä¢ Repasser l'op√©ration en "EN_ATTENTE_DEVIS"<br>
                  ‚Ä¢ Vous pourrez g√©n√©rer un nouveau PDF<br><br>
                  ‚ö†Ô∏è L'ancien devis restera archiv√© dans l'historique
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </section>
        {% endif %}

        <!-- SECTION LIGNES D'INTERVENTION -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.6"/></svg>
              {% if operation.avec_devis and operation.statut == 'en_attente_devis' %}
                Lignes du devis
              {% else %}
                Lignes d'intervention
              {% endif %}
              {% if interventions %}
              <span class="section-badge complete">{{ interventions.count }} ligne{{ interventions.count|pluralize }}</span>
              {% else %}
              <span class="section-badge pending">Aucune ligne</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            {% if interventions %}
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Description</th>
                    <th style="width:120px">Montant (‚Ç¨)</th>
                    <th style="width:100px">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for intervention in interventions %}
                  <tr>
                    <td>{{ intervention.description }}</td>
                    <td><strong>{{ intervention.montant|floatformat:2 }}</strong></td>
                    <td>
                      {% if operation.devis_statut != 'accepte' %}
                      <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette ligne ?')">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_intervention">
                        <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                        <button type="submit" class="btn danger sm">Supprimer</button>
                      </form>
                      {% else %}
                      <span style="color:var(--muted); font-size:.85rem">üîí Verrouill√©</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr class="total-row">
                    <td><strong>TOTAL</strong></td>
                    <td><strong>{{ montant_total|floatformat:2 }} ‚Ç¨</strong></td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            {% else %}
            <div class="alert info">Aucune ligne ajout√©e</div>
            {% endif %}

            {% if operation.devis_statut != 'accepte' %}
            <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border)">
              <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Ajouter une ligne</h4>
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_intervention">
                <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
                  <div style="flex:1; min-width:250px">
                    <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Description</label>
                    <input type="text" name="description" class="input" placeholder="Ex: Main d'≈ìuvre, Fournitures..." required>
                  </div>
                  <div style="flex:0 0 150px">
                    <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Montant (‚Ç¨)</label>
                    <input type="number" name="montant" class="input" placeholder="0.00" step="0.01" required>
                  </div>
                  <button type="submit" class="btn success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                    Ajouter
                  </button>
                </div>
              </form>
            </div>
            {% else %}
            <div class="alert info" style="margin-top:1.5rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 15v-3m0 0V9m0 3H9m3 0h3m6 3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              <div><strong>üîí Montant verrouill√© (devis accept√©)</strong><br>
              Les lignes ne peuvent plus √™tre modifi√©es ni supprim√©es.</div>
            </div>
            {% endif %}
          </div>
        </section>

        <!-- SECTION PLANIFICATION -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6"/></svg>
              Planification
              
              {% if operation.statut == 'realise' or operation.statut == 'paye' %}
                <span class="section-badge complete">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  R√©alis√©e
                </span>
              {% elif operation.date_prevue %}
                <span class="section-badge complete">
                  üìÖ {{ operation.date_prevue|date:"d/m/Y H:i" }}
                </span>
              {% else %}
                <span class="section-badge pending">√Ä planifier</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            {% if operation.statut == 'realise' or operation.statut == 'paye' %}
            <!-- MODE LECTURE : R√©alis√©e -->
            <div class="alert success" style="margin-bottom:1rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
              <div>
                <strong>‚úÖ Intervention r√©alis√©e</strong>
                {% if operation.date_realisation %}
                  <br>Date de r√©alisation : <strong>{{ operation.date_realisation|date:"d/m/Y √† H:i" }}</strong>
                {% endif %}
              </div>
            </div>
            
            <div class="info-grid">
              {% if operation.date_prevue %}
              <div class="info-card">
                <div class="label">üìÖ Date pr√©vue</div>
                <div class="value">{{ operation.date_prevue|date:"d/m/Y √† H:i" }}</div>
              </div>
              {% endif %}
              
              {% if operation.date_realisation %}
              <div class="info-card">
                <div class="label">‚úÖ Date de r√©alisation</div>
                <div class="value" style="color:var(--success); font-weight:700">
                  {{ operation.date_realisation|date:"d/m/Y √† H:i" }}
                </div>
              </div>
              {% endif %}
            </div>
            
            {% else %}
            <!-- MODE ACTIF : Planification -->
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_planning">
              
              <div class="info-card" style="margin-bottom:1rem">
                <div class="label">üìÖ Date d'intervention pr√©vue</div>
                <div class="value">
                  <input type="datetime-local" 
                        name="date_prevue" 
                        class="input" 
                        value="{% if operation.date_prevue %}{{ operation.date_prevue|date:'Y-m-d\TH:i' }}{% endif %}"
                        required>
                </div>
              </div>
              
              {% if operation.date_prevue and operation.statut == 'planifie' %}
              <div class="alert info" style="margin-bottom:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
                <div>üí° <strong>Actuellement planifi√© le {{ operation.date_prevue|date:"d/m/Y √† H:i" }}</strong><br>
                Modifiez la date ci-dessus pour replanifier.</div>
              </div>
              {% endif %}
              
              <div style="display:flex; gap:1rem; flex-wrap:wrap">
                <button type="submit" class="btn primary" style="flex:1">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  {% if operation.date_prevue %}Replanifier{% else %}Enregistrer la date{% endif %}
                </button>
                
                {% if operation.date_prevue %}
                <button type="button" class="btn success" style="flex:1" onclick="toggleRealisationForm()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  Valider la r√©alisation
                </button>
                {% endif %}
              </div>
            </form>
            
            <!-- Formulaire validation r√©alisation (cach√©) -->
            <div id="realisation-form" style="display:none; margin-top:1.5rem; padding-top:1.5rem; border-top:2px solid var(--border)">
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="valider_realisation">
                
                <h4 style="margin-bottom:1rem; color:var(--success); font-size:1.1rem; display:flex; align-items:center; gap:.5rem">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                  Validation de la r√©alisation
                </h4>
                
                <div class="info-card" style="margin-bottom:1rem">
                  <div class="label">Date de r√©alisation effective</div>
                  <div class="value">
                    <input type="datetime-local" 
                          name="date_realisation" 
                          class="input" 
                          max="{{ now|date:'Y-m-d\TH:i' }}"
                          required>
                    <small style="display:block; margin-top:0.5rem; color:var(--muted); font-size:0.85rem">
                      ‚ö†Ô∏è La date ne peut pas √™tre dans le futur
                    </small>
                  </div>
                </div>
                
                <div style="display:flex; gap:1rem">
                  <button type="button" class="btn" onclick="toggleRealisationForm()" style="flex:1">
                    Annuler
                  </button>
                  <button type="submit" class="btn success" style="flex:1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                    Confirmer la r√©alisation
                  </button>
                </div>
              </form>
            </div>
            {% endif %}
          </div>
        </section>

        <!-- SECTION FACTURE (si r√©alis√© ou pay√©) -->
        {% if operation.statut == 'realise' or operation.statut == 'paye' %}
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4" stroke="currentColor" stroke-width="1.6"/></svg>
              Facture
              {% if operation.facture_generee %}
                <span class="section-badge complete">‚úÖ {{ operation.numero_facture }}</span>
              {% else %}
                <span class="section-badge pending">‚ö†Ô∏è Non g√©n√©r√©e</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            {% if not operation.facture_generee %}
            <!-- √âTAT A : Non g√©n√©r√©e -->
            <div class="alert info" style="margin-bottom:1.5rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              <div><strong>‚úÖ Intervention r√©alis√©e le {{ operation.date_realisation|date:"d/m/Y" }}</strong><br>
              Vous pouvez maintenant g√©n√©rer la facture pour ce client.</div>
            </div>
            
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="generer_facture">
              
              <div class="info-grid" style="margin-bottom:1.5rem">
                <div class="info-card">
                  <div class="label">üìÖ Date d'√©mission</div>
                  <div class="value">
                    <input type="date" name="facture_date_emission" class="input" value="{{ now|date:'Y-m-d' }}" required>
                  </div>
                </div>
                <div class="info-card">
                  <div class="label">üí∞ Montant</div>
                  <div class="value" style="font-size: 1.2rem; color: var(--primary);">
                    {{ montant_total|floatformat:2 }} ‚Ç¨
                  </div>
                </div>
              </div>
              
              <div class="form-group" style="margin-bottom:1.5rem">
                <label style="display:block; color:var(--muted); font-size:.9rem; font-weight:600; margin-bottom:.5rem">
                  Notes sur la facture (optionnel)
                </label>
                <textarea name="facture_notes" class="textarea" placeholder="Ex: R√®glement sous 30 jours...">{{ operation.facture_notes|default:'' }}</textarea>
              </div>
              
              <button type="submit" class="btn success" style="width:100%">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6" stroke="currentColor" stroke-width="1.6"/></svg>
                üìÑ G√©n√©rer la facture PDF
              </button>
              
              <p style="margin-top: .75rem; font-size: .85rem; color: var(--muted); text-align: center;">
                üí° La facture sera automatiquement num√©rot√©e (FAC-2025-XXX) et t√©l√©charg√©e
              </p>
            </form>
            
            {% else %}
            <!-- √âTAT B : G√©n√©r√©e -->
            <div class="alert success" style="margin-bottom:1.5rem">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
              <div><strong>‚úÖ {{ operation.numero_facture }} g√©n√©r√©e</strong></div>
            </div>
            
            <div class="info-grid" style="margin-bottom:1.5rem">
              <div class="info-card">
                <div class="label">üìÑ Num√©ro</div>
                <div class="value">{{ operation.numero_facture }}</div>
              </div>
              <div class="info-card">
                <div class="label">üìÖ Date d'√©mission</div>
                <div class="value">{{ operation.facture_date_emission|date:"d/m/Y" }}</div>
              </div>
              <div class="info-card">
                <div class="label">üí∞ Montant</div>
                <div class="value">{{ montant_total|floatformat:2 }} ‚Ç¨</div>
              </div>
              <div class="info-card">
                <div class="label">‚úÖ Statut</div>
                <div class="value" style="{% if operation.statut == 'paye' %}color:var(--success){% else %}color:var(--warning){% endif %}">
                  {% if operation.statut == 'paye' %}Sold√©e{% else %}En attente de paiement{% endif %}
                </div>
              </div>
            </div>
            
            <a href="#" class="btn" style="width:100%; justify-content:center" onclick="alert('T√©l√©chargement du PDF (√† impl√©menter)'); return false;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="1.6"/></svg>
              üìÑ T√©l√©charger le PDF
            </a>
            {% endif %}
          </div>
        </section>
        {% endif %}

        <!-- SECTION PAIEMENT (condition √©largie) -->
        {% if not operation.avec_devis or operation.devis_statut == 'accepte' or operation.statut == 'realise' or operation.statut == 'paye' %}
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 8.5h20M2 12.5h20M6 16.5h8M6 20.5h8M6 4.5h8" stroke="currentColor" stroke-width="1.6"/></svg>
              Paiement
              {% if operation.statut == 'paye' %}
              <span class="section-badge complete">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                Sold√©
              </span>
              {% elif echeances %}
              <span class="section-badge pending">{{ total_echeances|default:0|floatformat:2 }} ‚Ç¨ / {{ montant_total|floatformat:2 }} ‚Ç¨</span>
              {% else %}
              <span class="section-badge disabled">Aucun paiement</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            <!-- R√©capitulatif financier -->
            <div style="background: rgba(148,163,184,.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
              <div class="info-grid">
                <div class="info-card">
                  <div class="label">üí∞ Montant total</div>
                  <div class="value" style="font-size:1.5rem; color:var(--primary); font-weight:700">
                    {{ montant_total|floatformat:2 }} ‚Ç¨
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">‚úÖ Pay√©</div>
                  <div class="value" style="font-size:1.5rem; color:var(--success); font-weight:700">
                    {{ total_echeances|default:0|floatformat:2 }} ‚Ç¨
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">‚è≥ En attente (pr√©vus)</div>
                  <div class="value" style="font-size:1.2rem; color:var(--warning); font-weight:600">
                    {{ total_echeances_prevus|default:0|floatformat:2 }} ‚Ç¨
                  </div>
                  <small style="color:var(--muted); font-size:0.8rem">Pr√©vus non pay√©s</small>
                </div>
                
                <div class="info-card">
                  <div class="label">üéØ Reste √† enregistrer</div>
                  <div class="value" style="font-size:1.5rem; font-weight:700; color:{% if reste_a_enregistrer == 0 %}var(--success){% elif reste_a_enregistrer < 0 %}var(--danger){% else %}var(--warning){% endif %}">
                    {{ reste_a_enregistrer|default:montant_total|floatformat:2 }} ‚Ç¨
                  </div>
                </div>
              </div>
              
              {% if operation.statut == 'paye' %}
              <div class="alert success" style="margin-top:1rem">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                <div><strong>üéâ Op√©ration sold√©e !</strong> Tous les paiements ont √©t√© re√ßus.</div>
              </div>
              {% endif %}
            </div>

            <!-- Liste des paiements -->
            {% if echeances %}
            <div style="background: rgba(148,163,184,.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
              <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">üìù Historique des paiements</h4>
              
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Montant</th>
                      <th>Statut</th>
                      <th style="width:100px">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for echeance in echeances %}
                    <tr style="{% if echeance.paye %}background: rgba(34,197,94,.05);{% elif echeance.date_echeance < now.date %}background: rgba(239,68,68,.05);{% endif %}">
                      <td>
                        <strong>{{ echeance.date_echeance|date:"d/m/Y" }}</strong>
                        {% if echeance.date_echeance < now.date and not echeance.paye %}
                        <br><small style="color:var(--danger)">‚ö†Ô∏è En retard</small>
                        {% endif %}
                      </td>
                      <td><strong>{{ echeance.montant|floatformat:2 }} ‚Ç¨</strong></td>
                      <td>
                        {% if echeance.paye %}
                          <span style="color:var(--success); font-weight:600">‚úÖ Pay√©</span>
                        {% else %}
                          <span style="color:var(--warning); font-weight:600">‚è≥ En attente</span>
                        {% endif %}
                      </td>
                      <td>
                        <div style="display:flex; gap:.3rem">
                          {% if not echeance.paye %}
                          <form method="POST" style="display:inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="marquer_paye">
                            <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                            <button type="submit" class="btn success sm" title="Marquer comme pay√©">‚úì</button>
                          </form>
                          {% endif %}
                          
                          <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer ce paiement ?')">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_paiement">
                            <input type="hidden" name="echeance_id" value="{{ echeance.id }}">
                            <button type="submit" class="btn danger sm">‚úó</button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            {% endif %}

            <!-- Formulaire ajout paiement -->
            <div style="background: rgba(148,163,184,.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
              <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">
                {% if echeances %}Ajouter un paiement{% else %}Enregistrer le premier paiement{% endif %}
              </h4>
              
              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_paiement">
                
                <div class="info-grid" style="margin-bottom:1rem">
                  <div class="info-card">
                    <div class="label">üíµ Montant (‚Ç¨)</div>
                    <div class="value">
                      <input type="number" 
                            name="montant" 
                            class="input" 
                            placeholder="Ex: 500" 
                            step="0.01" 
                            min="0.01"
                            required>
                    </div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">üìÖ Date du paiement</div>
                    <div class="value">
                      <input type="date" 
                            name="date_paiement" 
                            class="input" 
                            value="{{ now|date:'Y-m-d' }}"
                            required>
                    </div>
                  </div>
                  
                  <div class="info-card">
                    <div class="label">‚úÖ Statut</div>
                    <div class="value">
                      <select name="paye" class="select">
                        <option value="true">D√©j√† pay√©</option>
                        <option value="false">Pr√©vu / √Ä venir</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <button type="submit" class="btn success" style="width:100%">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                  Enregistrer ce paiement
                </button>
              </form>
            </div>
          </div>
        </section>
        {% endif %}

      </div>

      <!-- COLONNE DROITE -->
      <div class="right-column">
        <!-- HISTORIQUE -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/></svg>
              Historique
              {% if historique %}
              <span class="section-badge complete">{{ historique.count }} √©v√©nement{{ historique.count|pluralize }}</span>
              {% endif %}
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="section-body">
            {% if historique %}
            <div class="table-wrap">
              <table>
                <thead><tr><th>Date</th><th>Action</th></tr></thead>
                <tbody>
                  {% for entry in historique %}
                  <tr>
                    <td style="font-size:.85rem">{{ entry.date|date:"d/m H:i" }}</td>
                    <td style="font-size:.9rem">{{ entry.action }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert info">Aucun historique</div>
            {% endif %}
          </div>
        </section>

        <!-- COMMENTAIRES STICKY -->
        <section class="section sticky-notes">
          <div class="section-header" onclick="toggleSection(this)">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M7 8h10M7 12h4m1 8-4-4H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3l-4 4Z" stroke="currentColor" stroke-width="1.6"/>
              </svg>
              Commentaires
            </h2>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="section-body">
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_commentaires">
              
              <textarea 
                name="commentaires" 
                class="notes-textarea" 
                rows="6" 
                placeholder="Notes libres sur cette op√©ration..."
              >{{ operation.commentaires|default:'' }}</textarea>
              
              <div class="notes-actions">
                <button type="submit" class="btn success">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m5 12 4 4 10-10"/>
                  </svg>
                  Enregistrer
                </button>
              </div>
            </form>
          </div>
        </section>
      </div>
    </div>

    <div style="margin-top:1.5rem">
      <a href="{% url 'operations' %}" class="btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5"/></svg>
        Retour aux op√©rations
      </a>
    </div>
  </div>

  <script>
    // ========================================
    // FONCTIONS GLOBALES
    // ========================================
    function confirmDeleteOperation() {
      const id = '{{ operation.id_operation }}';
      const type = '{{ operation.type_prestation|escapejs }}';
      const client = '{{ operation.client.nom }} {{ operation.client.prenom }}';
      const interventions = {{ interventions.count|default:0 }};
      const echeances = {{ echeances.count|default:0 }};
      
      let message = '‚ö†Ô∏è ATTENTION : Supprimer l\'op√©ration ' + id + ' ?\n\n';
      message += 'üìã Type : ' + type + '\n';
      message += 'üë§ Client : ' + client + '\n';
      
      if (interventions > 0) {
        message += '\nüî∏ ' + interventions + ' ligne(s) d\'intervention seront supprim√©e(s)';
      }
      
      if (echeances > 0) {
        message += '\nüí∞ ' + echeances + ' √©ch√©ance(s) de paiement seront supprim√©e(s)';
      }
      
      message += '\n\nüö® Cette action est IRR√âVERSIBLE !';
      
      return confirm(message);
    }

    function toggleSection(header) {
      const section = header.closest('.section');
      const body = section.querySelector('.section-body');
      
      header.classList.toggle('collapsed');
      body.classList.toggle('collapsed');
      
      const sectionTitle = header.querySelector('.section-title').textContent.trim();
      const isCollapsed = body.classList.contains('collapsed');
      localStorage.setItem(`section-${sectionTitle}`, isCollapsed ? 'collapsed' : 'expanded');
    }

    window.toggleRealisationForm = function() {
      const realisationForm = document.getElementById('realisation-form');
      if (!realisationForm) return;
      
      const isVisible = realisationForm.style.display !== 'none';
      realisationForm.style.display = isVisible ? 'none' : 'block';
      
      if (!isVisible) {
        realisationForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    // ========================================
    // SYST√àME DE NOTIFICATIONS TOAST
    // ========================================
    function showToast(message, type = 'info', duration = 5000) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      let icon = '';
      switch(type) {
        case 'success':
          icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m5 12 4 4 10-10"/></svg>';
          break;
        case 'error':
          icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6m0-6 6 6"/></svg>';
          break;
        case 'warning':
          icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4m0 4h0M12 3l9 18H3L12 3z"/></svg>';
          break;
        case 'info':
        default:
          icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h0"/></svg>';
          break;
      }
      
      toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">${message}</div>
        <button class="toast-close" onclick="dismissToast(this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6 6 18M6 6l12 12"/>
          </svg>
        </button>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        dismissToast(toast.querySelector('.toast-close'));
      }, duration);
    }

    function dismissToast(button) {
      const toast = button.closest('.toast');
      if (!toast) return;
      
      toast.classList.add('hiding');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }

    // Afficher les messages Django au chargement
    window.addEventListener('DOMContentLoaded', function() {
      const messagesContainer = document.getElementById('django-messages');
      if (messagesContainer) {
        const messages = messagesContainer.querySelectorAll('[data-message]');
        messages.forEach((msg, index) => {
          setTimeout(() => {
            const type = msg.dataset.type || 'info';
            const message = msg.dataset.message;
            showToast(message, type);
          }, index * 200);
        });
      }
    });

    // ========================================
    // INITIALISATION
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      const statut = '{{ operation.statut }}';
      const operationId = '{{ operation.id }}';
      const storageKey = `operation-${operationId}-sections-initialized`;
      const isFirstVisit = !localStorage.getItem(storageKey);
      
      const sections = document.querySelectorAll('.section');
      
      sections.forEach((section) => {
        const header = section.querySelector('.section-header');
        const body = section.querySelector('.section-body');
        
        if (!header || !body) return;
        
        const titleElement = header.querySelector('.section-title');
        if (!titleElement) return;
        
        const title = titleElement.textContent.trim();
        const savedState = localStorage.getItem(`section-${title}`);
        
        if (savedState && !isFirstVisit) {
          if (savedState === 'collapsed') {
            header.classList.add('collapsed');
            body.classList.add('collapsed');
          }
        } else {
          header.classList.add('collapsed');
          body.classList.add('collapsed');
          
          let shouldOpen = false;
          
          switch(statut) {
            case 'en_attente_devis':
              shouldOpen = title.includes('Devis') || title.includes('Lignes');
              break;
            case 'a_planifier':
              shouldOpen = title.includes('Lignes') || title.includes('Planification');
              break;
            case 'planifie':
              shouldOpen = title.includes('Planification');
              break;
            case 'realise':
              shouldOpen = title.includes('Facture') || title.includes('Paiement');
              break;
            case 'paye':
              shouldOpen = title.includes('Paiement');
              break;
            case 'devis_refuse':
              shouldOpen = title.includes('Devis');
              break;
            default:
              shouldOpen = title.includes('Informations g√©n√©rales');
          }
          
          if (shouldOpen) {
            header.classList.remove('collapsed');
            body.classList.remove('collapsed');
          }
        }
      });
      
      if (isFirstVisit) {
        localStorage.setItem(storageKey, 'true');
      }
      
      console.log('‚úÖ Fiche op√©ration initialis√©e');
    });
  </script>
</body>
</html>