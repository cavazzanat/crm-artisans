<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ operation.id_operation }} - {{ operation.type_prestation }} ‚Äì CRM Artisans</title>
  <!-- Gardez tout le CSS existant -->
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/></svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav style="display:flex; gap:1rem">
        <a href="{% url 'dashboard' %}" style="color:var(--muted); text-decoration:none">Accueil</a>
        <a href="{% url 'operations' %}" style="color:var(--muted); text-decoration:none">Op√©rations</a>
        <a href="{% url 'clients' %}" style="color:var(--muted); text-decoration:none">Clients</a>
      </nav>
      <div style="color:var(--muted); font-size:.9rem">{{ user.username }}</div>
    </div>
  </header>

  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'dashboard' %}">Accueil</a> / 
      <a href="{% url 'operations' %}">Op√©rations</a> / 
      {{ operation.id_operation }}
    </div>

    <h1>{{ operation.id_operation }} - {{ operation.type_prestation }}</h1>
    <span class="status-badge {{ operation.statut }}">{{ operation.get_statut_display }}</span>

    <!-- Messages Django -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert {{ message.tags }}" style="margin-top:1rem">
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <div class="workflow-steps">
      <div class="workflow-step {% if operation.statut == 'en_attente_devis' %}active{% endif %}">Devis</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'a_planifier' %}active{% endif %}">√Ä planifier</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'planifie' %}active{% endif %}">Planifi√©</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'realise' %}active{% endif %}">R√©alis√©</div>
      <div class="workflow-arrow">‚Üí</div>
      <div class="workflow-step {% if operation.statut == 'paye' %}active{% endif %}">Pay√©</div>
    </div>

    <div class="main-content">
      <div class="left-column">
        <!-- Section Informations g√©n√©rales -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Informations g√©n√©rales</h2>
          </div>
          <div class="info-grid">
            <div class="info-card">
              <div class="label">Client</div>
              <div class="value">
                <strong>{{ operation.client.nom }} {{ operation.client.prenom }}</strong><br>
                <a href="{% url 'client_detail' client_id=operation.client.id %}" style="color:var(--primary); text-decoration:none">Voir le profil</a>
              </div>
            </div>
            <div class="info-card">
              <div class="label">Type de prestation</div>
              <div class="value">{{ operation.type_prestation }}</div>
            </div>
            <div class="info-card">
              <div class="label">Adresse</div>
              <div class="value">{{ operation.adresse_intervention }}</div>
            </div>
            <div class="info-card">
              <div class="label">Contact</div>
              <div class="value">
                <a href="tel:{{ operation.client.telephone }}" style="color:var(--primary); text-decoration:none">
                  {{ operation.client.telephone }}
                </a>
                {% if operation.client.email %}
                <br><a href="mailto:{{ operation.client.email }}" style="color:var(--primary); text-decoration:none">
                  {{ operation.client.email }}
                </a>
                {% endif %}
              </div>
            </div>
          </div>
        </section>

        <!-- Section Statut du devis -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" stroke="currentColor" stroke-width="1.6"/></svg>
              Statut du devis
            </h2>
          </div>
          
          <form method="POST" id="devis-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_devis_status">
            
            <div class="info-card">
              <div class="label">Avez-vous cr√©√© un devis ?</div>
              <div class="value">
                <select id="devis-cree" name="devis_cree" class="select" style="max-width:200px">
                  <option value="non">Non</option>
                  <option value="oui">Oui</option>
                </select>
              </div>
            </div>

            <div id="devis-details" style="margin-top:1rem; display:none">
              <div class="info-grid">
                <div class="info-card">
                  <div class="label">Date d'envoi au client</div>
                  <div class="value">
                    <input type="date" id="devis-date-envoi" name="devis_date_envoi" class="input">
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">R√©ponse du client</div>
                  <div class="value">
                    <select id="devis-statut" name="devis_statut" class="select">
                      <option value="en_attente">En attente de r√©ponse</option>
                      <option value="accepte">Devis accept√©</option>
                      <option value="refuse">Devis refus√©</option>
                      <option value="relance">√Ä relancer</option>
                    </select>
                  </div>
                </div>
              </div>

              <div id="devis-accepte-alert" class="alert success" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                <div><strong>Devis accept√© !</strong> Vous pouvez maintenant planifier l'intervention.</div>
              </div>

              <div id="devis-refuse-alert" class="alert danger" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="2"/></svg>
                <div><strong>Devis refus√©</strong> - L'op√©ration ne peut pas progresser.</div>
              </div>

              <div id="devis-attente-alert" class="alert info" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>En attente de r√©ponse</strong> - Le client n'a pas encore r√©pondu.</div>
              </div>

              <div id="devis-relance-alert" class="alert warning" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>√Ä relancer</strong> - Pensez √† relancer le client.</div>
              </div>

              <button type="submit" class="btn success" style="margin-top:1rem">Enregistrer le statut du devis</button>
            </div>

            <div id="no-devis-alert" class="alert info">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0" stroke="currentColor" stroke-width="1.6"/></svg>
              <div><strong>Aucun devis cr√©√©</strong> - Cr√©ez les lignes ci-dessous puis g√©n√©rez le PDF.</div>
            </div>
          </form>
        </section>

        <!-- Section Lignes du devis -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.6"/></svg>
              Devis / Op√©ration - Lignes
            </h2>
            <button class="btn primary" onclick="alert('Fonctionnalit√© PDF en d√©veloppement')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8ZM14 2v6h6" stroke="currentColor" stroke-width="1.5"/></svg>
              G√©n√©rer PDF
            </button>
          </div>
          
          {% if interventions %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Description</th>
                  <th style="width:120px">Montant (‚Ç¨)</th>
                  <th style="width:100px">Actions</th>
                </tr>
              </thead>
              <tbody id="lignes-devis">
                {% for intervention in interventions %}
                <tr data-id="{{ intervention.id }}">
                  <td>{{ intervention.description }}</td>
                  <td><strong>{{ intervention.montant }}</strong></td>
                  <td>
                    <form method="POST" style="display:inline" onsubmit="return confirm('Supprimer cette ligne ?')">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_intervention">
                      <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                      <button type="submit" class="btn danger sm">Supprimer</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>TOTAL</strong></td>
                  <td><strong id="total-devis">{{ montant_total }} ‚Ç¨</strong></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          {% else %}
          <div class="alert info">Aucune ligne ajout√©e au devis</div>
          {% endif %}

          <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border)">
            <h4 style="margin-bottom:1rem; color:var(--text); font-size:1rem">Ajouter une ligne</h4>
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="add_intervention">
              <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap">
                <div style="flex:1; min-width:250px">
                  <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Description</label>
                  <input type="text" name="description" class="input" placeholder="Ex: Main d'≈ìuvre, Fournitures..." required>
                </div>
                <div style="flex:0 0 150px">
                  <label style="display:block; margin-bottom:.5rem; color:var(--muted); font-size:.9rem; font-weight:600">Montant (‚Ç¨)</label>
                  <input type="number" name="montant" class="input" placeholder="0.00" step="0.01" required>
                </div>
                <button type="submit" class="btn success">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
                  Ajouter
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- Section Planification -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Planification</h2>
          </div>
          
          <form method="POST" id="planning-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_planning">
            
            <div class="info-card" style="margin-bottom:1rem">
              <div class="label">Cette op√©ration est-elle :</div>
              <div class="value">
                <select id="planification-type" name="planning_type" class="select" style="max-width:300px">
                  <option value="a_planifier">√Ä planifier (intervention future)</option>
                  <option value="deja_realise">D√©j√† r√©alis√©e (saisie apr√®s coup)</option>
                </select>
              </div>
            </div>

            <div id="planning-section">
              <div class="alert warning" id="date-passee-alert" style="display:none">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 9v4M12 17h0M12 3l9 18H3L12 3z" stroke="currentColor" stroke-width="1.6"/></svg>
                <div><strong>Date d√©pass√©e !</strong> La date pr√©vue est pass√©e. Confirmez la r√©alisation ou replanifiez.</div>
              </div>
              
              <div class="info-grid">
                <div class="info-card">
                  <div class="label">Date pr√©vue d'intervention</div>
                  <div class="value">
                    <input type="datetime-local" id="planning-date" name="date_prevue" class="input" 
                           value="{% if operation.date_prevue %}{{ operation.date_prevue|date:'Y-m-d\TH:i' }}{% endif %}">
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">Actions</div>
                  <div class="value">
                    <button type="submit" class="btn success" style="width:100%; margin-bottom:.5rem">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                      Enregistrer la planification
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="deja-realise-section" style="display:none">
              <div class="info-grid">
                <div class="info-card">
                  <div class="label">Date de r√©alisation</div>
                  <div class="value">
                    <input type="datetime-local" id="realisation-date" name="date_realisation" class="input"
                           value="{% if operation.date_realisation %}{{ operation.date_realisation|date:'Y-m-d\TH:i' }}{% endif %}">
                  </div>
                </div>
                
                <div class="info-card">
                  <div class="label">Actions</div>
                  <div class="value">
                    <button type="submit" class="btn success" style="width:100%">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/></svg>
                      Valider la r√©alisation
                    </button>
                  </div>
                </div>
              </div>
              <p style="margin-top:.5rem; color:var(--muted); font-size:.85rem">
                Utilisez cette option si l'intervention a d√©j√† eu lieu et que vous souhaitez la saisir dans le syst√®me.
              </p>
            </div>
          </form>
        </section>

        <!-- Section Paiement (placeholder pour future extension) -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Paiement</h2>
          </div>
          <div class="alert info">
            <div>Module de gestion des paiements √† venir (comptant / √©chelonn√©)</div>
          </div>
        </section>
      </div>

      <div class="right-column">
        <!-- Section Historique -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Historique</h2>
          </div>
          {% if historique %}
          <div class="table-wrap">
            <table>
              <thead><tr><th>Date</th><th>Action</th></tr></thead>
              <tbody>
                {% for entry in historique %}
                <tr>
                  <td style="font-size:.85rem">{{ entry.date|date:"d/m H:i" }}</td>
                  <td style="font-size:.9rem">{{ entry.action }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert info">Aucun historique</div>
          {% endif %}
        </section>
      </div>
    </div>

    <div style="margin-top:1.5rem">
      <a href="{% url 'operations' %}" class="btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5"/></svg>
        Retour aux op√©rations
      </a>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ============================================
  // VARIABLES GLOBALES
  // ============================================
  let MONTANT_TOTAL = {{ montant_total|default:0 }};
  const LIGNES_INITIALES = {{ lignes_json|safe }};
  
  // ============================================
  // FONCTIONS UTILITAIRES
  // ============================================
  
  function getNowFormatted() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
  }

  function getTodayDate() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate());
  }

  function formatMontant(montant) {
    return new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(montant) + ' ‚Ç¨';
  }

  // ============================================
  // GESTION DU STATUT DU DEVIS
  // ============================================
  
  const devisCreeSelect = document.getElementById('devis-cree');
  const devisDetails = document.getElementById('devis-details');
  const noDevisAlert = document.getElementById('no-devis-alert');
  const devisStatutSelect = document.getElementById('devis-statut');

  function updateDevisDisplay() {
    const isCreated = devisCreeSelect.value === 'oui';
    devisDetails.style.display = isCreated ? 'block' : 'none';
    noDevisAlert.style.display = isCreated ? 'none' : 'flex';
    if (isCreated) {
      updateDevisAlerts();
    }
  }

  function updateDevisAlerts() {
    const statut = devisStatutSelect.value;
    
    // Cacher toutes les alertes
    document.getElementById('devis-accepte-alert').style.display = 'none';
    document.getElementById('devis-refuse-alert').style.display = 'none';
    document.getElementById('devis-attente-alert').style.display = 'none';
    document.getElementById('devis-relance-alert').style.display = 'none';
    
    // Afficher l'alerte correspondante
    if (statut === 'accepte') {
      document.getElementById('devis-accepte-alert').style.display = 'flex';
    } else if (statut === 'refuse') {
      document.getElementById('devis-refuse-alert').style.display = 'flex';
    } else if (statut === 'en_attente') {
      document.getElementById('devis-attente-alert').style.display = 'flex';
    } else if (statut === 'relance') {
      document.getElementById('devis-relance-alert').style.display = 'flex';
    }
  }

  if (devisCreeSelect && devisStatutSelect) {
    devisCreeSelect.addEventListener('change', updateDevisDisplay);
    devisStatutSelect.addEventListener('change', updateDevisAlerts);
    updateDevisDisplay();
  }

  // ============================================
  // GESTION DE LA PLANIFICATION
  // ============================================
  
  const planificationType = document.getElementById('planification-type');
  const planningSection = document.getElementById('planning-section');
  const dejaRealiseSection = document.getElementById('deja-realise-section');
  const planningDate = document.getElementById('planning-date');
  const realisationDate = document.getElementById('realisation-date');
  const datePasseeAlert = document.getElementById('date-passee-alert');

  function updatePlanningDisplay() {
    const type = planificationType.value;
    
    if (type === 'a_planifier') {
      planningSection.style.display = 'block';
      dejaRealiseSection.style.display = 'none';
      checkDatePassee();
    } else {
      planningSection.style.display = 'none';
      dejaRealiseSection.style.display = 'block';
      
      // Pr√©-remplir avec la date actuelle si vide
      if (!realisationDate.value) {
        realisationDate.value = getNowFormatted();
      }
    }
  }

  function checkDatePassee() {
    if (planningDate.value) {
      const dateSelectionnee = new Date(planningDate.value);
      const maintenant = new Date();
      
      if (dateSelectionnee < maintenant) {
        datePasseeAlert.style.display = 'flex';
      } else {
        datePasseeAlert.style.display = 'none';
      }
    }
  }

  if (planificationType) {
    planificationType.addEventListener('change', updatePlanningDisplay);
    updatePlanningDisplay();
  }

  if (planningDate) {
    planningDate.addEventListener('change', checkDatePassee);
    checkDatePassee();
  }

  // ============================================
  // CALCUL AUTOMATIQUE DU TOTAL (c√¥t√© client)
  // ============================================
  
  function calculerTotalDevis() {
    const tbody = document.getElementById('lignes-devis');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    let total = 0;
    
    rows.forEach(row => {
      const montantCell = row.querySelector('td:nth-child(2) strong');
      if (montantCell) {
        const montantText = montantCell.textContent.trim();
        const montant = parseFloat(montantText.replace(',', '.')) || 0;
        total += montant;
      }
    });
    
    MONTANT_TOTAL = total;
    
    const totalElement = document.getElementById('total-devis');
    if (totalElement) {
      totalElement.textContent = formatMontant(total);
    }
  }

  // Calculer le total au chargement si des lignes existent
  if (document.getElementById('lignes-devis')) {
    calculerTotalDevis();
  }

  // ============================================
  // GESTION DES PAIEMENTS √âCHELONN√âS (FUTUR)
  // ============================================
  
  const optComptant = document.getElementById('option-comptant');
  const optEchelonne = document.getElementById('option-echelonne');
  const radioComptant = document.getElementById('radio-comptant');
  const radioEchelonne = document.getElementById('radio-echelonne');

  function toggleModePaiement() {
    if (!radioComptant || !radioEchelonne) return;
    
    const isComptant = radioComptant.checked;
    
    if (optComptant) optComptant.classList.toggle('selected', isComptant);
    if (optEchelonne) optEchelonne.classList.toggle('selected', !isComptant);
    
    const comptantFields = document.getElementById('comptant-fields');
    const echelonneFields = document.getElementById('echelonne-fields');
    
    if (comptantFields) comptantFields.style.display = isComptant ? 'block' : 'none';
    if (echelonneFields) echelonneFields.style.display = isComptant ? 'none' : 'block';
  }

  if (optComptant && optEchelonne && radioComptant && radioEchelonne) {
    optComptant.addEventListener('click', () => {
      radioComptant.checked = true;
      toggleModePaiement();
    });
    
    optEchelonne.addEventListener('click', () => {
      radioEchelonne.checked = true;
      toggleModePaiement();
    });
    
    radioComptant.addEventListener('change', toggleModePaiement);
    radioEchelonne.addEventListener('change', toggleModePaiement);
    
    toggleModePaiement();
  }

  // ============================================
  // GESTION DES √âCH√âANCES (MODULE AVANC√â - FUTUR)
  // ============================================
  
  let echeances = [];
  let echeanceCounter = 0;

  window.ajouterEcheance = function() {
    echeanceCounter++;
    const id = 'ech-' + echeanceCounter;
    echeances.push({
      id: id,
      montant: 0,
      date: getTodayDate()
    });
    renderEcheances();
  };

  window.supprimerEcheance = function(id) {
    echeances = echeances.filter(e => e.id !== id);
    renderEcheances();
  };

  function calculerReste() {
    const total = echeances.reduce((sum, e) => sum + e.montant, 0);
    const resteElement = document.getElementById('reste-calcul');
    if (resteElement) {
      resteElement.textContent = formatMontant(MONTANT_TOTAL - total);
    }
  }

  function renderEcheances() {
    const tbody = document.getElementById('echeances-list');
    if (!tbody) return;
    
    // Supprimer les lignes d'√©ch√©ances existantes
    const existingRows = tbody.querySelectorAll('.echeance-row');
    existingRows.forEach(row => row.remove());
    
    const totalRow = tbody.querySelector('.total-row');
    
    // Ajouter chaque √©ch√©ance
    echeances.forEach((ech, i) => {
      const row = document.createElement('tr');
      row.className = 'echeance-row';
      row.innerHTML = `
        <td>√âch. ${i + 1}</td>
        <td>
          <input type="number" step="0.01" min="0" 
                 class="input" style="max-width:100px; margin:0" 
                 data-id="${ech.id}" data-field="montant" 
                 value="${ech.montant || ''}"> ‚Ç¨
        </td>
        <td>
          <input type="date" value="${ech.date}" 
                 class="input" style="max-width:150px" 
                 data-id="${ech.id}" data-field="date">
        </td>
        <td>
          <button type="button" class="btn sm" onclick="supprimerEcheance('${ech.id}')">√ó</button>
        </td>
      `;
      
      if (totalRow && totalRow.nextSibling) {
        totalRow.parentNode.insertBefore(row, totalRow.nextSibling);
      } else if (totalRow) {
        tbody.appendChild(row);
      }
    });
    
    // Ajouter les √©v√©nements sur les inputs
    document.querySelectorAll('.echeance-row input').forEach(input => {
      input.addEventListener('input', (e) => {
        const id = e.target.dataset.id;
        const field = e.target.dataset.field;
        const echeance = echeances.find(e => e.id === id);
        
        if (echeance) {
          if (field === 'montant') {
            echeance.montant = parseFloat(e.target.value) || 0;
          } else if (field === 'date') {
            echeance.date = e.target.value;
          }
          calculerReste();
        }
      });
    });
    
    calculerReste();
  }

  // ============================================
  // INITIALISATION DES DATES PAR D√âFAUT
  // ============================================
  
  const datePaiementInput = document.getElementById('date-paiement');
  if (datePaiementInput && !datePaiementInput.value) {
    datePaiementInput.value = getTodayDate();
  }

  const devisDateEnvoi = document.getElementById('devis-date-envoi');
  if (devisDateEnvoi && !devisDateEnvoi.value) {
    devisDateEnvoi.value = getTodayDate();
  }

  // ============================================
  // CONFIRMATION AVANT SUPPRESSION
  // ============================================
  
  document.querySelectorAll('form[onsubmit*="confirm"]').forEach(form => {
    form.addEventListener('submit', function(e) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette ligne ?')) {
        e.preventDefault();
        return false;
      }
    });
  });

  // ============================================
  // DEBUG (√† retirer en production)
  // ============================================
  
  console.log('üìä Donn√©es charg√©es:');
  console.log('- Montant total:', MONTANT_TOTAL);
  console.log('- Lignes initiales:', LIGNES_INITIALES);
  console.log('‚úÖ JavaScript initialis√© avec succ√®s');
});
</script>
</body>
</html>