<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Opérations – CRM Artisans</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --primary: #6366f1; /* indigo */
      --success: #22c55e; /* green */
      --warning: #f59e0b; /* amber */
      --danger: #ef4444; /* red */
      --accent: #8b5cf6; /* violet */
      --ring: rgba(99,102,241,.35);
      --border: rgba(148,163,184,.15);
      --shadow: 0 10px 25px rgba(2,6,23,.3), 0 1px 0 rgba(255,255,255,.03) inset;

      /* Variables pour mode clair */
      --bg-light: #f8fafc;
      --card-light: #ffffff;
      --text-light: #1e293b;
      --muted-light: #64748b;
      --border-light: rgba(30,41,59,.12);
      --shadow-light: 0 10px 25px rgba(30,41,59,.08), 0 1px 0 rgba(255,255,255,.8) inset;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.12), transparent 40%),
                  radial-gradient(1000px 600px at 80% 10%, rgba(139,92,246,.12), transparent 40%),
                  var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    /* Header (identique Dashboard) */
    .header{ 
      position: sticky; top: 0; z-index: 40; 
      backdrop-filter: saturate(180%) blur(8px); 
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.65)); 
      border-bottom: 1px solid var(--border) 
    }
    .header-inner{ 
      max-width:1280px; margin:0 auto; padding:.85rem 1rem; 
      display:flex; align-items:center; gap:1rem; justify-content:space-between 
    }
    .brand{ display:flex; align-items:center; gap:.75rem; font-weight:700; letter-spacing:.2px }
    .logo{ 
      width:34px; height:34px; border-radius:10px; 
      background:linear-gradient(145deg, var(--primary), var(--accent)); 
      box-shadow: var(--shadow); display:grid; place-items:center 
    }
    .logo svg{ width:18px; height:18px; color:white }
    .nav{ display:flex; gap:.25rem; align-items:center }
    .nav a{ 
      text-decoration:none; color:var(--muted); padding:.55rem .8rem; 
      border-radius:10px; border:1px solid transparent 
    }
    .nav a:hover{ color:var(--text); background:rgba(148,163,184,.08); border-color:var(--border) }
    .nav a.active{ 
      color:white; background:rgba(99,102,241,.18); 
      border-color: rgba(99,102,241,.35); box-shadow: 0 0 0 2px var(--ring) 
    }
    .user{ display:flex; align-items:center; gap:.75rem; color:var(--muted); font-size:.95rem }
    .user form button{ 
      background:none; border:none; color:var(--muted); cursor:pointer; 
      text-decoration:underline; font:inherit 
    }

    /* Main */
    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    .page-title{ 
      font-size: clamp(1.4rem, 2.4vw, 2rem); font-weight:800; 
      letter-spacing:.2px; margin-bottom:.25rem 
    }
    .subtitle{ color:var(--muted); margin:0 0 1.25rem }

    /* Cards/sections */
    .section{ 
      background: linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,.4)); 
      border:1px solid var(--border); border-radius:16px; padding:1rem; 
      box-shadow: var(--shadow); margin-top:1rem 
    }
    .section-header{ 
      display:flex; align-items:center; justify-content:space-between; gap:1rem; 
      padding:.4rem .35rem .9rem; border-bottom:1px dashed var(--border) 
    }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700 }
    .badge{ 
      font-size:.75rem; color:var(--muted); padding:.15rem .5rem; 
      border-radius:999px; border:1px solid var(--border); 
      background: rgba(148,163,184,.08) 
    }

    /* Toolbar & buttons */
    .toolbar{ display:flex; gap:.5rem; flex-wrap:wrap }
    .btn{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; 
      border-radius:10px; border:1px solid var(--border); 
      background:rgba(148,163,184,.07); color:var(--text); 
      text-decoration:none; cursor:pointer; font:inherit 
    }
    .btn:hover{ background:rgba(148,163,184,.12) }
    .btn.primary{ 
      background:linear-gradient(180deg, rgba(99,102,241,.18), rgba(99,102,241,.12)); 
      border-color: rgba(99,102,241,.35); color: white 
    }

    /* Search */
    .search{ display:grid; gap:.8rem; grid-template-columns: 1fr auto auto }
    .field{ display:grid; gap:.35rem }
    .label{ color:var(--muted); font-size:.9rem; font-weight:600 }
    .input{ 
      width:100%; padding:.65rem .8rem; border-radius:10px; 
      border:1px solid var(--border); background: rgba(2,6,23,.35); 
      color: var(--text); font:inherit 
    }
    .input::placeholder{ color: rgba(226,232,240,.55) }
    .input:focus{ 
      outline:none; box-shadow: 0 0 0 2px var(--ring); 
      border-color: rgba(99,102,241,.35) 
    }

    /* Filters quick */
    .filters-quick{ display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom: 1rem }
    .filter-btn{ 
      display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; 
      border-radius:10px; border:1px solid var(--border); 
      background:rgba(148,163,184,.05); color:var(--text); 
      text-decoration:none; font-size:.9rem 
    }
    .filter-btn:hover{ background:rgba(148,163,184,.1) }
    .filter-btn.active{ 
      background:linear-gradient(180deg, rgba(99,102,241,.18), rgba(99,102,241,.12)); 
      border-color: rgba(99,102,241,.35); color: white 
    }

    /* Table */
    .table-wrap{ overflow:auto; border-radius:12px; border:1px solid var(--border) }
    table{ width:100%; border-collapse: collapse; min-width: 1100px }
    thead th{ 
      position:sticky; top:0; background: rgba(15,23,42,.9); backdrop-filter: blur(6px); 
      color:var(--muted); text-transform:uppercase; letter-spacing:.08rem; 
      font-size:.75rem; text-align:left; padding:.9rem .85rem; 
      border-bottom:1px solid var(--border) 
    }
    tbody td{ padding:.9rem .85rem; border-bottom:1px dashed var(--border); vertical-align: top }
    tbody tr:hover{ background: rgba(148,163,184,.05) }

    .operation-id{ font-weight:700; color: var(--primary) }
    .client-name{ font-weight:600 }
    .muted{ color: var(--muted) }
    .nowrap{ white-space:nowrap }
    .chip{ 
      display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; 
      border-radius:999px; font-size:.78rem; border:1px solid var(--border); 
      color: var(--muted); background: rgba(148,163,184,.08) 
    }
    .chip.status{ color:#60a5fa; border-color: rgba(59,130,246,.35); background: rgba(59,130,246,.08) }
    .chip.en-attente{ color:#f59e0b; border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08) }
    .chip.realise{ color:#22c55e; border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08) }

    .documents{ display:flex; gap:.3rem }
    .doc-btn{ 
      padding:.25rem .5rem; background: rgba(148,163,184,.08); 
      border:1px solid var(--border); border-radius:6px; 
      text-decoration:none; color:var(--muted); font-size:.8rem 
    }
    .doc-btn:hover{ background: rgba(148,163,184,.12) }

    .btn-view{ 
      display:inline-flex; align-items:center; gap:.35rem; padding:.4rem .7rem; 
      border-radius:8px; border:1px solid rgba(99,102,241,.35); 
      background: rgba(99,102,241,.15); color:white; text-decoration:none; font-size:.8rem 
    }
    .btn-view:hover{ box-shadow: 0 0 0 2px var(--ring) }

    .total-count{ margin-bottom: 1rem; color: var(--muted); font-size: .9rem }

    /* Responsive: table -> cartes */
    @media (max-width: 780px){
      .search{ grid-template-columns: 1fr; }
      .filters-quick{ justify-content: center; }
      .table-wrap{ border:none }
      table{ display:block }
      thead{ display:none }
      tbody{ display:grid; gap:.75rem }
      tbody tr{ 
        display:grid; gap:.45rem; border:1px solid var(--border); 
        border-radius:12px; padding:.85rem; background: rgba(2,6,23,.5) 
      }
      tbody td{ padding:.15rem 0; border:none }
      tbody td[data-label]{ color:var(--muted); font-size:.78rem }
    }

    /* Light mode - Aligné avec Dashboard */
    @media (prefers-color-scheme: light){
      :root{ 
        --bg: var(--bg-light); 
        --card: var(--card-light); 
        --text: var(--text-light); 
        --muted: var(--muted-light); 
        --border: var(--border-light); 
        --shadow: var(--shadow-light);
      }
      
      body{ 
        background: radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.05), transparent 40%), 
                    radial-gradient(1000px 600px at 80% 10%, rgba(139,92,246,.05), transparent 40%), 
                    var(--bg) 
      }
      
      .header{ 
        background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.8));
        backdrop-filter: saturate(180%) blur(8px);
        border-bottom: 1px solid var(--border);
      }
      
      .section{ 
        background: var(--card); 
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      
      .table-wrap{ 
        background: var(--card); 
        border: 1px solid var(--border) 
      }
      
      thead th{ 
        background: rgba(248,250,252,.95); 
        backdrop-filter: blur(6px);
        color: var(--muted) 
      }
      
      .input{ 
        background: #fff; 
        border-color: var(--border); 
        color: var(--text) 
      }
      .input::placeholder{ color: rgba(100,116,139,.6) }
      
      .nav a{ color: var(--muted) }
      .nav a:hover{ color: var(--text) }
      .nav a.active{ 
        color: var(--primary); 
        background: rgba(99,102,241,.08); 
        border-color: rgba(99,102,241,.2) 
      }
      
      .user{ color: var(--muted) }
      .user form button{ color: var(--muted) }
      
      .btn{ 
        background: rgba(148,163,184,.06); 
        color: var(--text);
        border: 1px solid var(--border);
      }
      .btn:hover{ background: rgba(148,163,184,.1) }
      
      .btn.primary{ 
        background: rgba(99,102,241,.1); 
        border-color: rgba(99,102,241,.2);
        color: var(--primary);
      }
      
      .filter-btn{ 
        background: rgba(148,163,184,.04); 
        color: var(--text);
      }
      .filter-btn.active{ 
        background: rgba(99,102,241,.1); 
        border-color: rgba(99,102,241,.2);
        color: var(--primary);
      }
      
      .operation-id{ color: var(--primary) }
      
      .chip{ 
        color: var(--muted);
        border: 1px solid var(--border);
        background: rgba(148,163,184,.04);
      }
      
      .chip.status{ 
        color: #2563eb; 
        border-color: rgba(37,99,235,.25); 
        background: rgba(37,99,235,.06);
      }
      
      .chip.en-attente{ 
        color: #d97706; 
        border-color: rgba(217,119,6,.25); 
        background: rgba(217,119,6,.06);
      }
      
      .chip.realise{ 
        color: #16a34a; 
        border-color: rgba(22,163,74,.25); 
        background: rgba(22,163,74,.06);
      }
      
      .doc-btn{ 
        background: rgba(148,163,184,.04); 
        color: var(--muted);
      }
      
      .btn-view{ 
        background: rgba(99,102,241,.1); 
        border-color: rgba(99,102,241,.2);
        color: var(--primary);
      }
      
      tbody tr{ background: transparent }
      tbody tr:hover{ background: rgba(148,163,184,.03) }
      
      @media (max-width:780px){ 
        tbody tr{ 
          background: rgba(248,250,252,.8);
          border: 1px solid var(--border);
        } 
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav class="nav" aria-label="Navigation principale">
        <a href="{% url 'dashboard' %}">Accueil</a>
        <a href="{% url 'operations' %}" class="active">Opérations</a>
        <a href="{% url 'clients' %}">Clients</a>
      </nav>
      <div class="user">
        <span>Connecté·e : {{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" title="Se déconnecter">Déconnexion</button>
        </form>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="page-title">Gestion des opérations</h1>
    <p class="subtitle">{{ operations|length|default:0 }} opération(s) trouvée(s)</p>

    <!-- Section Filtres Rapides -->
    <section class="section" aria-labelledby="filters-title">
      <div class="section-header">
        <h2 class="section-title" id="filters-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 6h18M9 12h6m-4 6h2" stroke="currentColor" stroke-width="1.6"/></svg>
          Filtres rapides
        </h2>
        <div class="toolbar">
          {% if statut_filtre or ville_filtre or search %}
            <a href="{% url 'operations' %}" class="btn">Effacer filtres</a>
          {% endif %}
        </div>
      </div>
      
      <div class="filters-quick">
        <a href="?statut=en_attente_devis" class="filter-btn {% if statut_filtre == 'en_attente_devis' %}active{% endif %}">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2Z" stroke="currentColor" stroke-width="1.6"/></svg>
          En attente devis
        </a>
        <a href="?statut=a_planifier" class="filter-btn {% if statut_filtre == 'a_planifier' %}active{% endif %}">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="1.6"/></svg>
          À planifier
        </a>
        <a href="?statut=realise" class="filter-btn {% if statut_filtre == 'realise' %}active{% endif %}">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 12v-2" stroke="currentColor" stroke-width="1.6"/></svg>
          Attente paiement
        </a>
      </div>

      <form method="GET" style="padding:.6rem .4rem 0">
        <div class="search">
          <label class="field">
            <span class="label">Recherche & filtres</span>
            <input class="input" type="text" name="search" value="{{ search|default:'' }}" placeholder="Client, opération, ville, téléphone...">
          </label>
          <button type="submit" class="btn primary">Rechercher</button>
          <a href="{% url 'operations' %}" class="btn">Effacer</a>
        </div>
      </form>
    </section>

    <!-- Liste des opérations -->
    <section class="section" aria-labelledby="operations-title">
      <div class="section-header">
        <h2 class="section-title" id="operations-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 10h10M7 14h7M4 6h16v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6Z" stroke="currentColor" stroke-width="1.6"/></svg>
          Opérations <span class="badge">{{ total_operations }}</span>
        </h2>
        <div class="toolbar" aria-label="Actions rapides">
          {% if statut_filtre %}<span class="chip status">Statut: {{ statut_filtre }}</span>{% endif %}
          {% if ville_filtre %}<span class="chip status">Ville: {{ ville_filtre }}</span>{% endif %}
          <a href="/operations/nouvelle/" class="btn primary">Nouvelle opération</a>
        </div>
      </div>

      {% if operations %}
        <div class="total-count">
          {{ operations|length }} opération{{ operations|length|pluralize }} trouvée{{ operations|length|pluralize }}
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Id Client</th>
                <th>Date</th>
                <th>Client / Opération</th>
                <th>Ville</th>
                <th>Montant</th>
                <th>Statut</th>
                <th>Documents</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for operation in operations %}
              <tr>
                <td class="operation-id" data-label="Id">{{ operation.client.id_client }}</td>
                <td data-label="Date">
                  <div class="nowrap">
                    {% if operation.date_prevue %}
                      {{ operation.date_prevue|date:"d/m/Y H:i" }}
                    {% else %}
                      {{ operation.date_creation|date:"d/m/Y" }}
                    {% endif %}
                  </div>
                </td>
                <td data-label="Client">
                  <div class="client-name">{{ operation.client.nom }} {{ operation.client.prenom }}</div>
                  <div class="muted">{{ operation.type_prestation|truncatechars:40 }}</div>
                </td>
                <td data-label="Ville">{{ operation.client.ville|default:"—" }}</td>
                <td data-label="Montant">
                  {% if operation.montant_total %}
                    {{ operation.montant_total }}€
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td data-label="Statut">
                  {% if operation.statut == 'en_attente_devis' %}
                    <span class="chip en-attente">En attente devis</span>
                  {% elif operation.statut == 'a_planifier' %}
                    <span class="chip status">À planifier</span>
                  {% elif operation.statut == 'realise' %}
                    <span class="chip realise">Attente paiement</span>
                  {% else %}
                    <span class="chip">{{ operation.get_statut_display }}</span>
                  {% endif %}
                </td>
                <td data-label="Documents">
                  <div class="documents">
                    <a href="#" class="doc-btn" title="Devis">📄</a>
                    {% if operation.peut_generer_facture %}
                      <a href="#" class="doc-btn" title="Facture">🧾</a>
                    {% endif %}
                  </div>
                </td>
                <td data-label="Actions">
                  <div class="toolbar">
                    <a href="/operations/{{ operation.id }}/" class="btn-view" title="Voir les détails">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 5C7 5 3.73 8.11 2 12c1.73 3.89 5 7 10 7s8.27-3.11 10-7c-1.73-3.89-5-7-10-7Zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z" stroke="currentColor" stroke-width="1.6"/></svg>
                      Voir
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="section" style="text-align:center">
          <p style="color:var(--muted); padding:1rem">Aucune opération ne correspond à votre recherche.</p>
          <div class="toolbar" style="justify-content:center; padding-bottom:.5rem">
            <a href="/operations/nouvelle/" class="btn primary">Créer la première opération</a>
          </div>
        </div>
      {% endif %}
    </section>

    <!-- Pagination -->
    {% if page_obj %}
      <section class="section" style="display:flex; justify-content:space-between; align-items:center">
        <span class="muted">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
        <div class="toolbar">
          {% if page_obj.has_previous %}
            <a class="btn" href="?page={{ page_obj.previous_page_number }}&search={{ search }}">Précédent</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a class="btn" href="?page={{ page_obj.next_page_number }}&search={{ search }}">Suivant</a>
          {% endif %}
        </div>
      </section>
    {% endif %}
  </main>

  <script>
    // Recherche instantanée (optionnelle)
    document.querySelector('input[name="search"]').addEventListener('input', function(e) {
      clearTimeout(this.searchTimeout);
      this.searchTimeout = setTimeout(() => {
        if (e.target.value.length > 2 || e.target.value.length === 0) {
          const form = e.target.closest('form');
          form.submit();
        }
      }, 800);
    });
  </script>
{% if messages %}
{% for message in messages %}
<div class="alert {{ message.tags }}">
  {{ message }}
</div>
{% endfor %}

<script>
setTimeout(function() {
  document.querySelectorAll('.alert').forEach(el => el.remove());
}, 3000); // 3 secondes
</script>
{% endif %}
</body>
</html>