<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Opérations – CRM Artisans</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg: #0b1220; --card:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --border: rgba(148,163,184,.15);
      --primary:#6366f1; --accent:#8b5cf6; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444;
      --ring: rgba(99,102,241,.35); --shadow: 0 10px 25px rgba(2,6,23,.25);
      --chip-bg: rgba(148,163,184,.06);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#475569; --border: rgba(2,6,23,.12); --chip-bg:#f1f5f9; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--text); line-height:1.5}

    /* Header identique */
    .header{ position: sticky; top: 0; z-index: 40; backdrop-filter: saturate(180%) blur(8px); background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.65)); border-bottom: 1px solid var(--border) }
    .header-inner{ max-width:1280px; margin:0 auto; padding:.85rem 1rem; display:flex; align-items:center; gap:1rem; justify-content:space-between }
    .brand{ display:flex; align-items:center; gap:.75rem; font-weight:700; letter-spacing:.2px }
    .logo{ width:34px; height:34px; border-radius:10px; background:linear-gradient(145deg, var(--primary), var(--accent)); box-shadow: var(--shadow); display:grid; place-items:center }
    .logo svg{ width:18px; height:18px; color:white }
    .nav{ display:flex; gap:.25rem; align-items:center }
    .nav a{ text-decoration:none; color:var(--muted); padding:.55rem .8rem; border-radius:10px; border:1px solid transparent }
    .nav a:hover{ color:var(--text); background:rgba(148,163,184,.08); border-color:var(--border) }
    .nav a.active{ color:white; background:rgba(99,102,241,.18); border-color: rgba(99,102,241,.35); box-shadow: 0 0 0 2px var(--ring) }

    .container{max-width:1200px;margin:1.25rem auto;padding:0 1rem}
    .page-title{font-size:clamp(1.4rem,2.2vw,1.9rem);font-weight:800;margin:.25rem 0}
    .subtitle{color:var(--muted);margin:0 0 1rem}

    /* KPI strip (3 essentiels) */
    .kpi-strip{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.8rem;margin:1rem 0}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem;box-shadow:var(--shadow);display:grid;gap:.45rem}
    .kpi h3{margin:0;font-size:.78rem;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.06em}
    .kpi .value{font-variant-numeric:tabular-nums;font-size:1.6rem;font-weight:800}
    .kpi .sub{color:var(--muted);font-size:.8rem}

    /* Filtres compacts */
    .filters{background:var(--card);padding:.6rem;border:1px solid var(--border);border-radius:12px;margin:1rem 0}
    .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:.8rem;margin-bottom:.75rem}
    .filter-group{background:rgba(148,163,184,.03);border:1px solid var(--border);border-radius:10px;padding:.75rem}
    .filter-title{font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05rem;margin-bottom:.5rem}
    .filter-chips{display:flex;flex-direction:column;gap:.35rem}
    .chip{display:flex;align-items:center;justify-content:space-between;padding:.4rem .6rem;border-radius:6px;border:1px solid var(--border);background:rgba(148,163,184,.05);color:var(--text);text-decoration:none;font-size:.85rem;transition:all .2s}
    .chip:hover{background:rgba(148,163,184,.1);transform:translateX(2px)}
    .chip.active{background:linear-gradient(90deg,rgba(99,102,241,.18),rgba(99,102,241,.12));border-color:rgba(99,102,241,.35);color:white;font-weight:600}
    .chip.alert{border-color:var(--danger);background:rgba(239,68,68,.08)}
    .chip.alert.active{background:linear-gradient(90deg,rgba(239,68,68,.2),rgba(239,68,68,.15));color:white}
    .chip.warning{border-color:var(--warning);background:rgba(245,158,11,.08)}
    .chip.warning.active{background:linear-gradient(90deg,rgba(245,158,11,.2),rgba(245,158,11,.15));color:white}
    .count{background:rgba(148,163,184,.15);padding:.1rem .4rem;border-radius:999px;font-size:.7rem;font-weight:700;min-width:24px;text-align:center}
    .chip.active .count{background:rgba(255,255,255,.25)}

    /* Recherche */
    .search-bar{display:flex;gap:.5rem;flex-wrap:wrap;padding-top:.75rem;border-top:1px solid var(--border)}
    .input{padding:.5rem .7rem;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);flex:1;min-width:200px}
    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .8rem;border-radius:10px;border:1px solid var(--border);background:var(--chip-bg);color:var(--text);text-decoration:none;cursor:pointer;font:inherit}
    .btn.primary{background:rgba(99,102,241,.18);border-color:rgba(99,102,241,.35);color:#fff}

    /* Section liste */
    .section{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);margin-top:1rem}
    .section-h{display:flex;justify-content:space-between;align-items:center;padding:.8rem 1rem;border-bottom:1px dashed var(--border)}
    .section-h h2{margin:0;font-size:1rem;display:flex;align-items:center;gap:.6rem;font-weight:800}
    .badge{font-size:.75rem;background:var(--chip-bg);border:1px solid var(--border);border-radius:999px;padding:.15rem .6rem;color:var(--muted)}

    /* Table */
    .table-wrap{overflow:auto;border-radius:0 0 14px 14px}
    table{width:100%;border-collapse:collapse;min-width:960px}
    thead th{position:sticky;top:0;background:var(--card);color:var(--muted);text-transform:uppercase;letter-spacing:.06em;font-size:.72rem;text-align:left;padding:.7rem .8rem;border-bottom:1px solid var(--border)}
    tbody td{padding:.7rem .8rem;border-bottom:1px dashed var(--border);vertical-align:top}
    tbody tr:hover{background:rgba(148,163,184,.06)}
    .id{color:var(--primary);font-weight:800}
    .status{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);background:var(--chip-bg);font-size:.78rem}
    .status.ok{color:var(--success);border-color:rgba(34,197,94,.35)}
    .status.warn{color:var(--warning);border-color:rgba(245,158,11,.35)}
    .status.bad{color:var(--danger);border-color:rgba(239,68,68,.35)}

    @media (max-width:760px){
      .kpi-strip{grid-template-columns:1fr}
      .filter-grid{grid-template-columns:1fr}
      thead{display:none}
      table{display:block}
      tbody{display:grid;gap:.75rem}
      tbody tr{display:grid;gap:.45rem;border:1px solid var(--border);border-radius:12px;padding:.85rem;background:var(--card)}
      tbody td{padding:.15rem 0;border:0}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo"><svg viewBox="0 0 24 24" fill="none"><path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/></svg></div>
        <span>CRM Artisans</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}">Accueil</a>
        <a href="{% url 'operations' %}" class="active">Opérations</a>
        <a href="{% url 'clients' %}">Clients</a>
      </nav>
      <div class="muted">{{ user.username }}</div>
    </div>
  </header>

  <main class="container">
    <h1 class="page-title">Opérations</h1>
    <p class="subtitle">{{ nb_total }} opération{{ nb_total|pluralize }}</p>

    <!-- KPI -->
    <section class="kpi-strip">
      <article class="kpi">
        <h3>CA encaissé</h3>
        <div class="value">{{ ca_encaisse|floatformat:0 }} €</div>
        <div class="sub">Paiements confirmés</div>
      </article>
      <article class="kpi">
        <h3>Encours</h3>
        <div class="value">{{ ca_en_attente_total|floatformat:0 }} €</div>
        <div class="sub">dont retard : <strong>{{ ca_retard|floatformat:0 }} €</strong></div>
      </article>
      <article class="kpi">
        <h3>Prévisionnel</h3>
        <div class="value">{{ ca_previsionnel|floatformat:0 }} €</div>
        <div class="sub">Opérations planifiées</div>
      </article>
    </section>

    <!-- Filtres compacts -->
    <form method="GET" class="filters">
      <div class="filter-grid">
        <!-- Cycle -->
        <div class="filter-group">
          <div class="filter-title">🔄 Cycle</div>
          <div class="filter-chips">
            <a href="?filtre=toutes" class="chip {% if filtre_actif == 'toutes' %}active{% endif %}">
              <span>Toutes</span><span class="count">{{ nb_total }}</span>
            </a>
            <a href="?filtre=en_attente_devis" class="chip {% if filtre_actif == 'en_attente_devis' %}active{% endif %}">
              <span>🟡 Devis</span><span class="count">{{ nb_en_attente_devis }}</span>
            </a>
            <a href="?filtre=a_planifier" class="chip {% if filtre_actif == 'a_planifier' %}active{% endif %}">
              <span>🔵 À planifier</span><span class="count">{{ nb_a_planifier }}</span>
            </a>
          </div>
        </div>

        <!-- État -->
        <div class="filter-group">
          <div class="filter-title">📋 État</div>
          <div class="filter-chips">
            <a href="?filtre=planifie" class="chip {% if filtre_actif == 'planifie' %}active{% endif %}">
              <span>📅 Planifiées</span><span class="count">{{ nb_planifie }}</span>
            </a>
            <a href="?filtre=realise" class="chip {% if filtre_actif == 'realise' %}active{% endif %}">
              <span>🟢 Réalisées</span><span class="count">{{ nb_realise }}</span>
            </a>
            <a href="?filtre=paye" class="chip {% if filtre_actif == 'paye' %}active{% endif %}">
              <span>✅ Payées</span><span class="count">{{ nb_paye }}</span>
            </a>
          </div>
        </div>

        <!-- Alertes -->
        <div class="filter-group">
          <div class="filter-title">💰 Alertes</div>
          <div class="filter-chips">
            {% if nb_paiements_retard > 0 %}
            <a href="?filtre=retards" class="chip alert {% if filtre_actif == 'retards' %}active{% endif %}">
              <span>🚨 Retards</span><span class="count">{{ nb_paiements_retard }}</span>
            </a>
            {% endif %}
            {% if nb_operations_sans_paiement > 0 %}
            <a href="?filtre=non_planifies" class="chip warning {% if filtre_actif == 'non_planifies' %}active{% endif %}">
              <span>⚠️ Non planifiés</span><span class="count">{{ nb_operations_sans_paiement }}</span>
            </a>
            {% endif %}
            {% if nb_paiements_retard == 0 and nb_operations_sans_paiement == 0 %}
            <div style="color:var(--success);font-size:.85rem;padding:.5rem;text-align:center">✅ Aucune alerte</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Recherche -->
      <div class="search-bar">
        <input type="text" name="recherche" value="{{ recherche|default:'' }}" placeholder="Client, ville, téléphone…" class="input">
        <input type="hidden" name="filtre" value="{{ filtre_actif }}">
        <button class="btn" type="submit">Rechercher</button>
        {% if recherche %}<a class="btn" href="?filtre={{ filtre_actif }}">Effacer</a>{% endif %}
        <a href="{% url 'operation_create' %}" class="btn primary">+ Nouvelle</a>
      </div>
    </form>

    <!-- Liste -->
    <section class="section">
      <div class="section-h">
        <h2>
          {% if filtre_actif == 'retards' %}🚨 Retards{% elif filtre_actif == 'non_planifies' %}⚠️ Non planifiés{% else %}{{ filtre_actif|title }}{% endif %}
          <span class="badge">{{ total_operations }}</span>
        </h2>
      </div>

      {% if operations %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Date</th><th>Client / Opération</th>
              {% if filtre_actif == 'retards' %}
                <th>Échéance</th><th>Retard</th><th>Montant</th>
              {% elif filtre_actif == 'non_planifies' %}
                <th>Réalisation</th><th>Total</th>
              {% else %}
                <th>Ville</th><th>Montant</th><th>Statut</th>
              {% endif %}
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for operation in operations %}
            <tr>
              <td class="id">{{ operation.id_operation }}</td>
              <td>{% if operation.date_prevue %}{{ operation.date_prevue|date:"d/m/Y" }}{% else %}{{ operation.date_creation|date:"d/m/Y" }}{% endif %}</td>
              <td>
                <div style="font-weight:700">{{ operation.client.nom }} {{ operation.client.prenom }}</div>
                <div style="color:var(--muted);font-size:.85rem">{{ operation.type_prestation|truncatechars:50 }}</div>
              </td>
              {% if filtre_actif == 'retards' %}
                <td>{% if operation.premier_retard %}{{ operation.premier_retard.date_echeance|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                <td>{% if operation.jours_retard %}<strong class="status bad">{{ operation.jours_retard }} j</strong>{% else %}—{% endif %}</td>
                <td>{% if operation.premier_retard %}<strong>{{ operation.premier_retard.montant|floatformat:0 }} €</strong>{% else %}—{% endif %}</td>
              {% elif filtre_actif == 'non_planifies' %}
                <td>{% if operation.date_realisation %}{{ operation.date_realisation|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                <td><strong class="status warn">{{ operation.reste_a_planifier|floatformat:0 }} €</strong></td>
              {% else %}
                <td>{{ operation.client.ville|default:"—" }}</td>
                <td>{% if operation.montant_total %}{{ operation.montant_total|floatformat:0 }} €{% else %}—{% endif %}</td>
                <td>
                  {% if operation.statut == 'planifie' %}<span class="status">Planifié</span>
                  {% elif operation.statut == 'realise' %}<span class="status ok">Réalisé</span>
                  {% elif operation.statut == 'paye' %}<span class="status ok">Payé</span>
                  {% else %}<span class="status">{{ operation.get_statut_display }}</span>{% endif %}
                </td>
              {% endif %}
              <td><a href="{% url 'operation_detail' operation.id %}" class="btn">Voir</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div style="text-align:center;padding:2rem"><p style="color:var(--muted)">Aucune opération.</p></div>
      {% endif %}
    </section>
  </main>
</body>
</html>