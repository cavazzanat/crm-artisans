<!DOCTYPE html>
<html>
<head>
    <title>{{ client.nom }} {{ client.prenom }} - CRM Artisans</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root{
          --bg:#F6F8FB;
          --surface:#FFFFFF;
          --ink:#1A1F2C;
          --muted:#6B7280;

          --primary:#1565C0;
          --primary-ink:#FFFFFF;
          --primary-weak:#E3F2FD;

          --success:#2E7D32;
          --warning:#B26A00;
          --info:#0277BD;
          --danger:#C62828;

          --border:#E5E7EB;
          --radius:10px;
          --shadow:0 2px 8px rgba(16,24,40,.08);
        }

        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
            background:var(--bg); color:var(--ink); font-size:17px; line-height:1.4;
        }

        .header{
            background:var(--surface); padding:1rem 2rem; display:flex;
            justify-content:space-between; align-items:center; border-bottom:1px solid var(--border);
            box-shadow:var(--shadow);
        }
        .header h1{font-size:1.4rem; color:var(--ink);}
        .nav-menu{display:flex; gap:1rem;}
        .nav-menu a{padding:.5rem 1rem; border-radius:6px; text-decoration:none; color:var(--ink);}
        .nav-menu a.active{background:var(--ink); color:#fff;}

        .container{max-width:1000px;margin:2rem auto;padding:0 1rem;}

        .page-head{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;}
        .page-title{font-size:1.6rem; font-weight:700;}
        .page-title .id{font-weight:400;color:var(--muted);}

        .action-row{display:flex;flex-wrap:wrap;gap:.5rem;}

        .btn{height:48px; padding:0 14px; border-radius:var(--radius); border:1px solid transparent;
             display:inline-flex;align-items:center;gap:.4rem;font-weight:600;cursor:pointer;font-size:.9rem;}
        .btn-primary{background:var(--primary);color:#fff;}
        .btn-outline{background:#fff;color:var(--ink);border:1px solid var(--border);}
        .btn-success{background:var(--success);color:#fff;}
        .btn-danger{background:var(--danger);color:#fff;}
        .btn:hover{filter:brightness(.95);}

        .section{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:1.5rem;}
        .section-h{padding:1rem 1.25rem; border-bottom:1px solid var(--border); background:#F9FAFB; font-weight:700;}
        .section> *:not(.section-h){padding:1rem 1.25rem;}

        .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
        .info-label{font-weight:600;font-size:.9rem;color:var(--muted);}
        .info-value a{color:var(--primary);text-decoration:none;}
        .info-value a:hover{text-decoration:underline;}

        .stats-line{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;}
        .stat-chip{background:var(--primary-weak);border-radius:12px;padding:12px;text-align:center;}
        .stat-val{font-size:1.4rem;font-weight:800;color:var(--ink);}
        .stat-lab{font-size:.85rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}

        .table{width:100%;border-collapse:collapse;}
        .table th,.table td{padding:.75rem;text-align:left;border-bottom:1px solid var(--border);}
        .table th{background:#F9FAFB;font-weight:600;color:var(--muted);}
        .table tr:hover{background:#FAFAFA;}

        .badge{display:inline-block;padding:.25rem .5rem;border-radius:8px;font-size:.85rem;font-weight:600;}
        .badge--en_attente_devis{background:#FFF3CD;color:#8A6D3B;}
        .badge--a_planifier{background:#E0F2FE;color:#075985;}
        .badge--planifie{background:#E8F5E9;color:#2E7D32;}
        .badge--realise{background:#E3F2FD;color:#0D47A1;}
        .badge--paye{background:#E6F4EA;color:#0F5132;}
        .badge--devis_refuse{background:#FDECEA;color:#B71C1C;}

        .bottom-bar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);
            box-shadow:0 -2px 8px rgba(16,24,40,.06);padding:.5rem;display:none;gap:.5rem;justify-content:space-around;}
        .bbtn{flex:1;height:48px;border-radius:var(--radius);border:1px solid var(--border);background:#fff;font-weight:700;}

        @media(max-width:768px){
          .info-grid{grid-template-columns:1fr;}
          .stats-line{grid-template-columns:1fr;}
          .bottom-bar{display:flex;}
        }
    </style>
</head>
<body>
<header class="header">
    <h1>CRM Artisans</h1>
    <nav class="nav-menu">
        <a href="{% url 'dashboard' %}">Accueil</a>
        <a href="{% url 'operations' %}">Op√©rations</a>
        <a href="{% url 'clients' %}" class="active">Clients</a>
    </nav>
    <div class="user-info">
        Connect√© : {{ user.username }} |
        <form method="post" action="{% url 'logout' %}" style="display:inline;margin:0;">
            {% csrf_token %}
            <button type="submit" style="background:none;border:none;color:var(--ink);cursor:pointer;font-size:.9rem;text-decoration:underline;">D√©connexion</button>
        </form>
    </div>
</header>

<div class="container">
    <div class="page-head">
        <h1 class="page-title">{{ client.nom }} {{ client.prenom }} <span class="id">({{ client.id_client }})</span></h1>

        <div class="action-row">
            <button id="editBtn" class="btn btn-outline" onclick="toggleEdit()">‚úèÔ∏è √âditer</button>
            <form method="POST" action="{% url 'client_delete' client.id %}" 
                  onsubmit="return confirm('ATTENTION : Supprimer {{ client.nom }} {{ client.prenom }} ET toutes ses {{ nb_operations }} op√©ration(s) ? Action irr√©versible.')">
                {% csrf_token %}
                <input type="hidden" name="force_delete" value="true">
                <button type="submit" class="btn btn-danger">üóëÔ∏è Supprimer</button>
            </form>
            <a href="{% url 'operation_create' %}?client={{ client.id }}" class="btn btn-primary">‚ûï Nouvelle op√©ration</a>

            <button id="saveBtn" class="btn btn-success" style="display:none;" onclick="saveClient()">‚úîÔ∏è Enregistrer</button>
            <button id="cancelBtn" class="btn btn-outline" style="display:none;" onclick="cancelEdit()">‚Ü©Ô∏è Annuler</button>
        </div>
    </div>

    <!-- Infos client -->
    <section class="section">
        <header class="section-h">Informations client</header>
        <div class="info-grid" id="displayMode">
            <div><div class="info-label">Nom complet</div><div class="info-value">{{ client.nom }} {{ client.prenom }}</div></div>
            <div><div class="info-label">T√©l√©phone</div><div class="info-value"><a href="tel:{{ client.telephone }}">{{ client.telephone }}</a></div></div>
            <div><div class="info-label">Email</div><div class="info-value">
                {% if client.email %}<a href="mailto:{{ client.email }}">{{ client.email }}</a>{% else %}<em>Non renseign√©</em>{% endif %}
            </div></div>
            <div style="grid-column:1/-1;"><div class="info-label">Adresse</div><div class="info-value">{{ client.adresse }}, {{ client.ville }}</div></div>
            <div><div class="info-label">Client depuis</div><div class="info-value">{{ client.date_creation|date:"d/m/Y" }}</div></div>
        </div>
        <!-- Formulaire √©dition -->
        <form method="POST" action="{% url 'client_edit' client.id %}" id="editForm" style="display:none;">
            {% csrf_token %}
            <div class="info-grid">
                <div><div class="info-label">Nom *</div><input type="text" id="edit-nom" name="nom" value="{{ client.nom }}" required></div>
                <div><div class="info-label">Pr√©nom</div><input type="text" id="edit-prenom" name="prenom" value="{{ client.prenom }}"></div>
                <div><div class="info-label">T√©l√©phone *</div><input type="tel" id="edit-telephone" name="telephone" value="{{ client.telephone }}" required></div>
                <div><div class="info-label">Email</div><input type="email" id="edit-email" name="email" value="{{ client.email }}"></div>
                <div><div class="info-label">Adresse</div><input type="text" id="edit-adresse" name="adresse" value="{{ client.adresse }}"></div>
                <div><div class="info-label">Ville</div><input type="text" id="edit-ville" name="ville" value="{{ client.ville }}"></div>
            </div>
        </form>
    </section>

    <!-- Stats -->
    <section class="section">
        <header class="section-h">Statistiques</header>
        <div class="stats-line">
            <div class="stat-chip"><div class="stat-val">{{ nb_operations }}</div><div class="stat-lab">Op√©rations</div></div>
            <div class="stat-chip"><div class="stat-val">{{ ca_total }}‚Ç¨</div><div class="stat-lab">CA Total</div></div>
        </div>
    </section>

    <!-- Historique -->
    <section class="section">
        <header class="section-h">Historique des op√©rations ({{ nb_operations }})</header>
        {% if operations %}
        <table class="table">
            <thead><tr><th>Date</th><th>Type</th><th>Montant</th><th>Statut</th><th></th></tr></thead>
            <tbody>
                {% for operation in operations %}
                <tr>
                    <td>
                        {% if operation.date_prevue %}
                            {{ operation.date_prevue|date:"d/m H:i" }}
                        {% else %}
                            {{ operation.date_creation|date:"d/m/Y" }}
                        {% endif %}
                    </td>
                    <td>{{ operation.type_prestation }}</td>
                    <td><strong>{{ operation.montant_total }}‚Ç¨</strong></td>
                    <td>
                        <span class="badge badge--{{ operation.statut }}">
                            {{ operation.get_statut_display }}
                        </span>
                    </td>
                    <td><a href="{% url 'operation_detail' operation.pk %}" class="btn btn-outline">Voir</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align:center;padding:2rem;color:var(--muted);">
            <h4>Aucune op√©ration</h4>
            <p>Ce client n'a pas encore d'op√©ration enregistr√©e.</p>
            <a href="{% url 'operation_create' %}?client={{ client.id }}" class="btn btn-primary" style="margin-top:1rem;">Cr√©er la premi√®re op√©ration</a>
        </div>
        {% endif %}
    </section>

    <div style="margin-top:1rem;">
        <a href="{% url 'clients' %}" class="btn btn-outline">‚Üê Retour √† la liste</a>
    </div>
</div>

<!-- Barre mobile -->
<nav class="bottom-bar">
  <button class="bbtn" onclick="toggleEdit()">‚úèÔ∏è √âditer</button>
  <a class="bbtn" href="{% url 'operation_create' %}?client={{ client.id }}">‚ûï Op√©ration</a>
  <a class="bbtn" href="tel:{{ client.telephone }}">üìû Appeler</a>
</nav>

<script>
let originalValues={};
function toggleEdit(){
  originalValues={
    nom:document.getElementById('edit-nom').value,
    prenom:document.getElementById('edit-prenom').value,
    telephone:document.getElementById('edit-telephone').value,
    email:document.getElementById('edit-email').value,
    adresse:document.getElementById('edit-adresse').value,
    ville:document.getElementById('edit-ville').value
  };
  document.getElementById('displayMode').style.display='none';
  document.getElementById('editForm').style.display='block';
  document.getElementById('editBtn').style.display='none';
  document.getElementById('saveBtn').style.display='inline-block';
  document.getElementById('cancelBtn').style.display='inline-block';
}
function cancelEdit(){
  document.getElementById('edit-nom').value=originalValues.nom;
  document.getElementById('edit-prenom').value=originalValues.prenom;
  document.getElementById('edit-telephone').value=originalValues.telephone;
  document.getElementById('edit-email').value=originalValues.email;
  document.getElementById('edit-adresse').value=originalValues.adresse;
  document.getElementById('edit-ville').value=originalValues.ville;
  document.getElementById('displayMode').style.display='grid';
  document.getElementById('editForm').style.display='none';
  document.getElementById('editBtn').style.display='inline-block';
  document.getElementById('saveBtn').style.display='none';
  document.getElementById('cancelBtn').style.display='none';
}
function saveClient(){
  const nom=document.getElementById('edit-nom').value.trim();
  const telephone=document.getElementById('edit-telephone').value.trim();
  if(!nom||!telephone){alert('Le nom et le t√©l√©phone sont obligatoires');return;}
  document.getElementById('editForm').submit();
}
</script>
</body>
</html>
