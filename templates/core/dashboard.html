<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - CRM Artisans</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --ring: rgba(99,102,241,.35);
      --border: rgba(148,163,184,.15);
      --shadow: 0 10px 25px rgba(2,6,23,.3), 0 1px 0 rgba(255,255,255,.03) inset;

      --bg-light: #f8fafc;
      --card-light: #ffffff;
      --text-light: #1e293b;
      --muted-light: #64748b;
      --border-light: rgba(30,41,59,.12);
      --shadow-light: 0 10px 25px rgba(30,41,59,.08), 0 1px 0 rgba(255,255,255,.8) inset;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.12), transparent 40%),
                  radial-gradient(1000px 600px at 80% 10%, rgba(139,92,246,.12), transparent 40%),
                  var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    /* Header */
    .header{
      position: sticky; top: 0; z-index: 40;
      backdrop-filter: saturate(180%) blur(8px);
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.65));
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      max-width: 1280px; margin: 0 auto; padding: .85rem 1rem;
      display:flex; align-items:center; gap:1rem; justify-content: space-between;
    }
    .brand{ display:flex; align-items:center; gap:.75rem; font-weight:700; letter-spacing:.2px }
    .logo{ width:34px; height:34px; border-radius:10px; background:linear-gradient(145deg, var(--primary), var(--accent)); box-shadow: var(--shadow); display:grid; place-items:center; }
    .logo svg{ width:18px; height:18px; color:white }

    .nav{ display:flex; gap:.25rem; align-items:center }
    .nav a{ text-decoration:none; color:var(--muted); padding:.55rem .8rem; border-radius:10px; border:1px solid transparent }
    .nav a:hover{ color:var(--text); background:rgba(148,163,184,.08); border-color:var(--border) }
    .nav a.active{ color:white; background:rgba(99,102,241,.18); border-color: rgba(99,102,241,.35); box-shadow: 0 0 0 2px var(--ring) }

    .user{ display:flex; align-items:center; gap:.75rem; color:var(--muted); font-size:.95rem }
    .user form button{ background:none; border:none; color:var(--muted); cursor:pointer; text-decoration:underline; font:inherit }

    /* Main container */
    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    .page-title{ font-size: clamp(1.4rem, 2.4vw, 2rem); font-weight:800; letter-spacing:.2px; margin-bottom: 1.25rem }
    .subtitle{ color:var(--muted); margin-bottom:1.75rem }

    /* KPI layout */
    .kpi-grid{ display:grid; gap:1rem; grid-template-columns: repeat(12, 1fr); margin-bottom:2rem }
    .kpi{ background: linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,.4)); border:1px solid var(--border); border-radius:16px; padding:1.1rem; box-shadow: var(--shadow); position:relative; overflow:hidden }
    .kpi:after{ content:""; position:absolute; inset:auto -30% -40% auto; width:180px; height:180px; background: radial-gradient(closest-side, rgba(99,102,241,.18), transparent 70%); transform: rotate(25deg) }
    .kpi h3{ font-size:.8rem; text-transform:uppercase; letter-spacing:.12rem; color:var(--muted); margin:0 0 .45rem }
    .kpi .value{ font-size: clamp(1.6rem, 2.5vw, 2.2rem); font-weight:800 }

    .kpi.ca{ grid-column: span 6 }
    .kpi.clients{ grid-column: span 6 }
    .kpi.devis, .kpi.planifier, .kpi.paiement{ grid-column: span 4 }

    .accent-success{ box-shadow: inset 0 0 0 1px rgba(34,197,94,.25) }
    .accent-info{ box-shadow: inset 0 0 0 1px rgba(99,102,241,.25) }
    .accent-warn{ box-shadow: inset 0 0 0 1px rgba(245,158,11,.25) }

    /* Sections */
    .section{ background: linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,.4)); border:1px solid var(--border); border-radius:16px; padding:1rem; box-shadow: var(--shadow); margin-top:1.25rem }
    .section-header{ display:flex; align-items:center; justify-content:space-between; gap:1rem; padding: .4rem .35rem .9rem; border-bottom:1px dashed var(--border) }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700 }
    .section-title .badge{ font-size:.75rem; color:var(--muted); padding:.15rem .5rem; border-radius:999px; border:1px solid var(--border); background: rgba(148,163,184,.08) }

    .toolbar{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; border-radius:10px; border:1px solid var(--border); background:rgba(148,163,184,.07); color:var(--text); text-decoration:none; cursor:pointer; font-size:.9rem }
    .btn:hover{ background:rgba(148,163,184,.12) }
    .btn.primary{ background:linear-gradient(180deg, rgba(99,102,241,.18), rgba(99,102,241,.12)); border-color: rgba(99,102,241,.35); color:white }

    /* Calendar */
    .calendar-nav{ display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem }
    .calendar-title{ font-size:1.1rem; font-weight:600 }
    .nav-btn{ padding:.5rem; border:1px solid var(--border); background:rgba(148,163,184,.07); color:var(--text); cursor:pointer; border-radius:8px }
    .nav-btn:hover{ background:rgba(148,163,184,.12) }

    .view-buttons{ display:flex; gap:.25rem }
    .view-btn{ padding:.4rem .7rem; border:1px solid var(--border); background:rgba(148,163,184,.07); color:var(--text); cursor:pointer; border-radius:6px; font-size:.85rem }
    .view-btn:hover{ background:rgba(148,163,184,.12) }
    .view-btn.active{ background:var(--primary); color:white; border-color:var(--primary) }

    /* Vue Semaine + Mois */
    .calendar-view{ margin-top:1rem }
    .week-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:.5rem }
    .day-card{
      background:rgba(2,6,23,.4);
      border:1px solid var(--border);
      border-radius:12px;
      padding:.75rem;
      min-height:120px;
      cursor: pointer;
    }
    .day-card.today{ border-color:var(--primary); background:rgba(99,102,241,.1) }
    .day-card.selected{ border-color:var(--warning); box-shadow: 0 0 0 2px rgba(245,158,11,.3) }
    .day-header{ font-weight:600; margin-bottom:.5rem; font-size:.9rem }
    .day-number{ color:var(--muted); font-size:.8rem; margin-bottom:.5rem }

    .event-item{
      border-radius:6px;
      padding:.3rem;
      margin:.2rem 0;
      font-size:.75rem;
      cursor:pointer;
      line-height:1.2;
      transition: all 0.2s ease;
      border:1px solid;
    }
    .event-item:hover{ transform: translateY(-1px) }

    /* Couleurs par statut - Logique simplifiée */
    .event-item.event-planifie{
      /* Vert : opération planifiée future */
      background:rgba(34,197,94,.2);
      border-color:rgba(34,197,94,.3);
    }
    .event-item.event-planifie:hover{ background:rgba(34,197,94,.3) }

    .event-item.event-attention{
      /* Rouge : opération passée à valider */
      background:rgba(239,68,68,.2);
      border-color:rgba(239,68,68,.3);
      animation: pulse 2s infinite;
    }
    .event-item.event-attention:hover{ background:rgba(239,68,68,.3) }

    .event-item.event-pending{
      /* Gris : opération à replanifier/traiter */
      background:rgba(148,163,184,.15);
      border-color:rgba(148,163,184,.3);
      border-style: dashed;
    }
    .event-item.event-pending:hover{ background:rgba(148,163,184,.25) }

    /* Animation pulse pour les opérations qui nécessitent attention */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    /* Vue Mois */
    .month-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:.25rem;
      margin-top:1rem;
    }
    .month-header-row{ display: contents; }
    .month-day-header{
      background: rgba(148,163,184,.1);
      color: var(--muted);
      font-size: .75rem;
      font-weight: 600;
      text-align: center;
      padding: .5rem;
      border-radius: 6px 6px 0 0;
      text-transform: uppercase;
      letter-spacing: .05rem;
    }
    .month-day-cell{
      background: rgba(2,6,23,.3);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: .4rem;
      min-height: 80px;
      cursor: pointer;
      position: relative;
    }
    .month-day-cell:hover{ background: rgba(2,6,23,.5); }
    .month-day-cell.today{ border-color: var(--primary); background: rgba(99,102,241,.1); }
    .month-day-cell.other-month{ opacity: 0.4; }
    .month-day-cell.selected{ border-color: var(--warning); box-shadow: 0 0 0 2px rgba(245,158,11,.3); }
    .month-day-number{ font-weight: 600; font-size: .8rem; margin-bottom: .25rem; }
    .month-events{ display: flex; flex-direction: column; gap: .15rem; }
    .month-event-item{
      background: rgba(99,102,241,.3);
      border: 1px solid rgba(99,102,241,.4);
      border-radius: 4px;
      padding: .15rem .25rem;
      font-size: .65rem;
      line-height: 1.1;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .month-event-item:hover{ background: rgba(99,102,241,.4); transform: translateY(-1px); }
    .month-event-more{
      color: var(--muted);
      font-size: .6rem;
      font-style: italic;
      cursor: pointer;
      padding: .1rem .25rem;
    }
    .month-event-more:hover{ color: var(--text); }

    /* Panneau latéral */
    .side-panel{
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: linear-gradient(180deg, rgba(2,6,23,.95), rgba(2,6,23,.9));
      border-left: 1px solid var(--border);
      box-shadow: -10px 0 25px rgba(0,0,0,.2);
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
      backdrop-filter: blur(10px);
    }
    .side-panel.open{ right: 0 }
    .panel-header{
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0;
      background: rgba(2,6,23,.9);
      backdrop-filter: blur(10px);
    }
    .panel-title{ font-size: 1.1rem; font-weight: 700; margin-bottom: .5rem; color: var(--text); }
    .panel-subtitle{ color: var(--muted); font-size: .9rem; }
    .close-panel{
      position: absolute; top: 1rem; right: 1rem;
      background: none; border: none; color: var(--muted);
      cursor: pointer; padding: .5rem; border-radius: 6px;
    }
    .close-panel:hover{ background: rgba(148,163,184,.1); color: var(--text) }
    .panel-content{ padding: 1.5rem; }

    .operation-tabs{ display: flex; gap: .5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .operation-tab{ padding: .4rem .8rem; background: rgba(148,163,184,.07); border: 1px solid var(--border); border-radius: 6px; font-size: .8rem; cursor: pointer; color: var(--muted); transition: all 0.2s ease; }
    .operation-tab.active{ background: var(--primary); border-color: var(--primary); color: white; }

    .detail-section{ margin-bottom: 1.5rem; }
    .detail-section h4{ color: var(--text); font-size: .9rem; margin-bottom: .75rem; text-transform: uppercase; letter-spacing: .05rem; font-weight: 600; }
    .detail-item{ margin-bottom: .5rem; padding: .5rem 0; }
    .detail-label{ color: var(--muted); font-size: .8rem; margin-bottom: .25rem; }
    .detail-value{ color: var(--text); font-size: .9rem; }

    .client-actions{ display: flex; gap: .75rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .action-btn{
      flex: 1; padding: .75rem 1rem; border: 1px solid var(--border); border-radius: 8px;
      background: rgba(148,163,184,.07); color: var(--text); text-decoration: none; text-align: center;
      font-size: .85rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: .5rem;
    }
    .action-btn:hover{ background: rgba(148,163,184,.12); transform: translateY(-1px); }
    .action-btn.success{ background: var(--success); border-color: var(--success); color: white; }
    .action-btn.primary{ background: var(--primary); border-color: var(--primary); color: white; }

    /* Contrôles de changement de statut */
    .status-change-controls{ display: flex; flex-direction: column; gap: .75rem; }
    .status-select{ 
      width: 100%; padding: .5rem .7rem; border-radius: 8px; 
      border: 1px solid var(--border); background: rgba(2,6,23,.35); 
      color: var(--text); font-size: .9rem;
    }
    .status-select:focus{ 
      outline: none; box-shadow: 0 0 0 2px var(--ring); 
      border-color: rgba(99,102,241,.35);
    }
    .date-inputs{ display: flex; flex-direction: column; gap: .5rem; }
    .date-input{ 
      width: 100%; padding: .5rem .7rem; border-radius: 8px; 
      border: 1px solid var(--border); background: rgba(2,6,23,.35); 
      color: var(--text); font-size: .85rem;
    }
    .date-input:focus{ 
      outline: none; box-shadow: 0 0 0 2px var(--ring); 
      border-color: rgba(99,102,241,.35);
    }
    .status-actions{ display: flex; gap: .5rem; justify-content: flex-end; }
    .status-actions .action-btn{ flex: 0 0 auto; padding: .5rem .75rem; font-size: .85rem; }

    /* Table */
    .table-wrap{ overflow:auto; border-radius:12px; border:1px solid var(--border) }
    table{ width:100%; border-collapse: collapse; min-width: 980px }
    thead th{
      position:sticky; top:0; background: rgba(15,23,42,.9); backdrop-filter: blur(6px);
      color:var(--muted); text-transform:uppercase; letter-spacing:.08rem;
      font-size:.75rem; text-align:left; padding:.9rem .85rem;
      border-bottom:1px solid var(--border)
    }
    tbody td{ padding:.9rem .85rem; border-bottom:1px dashed var(--border); vertical-align: top }
    tbody tr:hover{ background: rgba(148,163,184,.05) }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; font-size:.78rem; border:1px solid var(--border); color: var(--muted) }
    .btn-view{ display:inline-flex; align-items:center; gap:.45rem; padding:.45rem .7rem; border-radius:8px; border:1px solid rgba(99,102,241,.35); background: rgba(99,102,241,.15); color:white; text-decoration:none; font-size:.8rem }
    .btn-view:hover{ box-shadow: 0 0 0 2px var(--ring) }

    /* Panneau: harmonisation & densité */
.side-panel{
  right:-420px; width:420px; border-left:1px solid var(--border);
  background:linear-gradient(180deg, rgba(2,6,23,.96), rgba(2,6,23,.9));
}
.panel-header{ display:flex; align-items:flex-start; gap:1rem; }
.panel-header-left{ display:flex; flex-direction:column; gap:.4rem; }
.panel-kicker{ font-size:.7rem; letter-spacing:.1rem; text-transform:uppercase; color:var(--muted); }
.panel-title{ font-size:1.1rem; font-weight:800; margin:0; color:var(--text); }
.panel-meta{ display:flex; flex-wrap:wrap; gap:.4rem; align-items:center; color:var(--muted); }
.meta-item{ display:inline-flex; gap:.35rem; align-items:center; padding:.2rem .5rem; border:1px dashed var(--border); border-radius:999px; font-size:.78rem; }

/* Timeline des créneaux */
.op-timeline{ display:flex; gap:.5rem; align-items:center; padding:.5rem; border:1px solid var(--border); border-radius:10px; background:rgba(148,163,184,.07); margin-bottom:1rem; overflow:auto; }
.op-slot{
  display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border:1px solid var(--border);
  border-radius:999px; font-size:.8rem; cursor:pointer; white-space:nowrap; transition:.2s;
}
.op-slot.active{ background:rgba(99,102,241,.15); border-color:rgba(99,102,241,.35); color:white; box-shadow:0 0 0 2px var(--ring); }
.op-slot:hover{ background:rgba(148,163,184,.12); }

/* Grille d’infos compacte */
.detail-section.compact{ padding-bottom:.5rem; }
.detail-grid{ display:grid; gap:.6rem; }
.detail-grid.two{ grid-template-columns: repeat(2, minmax(0,1fr)); }
.detail-grid .span-2{ grid-column:1 / -1; }
.detail-label{ color:var(--muted); font-size:.78rem; margin-bottom:.15rem; }
.detail-value{ color:var(--text); font-size:.92rem; font-weight:600; }

/* Quick actions (tel / wa / maps) */
.quick-actions{ display:flex; gap:.5rem; margin-top:.6rem; flex-wrap:wrap; }
.qa-btn{
  display:inline-flex; align-items:center; justify-content:center;
  padding:.45rem .7rem; border:1px solid var(--border); border-radius:8px;
  background:rgba(148,163,184,.07); font-size:.82rem; color:var(--text); text-decoration:none;
}
.qa-btn:hover{ background:rgba(148,163,184,.12); }

/* Stepper de statut */
.status-stepper{ display:flex; gap:.4rem; flex-wrap:wrap; }
.status-stepper .step{
  padding:.4rem .7rem; border:1px solid var(--border); border-radius:999px;
  font-size:.8rem; color:var(--muted); background:rgba(148,163,184,.05); cursor:pointer;
}
.status-stepper .step.active{ color:white; background:rgba(99,102,241,.2); border-color:rgba(99,102,241,.35); box-shadow:0 0 0 2px var(--ring); }
.status-form{ margin-top:.75rem; border:1px dashed var(--border); border-radius:10px; padding:.75rem; background:rgba(2,6,23,.35); }
.date-row{ display:grid; grid-template-columns:1fr 1fr; gap:.6rem; }
.date-field{ display:flex; flex-direction:column; gap:.25rem; }
.date-field span{ font-size:.78rem; color:var(--muted); }
.date-input{ width:100%; padding:.5rem .7rem; border-radius:8px; border:1px solid var(--border); background:rgba(2,6,23,.35); color:var(--text); font-size:.85rem; }
.date-input:focus{ outline:none; box-shadow:0 0 0 2px var(--ring); border-color:rgba(99,102,241,.35); }

/* Footer sticky */
.panel-footer{
  position:sticky; bottom:0; display:flex; gap:.5rem; padding:.8rem 1rem;
  border-top:1px solid var(--border);
  background:linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.96));
  backdrop-filter: blur(8px);
}
.panel-footer .btn{ flex:1; }

/* Badges de statut harmonisés */
.status-badge{
  display:inline-flex; align-items:center; gap:.45rem; padding:.28rem .6rem; border-radius:999px; font-size:.8rem; font-weight:700; border:1px solid;
}
.status-badge.en_attente_devis{ color:#f59e0b; background:rgba(245,158,11,.1); border-color:rgba(245,158,11,.25); }
.status-badge.a_planifier{ color:#3b82f6; background:rgba(59,130,246,.12); border-color:rgba(59,130,246,.25); }
.status-badge.planifie{ color:#8b5cf6; background:rgba(139,92,246,.12); border-color:rgba(139,92,246,.25); }
.status-badge.realise{ color:#22c55e; background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.25); }
.status-badge.paye{ color:#10b981; background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.25); }

/* Light mode: conserve ton thème */
@media (prefers-color-scheme: light){
  .op-slot.active{ color:var(--primary); }
  .status-stepper .step.active{ color:var(--primary); background:rgba(99,102,241,.1); }
}


    /* Responsive */
    @media (max-width: 768px){
      .kpi.ca, .kpi.clients, .kpi.devis, .kpi.planifier, .kpi.paiement{ grid-column: 1 / -1 }
      .week-grid{ grid-template-columns: 1fr; gap:.3rem }
      .month-grid{ grid-template-columns: repeat(7, 1fr); gap:.15rem }
      .month-day-cell{ min-height: 60px; padding: .25rem }
      .month-event-item{ font-size: .6rem; padding: .1rem .2rem }
      .calendar-nav{ flex-direction:column; align-items:flex-start }
      .side-panel{ width: 100%; right: -100% }
      .table-wrap{ border:none }
      table{ display:block }
      thead{ display:none }
      tbody{ display:grid; gap:.75rem }
      tbody tr{ display:grid; gap:.4rem; border:1px solid var(--border); border-radius:12px; padding:.8rem; background: rgba(2,6,23,.5) }
      tbody td{ padding:.15rem 0; border:none }
    }

    /* Light mode */
    @media (prefers-color-scheme: light){
      :root{
        --bg: var(--bg-light);
        --card: var(--card-light);
        --text: var(--text-light);
        --muted: var(--muted-light);
        --border: var(--border-light);
        --shadow: var(--shadow-light);
      }
      body{
        background: radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.05), transparent 40%),
                    radial-gradient(1000px 600px at 80% 10%, rgba(139,92,246,.05), transparent 40%),
                    var(--bg);
      }
      .header{
        background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.8));
        backdrop-filter: saturate(180%) blur(8px);
      }
      .kpi, .section{ background: var(--card); border: 1px solid var(--border); box-shadow: var(--shadow); }
      .day-card, .month-day-cell{ background: var(--card) }
      .day-card.today, .month-day-cell.today{ border-color:var(--primary); background:rgba(99,102,241,.05) }
      .side-panel{ background: rgba(255,255,255,.98) }
      .nav a.active, .view-btn.active{
        color: var(--primary);
        background: rgba(99,102,241,.08);
        border-color: rgba(99,102,241,.2);
      }
      .btn.primary{
        background: rgba(99,102,241,.1);
        border-color: rgba(99,102,241,.2);
        color: var(--primary);
      }
      .status-select, .date-input{ 
        background: #fff; 
        border-color: var(--border); 
        color: var(--text) 
      }
      .month-day-header{ background: rgba(148,163,184,.05); }
      .month-day-cell{ background: var(--card); }
      .month-event-item{ background: rgba(99,102,241,.1); border-color: rgba(99,102,241,.2); }
    }
  </style>
</head>
<body>
  {% csrf_token %}
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}" class="active">Accueil</a>
        <a href="{% url 'operations' %}">Opérations</a>
        <a href="{% url 'clients' %}">Clients</a>
      </nav>
      <div class="user">
        <span>Connecté : {{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit">Déconnexion</button>
        </form>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="page-title">Tableau de bord</h1>
    <p class="subtitle">Vue d'ensemble des performances et du planning.</p>

    <!-- KPI dynamiques -->
    <section class="kpi-grid">
      <article class="kpi ca accent-success">
        <h3>CA du mois</h3>
        <div class="value">{{ ca_mois|floatformat:0 }} €</div>
      </article>
      <article class="kpi clients accent-info">
        <h3>Clients</h3>
        <div class="value">{{ nb_clients }}</div>
      </article>
      <article class="kpi devis accent-warn">
        <h3>En attente devis</h3>
        <div class="value">{{ nb_en_attente_devis }}</div>
      </article>
      <article class="kpi planifier accent-info">
        <h3>À planifier</h3>
        <div class="value">{{ nb_a_planifier }}</div>
      </article>
      <article class="kpi paiement accent-warn">
        <h3>Attente paiement</h3>
        <div class="value">{{ nb_realise }}</div>
      </article>
    </section>

    <!-- Planning -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Planning des interventions
          <span class="badge" id="events-count">0</span>
        </h2>
        <div class="toolbar">
          <a href="{% url 'operation_create' %}" class="btn primary">Nouvelle opération</a>
        </div>
      </div>

      <div class="calendar-nav">
        <div class="calendar-title" id="calendar-title">Semaine courante</div>
        <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap">
          <div>
            <button class="nav-btn" onclick="navigateCalendar(-1)">← Précédent</button>
            <button class="nav-btn" onclick="navigateCalendar(0)" style="margin:0 .5rem">Aujourd'hui</button>
            <button class="nav-btn" onclick="navigateCalendar(1)">Suivant →</button>
          </div>
          <div class="view-buttons">
            <button class="view-btn" onclick="setView('day')" id="day-btn">Jour</button>
            <button class="view-btn active" onclick="setView('week')" id="week-btn">Semaine</button>
            <button class="view-btn" onclick="setView('month')" id="month-btn">Mois</button>
          </div>
        </div>
      </div>

      <div class="calendar-view">
        <div class="week-grid" id="calendar-grid"><!-- JS --></div>
      </div>
    </section>

    <!-- Opérations à planifier -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 7v6l4 4M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Opérations à planifier
          <span class="badge">{{ operations_a_planifier|length }}</span>
        </h2>
        <div class="toolbar">
          <a href="{% url 'operation_create' %}" class="btn primary">Nouvelle opération</a>
        </div>
      </div>

      {% if operations_a_planifier %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Créée le</th>
              <th>Client</th>
              <th>Opération</th>
              <th>Téléphone</th>
              <th>Statut</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for operation in operations_a_planifier %}
            <tr>
              <td>{{ operation.date_creation|date:"d/m/Y" }}</td>
              <td>{{ operation.client.nom }} {{ operation.client.prenom }}</td>
              <td>{{ operation.type_prestation|truncatechars:40 }}</td>
              <td><a href="tel:{{ operation.client.telephone }}" class="chip">{{ operation.client.telephone }}</a></td>
              <td>
                <span class="chip" style="background: rgba(245,158,11,.1); color: var(--warning); border-color: rgba(245,158,11,.3)">
                  {{ operation.get_statut_display }}
                </span>
              </td>
              <td>
                <a href="{% url 'operation_detail' operation.id %}" class="btn-view">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                    <path d="M12 7v6l4 4M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6"/>
                  </svg>
                  Planifier
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div style="text-align:center; padding:2rem; color:var(--muted)">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="margin-bottom: 1rem; opacity: .5">
          <path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <p>Toutes les opérations sont planifiées !</p>
        <p style="font-size: .9rem; margin-top: .5rem">Créez une nouvelle opération pour commencer.</p>
      </div>
      {% endif %}
    </section>

    <!-- Actions rapides (liens Django) -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h10M4 12h7M4 17h13" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Actions rapides
        </h2>
      </div>
      <div class="toolbar">
        <a href="{% url 'operation_create' %}" class="btn primary">Nouvelle opération</a>
        <a href="{% url 'clients' %}" class="btn">Voir les clients</a>
        <a href="{% url 'client_create' %}" class="btn">Nouveau client</a>
      </div>
    </section>
  </main>
  <div class="panel-header">
    <div class="panel-header-left">
      <div class="panel-kicker">Intervention</div>
      <h3 class="panel-title" id="panel-title">—</h3>
      <div class="panel-meta">
        <span id="panel-date" class="meta-item">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2Z" stroke="currentColor" stroke-width="1.5"/></svg>
          —
        </span>
        <span id="panel-time" class="meta-item">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="1.5"/></svg>
          —
        </span>
        <span id="detail-status-badge" class="status-badge">—</span>
      </div>
    </div>
    <button class="close-panel" onclick="closeSidePanel()" aria-label="Fermer">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/></svg>
    </button>
  </div>

  <div class="panel-content">
    <!-- Timeline des créneaux si plusieurs opérations dans la journée -->
    <div id="operation-timeline" class="op-timeline" hidden><!-- JS injectera --></div>

    <!-- Bloc client + actions rapides -->
    <section class="detail-section compact">
      <h4>Client</h4>
      <div class="detail-grid two">
        <div>
          <div class="detail-label">Nom</div>
          <div class="detail-value" id="detail-client">—</div>
        </div>
        <div>
          <div class="detail-label">Contact</div>
          <div class="detail-value" id="detail-phone">—</div>
        </div>
      </div>
      <div class="quick-actions">
        <a id="qa-call" class="qa-btn" target="_blank" rel="noopener">Appeler</a>
        <a id="qa-whatsapp" class="qa-btn" target="_blank" rel="noopener">WhatsApp</a>
        <a id="qa-maps" class="qa-btn" target="_blank" rel="noopener">Itinéraire</a>
      </div>
    </section>

    <!-- Bloc intervention -->
    <section class="detail-section compact">
      <h4>Intervention</h4>
      <div class="detail-grid two">
        <div>
          <div class="detail-label">Intitulé</div>
          <div class="detail-value" id="detail-service">—</div>
        </div>
        <div>
          <div class="detail-label">Heure</div>
          <div class="detail-value" id="detail-time">—</div>
        </div>
        <div class="span-2">
          <div class="detail-label">Adresse</div>
          <div class="detail-value" id="detail-address">—</div>
        </div>
      </div>
      <div class="tags" id="detail-tags"><!-- facultatif: JS peut ajouter des tags: Urgent, VIP, etc. --></div>
    </section>

    <!-- Stepper statut -->
    <section class="detail-section">
      <h4>Statut</h4>
      <div class="status-stepper" id="status-stepper">
        <button class="step" data-value="en_attente_devis">Demande</button>
        <button class="step" data-value="a_planifier">À planifier</button>
        <button class="step" data-value="planifie">Planifié</button>
        <button class="step" data-value="realise">Réalisé</button>
        <button class="step" data-value="paye">Payé</button>
      </div>
      <form id="quick-status-form" class="status-form" hidden>
        <div class="date-row">
          <label class="date-field" id="field-prevue" hidden>
            <span>Date prévue</span>
            <input type="datetime-local" id="quick-date-prevue" class="date-input">
          </label>
          <label class="date-field" id="field-realisation" hidden>
            <span>Date de réalisation</span>
            <input type="datetime-local" id="quick-date-realisation" class="date-input">
          </label>
          <label class="date-field" id="field-paiement" hidden>
            <span>Date de paiement</span>
            <input type="datetime-local" id="quick-date-paiement" class="date-input">
          </label>
        </div>
        <div class="status-actions">
          <button type="button" class="action-btn success" onclick="saveQuickStatus()">Valider</button>
          <button type="button" class="action-btn" onclick="cancelQuickStatus()">Annuler</button>
        </div>
      </form>
    </section>

    <!-- Lien fiche -->
    <section class="detail-section">
      <div class="client-actions">
        <a href="#" class="action-btn primary" id="detail-btn">Voir la fiche complète</a>
      </div>
    </section>
  </div>

  <!-- Footer sticky -->
  <div class="panel-footer">
    <a href="{% url 'operation_create' %}" class="btn primary">Nouvelle opération</a>
    <button id="change-status-btn" class="btn" onclick="startQuickStatusChange()">Changer le statut</button>
  </div>


  <!-- Overlay -->
  <div id="overlay" onclick="closeSidePanel()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.3); z-index:999"></div>

  <script>
    // Variables globales
    let calendarEvents = [];
    let currentView = 'week';
    let currentOffset = 0;
    let selectedDate = null;
    let selectedDayEvents = [];
    let currentOperationIndex = 0;

    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin','Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    const monthsShort = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun','Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
    const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

    // Données: parse JSON venant du backend (fallback léger si besoin)
    function initCalendarEvents() {
      try {
        const jsonData = '{{ calendar_events_json|escapejs }}';
        if (jsonData && jsonData !== 'null' && jsonData !== 'undefined') {
          calendarEvents = JSON.parse(jsonData);
        } else {
          calendarEvents = [];
        }
      } catch (e) {
        console.error('Erreur parsing calendar_events_json:', e);
        calendarEvents = [];
      }
    }

    // Utils
    function formatDate(date) {
      return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
    }
    function getWeekDates(offset = 0) {
      const today = new Date();
      const monday = new Date(today);
      monday.setDate(today.getDate() - today.getDay() + 1 + (offset * 7));
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        dates.push(date);
      }
      return dates;
    }

    // Vues
    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(view + '-btn').classList.add('active');
      renderCalendar();
    }
    function navigateCalendar(direction) {
      if (direction === 0) currentOffset = 0;
      else currentOffset += direction;
      renderCalendar();
    }

    // Rendu
    function renderCalendar() {
      closeSidePanel();
      if (currentView === 'week') renderWeekView();
      else if (currentView === 'day') renderDayView();
      else if (currentView === 'month') renderMonthView();
      updateEventCount();
    }

    function renderWeekView() {
      const weekDates = getWeekDates(currentOffset);
      const today = new Date();
      const grid = document.getElementById('calendar-grid');

      const startDate = weekDates[0];
      const endDate = weekDates[6];
      document.getElementById('calendar-title').textContent =
        `${startDate.getDate()} ${monthsShort[startDate.getMonth()]} - ${endDate.getDate()} ${monthsShort[endDate.getMonth()]} ${endDate.getFullYear()}`;

      grid.innerHTML = '';
      grid.className = 'week-grid';

      weekDates.forEach((date, index) => {
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (formatDate(date) === formatDate(today)) dayCard.classList.add('today');

        dayCard.innerHTML = `
          <div class="day-header">${dayNames[index]}</div>
          <div class="day-number">${date.getDate()}</div>
        `;

        const dayEvents = calendarEvents.filter(event => event.date === formatDate(date));
        dayEvents.forEach((event, eventIndex) => {
          const eventEl = document.createElement('div');
          eventEl.className = `event-item ${event.color_class || 'event-default'}`;
          eventEl.innerHTML = `${event.time || ''} ${event.client_nom || ''}`;
          eventEl.onclick = (e) => { e.stopPropagation(); handleEventClick(formatDate(date), dayEvents, eventIndex); };
          dayCard.appendChild(eventEl);
        });

        dayCard.onclick = (e) => {
          if (dayEvents.length > 0 && (e.target === dayCard || e.target.classList.contains('day-header') || e.target.classList.contains('day-number'))) {
            handleEventClick(formatDate(date), dayEvents, 0);
          }
        };
        grid.appendChild(dayCard);
      });
    }

    function renderDayView() {
      const date = new Date();
      date.setDate(date.getDate() + currentOffset);

      document.getElementById('calendar-title').textContent =
        date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      grid.className = 'day-timeline';

      const dayEvents = calendarEvents.filter(event => event.date === formatDate(date));
      const dayCard = document.createElement('div');
      dayCard.className = 'day-card';
      dayCard.style.minHeight = '200px';
      dayCard.innerHTML = `<div class="day-header">Interventions du ${date.getDate()} ${monthsShort[date.getMonth()]}</div>`;

      dayEvents.forEach((event, eventIndex) => {
        const eventEl = document.createElement('div');
        eventEl.className = `event-item ${event.color_class || 'event-default'}`;
        eventEl.innerHTML = `${event.time || ''} ${event.client_nom || ''}`;
        eventEl.onclick = (e) => { e.stopPropagation(); handleEventClick(formatDate(date), dayEvents, eventIndex); };
        dayCard.appendChild(eventEl);
      });

      if (dayEvents.length === 0) {
        dayCard.innerHTML += '<p style="color:var(--muted); font-style:italic; margin-top:1rem">Aucune intervention prévue</p>';
      }
      grid.appendChild(dayCard);
    }

    function renderMonthView() {
      const today = new Date();
      const currentMonth = new Date(today.getFullYear(), today.getMonth() + currentOffset, 1);

      document.getElementById('calendar-title').textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      grid.className = 'month-grid';

      const firstDay = new Date(currentMonth);
      const startOfWeek = new Date(firstDay);
      const dayOfWeek = (firstDay.getDay() + 6) % 7; // Lundi=0
      startOfWeek.setDate(firstDay.getDate() - dayOfWeek);

      const headerRow = document.createElement('div');
      headerRow.className = 'month-header-row';
      dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'month-day-header';
        dayHeader.textContent = day;
        headerRow.appendChild(dayHeader);
      });
      grid.appendChild(headerRow);

      for (let week = 0; week < 6; week++) {
        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
          const cellDate = new Date(startOfWeek);
          cellDate.setDate(startOfWeek.getDate() + (week * 7) + dayIndex);

          const dayCell = document.createElement('div');
          dayCell.className = 'month-day-cell';
          const isCurrentMonth = cellDate.getMonth() === currentMonth.getMonth();
          const isToday = formatDate(cellDate) === formatDate(today);
          if (!isCurrentMonth) dayCell.classList.add('other-month');
          if (isToday) dayCell.classList.add('today');

          const dayNumber = document.createElement('div');
          dayNumber.className = 'month-day-number';
          dayNumber.textContent = cellDate.getDate();
          dayCell.appendChild(dayNumber);

          const dayEvents = calendarEvents.filter(event => event.date === formatDate(cellDate));
          if (dayEvents.length > 0) {
            const eventContainer = document.createElement('div');
            eventContainer.className = 'month-events';

            dayEvents.slice(0, 3).forEach((event, index) => {
              const eventEl = document.createElement('div');
              eventEl.className = 'month-event-item';
              eventEl.innerHTML = `${event.time || ''} ${event.client_nom || ''}`;
              eventEl.onclick = (e) => { e.stopPropagation(); handleEventClick(formatDate(cellDate), dayEvents, index); };
              eventContainer.appendChild(eventEl);
            });

            if (dayEvents.length > 3) {
              const moreEl = document.createElement('div');
              moreEl.className = 'month-event-more';
              moreEl.textContent = `+${dayEvents.length - 3} autres`;
              moreEl.onclick = () => handleEventClick(formatDate(cellDate), dayEvents, 0);
              eventContainer.appendChild(moreEl);
            }
            dayCell.appendChild(eventContainer);
          }

          dayCell.onclick = () => { if (dayEvents.length > 0) handleEventClick(formatDate(cellDate), dayEvents, 0); };
          grid.appendChild(dayCell);
        }
      }
    }

    // Sélection & panneau latéral
    function handleEventClick(dateStr, dayEvents, operationIndex) {
      selectedDate = dateStr;
      selectedDayEvents = dayEvents;
      currentOperationIndex = operationIndex;

      document.querySelectorAll('.day-card, .month-day-cell').forEach(card => card.classList.remove('selected'));
      const dayElements = document.querySelectorAll('.day-card, .month-day-cell');
      dayElements.forEach(el => {
        const dayNumber = el.querySelector('.day-number, .month-day-number');
        if (dayNumber) {
          const eventDate = new Date(dateStr);
          if (parseInt(dayNumber.textContent) === eventDate.getDate()) el.classList.add('selected');
        }
      });
      openSidePanel();
    }

    function openSidePanel() {
      document.getElementById('side-panel').classList.add('open');
      document.getElementById('overlay').style.display = 'block';
      updatePanelContent();
    }
    function closeSidePanel() {
      document.getElementById('side-panel').classList.remove('open');
      document.getElementById('overlay').style.display = 'none';
      document.querySelectorAll('.day-card, .month-day-cell').forEach(card => card.classList.remove('selected'));
      selectedDate = null; selectedDayEvents = [];
    }

function updatePanelContent() {
  if (!selectedDate) return;

  const date = new Date(selectedDate);
  const dateStr = date.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  document.getElementById('panel-date').textContent = dateStr;

  // Timeline
  const tl = document.getElementById('operation-timeline');
  tl.innerHTML = '';
  if (selectedDayEvents.length > 1) {
    tl.hidden = false;
    selectedDayEvents.forEach((ev, i) => {
      const btn = document.createElement('button');
      btn.className = 'op-slot' + (i === currentOperationIndex ? ' active' : '');
      btn.textContent = ev.time || '--:--';
      btn.onclick = () => switchOperation(i);
      tl.appendChild(btn);
    });
  } else {
    tl.hidden = true;
  }

  document.getElementById('panel-title').textContent =
    `${selectedDayEvents.length || 0} intervention${selectedDayEvents.length > 1 ? 's' : ''}`;

  updateOperationDetails();
}


    function switchOperation(index) {
      currentOperationIndex = index;
      updateOperationDetails();
      document.querySelectorAll('.operation-tab').forEach((tab, i) => tab.classList.toggle('active', i === index));
    }

function updateOperationDetails() {
  const op = selectedDayEvents[currentOperationIndex];
  if (!op) return;

  const set = (id, val) => document.getElementById(id).textContent = val || '—';
  set('detail-service', op.service);
  set('detail-time', op.time);
  set('detail-address', op.address);
  set('detail-client', op.client_nom);
  set('detail-phone', op.phone);

  document.getElementById('panel-time').childNodes[1].nodeValue = ' ' + (op.time || '—'); // après l’icône
  document.getElementById('detail-btn').href = op.url || '#';

  // Badge statut
  const badge = document.getElementById('detail-status-badge');
  badge.textContent = op.statut_display || '—';
  badge.className = 'status-badge';
  if (op.statut) badge.classList.add(op.statut.replaceAll(' ', '_'));

  // Quick actions
  const tel = (op.phone || '').replace(/\s+/g,'');
  const adr = encodeURIComponent(op.address || '');
  document.getElementById('qa-call').href = tel ? `tel:${tel}` : '#';
  document.getElementById('qa-whatsapp').href = tel ? `https://wa.me/${tel}` : '#';
  document.getElementById('qa-maps').href = adr ? `https://www.google.com/maps/dir/?api=1&destination=${adr}` : '#';

  // Stepper statut
  document.querySelectorAll('#status-stepper .step').forEach(b => {
    b.classList.toggle('active', b.dataset.value === op.statut);
    b.onclick = () => {
      document.getElementById('quick-status-form').hidden = false;
      document.getElementById('change-status-btn').style.display = 'none';
      document.getElementById('quick-status-select').value = b.dataset.value; // garde ta source de vérité si tu veux
      // toggle des champs date
      toggleDateFields(b.dataset.value);
    };
  });
}

function toggleDateFields(statusValue){
  const show = (id, on) => document.getElementById(id).hidden = !on;
  show('field-prevue', statusValue === 'planifie');
  show('field-realisation', statusValue === 'realise' || statusValue === 'paye');
  show('field-paiement', statusValue === 'paye');

  // Pré-remplissage
  const now = new Date();
  const fmt = n => String(n).padStart(2,'0');
  const nowStr = `${now.getFullYear()}-${fmt(now.getMonth()+1)}-${fmt(now.getDate())}T${fmt(now.getHours())}:${fmt(now.getMinutes())}`;

  if (statusValue === 'planifie' && !document.getElementById('quick-date-prevue').value)
    document.getElementById('quick-date-prevue').value = nowStr;
  if ((statusValue === 'realise' || statusValue === 'paye') && !document.getElementById('quick-date-realisation').value)
    document.getElementById('quick-date-realisation').value = nowStr;
  if (statusValue === 'paye' && !document.getElementById('quick-date-paiement').value)
    document.getElementById('quick-date-paiement').value = nowStr;
}

function startQuickStatusChange(){
  document.getElementById('quick-status-form').hidden = false;
  document.getElementById('change-status-btn').style.display = 'none';
  const op = selectedDayEvents[currentOperationIndex];
  toggleDateFields(op?.statut || 'a_planifier');
}
function cancelQuickStatus(){
  document.getElementById('quick-status-form').hidden = true;
  document.getElementById('change-status-btn').style.display = '';
}



    // Fonctions pour le changement rapide de statut
    function startQuickStatusChange() {
      document.getElementById('change-status-btn').style.display = 'none';
      document.getElementById('quick-status-form').style.display = 'block';
      updateDateFieldsQuick();
    }

    function cancelQuickStatus() {
      document.getElementById('change-status-btn').style.display = 'flex';
      document.getElementById('quick-status-form').style.display = 'none';
    }

    function updateDateFieldsQuick() {
      const statusValue = document.getElementById('quick-status-select').value;
      const datePrevueInput = document.getElementById('quick-date-prevue');
      const dateRealisationInput = document.getElementById('quick-date-realisation');
      const datePaiementInput = document.getElementById('quick-date-paiement');
      
      // Masquer tous les champs
      datePrevueInput.style.display = 'none';
      dateRealisationInput.style.display = 'none';
      datePaiementInput.style.display = 'none';
      
      // Réinitialiser required
      datePrevueInput.required = false;
      dateRealisationInput.required = false;
      datePaiementInput.required = false;
      
      // Date/heure actuelle formatée pour les inputs
      const now = new Date();
      const nowFormatted = now.getFullYear() + '-' + 
        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
        String(now.getDate()).padStart(2, '0') + 'T' + 
        String(now.getHours()).padStart(2, '0') + ':' + 
        String(now.getMinutes()).padStart(2, '0');
      
      // Afficher selon le statut
      if (statusValue === 'planifie') {
        datePrevueInput.style.display = 'block';
        datePrevueInput.required = true;
        if (!datePrevueInput.value) datePrevueInput.value = nowFormatted;
        datePrevueInput.placeholder = 'Date prévue';
      } else if (statusValue === 'realise') {
        dateRealisationInput.style.display = 'block';
        dateRealisationInput.required = true;
        if (!dateRealisationInput.value) dateRealisationInput.value = nowFormatted;
        dateRealisationInput.placeholder = 'Date de réalisation';
      } else if (statusValue === 'paye') {
        dateRealisationInput.style.display = 'block';
        datePaiementInput.style.display = 'block';
        dateRealisationInput.required = true;
        datePaiementInput.required = true;
        if (!dateRealisationInput.value) dateRealisationInput.value = nowFormatted;
        if (!datePaiementInput.value) datePaiementInput.value = nowFormatted;
        dateRealisationInput.placeholder = 'Date de réalisation';
        datePaiementInput.placeholder = 'Date de paiement';
      }
    }

    function saveQuickStatus() {
      const operation = selectedDayEvents[currentOperationIndex];
      if (!operation) return;
      
      const newStatus = document.getElementById('quick-status-select').value;
      const datePrevue = document.getElementById('quick-date-prevue').value;
      const dateRealisation = document.getElementById('quick-date-realisation').value;
      const datePaiement = document.getElementById('quick-date-paiement').value;
      
      // Validation des dates obligatoires
      if (newStatus === 'planifie' && !datePrevue) {
        alert('La date prévue est obligatoire pour le statut "Planifié"');
        return;
      }
      if (newStatus === 'realise' && !dateRealisation) {
        alert('La date de réalisation est obligatoire pour le statut "Réalisé"');
        return;
      }
      if (newStatus === 'paye' && (!dateRealisation || !datePaiement)) {
        alert('Les dates de réalisation et de paiement sont obligatoires pour le statut "Payé"');
        return;
      }
      
      // Validation date future pour planifié
      if (newStatus === 'planifie' && datePrevue) {
        const selectedDate = new Date(datePrevue);
        const now = new Date();
        if (selectedDate <= now) {
          alert('La date prévue ne peut pas être dans le passé');
          return;
        }
      }
      
      // Obtenir le token CSRF
      let csrfToken = '';
      const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
      if (csrfInput) {
        csrfToken = csrfInput.value;
      } else {
        // Fallback : essayer de récupérer depuis les cookies
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'csrftoken') {
            csrfToken = value;
            break;
          }
        }
      }
      
      // Préparer les données
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', csrfToken);
      formData.append('action', 'change_status');
      formData.append('statut', newStatus);
      if (datePrevue) formData.append('date_prevue', datePrevue);
      if (dateRealisation) formData.append('date_realisation', dateRealisation);
      if (datePaiement) formData.append('date_paiement', datePaiement);
      
      // Envoyer la requête
      fetch(operation.url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        }
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Erreur HTTP');
        }
      })
      .then(data => {
        if (data.success) {
          alert('Statut mis à jour avec succès !');
          // Rafraîchir la page pour voir les changements
          location.reload();
        } else {
          alert('Erreur lors de la mise à jour : ' + (data.message || 'Erreur inconnue'));
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur de connexion lors de la mise à jour');
      });
    }

    function updateEventCount() {
      let count = 0;
      if (currentView === 'day') {
        const date = new Date(); date.setDate(date.getDate() + currentOffset);
        count = calendarEvents.filter(event => event.date === formatDate(date)).length;
      } else if (currentView === 'week') {
        const weekDates = getWeekDates(currentOffset);
        weekDates.forEach(date => { count += calendarEvents.filter(event => event.date === formatDate(date)).length; });
      } else if (currentView === 'month') {
        const today = new Date();
        const currentMonth = new Date(today.getFullYear(), today.getMonth() + currentOffset, 1);
        const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
        count = calendarEvents.filter(event => {
          const d = new Date(event.date);
          return d >= currentMonth && d < nextMonth;
        }).length;
      }
      document.getElementById('events-count').textContent = count;
    }

    // Init
    document.addEventListener('DOMContentLoaded', function() {
      initCalendarEvents();
      renderCalendar();
      
      // Ajouter l'événement pour le changement de statut
      const statusSelect = document.getElementById('quick-status-select');
      if (statusSelect) {
        statusSelect.addEventListener('change', updateDateFieldsQuick);
      }
    });

    // Fermer panneau si clic extérieur
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.side-panel') && !e.target.closest('.event-item') && !e.target.closest('.day-card') && !e.target.closest('.month-event-item')) {
        if (document.getElementById('side-panel').classList.contains('open')) closeSidePanel();
      }
    });
  </script>
</body>
</html>