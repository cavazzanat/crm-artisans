<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - CRM Artisans</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --ring: rgba(99,102,241,.35);
      --border: rgba(148,163,184,.15);
      --shadow: 0 10px 25px rgba(2,6,23,.3), 0 1px 0 rgba(255,255,255,.03) inset;
      
      --bg-light: #f8fafc;
      --card-light: #ffffff;
      --text-light: #1e293b;
      --muted-light: #64748b;
      --border-light: rgba(30,41,59,.12);
      --shadow-light: 0 10px 25px rgba(30,41,59,.08), 0 1px 0 rgba(255,255,255,.8) inset;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.12), transparent 40%),
                  radial-gradient(1000px 600px at 80% 10%, rgba(139,92,246,.12), transparent 40%),
                  var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    /* Header */
    .header{
      position: sticky; top: 0; z-index: 40;
      backdrop-filter: saturate(180%) blur(8px);
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.65));
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      max-width: 1280px; margin: 0 auto; padding: .85rem 1rem;
      display:flex; align-items:center; gap:1rem; justify-content: space-between;
    }
    .brand{ display:flex; align-items:center; gap:.75rem; font-weight:700; letter-spacing:.2px }
    .logo{ width:34px; height:34px; border-radius:10px; background:linear-gradient(145deg, var(--primary), var(--accent)); box-shadow: var(--shadow); display:grid; place-items:center; }
    .logo svg{ width:18px; height:18px; color:white }

    .nav{ display:flex; gap:.25rem; align-items:center }
    .nav a{ text-decoration:none; color:var(--muted); padding:.55rem .8rem; border-radius:10px; border:1px solid transparent }
    .nav a:hover{ color:var(--text); background:rgba(148,163,184,.08); border-color:var(--border) }
    .nav a.active{ color:white; background:rgba(99,102,241,.18); border-color: rgba(99,102,241,.35); box-shadow: 0 0 0 2px var(--ring) }

    .user{ display:flex; align-items:center; gap:.75rem; color:var(--muted); font-size:.95rem }
    .user form button{ background:none; border:none; color:var(--muted); cursor:pointer; text-decoration:underline; font:inherit }

    /* Main container */
    .container{ max-width:1280px; margin: 2rem auto; padding: 0 1rem }
    .page-title{ font-size: clamp(1.4rem, 2.4vw, 2rem); font-weight:800; letter-spacing:.2px; margin-bottom: 1.25rem }
    .subtitle{ color:var(--muted); margin-bottom:1.75rem }

    /* KPI layout */
    .kpi-grid{ display:grid; gap:1rem; grid-template-columns: repeat(12, 1fr); margin-bottom:2rem }
    .kpi{ background: linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,.4)); border:1px solid var(--border); border-radius:16px; padding:1.1rem; box-shadow: var(--shadow); position:relative; overflow:hidden }
    .kpi:after{ content:""; position:absolute; inset:auto -30% -40% auto; width:180px; height:180px; background: radial-gradient(closest-side, rgba(99,102,241,.18), transparent 70%); transform: rotate(25deg) }
    .kpi h3{ font-size:.8rem; text-transform:uppercase; letter-spacing:.12rem; color:var(--muted); margin:0 0 .45rem }
    .kpi .value{ font-size: clamp(1.6rem, 2.5vw, 2.2rem); font-weight:800 }

    .kpi.ca{ grid-column: span 6 }
    .kpi.clients{ grid-column: span 6 }
    .kpi.devis, .kpi.planifier, .kpi.paiement{ grid-column: span 4 }

    .accent-success{ box-shadow: inset 0 0 0 1px rgba(34,197,94,.25) }
    .accent-info{ box-shadow: inset 0 0 0 1px rgba(99,102,241,.25) }
    .accent-warn{ box-shadow: inset 0 0 0 1px rgba(245,158,11,.25) }

    /* Sections */
    .section{ background: linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,.4)); border:1px solid var(--border); border-radius:16px; padding:1rem; box-shadow: var(--shadow); margin-top:1.25rem }
    .section-header{ display:flex; align-items:center; justify-content:space-between; gap:1rem; padding: .4rem .35rem .9rem; border-bottom:1px dashed var(--border) }
    .section-title{ display:flex; gap:.6rem; align-items:center; font-size:1.05rem; font-weight:700 }
    .section-title .badge{ font-size:.75rem; color:var(--muted); padding:.15rem .5rem; border-radius:999px; border:1px solid var(--border); background: rgba(148,163,184,.08) }

    .toolbar{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; border-radius:10px; border:1px solid var(--border); background:rgba(148,163,184,.07); color:var(--text); text-decoration:none; cursor:pointer; font-size:.9rem }
    .btn:hover{ background:rgba(148,163,184,.12) }
    .btn.primary{ background:linear-gradient(180deg, rgba(99,102,241,.18), rgba(99,102,241,.12)); border-color: rgba(99,102,241,.35); color:white }

    /* Calendar multi-vues */
    .calendar-simple{ padding:1rem 0 }
    .calendar-nav{ display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem }
    .calendar-title{ font-size:1.1rem; font-weight:600 }
    .nav-btn{ padding:.5rem; border:1px solid var(--border); background:rgba(148,163,184,.07); color:var(--text); cursor:pointer; border-radius:8px }
    .nav-btn:hover{ background:rgba(148,163,184,.12) }
    
    .view-buttons{ display:flex; gap:.25rem }
    .view-btn{ padding:.4rem .7rem; border:1px solid var(--border); background:rgba(148,163,184,.07); color:var(--text); cursor:pointer; border-radius:6px; font-size:.85rem }
    .view-btn:hover{ background:rgba(148,163,184,.12) }
    .view-btn.active{ background:var(--primary); color:white; border-color:var(--primary) }

    /* Vue Jour */
    .day-view{ display:none }
    .day-timeline{ display:grid; grid-template-columns: 80px 1fr; gap:1px; background:var(--border); border-radius:12px; overflow:hidden }
    .time-slot{ background:rgba(15,23,42,.8); padding:.5rem; font-size:.75rem; color:var(--muted); text-align:center }
    .hour-events{ background:rgba(2,6,23,.4); min-height:60px; padding:.25rem; position:relative }

    /* Vue Semaine */
    .week-view{ display:grid; grid-template-columns: repeat(7, 1fr); gap:.5rem; margin-top:1rem }
    .day-card{ 
      background:rgba(2,6,23,.4); 
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:.75rem; 
      min-height:120px;
      position:relative;
    }
    .day-card.today{ border-color:var(--primary); background:rgba(99,102,241,.1) }
    .day-header{ font-weight:600; margin-bottom:.5rem; font-size:.9rem }
    .day-number{ color:var(--muted); font-size:.8rem }

    /* Vue Mois */
    .month-view{ display:none }
    .month-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background:var(--border); border-radius:12px; overflow:hidden }
    .month-day{ background:rgba(2,6,23,.4); min-height:80px; padding:.4rem; position:relative; border-bottom:1px solid var(--border) }
    .month-day.other-month{ opacity:.4 }
    .month-day.today{ background:rgba(99,102,241,.1); border:1px solid var(--primary) }
    .month-day-number{ font-size:.8rem; font-weight:600; margin-bottom:.2rem }
    .month-header{ background:rgba(15,23,42,.8); padding:.5rem; text-align:center; font-size:.8rem; color:var(--muted); font-weight:600 }

    /* Vue Année */
    .year-view{ display:none }
    .year-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:1rem }
    .month-mini{ 
      background:rgba(2,6,23,.4); 
      border:1px solid var(--border); 
      border-radius:8px; 
      padding:.75rem; 
    }
    .month-mini-header{ text-align:center; font-weight:600; margin-bottom:.5rem; font-size:.9rem }
    .month-mini-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:1px }
    .month-mini-day{ 
      width:24px; height:20px; 
      font-size:.7rem; 
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .month-mini-day.has-event{ background:rgba(99,102,241,.3); border-radius:3px }
    .month-mini-day.today{ background:var(--primary); color:white; border-radius:3px }

    .event-item{ 
      background:rgba(99,102,241,.2); 
      border:1px solid rgba(99,102,241,.3); 
      border-radius:6px; 
      padding:.3rem; 
      margin:.2rem 0; 
      font-size:.75rem; 
      cursor:pointer;
      line-height:1.2;
      transition: all 0.2s ease;
    }
    .event-item:hover{ background:rgba(99,102,241,.3); transform: translateY(-1px) }

    /* Jour sélectionné */
    .day-card.selected{ border-color:var(--warning); box-shadow: 0 0 0 2px rgba(245,158,11,.3) }
    .month-day.selected{ border-color:var(--warning); box-shadow: 0 0 0 2px rgba(245,158,11,.3) }

    /* Panneau latéral */
    .side-panel{
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: linear-gradient(180deg, rgba(2,6,23,.95), rgba(2,6,23,.9));
      border-left: 1px solid var(--border);
      box-shadow: -10px 0 25px rgba(0,0,0,.2);
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
      backdrop-filter: blur(10px);
    }
    .side-panel.open{ right: 0 }

    .panel-header{
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: rgba(2,6,23,.9);
      backdrop-filter: blur(10px);
    }
    .panel-title{
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: .5rem;
      color: var(--text);
    }
    .panel-subtitle{
      color: var(--muted);
      font-size: .9rem;
    }

    .close-panel{
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: .5rem;
      border-radius: 6px;
    }
    .close-panel:hover{ background: rgba(148,163,184,.1); color: var(--text) }

    .panel-content{
      padding: 1.5rem;
    }

    .operation-tabs{
      display: flex;
      gap: .5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .operation-tab{
      padding: .4rem .8rem;
      background: rgba(148,163,184,.07);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: .8rem;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.2s ease;
    }
    .operation-tab.active{
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .operation-tab:hover:not(.active){
      background: rgba(148,163,184,.12);
      color: var(--text);
    }

    .operation-details{
      margin-bottom: 2rem;
    }
    .detail-section{
      margin-bottom: 1.5rem;
    }
    .detail-section h4{
      color: var(--text);
      font-size: .9rem;
      margin-bottom: .75rem;
      text-transform: uppercase;
      letter-spacing: .05rem;
      font-weight: 600;
    }
    .detail-item{
      margin-bottom: .5rem;
      padding: .5rem 0;
    }
    .detail-label{
      color: var(--muted);
      font-size: .8rem;
      margin-bottom: .25rem;
    }
    .detail-value{
      color: var(--text);
      font-size: .9rem;
    }

    .client-actions{
      display: flex;
      gap: .75rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    .action-btn{
      flex: 1;
      padding: .75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(148,163,184,.07);
      color: var(--text);
      text-decoration: none;
      text-align: center;
      font-size: .85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
    }
    .action-btn:hover{
      background: rgba(148,163,184,.12);
      transform: translateY(-1px);
    }
    .action-btn.primary{
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .action-btn.success{
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    /* Responsive */
    @media (max-width: 768px){
      .side-panel{
        width: 100%;
        right: -100%;
      }
    }

    /* Table */
    .table-wrap{ overflow:auto; border-radius:12px; border:1px solid var(--border); margin-top:1rem }
    table{ width:100%; border-collapse: collapse; min-width: 800px; }
    thead th{ background: rgba(15,23,42,.9); color:var(--muted); text-transform:uppercase; letter-spacing:.08rem; font-size:.75rem; text-align:left; padding:.9rem .85rem; border-bottom:1px solid var(--border) }
    tbody td{ padding: .85rem .85rem; border-bottom:1px dashed var(--border) }
    tbody tr:hover{ background: rgba(148,163,184,.05) }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; font-size:.78rem; border:1px solid var(--border); color: var(--muted) }

    .btn-view{ display:inline-flex; align-items:center; gap:.45rem; padding:.45rem .7rem; border-radius:8px; border:1px solid rgba(99,102,241,.35); background: rgba(99,102,241,.15); color:white; text-decoration:none; font-size:.8rem }
    .btn-view:hover{ box-shadow: 0 0 0 2px var(--ring) }

    /* Responsive */
    @media (max-width: 768px){
      .kpi.ca, .kpi.clients, .kpi.devis, .kpi.planifier, .kpi.paiement{ grid-column: 1 / -1 }
      .week-calendar{ grid-template-columns: 1fr; gap:.3rem }
      .calendar-nav{ flex-direction:column; align-items:flex-start }
      .table-wrap{ border:none }
      table{ display:block }
      thead{ display:none }
      tbody{ display:grid; gap:.75rem }
      tbody tr{ display:grid; gap:.4rem; border:1px solid var(--border); border-radius:12px; padding:.8rem; background: rgba(2,6,23,.5) }
      tbody td{ padding:.15rem 0; border:none }
    }

    /* Light mode */
    @media (prefers-color-scheme: light){
      :root{ 
        --bg: var(--bg-light); 
        --card: var(--card-light);
        --text: var(--text-light); 
        --muted: var(--muted-light); 
        --border: var(--border-light);
        --shadow: var(--shadow-light);
      }
      
      body{
        background: radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.05), transparent 40%),
                    radial-gradient(1000px 600px at 80% 10%, rgba(139,92,246,.05), transparent 40%),
                    var(--bg);
      }
      
      .header{ 
        background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.8));
        backdrop-filter: saturate(180%) blur(8px);
      }
      
      .kpi, .section{ 
        background: var(--card);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      
      .day-card{ background: var(--card) }
      .day-card.today{ border-color:var(--primary); background:rgba(99,102,241,.05) }
      
      .nav a.active{ 
        color: var(--primary); 
        background: rgba(99,102,241,.08);
        border-color: rgba(99,102,241,.2);
      }
      
      .btn.primary{ 
        background: rgba(99,102,241,.1); 
        border-color: rgba(99,102,241,.2);
        color: var(--primary);
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}" class="active">Accueil</a>
        <a href="{% url 'operations' %}">Opérations</a>
        <a href="{% url 'clients' %}">Clients</a>
      </nav>
      <div class="user">
        <span>Connecté : {{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit">Déconnexion</button>
        </form>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="page-title">Tableau de bord</h1>
    <p class="subtitle">Vue d'ensemble des performances et du planning.</p>

    <!-- KPI -->
    <section class="kpi-grid">
      <article class="kpi ca accent-success">
        <h3>CA du mois</h3>
        <div class="value">{{ ca_mois|floatformat:0 }} €</div>
      </article>
      <article class="kpi clients accent-info">
        <h3>Clients</h3>
        <div class="value">{{ nb_clients }}</div>
      </article>
      <article class="kpi devis accent-warn">
        <h3>En attente devis</h3>
        <div class="value">{{ nb_en_attente_devis }}</div>
      </article>
      <article class="kpi planifier accent-info">
        <h3>À planifier</h3>
        <div class="value">{{ nb_a_planifier }}</div>
      </article>
      <article class="kpi paiement accent-warn">
        <h3>Attente paiement</h3>
        <div class="value">{{ nb_realise }}</div>
      </article>
    </section>

    <!-- Planning simplifié -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Planning de la semaine
          <span class="badge" id="events-count">0</span>
        </h2>
        <div class="toolbar">
          <a href="{% url 'operation_create' %}" class="btn primary">Nouvelle opération</a>
        </div>
      </div>

      <div class="calendar-simple">
        <div class="calendar-nav">
          <div class="calendar-title" id="calendar-title">Semaine courante</div>
          <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap">
            <div>
              <button class="nav-btn" onclick="navigateCalendar(-1)">← Précédent</button>
              <button class="nav-btn" onclick="navigateCalendar(0)" style="margin:0 .5rem">Aujourd'hui</button>
              <button class="nav-btn" onclick="navigateCalendar(1)">Suivant →</button>
            </div>
            <div class="view-buttons">
              <button class="view-btn" onclick="setView('day')" id="day-btn">Jour</button>
              <button class="view-btn active" onclick="setView('week')" id="week-btn">Semaine</button>
              <button class="view-btn" onclick="setView('month')" id="month-btn">Mois</button>
              <button class="view-btn" onclick="setView('year')" id="year-btn">Année</button>
            </div>
          </div>
        </div>

        <!-- Vue Jour -->
        <div class="day-view" id="day-view">
          <div class="day-timeline">
            <div class="time-column">
              <div class="time-slot">08:00</div>
              <div class="time-slot">09:00</div>
              <div class="time-slot">10:00</div>
              <div class="time-slot">11:00</div>
              <div class="time-slot">14:00</div>
              <div class="time-slot">15:00</div>
              <div class="time-slot">16:00</div>
              <div class="time-slot">17:00</div>
            </div>
            <div class="events-column">
              <div class="hour-events" data-hour="8"></div>
              <div class="hour-events" data-hour="9"></div>
              <div class="hour-events" data-hour="10"></div>
              <div class="hour-events" data-hour="11"></div>
              <div class="hour-events" data-hour="14"></div>
              <div class="hour-events" data-hour="15"></div>
              <div class="hour-events" data-hour="16"></div>
              <div class="hour-events" data-hour="17"></div>
            </div>
          </div>
        </div>

        <!-- Vue Semaine -->
        <div class="week-view" id="week-view">
          <!-- Généré par JavaScript -->
        </div>

        <!-- Vue Mois -->
        <div class="month-view" id="month-view">
          <div class="month-grid">
            <!-- Headers des jours -->
            <div class="month-header">Lun</div>
            <div class="month-header">Mar</div>
            <div class="month-header">Mer</div>
            <div class="month-header">Jeu</div>
            <div class="month-header">Ven</div>
            <div class="month-header">Sam</div>
            <div class="month-header">Dim</div>
            <!-- Jours générés par JavaScript -->
          </div>
        </div>

        <!-- Vue Année -->
        <div class="year-view" id="year-view">
          <div class="year-grid" id="year-grid">
            <!-- Mois générés par JavaScript -->
          </div>
        </div>
      </div>
    </section>

    <!-- Prochaines opérations -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M7 10h10M7 14h7M4 6h16v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Prochaines opérations
          <span class="badge">{{ prochaines_operations|length }}</span>
        </h2>
        <div class="toolbar">
          <a href="{% url 'operations' %}?statut=planifie" class="btn">Voir plus</a>
        </div>
      </div>

      {% if prochaines_operations %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Opération</th>
              <th>Téléphone</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for operation in prochaines_operations %}
            <tr>
              <td>
                {% if operation.date_prevue %}
                  {{ operation.date_prevue|date:"d/m H\hi" }}
                {% else %}
                  <span class="chip">Non planifiée</span>
                {% endif %}
              </td>
              <td>{{ operation.client.nom }} {{ operation.client.prenom }}</td>
              <td>{{ operation.type_prestation|truncatechars:40 }}</td>
              <td>
                <a href="tel:{{ operation.client.telephone }}" class="chip">{{ operation.client.telephone }}</a>
              </td>
              <td>
                <a href="{% url 'operation_detail' operation.id %}" class="btn-view">Voir</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div style="text-align:center; padding:2rem; color:var(--muted)">
        <p>Aucune opération planifiée.</p>
      </div>
      {% endif %}
    </section>

    <!-- Actions rapides -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h10M4 12h7M4 17h13" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Actions rapides
        </h2>
      </div>
      <div class="toolbar">
        <a href="{% url 'operation_create' %}" class="btn primary">Nouvelle opération</a>
        <a href="{% url 'clients' %}" class="btn">Voir les clients</a>
        <a href="{% url 'client_create' %}" class="btn">Nouveau client</a>
      </div>
    </section>
  </main>

  <!-- Panneau latéral -->
  <div class="side-panel" id="side-panel">
    <div class="panel-header">
      <div class="panel-title" id="panel-title">Interventions du jour</div>
      <div class="panel-subtitle" id="panel-date">Sélectionnez une date</div>
      <button class="close-panel" onclick="closeSidePanel()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>

    <div class="panel-content">
      <div class="operation-tabs" id="operation-tabs">
        <!-- Onglets générés par JS -->
      </div>

      <div class="operation-details" id="operation-details">
        <div class="detail-section">
          <h4>Intervention</h4>
          <div class="detail-item">
            <div class="detail-label">Service</div>
            <div class="detail-value" id="detail-service">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Horaire</div>
            <div class="detail-value" id="detail-time">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Adresse</div>
            <div class="detail-value" id="detail-address">-</div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Client</h4>
          <div class="detail-item">
            <div class="detail-label">Nom</div>
            <div class="detail-value" id="detail-client">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Téléphone</div>
            <div class="detail-value" id="detail-phone">-</div>
          </div>
        </div>

        <div class="client-actions">
          <a href="#" class="action-btn success" id="call-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92Z" stroke="currentColor" stroke-width="2"/>
            </svg>
            Appeler
          </a>
          <a href="#" class="action-btn primary" id="detail-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M12 5C7 5 3.73 8.11 2 12c1.73 3.89 5 7 10 7s8.27-3.11 10-7c-1.73-3.89-5-7-10-7Zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            Voir détail
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" onclick="closeSidePanel()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.3); z-index:999"></div>

  <script>
    // Données Django - version corrigée
    let calendarEvents = [];
    try {
      calendarEvents = JSON.parse('{{ calendar_events_json|escapejs }}');
    } catch (e) {
      console.error('Erreur parsing calendar_events:', e);
      // Données de test en cas d'erreur
      calendarEvents = [
        {
          'id': 1,
          'client_nom': 'Test Client',
          'service': 'Test Service',
          'date': '2025-09-25',
          'time': '09:00',
          'address': 'Test Address',
          'phone': '0123456789',
          'url': '#'
        }
      ];
    }
  <script>
    // Données Django - version corrigée
    let calendarEvents = [];
    try {
      calendarEvents = JSON.parse('{{ calendar_events_json|escapejs }}');
    } catch (e) {
      console.error('Erreur parsing calendar_events:', e);
      // Données de test en cas d'erreur
      calendarEvents = [
        {
          'id': 1,
          'client_nom': 'Test Client',
          'service': 'Test Service',
          'date': '2025-09-25',
          'time': '09:00',
          'address': 'Test Address',
          'phone': '0123456789',
          'url': '#'
        }
      ];
    }
    
    let currentView = 'week';
    let currentDate = new Date();
    let currentOffset = 0;
    let selectedDate = null;
    let selectedDayEvents = [];
    let currentOperationIndex = 0;

    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                       'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    const monthsShort = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 
                        'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
    const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

    function formatDate(date) {
      return date.getFullYear() + '-' + 
        String(date.getMonth() + 1).padStart(2, '0') + '-' + 
        String(date.getDate()).padStart(2, '0');
    }

    function setView(view) {
      currentView = view;
      currentOffset = 0;
      closeSidePanel();
      
      // Update buttons
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(view + '-btn').classList.add('active');

      // Show/hide views
      document.getElementById('day-view').style.display = view === 'day' ? 'block' : 'none';
      document.getElementById('week-view').style.display = view === 'week' ? 'grid' : 'none';
      document.getElementById('month-view').style.display = view === 'month' ? 'block' : 'none';
      document.getElementById('year-view').style.display = view === 'year' ? 'block' : 'none';

      updateCalendarView();
    }

    function navigateCalendar(direction) {
      if (direction === 0) {
        currentOffset = 0;
        currentDate = new Date();
      } else {
        currentOffset += direction;
      }
      closeSidePanel();
      updateCalendarView();
    }

    function updateCalendarView() {
      // Clear previous selections
      document.querySelectorAll('.day-card.selected, .month-day.selected').forEach(el => {
        el.classList.remove('selected');
      });

      switch(currentView) {
        case 'day':
          updateDayView();
          break;
        case 'week':
          updateWeekView();
          break;
        case 'month':
          updateMonthView();
          break;
        case 'year':
          updateYearView();
          break;
      }
      updateEventCount();
    }

    function updateDayView() {
      const date = new Date();
      date.setDate(date.getDate() + currentOffset);
      
      document.getElementById('calendar-title').textContent = 
        date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      // Clear existing events
      document.querySelectorAll('.hour-events').forEach(slot => {
        slot.innerHTML = '';
      });

      // Add events for the day
      const dayEvents = calendarEvents.filter(event => event.date === formatDate(date));
      dayEvents.forEach((event, index) => {
        const hour = parseInt(event.time.split(':')[0]);
        const slot = document.querySelector(`[data-hour="${hour}"]`);
        if (slot) {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom}<br><small>${event.service}</small>`;
          eventEl.onclick = (e) => {
            e.stopPropagation();
            handleEventClick(formatDate(date), dayEvents, index);
          };
          slot.appendChild(eventEl);
        }
      });
    }

    function updateWeekView() {
      const startOfWeek = new Date();
      startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1 + (currentOffset * 7));
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 6);
      
      document.getElementById('calendar-title').textContent = 
        `${startOfWeek.getDate()} ${monthsShort[startOfWeek.getMonth()]} - ${endOfWeek.getDate()} ${monthsShort[endOfWeek.getMonth()]} ${endOfWeek.getFullYear()}`;
      
      const weekView = document.getElementById('week-view');
      weekView.innerHTML = '';
      
      const today = new Date();
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        
        if (formatDate(date) === formatDate(today)) {
          dayCard.classList.add('today');
        }
        
        dayCard.innerHTML = `
          <div class="day-header">${dayNames[i]}</div>
          <div class="day-number">${date.getDate()}</div>
        `;
        
        const dayEvents = calendarEvents.filter(event => event.date === formatDate(date));
        dayEvents.forEach((event, index) => {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom}`;
          eventEl.onclick = (e) => {
            e.stopPropagation();
            handleEventClick(formatDate(date), dayEvents, index);
          };
          dayCard.appendChild(eventEl);
        });
        
        // Click on empty area of day
        dayCard.onclick = (e) => {
          if (e.target === dayCard || e.target.classList.contains('day-header') || e.target.classList.contains('day-number')) {
            if (dayEvents.length > 0) {
              handleEventClick(formatDate(date), dayEvents, 0);
            }
          }
        };
        
        weekView.appendChild(dayCard);
      }
    }

    function updateMonthView() {
      const date = new Date();
      date.setMonth(date.getMonth() + currentOffset);
      date.setDate(1);
      
      document.getElementById('calendar-title').textContent = 
        `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
      
      const monthGrid = document.querySelector('.month-grid');
      const existingDays = monthGrid.querySelectorAll('.month-day');
      existingDays.forEach(day => day.remove());
      
      const firstDay = new Date(date);
      const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
      
      const today = new Date();
      
      for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'month-day';
        
        if (currentDate.getMonth() !== date.getMonth()) {
          dayEl.classList.add('other-month');
        }
        
        if (formatDate(currentDate) === formatDate(today)) {
          dayEl.classList.add('today');
        }
        
        dayEl.innerHTML = `<div class="month-day-number">${currentDate.getDate()}</div>`;
        
        const dayEvents = calendarEvents.filter(event => event.date === formatDate(currentDate));
        dayEvents.forEach((event, index) => {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom.split(' ')[0]}`;
          eventEl.onclick = (e) => {
            e.stopPropagation();
            handleEventClick(formatDate(currentDate), dayEvents, index);
          };
          dayEl.appendChild(eventEl);
        });

        // Click on day
        dayEl.onclick = (e) => {
          if (dayEvents.length > 0 && (e.target === dayEl || e.target.classList.contains('month-day-number'))) {
            handleEventClick(formatDate(currentDate), dayEvents, 0);
          }
        };
        
        monthGrid.appendChild(dayEl);
      }
    }

    function updateYearView() {
      const year = new Date().getFullYear() + currentOffset;
      document.getElementById('calendar-title').textContent = year;
      
      const yearGrid = document.getElementById('year-grid');
      yearGrid.innerHTML = '';
      
      const today = new Date();
      
      for (let month = 0; month < 12; month++) {
        const monthEl = document.createElement('div');
        monthEl.className = 'month-mini';
        
        const headerEl = document.createElement('div');
        headerEl.className = 'month-mini-header';
        headerEl.textContent = monthsShort[month];
        monthEl.appendChild(headerEl);
        
        const gridEl = document.createElement('div');
        gridEl.className = 'month-mini-grid';
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
        
        for (let i = 0; i < 35; i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          
          const dayEl = document.createElement('div');
          dayEl.className = 'month-mini-day';
          
          if (currentDate.getMonth() === month) {
            dayEl.textContent = currentDate.getDate();
            
            if (formatDate(currentDate) === formatDate(today)) {
              dayEl.classList.add('today');
            }
            
            const hasEvent = calendarEvents.some(event => event.date === formatDate(currentDate));
            if (hasEvent) {
              dayEl.classList.add('has-event');
              
              // Click handler for year view
              dayEl.onclick = () => {
                const dayEvents = calendarEvents.filter(event => event.date === formatDate(currentDate));
                if (dayEvents.length > 0) {
                  handleEventClick(formatDate(currentDate), dayEvents, 0);
                }
              };
            }
          }
          
          gridEl.appendChild(dayEl);
        }
        
        monthEl.appendChild(gridEl);
        yearGrid.appendChild(monthEl);
      }
    }

    function handleEventClick(dateStr, dayEvents, operationIndex) {
      selectedDate = dateStr;
      selectedDayEvents = dayEvents;
      currentOperationIndex = operationIndex;
      
      // Highlight selected day
      document.querySelectorAll('.day-card.selected, .month-day.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Add selection to corresponding day
      const dayElements = document.querySelectorAll('.day-card, .month-day');
      dayElements.forEach(el => {
        const dayDate = el.querySelector('.day-number, .month-day-number');
        if (dayDate && dayEvents.length > 0) {
          const eventDate = new Date(dateStr);
          if (dayDate.textContent == eventDate.getDate()) {
            el.classList.add('selected');
          }
        }
      });
      
      openSidePanel();
    }

    function openSidePanel() {
      document.getElementById('side-panel').classList.add('open');
      document.getElementById('overlay').style.display = 'block';
      
      updatePanelContent();
    }

    function closeSidePanel() {
      document.getElementById('side-panel').classList.remove('open');
      document.getElementById('overlay').style.display = 'none';
      
      // Remove selections
      document.querySelectorAll('.day-card.selected, .month-day.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      selectedDate = null;
      selectedDayEvents = [];
    }

    function updatePanelContent() {
      if (!selectedDate || selectedDayEvents.length === 0) return;
      
      const date = new Date(selectedDate);
      const dateStr = date.toLocaleDateString('fr-FR', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      document.getElementById('panel-date').textContent = dateStr;
      document.getElementById('panel-title').textContent = 
        `${selectedDayEvents.length} intervention${selectedDayEvents.length > 1 ? 's' : ''}`;
      
      // Update tabs
      const tabsContainer = document.getElementById('operation-tabs');
      tabsContainer.innerHTML = '';
      
      if (selectedDayEvents.length > 1) {
        selectedDayEvents.forEach((event, index) => {
          const tab = document.createElement('div');
          tab.className = `operation-tab ${index === currentOperationIndex ? 'active' : ''}`;
          tab.textContent = event.time;
          tab.onclick = () => switchOperation(index);
          tabsContainer.appendChild(tab);
        });
      }
      
      // Update operation details
      updateOperationDetails();
    }

    function switchOperation(index) {
      currentOperationIndex = index;
      updateOperationDetails();
      
      // Update tabs
      document.querySelectorAll('.operation-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
      });
    }

    function updateOperationDetails() {
      const operation = selectedDayEvents[currentOperationIndex];
      if (!operation) return;
      
      document.getElementById('detail-service').textContent = operation.service;
      document.getElementById('detail-time').textContent = operation.time;
      document.getElementById('detail-address').textContent = operation.address;
      document.getElementById('detail-client').textContent = operation.client_nom;
      document.getElementById('detail-phone').textContent = operation.phone;
      
      // Update action buttons
      document.getElementById('call-btn').href = `tel:${operation.phone}`;
      document.getElementById('detail-btn').href = operation.url;
    }

    function updateEventCount() {
      let eventCount = 0;
      
      if (currentView === 'day') {
        const date = new Date();
        date.setDate(date.getDate() + currentOffset);
        eventCount = calendarEvents.filter(event => event.date === formatDate(date)).length;
      } else if (currentView === 'week') {
        const startOfWeek = new Date();
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1 + (currentOffset * 7));
        for (let i = 0; i < 7; i++) {
          const date = new Date(startOfWeek);
          date.setDate(startOfWeek.getDate() + i);
          eventCount += calendarEvents.filter(event => event.date === formatDate(date)).length;
        }
      } else {
        eventCount = calendarEvents.length;
      }
      
      document.getElementById('events-count').textContent = eventCount;
    }

    // Close panel when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.side-panel') && !e.target.closest('.event-item') && !e.target.closest('.day-card') && !e.target.closest('.month-day')) {
        if (document.getElementById('side-panel').classList.contains('open')) {
          closeSidePanel();
        }
      }
    });

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
      setView('week');
    });.date === formatDate(date));
      dayEvents.forEach((event, index) => {
        const hour = parseInt(event.time.split(':')[0]);
        const slot = document.querySelector(`[data-hour="${hour}"]`);
        if (slot) {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom}<br><small>${event.service}</small>`;
          eventEl.onclick = (e) => {
            e.stopPropagation();
            handleEventClick(formatDate(date), dayEvents, index);
          };
          slot.appendChild(eventEl);
        }
      });
    }

    function updateWeekView() {
      const startOfWeek = new Date();
      startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1 + (currentOffset * 7));
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 6);
      
      document.getElementById('calendar-title').textContent = 
        `${startOfWeek.getDate()} ${monthsShort[startOfWeek.getMonth()]} - ${endOfWeek.getDate()} ${monthsShort[endOfWeek.getMonth()]} ${endOfWeek.getFullYear()}`;
      
      const weekView = document.getElementById('week-view');
      weekView.innerHTML = '';
      
      const today = new Date();
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        
        if (formatDate(date) === formatDate(today)) {
          dayCard.classList.add('today');
        }
        
        dayCard.innerHTML = `
          <div class="day-header">${dayNames[i]}</div>
          <div class="day-number">${date.getDate()}</div>
        `;
        
        const dayEvents = calendarEvents.filter(event => event.date === formatDate(date));
        dayEvents.forEach((event, index) => {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom}`;
          eventEl.onclick = (e) => {
            e.stopPropagation();
            handleEventClick(formatDate(date), dayEvents, index);
          };
          dayCard.appendChild(eventEl);
        });
        
        // Click on empty area of day
        dayCard.onclick = (e) => {
          if (e.target === dayCard || e.target.classList.contains('day-header') || e.target.classList.contains('day-number')) {
            if (dayEvents.length > 0) {
              handleEventClick(formatDate(date), dayEvents, 0);
            }
          }
        };
        
        weekView.appendChild(dayCard);
      }
    }

    function updateMonthView() {
      const date = new Date();
      date.setMonth(date.getMonth() + currentOffset);
      date.setDate(1);
      
      document.getElementById('calendar-title').textContent = 
        `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
      
      const monthGrid = document.querySelector('.month-grid');
      const existingDays = monthGrid.querySelectorAll('.month-day');
      existingDays.forEach(day => day.remove());
      
      const firstDay = new Date(date);
      const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
      
      const today = new Date();
      
      for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'month-day';
        
        if (currentDate.getMonth() !== date.getMonth()) {
          dayEl.classList.add('other-month');
        }
        
        if (formatDate(currentDate) === formatDate(today)) {
          dayEl.classList.add('today');
        }
        
        dayEl.innerHTML = `<div class="month-day-number">${currentDate.getDate()}</div>`;
        
        const dayEvents = calendarEvents.filter(event => event.date === formatDate(currentDate));
        dayEvents.forEach((event, index) => {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom.split(' ')[0]}`;
          eventEl.onclick = (e) => {
            e.stopPropagation();
            handleEventClick(formatDate(currentDate), dayEvents, index);
          };
          dayEl.appendChild(eventEl);
        });

        // Click on day
        dayEl.onclick = (e) => {
          if (dayEvents.length > 0 && (e.target === dayEl || e.target.classList.contains('month-day-number'))) {
            handleEventClick(formatDate(currentDate), dayEvents, 0);
          }
        };
        
        monthGrid.appendChild(dayEl);
      }
    }

    function updateYearView() {
      const year = new Date().getFullYear() + currentOffset;
      document.getElementById('calendar-title').textContent = year;
      
      const yearGrid = document.getElementById('year-grid');
      yearGrid.innerHTML = '';
      
      const today = new Date();
      
      for (let month = 0; month < 12; month++) {
        const monthEl = document.createElement('div');
        monthEl.className = 'month-mini';
        
        const headerEl = document.createElement('div');
        headerEl.className = 'month-mini-header';
        headerEl.textContent = monthsShort[month];
        monthEl.appendChild(headerEl);
        
        const gridEl = document.createElement('div');
        gridEl.className = 'month-mini-grid';
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
        
        for (let i = 0; i < 35; i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          
          const dayEl = document.createElement('div');
          dayEl.className = 'month-mini-day';
          
          if (currentDate.getMonth() === month) {
            dayEl.textContent = currentDate.getDate();
            
            if (formatDate(currentDate) === formatDate(today)) {
              dayEl.classList.add('today');
            }
            
            const hasEvent = calendarEvents.some(event => event.date === formatDate(currentDate));
            if (hasEvent) {
              dayEl.classList.add('has-event');
              
              // Click handler for year view
              dayEl.onclick = () => {
                const dayEvents = calendarEvents.filter(event => event.date === formatDate(currentDate));
                if (dayEvents.length > 0) {
                  handleEventClick(formatDate(currentDate), dayEvents, 0);
                }
              };
            }
          }
          
          gridEl.appendChild(dayEl);
        }
        
        monthEl.appendChild(gridEl);
        yearGrid.appendChild(monthEl);
      }
    }

    function handleEventClick(dateStr, dayEvents, operationIndex) {
      selectedDate = dateStr;
      selectedDayEvents = dayEvents;
      currentOperationIndex = operationIndex;
      
      // Highlight selected day
      document.querySelectorAll('.day-card.selected, .month-day.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Add selection to corresponding day
      const dayElements = document.querySelectorAll('.day-card, .month-day');
      dayElements.forEach(el => {
        const dayDate = el.querySelector('.day-number, .month-day-number');
        if (dayDate && dayEvents.length > 0) {
          const eventDate = new Date(dateStr);
          if (dayDate.textContent == eventDate.getDate()) {
            el.classList.add('selected');
          }
        }
      });
      
      openSidePanel();
    }

    function openSidePanel() {
      document.getElementById('side-panel').classList.add('open');
      document.getElementById('overlay').style.display = 'block';
      
      updatePanelContent();
    }

    function closeSidePanel() {
      document.getElementById('side-panel').classList.remove('open');
      document.getElementById('overlay').style.display = 'none';
      
      // Remove selections
      document.querySelectorAll('.day-card.selected, .month-day.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      selectedDate = null;
      selectedDayEvents = [];
    }

    function updatePanelContent() {
      if (!selectedDate || selectedDayEvents.length === 0) return;
      
      const date = new Date(selectedDate);
      const dateStr = date.toLocaleDateString('fr-FR', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      document.getElementById('panel-date').textContent = dateStr;
      document.getElementById('panel-title').textContent = 
        `${selectedDayEvents.length} intervention${selectedDayEvents.length > 1 ? 's' : ''}`;
      
      // Update tabs
      const tabsContainer = document.getElementById('operation-tabs');
      tabsContainer.innerHTML = '';
      
      if (selectedDayEvents.length > 1) {
        selectedDayEvents.forEach((event, index) => {
          const tab = document.createElement('div');
          tab.className = `operation-tab ${index === currentOperationIndex ? 'active' : ''}`;
          tab.textContent = event.time;
          tab.onclick = () => switchOperation(index);
          tabsContainer.appendChild(tab);
        });
      }
      
      // Update operation details
      updateOperationDetails();
    }

    function switchOperation(index) {
      currentOperationIndex = index;
      updateOperationDetails();
      
      // Update tabs
      document.querySelectorAll('.operation-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
      });
    }

    function updateOperationDetails() {
      const operation = selectedDayEvents[currentOperationIndex];
      if (!operation) return;
      
      document.getElementById('detail-service').textContent = operation.service;
      document.getElementById('detail-time').textContent = operation.time;
      document.getElementById('detail-address').textContent = operation.address;
      document.getElementById('detail-client').textContent = operation.client_nom;
      document.getElementById('detail-phone').textContent = operation.phone;
      
      // Update action buttons
      document.getElementById('call-btn').href = `tel:${operation.phone}`;
      document.getElementById('detail-btn').href = operation.url;
    }

    function updateEventCount() {
      let eventCount = 0;
      
      if (currentView === 'day') {
        const date = new Date();
        date.setDate(date.getDate() + currentOffset);
        eventCount = calendarEvents.filter(event => event.date === formatDate(date)).length;
      } else if (currentView === 'week') {
        const startOfWeek = new Date();
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1 + (currentOffset * 7));
        for (let i = 0; i < 7; i++) {
          const date = new Date(startOfWeek);
          date.setDate(startOfWeek.getDate() + i);
          eventCount += calendarEvents.filter(event => event.date === formatDate(date)).length;
        }
      } else {
        eventCount = calendarEvents.length;
      }
      
      document.getElementById('events-count').textContent = eventCount;
    }

    // Close panel when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.side-panel') && !e.target.closest('.event-item') && !e.target.closest('.day-card') && !e.target.closest('.month-day')) {
        if (document.getElementById('side-panel').classList.contains('open')) {
          closeSidePanel();
        }
      }
    });

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
      setView('week');
    });.date === formatDate(date));
      dayEvents.forEach(event => {
        const hour = parseInt(event.time.split(':')[0]);
        const slot = document.querySelector(`[data-hour="${hour}"]`);
        if (slot) {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom}<br><small>${event.service}</small>`;
          eventEl.onclick = () => { if (event.url) window.location.href = event.url; };
          slot.appendChild(eventEl);
        }
      });
    }

    function updateWeekView() {
      const startOfWeek = new Date();
      startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1 + (currentOffset * 7));
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 6);
      
      document.getElementById('calendar-title').textContent = 
        `${startOfWeek.getDate()} ${monthsShort[startOfWeek.getMonth()]} - ${endOfWeek.getDate()} ${monthsShort[endOfWeek.getMonth()]} ${endOfWeek.getFullYear()}`;
      
      const weekView = document.getElementById('week-view');
      weekView.innerHTML = '';
      
      const today = new Date();
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        
        if (formatDate(date) === formatDate(today)) {
          dayCard.classList.add('today');
        }
        
        dayCard.innerHTML = `
          <div class="day-header">${dayNames[i]}</div>
          <div class="day-number">${date.getDate()}</div>
        `;
        
        const dayEvents = calendarEvents.filter(event => event.date === formatDate(date));
        dayEvents.forEach(event => {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom}`;
          eventEl.onclick = () => { if (event.url) window.location.href = event.url; };
          dayCard.appendChild(eventEl);
        });
        
        weekView.appendChild(dayCard);
      }
    }

    function updateMonthView() {
      const date = new Date();
      date.setMonth(date.getMonth() + currentOffset);
      date.setDate(1);
      
      document.getElementById('calendar-title').textContent = 
        `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
      
      const monthGrid = document.querySelector('.month-grid');
      const existingDays = monthGrid.querySelectorAll('.month-day');
      existingDays.forEach(day => day.remove());
      
      const firstDay = new Date(date);
      const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
      
      const today = new Date();
      
      for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'month-day';
        
        if (currentDate.getMonth() !== date.getMonth()) {
          dayEl.classList.add('other-month');
        }
        
        if (formatDate(currentDate) === formatDate(today)) {
          dayEl.classList.add('today');
        }
        
        dayEl.innerHTML = `<div class="month-day-number">${currentDate.getDate()}</div>`;
        
        const dayEvents = calendarEvents.filter(event => event.date === formatDate(currentDate));
        dayEvents.forEach(event => {
          const eventEl = document.createElement('div');
          eventEl.className = 'event-item';
          eventEl.innerHTML = `${event.time} ${event.client_nom.split(' ')[0]}`;
          eventEl.onclick = () => { if (event.url) window.location.href = event.url; };
          dayEl.appendChild(eventEl);
        });
        
        monthGrid.appendChild(dayEl);
      }
    }

    function updateYearView() {
      const year = new Date().getFullYear() + currentOffset;
      document.getElementById('calendar-title').textContent = year;
      
      const yearGrid = document.getElementById('year-grid');
      yearGrid.innerHTML = '';
      
      const today = new Date();
      
      for (let month = 0; month < 12; month++) {
        const monthEl = document.createElement('div');
        monthEl.className = 'month-mini';
        
        const headerEl = document.createElement('div');
        headerEl.className = 'month-mini-header';
        headerEl.textContent = monthsShort[month];
        monthEl.appendChild(headerEl);
        
        const gridEl = document.createElement('div');
        gridEl.className = 'month-mini-grid';
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
        
        for (let i = 0; i < 35; i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          
          const dayEl = document.createElement('div');
          dayEl.className = 'month-mini-day';
          
          if (currentDate.getMonth() === month) {
            dayEl.textContent = currentDate.getDate();
            
            if (formatDate(currentDate) === formatDate(today)) {
              dayEl.classList.add('today');
            }
            
            const hasEvent = calendarEvents.some(event => event.date === formatDate(currentDate));
            if (hasEvent) {
              dayEl.classList.add('has-event');
            }
          }
          
          gridEl.appendChild(dayEl);
        }
        
        monthEl.appendChild(gridEl);
        yearGrid.appendChild(monthEl);
      }
    }

    function updateEventCount() {
      let eventCount = 0;
      
      if (currentView === 'day') {
        const date = new Date();
        date.setDate(date.getDate() + currentOffset);
        eventCount = calendarEvents.filter(event => event.date === formatDate(date)).length;
      } else if (currentView === 'week') {
        const startOfWeek = new Date();
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1 + (currentOffset * 7));
        for (let i = 0; i < 7; i++) {
          const date = new Date(startOfWeek);
          date.setDate(startOfWeek.getDate() + i);
          eventCount += calendarEvents.filter(event => event.date === formatDate(date)).length;
        }
      } else {
        eventCount = calendarEvents.length;
      }
      
      document.getElementById('events-count').textContent = eventCount;
    }

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
      setView('week');
    });
  </script>
  </script>
</body>
</html>