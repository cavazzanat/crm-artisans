<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - CRM Artisans</title>

  {% load static %}
  <link rel="icon" type="image/png" href="{% static 'core/image/favicon.png' %}">
  <style>
    /* ========================================
       VARIABLES - ALIGNÉES SUR LA DA EXISTANTE
       ======================================== */
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #6366f1;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
      --ring: rgba(99,102,241,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding-bottom: 3rem;
    }

    /* ========================================
       HEADER (IDENTIQUE AU RESTE)
       ======================================== */
    .header{
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: saturate(180%) blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .header-inner{
      max-width: 1280px;
      margin: 0 auto;
      padding: .85rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      justify-content: space-between;
    }
    .brand{
      display: flex;
      align-items: center;
      gap: .75rem;
      font-weight: 700;
      letter-spacing: .2px;
      color: var(--text);
    }
    .logo{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: linear-gradient(145deg, var(--primary), var(--accent));
      box-shadow: var(--shadow);
      display: grid;
      place-items: center;
    }
    .logo svg{ width: 18px; height: 18px; color: white }

    .nav{
      display: flex;
      gap: .25rem;
      align-items: center;
    }
    .nav a{
      text-decoration: none;
      color: var(--muted);
      padding: .55rem .8rem;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }
    .nav a:hover{
      color: var(--text);
      background: rgba(148,163,184,.08);
      border-color: var(--border);
    }
    .nav a.active{ 
      color:white; background:rgba(99,102,241,.18); 
      border-color: rgba(99,102,241,.35); box-shadow: 0 0 0 2px var(--ring) 
    }

    .user{
      display: flex;
      align-items: center;
      gap: .75rem;
      color: var(--muted);
      font-size: .95rem;
    }
    .user form button{
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      text-decoration: underline;
      font: inherit;
      padding: 0;
    }
    .user form button:hover{ color: var(--text); }

    /* ========================================
       LAYOUT PRINCIPAL
       ======================================== */
    .container{
      max-width: 1280px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .page-title{
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: .5rem;
      color: var(--text);
    }
    .subtitle{
      color: var(--muted);
      margin-bottom: 1.75rem;
      font-size: .95rem;
    }

/* ========================================
   KPI - VERSION COMPACTE ET ÉLÉGANTE
   ======================================== */
.kpi-grid {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 2rem;
  overflow-x: auto;
  padding-bottom: 0.5rem;
}

.kpi-card {
  background: white;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1rem 1.25rem;
  box-shadow: var(--shadow);
  transition: all 0.2s ease;
  min-width: 160px;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.kpi-card:hover {
  box-shadow: 0 4px 12px rgba(99,102,241,.15);
  border-color: var(--primary);
  background: linear-gradient(135deg, rgba(99,102,241,.02), white);
}

.kpi-card.alert {
  border: 2px solid var(--danger);
  background: linear-gradient(135deg, rgba(239,68,68,.03), rgba(239,68,68,.01));
}

.kpi-card.warning {
  border: 2px solid var(--warning);
  background: linear-gradient(135deg, rgba(245,158,11,.03), rgba(245,158,11,.01));
}

@keyframes pulse-glow {
  0%, 100% { 
    box-shadow: 0 0 0 0 rgba(239,68,68,.4);
  }
  50% { 
    box-shadow: 0 0 0 4px rgba(239,68,68,0);
  }
}

.kpi-card.alert {
  animation: pulse-glow 2s ease-in-out infinite;
}

.kpi-label {
  color: var(--muted);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05rem;
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.kpi-value {
  font-size: 1.75rem;
  font-weight: 800;
  line-height: 1;
  color: var(--text);
}

.kpi-card.alert .kpi-value {
  color: var(--danger);
}

.kpi-card.warning .kpi-value {
  color: var(--warning);
}

.kpi-subtitle {
  color: var(--muted);
  font-size: 0.7rem;
  margin-top: auto;
}

.kpi-subtitle a {
  color: inherit;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.2s;
}

.kpi-subtitle a:hover {
  text-decoration: underline;
}

/* Responsive - scroll horizontal sur mobile */
@media (max-width: 768px) {
  .kpi-grid {
    flex-wrap: nowrap;
    justify-content: flex-start;
  }
  
  .kpi-card {
    min-width: 140px;
  }
}
    /* ========================================
       SECTIONS (STYLE UNIFIÉ)
       ======================================== */
    .section{
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }
    .section-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }
    .section-title{
      display: flex;
      gap: .6rem;
      align-items: center;
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text);
    }
    .section-title .badge{
      font-size: .75rem;
      color: var(--muted);
      padding: .2rem .5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(148,163,184,.08);
      font-weight: 600;
    }

    /* ========================================
       BOUTONS (STYLE UNIFIÉ)
       ======================================== */
    .btn{
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .55rem .8rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      font-size: .9rem;
      transition: all 0.2s;
      font-family: inherit;
    }
    .btn:hover{
      background: #f8fafc;
      border-color: #cbd5e1;
      transform: translateY(-1px);
    }
    .btn.primary{
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .btn.primary:hover{ background: #4f46e5; }
    .btn.success{
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .btn.success:hover{ background: #16a34a; }
    .btn.warning{
      background: var(--warning);
      border-color: var(--warning);
      color: white;
    }
    .btn.warning:hover{ background: #d97706; }

    /* ========================================
       CALENDRIER - NAVIGATION
       ======================================== */
    .calendar-nav{
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .calendar-title{
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
    }
    .calendar-controls{
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .nav-buttons{
      display: flex;
      gap: .5rem;
    }
    .nav-btn{
      padding: .5rem .75rem;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      cursor: pointer;
      border-radius: 8px;
      font-size: .85rem;
      transition: all 0.2s;
    }
    .nav-btn:hover{
      background: #f8fafc;
      border-color: #cbd5e1;
    }

    .view-buttons{
      display: flex;
      gap: .25rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: .25rem;
      background: white;
    }
    .view-btn{
      padding: .4rem .7rem;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      border-radius: 6px;
      font-size: .85rem;
      transition: all 0.2s;
    }
    .view-btn:hover{
      background: rgba(148,163,184,.08);
      color: var(--text);
    }
    .view-btn.active{
      background: var(--primary);
      color: white;
    }

    /* ========================================
       CALENDRIER - VUE SEMAINE
       ======================================== */
    .week-grid{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: .75rem;
    }
    .day-card{
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: .75rem;
      min-height: 140px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .day-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    .day-card.today{
      border-color: var(--primary);
      background: rgba(99,102,241,.05);
    }
    .day-card.selected{
      border-color: var(--warning);
      box-shadow: 0 0 0 2px rgba(245,158,11,.3);
    }
    .day-header{
      font-weight: 600;
      margin-bottom: .5rem;
      font-size: .9rem;
      color: var(--text);
    }
    .day-number{
      color: var(--muted);
      font-size: .8rem;
      margin-bottom: .75rem;
    }
/* ========================================
   ÉVÉNEMENTS - CODE COULEUR SIMPLIFIÉ
   ======================================== */
.event-item{
  border-radius: 6px;
  padding: .4rem .5rem;
  margin: .3rem 0;
  font-size: .75rem;
  cursor: pointer;
  line-height: 1.3;
  transition: all 0.2s ease;
  border: 1px solid;
  display: flex;
  align-items: center;
  gap: .3rem;
}
.event-item:hover{
  transform: translateX(2px);
}

/* ⚪ Gris : Planifié */
.event-item.event-planifie{
  background: rgba(148,163,184,.15);
  border-color: rgba(148,163,184,.3);
  color: #475569;
}
.event-item.event-planifie:hover{
  background: rgba(148,163,184,.25);
}

/* 🔵 Bleu : Réalisé */
.event-item.event-realise{
  background: rgba(59,130,246,.15);
  border-color: rgba(59,130,246,.3);
  color: #1e40af;
}
.event-item.event-realise:hover{
  background: rgba(59,130,246,.25);
}

/* 🟢 Vert : Payé */
.event-item.event-paye{
  background: rgba(34,197,94,.15);
  border-color: rgba(34,197,94,.3);
  color: #166534;
}
.event-item.event-paye:hover{
  background: rgba(34,197,94,.25);
}

/* Icône de statut dans les événements */
.event-status-icon{
  flex-shrink: 0;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
}

@keyframes pulse-attention {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Icône de statut dans les événements */
    .event-status-icon{
      flex-shrink: 0;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    /* ========================================
       CALENDRIER - VUE MOIS
       ======================================== */
    .month-grid{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: .5rem;
    }
    .month-day-header{
      background: #f8fafc;
      color: var(--muted);
      font-size: .75rem;
      font-weight: 600;
      text-align: center;
      padding: .5rem;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: .05rem;
    }
    .month-day-cell{
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: .5rem;
      min-height: 90px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .month-day-cell:hover{
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }
    .month-day-cell.today{
      border-color: var(--primary);
      background: rgba(99,102,241,.05);
    }
    .month-day-cell.other-month{
      opacity: 0.4;
    }
    .month-day-cell.selected{
      border-color: var(--warning);
      box-shadow: 0 0 0 2px rgba(245,158,11,.3);
    }
    .month-day-number{
      font-weight: 600;
      font-size: .85rem;
      margin-bottom: .5rem;
      color: var(--text);
    }
    .month-events{
      display: flex;
      flex-direction: column;
      gap: .2rem;
    }
    .month-event-item{
      background: rgba(99,102,241,.15);
      border: 1px solid rgba(99,102,241,.3);
      border-radius: 4px;
      padding: .2rem .3rem;
      font-size: .65rem;
      line-height: 1.2;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text);
    }
    .month-event-item:hover{
      background: rgba(99,102,241,.25);
      transform: translateY(-1px);
    }
    .month-event-more{
      color: var(--muted);
      font-size: .6rem;
      font-style: italic;
      cursor: pointer;
      padding: .1rem .25rem;
    }
    .month-event-more:hover{
      color: var(--text);
    }

    /* ========================================
       PANNEAU LATÉRAL - REFONTE COMPLÈTE
       ======================================== */
    .side-panel{
      position: fixed;
      top: 0;
      right: -450px;
      width: 450px;
      height: 100vh;
      background: white;
      border-left: 1px solid var(--border);
      box-shadow: -10px 0 25px rgba(0,0,0,.1);
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    .side-panel.open{
      right: 0;
    }
    .panel-header{
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }
    .panel-title{
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: .25rem;
      color: var(--text);
    }
    .panel-subtitle{
      color: var(--muted);
      font-size: .9rem;
    }
    .close-panel{
      position: absolute;
      top: 1.25rem;
      right: 1.25rem;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: .5rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .close-panel:hover{
      background: rgba(148,163,184,.1);
      color: var(--text);
    }
    .panel-content{
      padding: 1.5rem;
    }

    /* Onglets interventions */
    .operation-tabs{
      display: flex;
      gap: .5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      padding-bottom: .75rem;
    }
    .operation-tab{
      padding: .5rem .75rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: .85rem;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.2s ease;
    }
    .operation-tab:hover{
      background: #f8fafc;
      color: var(--text);
    }
    .operation-tab.active{
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* Détails opération */
    .detail-section{
      margin-bottom: 1.5rem;
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }
    .detail-section h4{
      color: var(--text);
      font-size: .85rem;
      margin-bottom: .75rem;
      text-transform: uppercase;
      letter-spacing: .05rem;
      font-weight: 600;
    }
    .detail-item{
      margin-bottom: .75rem;
    }
    .detail-item:last-child{
      margin-bottom: 0;
    }
    .detail-label{
      color: var(--muted);
      font-size: .8rem;
      margin-bottom: .25rem;
      font-weight: 500;
    }
    .detail-value{
      color: var(--text);
      font-size: .95rem;
      font-weight: 500;
    }
    .detail-value.status{
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .3rem .6rem;
      border-radius: 12px;
      font-size: .85rem;
      border: 1px solid;
    }
    .detail-value.status.planifie{
      background: rgba(34,197,94,.1);
      border-color: rgba(34,197,94,.3);
      color: #166534;
    }
    .detail-value.status.attention{
      background: rgba(239,68,68,.1);
      border-color: rgba(239,68,68,.3);
      color: #991b1b;
    }

    /* ========================================
       ACTIONS SIMPLIFIÉES (NOUVEAU)
       ======================================== */
    .quick-actions{
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }
    .quick-action-title{
      font-size: .9rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: .5rem;
    }

    /* Formulaire réalisation */
    .realisation-form{
      background: rgba(34,197,94,.05);
      border: 1px solid rgba(34,197,94,.2);
      border-radius: 8px;
      padding: 1rem;
    }
    .realisation-form .form-group{
      margin-bottom: .75rem;
    }
    .realisation-form label{
      display: block;
      font-size: .85rem;
      color: var(--text);
      margin-bottom: .5rem;
      font-weight: 500;
    }
    .realisation-form input[type="datetime-local"]{
      width: 100%;
      padding: .55rem .7rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      font-size: .9rem;
      font-family: inherit;
    }
    .realisation-form input[type="datetime-local"]:focus{
      outline: none;
      box-shadow: 0 0 0 2px rgba(34,197,94,.2);
      border-color: var(--success);
    }
    .realisation-actions{
      display: flex;
      gap: .5rem;
      margin-top: .75rem;
    }
    .realisation-actions .btn{
      flex: 1;
    }

    /* Replanification */
    .replanification-form{
      background: rgba(245,158,11,.05);
      border: 1px solid rgba(245,158,11,.2);
      border-radius: 8px;
      padding: 1rem;
    }
    .replanification-form input[type="datetime-local"]{
      width: 100%;
      padding: .55rem .7rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      font-size: .9rem;
      font-family: inherit;
    }
    .replanification-form input[type="datetime-local"]:focus{
      outline: none;
      box-shadow: 0 0 0 2px rgba(245,158,11,.2);
      border-color: var(--warning);
    }

    /* Lien vers fiche complète */
    .panel-footer{
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      background: #f8fafc;
    }
    .panel-footer .btn{
      width: 100%;
      justify-content: center;
    }

    /* ========================================
       OVERLAY
       ======================================== */
    .overlay{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,.3);
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    /* ========================================
   COMMENTAIRES DANS PANNEAU LATÉRAL
   ======================================== */
.commentaires-textarea {
  width: 100%;
  padding: .65rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  color: var(--text);
  font-family: inherit;
  font-size: .9rem;
  resize: vertical;
  transition: all 0.2s ease;
  min-height: 100px;
}

.commentaires-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99,102,241,.1);
}

.commentaires-textarea::placeholder {
  color: var(--muted);
  opacity: 0.6;
}

.commentaires-actions {
  display: flex;
  gap: .5rem;
  margin-top: .75rem;
}

.commentaires-actions .btn {
  flex: 1;
}

#commentaires-text:empty::before {
  content: 'Aucun commentaire';
  color: var(--muted);
  font-style: italic;
  font-size: .85rem;
}

    /* ========================================
       RESPONSIVE
       ======================================== */
    @media (max-width: 768px){
      .kpi-grid{
        grid-template-columns: 1fr;
      }
      .week-grid{
        grid-template-columns: 1fr;
        gap: .5rem;
      }
      .month-grid{
        gap: .25rem;
      }
      .month-day-cell{
        min-height: 70px;
        padding: .35rem;
      }
      .month-event-item{
        font-size: .6rem;
        padding: .15rem .25rem;
      }
      .calendar-nav{
        flex-direction: column;
        align-items: flex-start;
      }
      .calendar-controls{
        width: 100%;
        justify-content: space-between;
      }
      .side-panel{
        width: 100%;
        right: -100%;
      }
    }
  </style>
</head>
<body>
  {% csrf_token %}
  
  <!-- HEADER -->
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 14.5 12 4l8 10.5-8 5.5-8-5.5Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <span>CRM Artisans</span>
      </div>
      <nav class="nav">
        <a href="{% url 'dashboard' %}" class="active">Accueil</a>
        <a href="{% url 'operations' %}">Opérations</a>
        <a href="{% url 'clients' %}">Clients</a>
      </nav>
      <div class="user">
        <span>{{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit">Déconnexion</button>
        </form>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="container">
    <h1 class="page-title">Tableau de bord</h1>
    <p class="subtitle">Vue d'ensemble de vos performances et planning</p>

    <!-- KPI -->
    <div class="kpi-grid">
      <!-- Clients -->
      <div class="kpi-card">
        <div class="kpi-label">👥 Clients</div>
        <div class="kpi-value">{{ nb_clients }}</div>
        <div class="kpi-subtitle">Actifs</div>
      </div>

      <!-- CA du mois -->
      <div class="kpi-card">
        <div class="kpi-label">💰 CA du mois</div>
        <div class="kpi-value">{{ ca_mois|floatformat:0 }} €</div>
        <div class="kpi-subtitle">Encaissé</div>
      </div>

      <!-- Devis en attente -->
      <div class="kpi-card">
        <div class="kpi-label">📄 Devis</div>
        <div class="kpi-value">{{ nb_en_attente_devis }}</div>
        <div class="kpi-subtitle">En attente</div>
      </div>

      <!-- À planifier -->
      <div class="kpi-card">
        <div class="kpi-label">📅 À planifier</div>
        <div class="kpi-value">{{ nb_a_planifier }}</div>
        <div class="kpi-subtitle">Interventions</div>
      </div>

      <!-- Paiements en retard -->
      {% if nb_paiements_retard > 0 %}
      <div class="kpi-card alert">
        <div class="kpi-label">🚨 Retards</div>
        <div class="kpi-value">{{ nb_paiements_retard }}</div>
        <div class="kpi-subtitle">
          <a href="{% url 'operations' %}?filtre=retards">À relancer →</a>
        </div>
      </div>
      {% endif %}

      <!-- Paiements non planifiés -->
      {% if nb_operations_sans_paiement > 0 %}
      <div class="kpi-card warning">
        <div class="kpi-label">⚠️ Non planifiés</div>
        <div class="kpi-value">{{ nb_operations_sans_paiement }}</div>
        <div class="kpi-subtitle">
          <a href="{% url 'operations' %}?filtre=non_planifies">À enregistrer →</a>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- PLANNING -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Planning des interventions
          <span class="badge" id="events-count">0</span>
        </h2>
        <div>
          <a href="{% url 'operation_create' %}" class="btn primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/>
            </svg>
            Nouvelle opération
          </a>
        </div>
      </div>

      <!-- ✅ NOUVELLE LÉGENDE -->
      <div style="display:flex; gap:1rem; margin-bottom:1rem; flex-wrap:wrap; align-items:center; padding:0.75rem; background:#f8fafc; border-radius:8px; border:1px solid var(--border)">
        <span style="font-size:.85rem; font-weight:600; color:var(--muted)">Légende :</span>
        <div style="display:flex; align-items:center; gap:.4rem">
          <span style="width:12px; height:12px; border-radius:50%; background:#94a3b8"></span>
          <span style="font-size:.85rem; color:var(--text)">Planifié</span>
        </div>
        <div style="display:flex; align-items:center; gap:.4rem">
          <span style="width:12px; height:12px; border-radius:50%; background:#3b82f6"></span>
          <span style="font-size:.85rem; color:var(--text)">Réalisé</span>
        </div>
        <div style="display:flex; align-items:center; gap:.4rem">
          <span style="width:12px; height:12px; border-radius:50%; background:#22c55e"></span>
          <span style="font-size:.85rem; color:var(--text)">Payé</span>
        </div>
        <span style="font-size:.75rem; color:var(--muted); margin-left:auto">
          💡 Seules les opérations planifiées apparaissent ici
        </span>
      </div>

      <div class="calendar-nav">
        <div class="calendar-title" id="calendar-title">Semaine courante</div>
        <div class="calendar-controls">
          <div class="nav-buttons">
            <button class="nav-btn" onclick="navigateCalendar(-1)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
            <button class="nav-btn" onclick="navigateCalendar(0)">Aujourd'hui</button>
            <button class="nav-btn" onclick="navigateCalendar(1)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <div class="view-buttons">
            <button class="view-btn" onclick="setView('day')" id="day-btn">Jour</button>
            <button class="view-btn active" onclick="setView('week')" id="week-btn">Semaine</button>
            <button class="view-btn" onclick="setView('month')" id="month-btn">Mois</button>
          </div>
        </div>
      </div>

      <div class="calendar-view">
        <div class="week-grid" id="calendar-grid"><!-- Généré par JS --></div>
      </div>
    </section>

    <!-- ACTIONS RAPIDES -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Actions rapides
        </h2>
      </div>
      <div style="display:flex; gap:.75rem; flex-wrap:wrap">
        <a href="{% url 'operation_create' %}" class="btn primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/>
          </svg>
          Nouvelle opération
        </a>
        <a href="{% url 'clients' %}" class="btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Voir les clients
        </a>
        <a href="{% url 'client_create' %}" class="btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M12.5 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0ZM20 8v6M23 11h-6" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Nouveau client
        </a>
      </div>
    </section>
  </main>

  <!-- PANNEAU LATÉRAL AVEC COMMENTAIRES -->
<div class="side-panel" id="side-panel">
  <div class="panel-header">
    <div class="panel-title" id="panel-title">Intervention</div>
    <div class="panel-subtitle" id="panel-date">-</div>
    <button class="close-panel" onclick="closeSidePanel()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
      </svg>
    </button>
  </div>

  <div class="panel-content">
    <!-- Onglets si plusieurs interventions le même jour -->
    <div class="operation-tabs" id="operation-tabs"></div>

    <!-- Détails intervention -->
    <div class="detail-section">
      <h4>📋 Intervention</h4>
      <div class="detail-item">
        <div class="detail-label">Service</div>
        <div class="detail-value" id="detail-service">-</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Horaire prévu</div>
        <div class="detail-value" id="detail-time">-</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Adresse</div>
        <div class="detail-value" id="detail-address">-</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Statut</div>
        <div class="detail-value status" id="detail-status">-</div>
      </div>
    </div>

    <!-- Détails client -->
    <div class="detail-section">
      <h4>👤 Client</h4>
      <div class="detail-item">
        <div class="detail-label">Nom</div>
        <div class="detail-value" id="detail-client">-</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Téléphone</div>
        <div class="detail-value">
          <a href="#" id="detail-phone" style="color:var(--primary); text-decoration:none">-</a>
        </div>
      </div>
    </div>

    <!-- ✅ NOUVEAU : SECTION COMMENTAIRES -->
    <div class="detail-section">
      <h4>📝 Commentaire / Constat</h4>
      <form id="form-commentaires" method="POST" style="display:none">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_commentaires_dashboard">
        <textarea 
          id="commentaires-textarea" 
          name="commentaires" 
          class="commentaires-textarea" 
          rows="4" 
          placeholder="Ex: Client absent, travaux supplémentaires identifiés, matériel manquant..."
        ></textarea>
        <div class="commentaires-actions">
          <button type="submit" class="btn success">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/>
            </svg>
            Enregistrer
          </button>
          <button type="button" class="btn" onclick="cancelCommentaires()">Annuler</button>
        </div>
      </form>
      
      <!-- Affichage commentaire existant ou bouton ajouter -->
      <div id="commentaires-display">
        <div id="commentaires-text" style="color:var(--text); font-size:.9rem; line-height:1.5; margin-bottom:.75rem; white-space:pre-wrap"></div>
        <button type="button" class="btn" id="btn-edit-commentaires" onclick="startEditCommentaires()" style="width:100%">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          <span id="btn-commentaires-text">Ajouter un commentaire</span>
        </button>
      </div>
    </div>

    <!-- ACTIONS SIMPLIFIÉES -->
    <div class="quick-actions">
      
      <!-- ✅ ACTION 1 : VALIDER LA RÉALISATION -->
      <div id="action-realisation" style="display:none">
        <div class="quick-action-title">✅ Valider la réalisation</div>
        <div class="realisation-form">
          <form id="form-realisation" method="POST" style="display:none">
            {% csrf_token %}
            <input type="hidden" name="action" value="valider_realisation">
            <div class="form-group">
              <label for="date-realisation">Date de réalisation</label>
              <input type="datetime-local" id="date-realisation" name="date_realisation" required>
              <small style="display:block; margin-top:.5rem; color:var(--muted); font-size:.8rem">
                💡 Pré-rempli avec la date prévue
              </small>
            </div>
            <div class="realisation-actions">
              <button type="submit" class="btn success">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/>
                </svg>
                Confirmer
              </button>
              <button type="button" class="btn" onclick="cancelRealisation()">Annuler</button>
            </div>
          </form>
          <button type="button" class="btn success" id="btn-start-realisation" onclick="startRealisation()" style="width:100%">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="2"/>
            </svg>
            Opération réalisée
          </button>
        </div>
      </div>

      <!-- 🔄 ACTION 2 : REPLANIFIER -->
      <div id="action-replanifier" style="display:none">
        <div class="quick-action-title">🔄 Replanifier l'intervention</div>
        <div class="replanification-form">
          <form id="form-replanification" method="POST" style="display:none">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_planning">
            <div class="form-group">
              <label for="date-replanification">Nouvelle date</label>
              <input type="datetime-local" id="date-replanification" name="date_prevue" required>
            </div>
            <div class="realisation-actions">
              <button type="submit" class="btn warning">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="M8 2v4M16 2v4M3 10h18" stroke="currentColor" stroke-width="1.6"/>
                </svg>
                Replanifier
              </button>
              <button type="button" class="btn" onclick="cancelReplanification()">Annuler</button>
            </div>
          </form>
          <button type="button" class="btn warning" id="btn-start-replanification" onclick="startReplanification()" style="width:100%">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M8 2v4M16 2v4M3 10h18" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            Replanifier
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Lien vers fiche complète -->
  <div class="panel-footer">
    <a href="#" class="btn primary" id="detail-btn-full">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" stroke="currentColor" stroke-width="1.6"/>
        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" stroke="currentColor" stroke-width="1.6"/>
      </svg>
      Voir la fiche complète
    </a>
  </div>
</div>

  <!-- OVERLAY -->
  <div class="overlay" id="overlay" onclick="closeSidePanel()"></div>

  <script>
    // ========================================
    // VARIABLES GLOBALES
    // ========================================
    let calendarEvents = [];
    let currentView = 'week';
    let currentOffset = 0;
    let selectedDate = null;
    let selectedDayEvents = [];
    let currentOperationIndex = 0;
    let currentOperation = null;

    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    const monthsShort = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
    const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

    // ========================================
    // INITIALISATION
    // ========================================
    function initCalendarEvents() {
      try {
        const jsonData = '{{ calendar_events_json|escapejs }}';
        if (jsonData && jsonData !== 'null' && jsonData !== 'undefined') {
          calendarEvents = JSON.parse(jsonData);
        } else {
          calendarEvents = [];
        }
      } catch (e) {
        console.error('Erreur parsing calendar_events_json:', e);
        calendarEvents = [];
      }
    }

    // ========================================
    // UTILITAIRES
    // ========================================
    function formatDate(date) {
      return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
    }

    function getWeekDates(offset = 0) {
      const today = new Date();
      const monday = new Date(today);
      monday.setDate(today.getDate() - today.getDay() + 1 + (offset * 7));
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        dates.push(date);
      }
      return dates;
    }

    function getNowFormatted() {
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      return now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
    }

    // ========================================
    // NAVIGATION VUES
    // ========================================
    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(view + '-btn').classList.add('active');
      renderCalendar();
    }

    function navigateCalendar(direction) {
      if (direction === 0) currentOffset = 0;
      else currentOffset += direction;
      renderCalendar();
    }

    // ========================================
    // RENDU CALENDRIER
    // ========================================
    function renderCalendar() {
      closeSidePanel();
      if (currentView === 'week') renderWeekView();
      else if (currentView === 'day') renderDayView();
      else if (currentView === 'month') renderMonthView();
      updateEventCount();
    }

    function renderWeekView() {
      const weekDates = getWeekDates(currentOffset);
      const today = new Date();
      const grid = document.getElementById('calendar-grid');

      const startDate = weekDates[0];
      const endDate = weekDates[6];
      document.getElementById('calendar-title').textContent =
        `${startDate.getDate()} ${monthsShort[startDate.getMonth()]} - ${endDate.getDate()} ${monthsShort[endDate.getMonth()]} ${endDate.getFullYear()}`;

      grid.innerHTML = '';
      grid.className = 'week-grid';

      weekDates.forEach((date, index) => {
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (formatDate(date) === formatDate(today)) dayCard.classList.add('today');

        dayCard.innerHTML = `
          <div class="day-header">${dayNames[index]}</div>
          <div class="day-number">${date.getDate()} ${monthsShort[date.getMonth()]}</div>
        `;

        const dayEvents = calendarEvents.filter(event => event.date === formatDate(date));
        dayEvents.forEach((event, eventIndex) => {
          const eventEl = document.createElement('div');
          eventEl.className = `event-item ${event.color_class || 'event-default'}`;
          eventEl.innerHTML = `
            <span class="event-status-icon"></span>
            <span>${event.time || ''} ${event.client_nom || ''}</span>
          `;
          eventEl.onclick = (e) => {
            e.stopPropagation();
            handleEventClick(formatDate(date), dayEvents, eventIndex);
          };
          dayCard.appendChild(eventEl);
        });

        if (dayEvents.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.style.cssText = 'color:var(--muted); font-size:.8rem; font-style:italic; margin-top:.5rem';
          emptyMsg.textContent = 'Aucune intervention';
          dayCard.appendChild(emptyMsg);
        }

        dayCard.onclick = (e) => {
          if (dayEvents.length > 0 && (e.target === dayCard || e.target.classList.contains('day-header') || e.target.classList.contains('day-number'))) {
            handleEventClick(formatDate(date), dayEvents, 0);
          }
        };
        grid.appendChild(dayCard);
      });
    }

    function renderDayView() {
      const date = new Date();
      date.setDate(date.getDate() + currentOffset);

      document.getElementById('calendar-title').textContent =
        date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      grid.className = 'day-timeline';

      const dayEvents = calendarEvents.filter(event => event.date === formatDate(date));
      const dayCard = document.createElement('div');
      dayCard.className = 'day-card';
      dayCard.style.minHeight = '200px';
      dayCard.innerHTML = `<div class="day-header">Interventions du ${date.getDate()} ${monthsShort[date.getMonth()]}</div>`;

      dayEvents.forEach((event, eventIndex) => {
        const eventEl = document.createElement('div');
        eventEl.className = `event-item ${event.color_class || 'event-default'}`;
        eventEl.innerHTML = `
          <span class="event-status-icon"></span>
          <span>${event.time || ''} ${event.client_nom || ''}</span>
        `;
        eventEl.onclick = (e) => {
          e.stopPropagation();
          handleEventClick(formatDate(date), dayEvents, eventIndex);
        };
        dayCard.appendChild(eventEl);
      });

      if (dayEvents.length === 0) {
        dayCard.innerHTML += '<p style="color:var(--muted); font-style:italic; margin-top:1rem">Aucune intervention prévue</p>';
      }
      grid.appendChild(dayCard);
    }

    function renderMonthView() {
      const today = new Date();
      const currentMonth = new Date(today.getFullYear(), today.getMonth() + currentOffset, 1);

      document.getElementById('calendar-title').textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      grid.className = 'month-grid';

      const firstDay = new Date(currentMonth);
      const startOfWeek = new Date(firstDay);
      const dayOfWeek = (firstDay.getDay() + 6) % 7;
      startOfWeek.setDate(firstDay.getDate() - dayOfWeek);

      // En-têtes jours
      dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'month-day-header';
        dayHeader.textContent = day;
        grid.appendChild(dayHeader);
      });

      // Cases jours
      for (let week = 0; week < 6; week++) {
        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
          const cellDate = new Date(startOfWeek);
          cellDate.setDate(startOfWeek.getDate() + (week * 7) + dayIndex);

          const dayCell = document.createElement('div');
          dayCell.className = 'month-day-cell';
          const isCurrentMonth = cellDate.getMonth() === currentMonth.getMonth();
          const isToday = formatDate(cellDate) === formatDate(today);
          if (!isCurrentMonth) dayCell.classList.add('other-month');
          if (isToday) dayCell.classList.add('today');

          const dayNumber = document.createElement('div');
          dayNumber.className = 'month-day-number';
          dayNumber.textContent = cellDate.getDate();
          dayCell.appendChild(dayNumber);

          const dayEvents = calendarEvents.filter(event => event.date === formatDate(cellDate));
          if (dayEvents.length > 0) {
            const eventContainer = document.createElement('div');
            eventContainer.className = 'month-events';

            dayEvents.slice(0, 2).forEach((event, index) => {
              const eventEl = document.createElement('div');
              eventEl.className = 'month-event-item';
              eventEl.innerHTML = `${event.time || ''} ${event.client_nom || ''}`;
              eventEl.onclick = (e) => {
                e.stopPropagation();
                handleEventClick(formatDate(cellDate), dayEvents, index);
              };
              eventContainer.appendChild(eventEl);
            });

            if (dayEvents.length > 2) {
              const moreEl = document.createElement('div');
              moreEl.className = 'month-event-more';
              moreEl.textContent = `+${dayEvents.length - 2} autre${dayEvents.length - 2 > 1 ? 's' : ''}`;
              moreEl.onclick = () => handleEventClick(formatDate(cellDate), dayEvents, 0);
              eventContainer.appendChild(moreEl);
            }
            dayCell.appendChild(eventContainer);
          }

          dayCell.onclick = () => {
            if (dayEvents.length > 0) handleEventClick(formatDate(cellDate), dayEvents, 0);
          };
          grid.appendChild(dayCell);
        }
      }
    }

    function updateEventCount() {
      let count = 0;
      if (currentView === 'day') {
        const date = new Date();
        date.setDate(date.getDate() + currentOffset);
        count = calendarEvents.filter(event => event.date === formatDate(date)).length;
      } else if (currentView === 'week') {
        const weekDates = getWeekDates(currentOffset);
        weekDates.forEach(date => {
          count += calendarEvents.filter(event => event.date === formatDate(date)).length;
        });
      } else if (currentView === 'month') {
        const today = new Date();
        const currentMonth = new Date(today.getFullYear(), today.getMonth() + currentOffset, 1);
        const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
        count = calendarEvents.filter(event => {
          const d = new Date(event.date);
          return d >= currentMonth && d < nextMonth;
        }).length;
      }
      document.getElementById('events-count').textContent = count;
    }

    // ========================================
    // PANNEAU LATÉRAL
    // ========================================
    function handleEventClick(dateStr, dayEvents, operationIndex) {
      selectedDate = dateStr;
      selectedDayEvents = dayEvents;
      currentOperationIndex = operationIndex;
      currentOperation = dayEvents[operationIndex];

      document.querySelectorAll('.day-card, .month-day-cell').forEach(card => card.classList.remove('selected'));
      const dayElements = document.querySelectorAll('.day-card, .month-day-cell');
      dayElements.forEach(el => {
        const dayNumber = el.querySelector('.day-number, .month-day-number');
        if (dayNumber) {
          const eventDate = new Date(dateStr);
          if (parseInt(dayNumber.textContent) === eventDate.getDate()) {
            el.classList.add('selected');
          }
        }
      });
      openSidePanel();
    }

    function openSidePanel() {
      document.getElementById('side-panel').classList.add('open');
      document.getElementById('overlay').style.display = 'block';
      updatePanelContent();
    }

    function closeSidePanel() {
      document.getElementById('side-panel').classList.remove('open');
      document.getElementById('overlay').style.display = 'none';
      document.querySelectorAll('.day-card, .month-day-cell').forEach(card => card.classList.remove('selected'));
      selectedDate = null;
      selectedDayEvents = [];
      currentOperation = null;
      
      // Reset formulaires
      cancelRealisation();
      cancelReplanification();
    }

    function updatePanelContent() {
      if (!selectedDate || selectedDayEvents.length === 0 || !currentOperation) return;

      const date = new Date(selectedDate);
      const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      document.getElementById('panel-date').textContent = dateStr;
      document.getElementById('panel-title').textContent = `Intervention - ${currentOperation.client_nom || ''}`;

      // Onglets si plusieurs interventions
      const tabsContainer = document.getElementById('operation-tabs');
      tabsContainer.innerHTML = '';
      if (selectedDayEvents.length > 1) {
        selectedDayEvents.forEach((event, index) => {
          const tab = document.createElement('div');
          tab.className = `operation-tab ${index === currentOperationIndex ? 'active' : ''}`;
          tab.textContent = `${event.time || '--:--'} ${event.client_nom || ''}`;
          tab.onclick = () => switchOperation(index);
          tabsContainer.appendChild(tab);
        });
      }

      updateOperationDetails();
    }

    function switchOperation(index) {
      currentOperationIndex = index;
      currentOperation = selectedDayEvents[index];
      updateOperationDetails();
      document.querySelectorAll('.operation-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
      });
    }

function updateOperationDetails() {
  if (!currentOperation) return;

  document.getElementById('detail-service').textContent = currentOperation.service || '-';
  document.getElementById('detail-time').textContent = currentOperation.time || '-';
  document.getElementById('detail-address').textContent = currentOperation.address || '-';
  document.getElementById('detail-client').textContent = currentOperation.client_nom || '-';
  
  const phoneLink = document.getElementById('detail-phone');
  phoneLink.textContent = currentOperation.phone || '-';
  phoneLink.href = currentOperation.phone ? `tel:${currentOperation.phone}` : '#';

  // Statut avec badge
  const statusEl = document.getElementById('detail-status');
  statusEl.textContent = currentOperation.statut_display || '-';
  statusEl.className = 'detail-value status';
  if (currentOperation.color_class) {
    if (currentOperation.color_class.includes('planifie')) {
      statusEl.classList.add('planifie');
    } else if (currentOperation.color_class.includes('attention')) {
      statusEl.classList.add('attention');
    }
  }

  // Lien fiche complète
  const btnFull = document.getElementById('detail-btn-full');
  btnFull.href = currentOperation.url || '#';

  // Définir les actions URL pour les formulaires
  const formRealisation = document.getElementById('form-realisation');
  const formReplanification = document.getElementById('form-replanification');
  const formCommentaires = document.getElementById('form-commentaires');
  
  if (formRealisation && currentOperation.url) {
    formRealisation.action = currentOperation.url;
  }
  if (formReplanification && currentOperation.url) {
    formReplanification.action = currentOperation.url;
  }
  if (formCommentaires && currentOperation.url) {
    formCommentaires.action = currentOperation.url;
  }

  // ✅ NOUVEAU : Afficher les commentaires existants
  const commentairesText = document.getElementById('commentaires-text');
  const btnCommentairesText = document.getElementById('btn-commentaires-text');
  
  if (currentOperation.commentaires && currentOperation.commentaires.trim()) {
    commentairesText.textContent = currentOperation.commentaires;
    btnCommentairesText.textContent = 'Modifier le commentaire';
  } else {
    commentairesText.textContent = '';
    btnCommentairesText.textContent = 'Ajouter un commentaire';
  }

  // Logique d'affichage des actions
  const actionRealisation = document.getElementById('action-realisation');
  const actionReplanifier = document.getElementById('action-replanifier');

  actionRealisation.style.display = 'none';
  actionReplanifier.style.display = 'none';

  if (currentOperation.statut === 'planifie') {
    actionRealisation.style.display = 'block';
    actionReplanifier.style.display = 'block';
  } else if (currentOperation.statut === 'a_planifier') {
    actionReplanifier.style.display = 'block';
  }
}

// ========================================
// GESTION DES COMMENTAIRES
// ========================================
function startEditCommentaires() {
  document.getElementById('commentaires-display').style.display = 'none';
  document.getElementById('form-commentaires').style.display = 'block';
  
  // Pré-remplir avec le commentaire existant
  const textarea = document.getElementById('commentaires-textarea');
  if (currentOperation && currentOperation.commentaires) {
    textarea.value = currentOperation.commentaires;
  } else {
    textarea.value = '';
  }
  
  // Focus sur le textarea
  textarea.focus();
}

function cancelCommentaires() {
  document.getElementById('commentaires-display').style.display = 'block';
  document.getElementById('form-commentaires').style.display = 'none';
}

// Reset lors de la fermeture du panneau
function closeSidePanel() {
  document.getElementById('side-panel').classList.remove('open');
  document.getElementById('overlay').style.display = 'none';
  document.querySelectorAll('.day-card, .month-day-cell').forEach(card => card.classList.remove('selected'));
  selectedDate = null;
  selectedDayEvents = [];
  currentOperation = null;
  
  // Reset formulaires
  cancelRealisation();
  cancelReplanification();
  cancelCommentaires();  // ← Ajouté
}

    // ========================================
    // ACTIONS SIMPLIFIÉES
    // ========================================

    // RÉALISATION
    function startRealisation() {
      document.getElementById('btn-start-realisation').style.display = 'none';
      document.getElementById('form-realisation').style.display = 'block';

      // Pré-remplir avec la date de l'opération si disponible
      const dateRealisationInput = document.getElementById('date-realisation');
      if (currentOperation && currentOperation.date && currentOperation.time) {
        const dateStr = currentOperation.date + 'T' + currentOperation.time;
        dateRealisationInput.value = dateStr;
      } else {
        dateRealisationInput.value = getNowFormatted();
      }
    }

    function cancelRealisation() {
      document.getElementById('btn-start-realisation').style.display = 'block';
      document.getElementById('form-realisation').style.display = 'none';
    }

    // REPLANIFICATION
    function startReplanification() {
      document.getElementById('btn-start-replanification').style.display = 'none';
      document.getElementById('form-replanification').style.display = 'block';

      // Pré-remplir avec date actuelle + 1 jour
      const dateReplanificationInput = document.getElementById('date-replanification');
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(9, 0, 0, 0);
      const pad = n => String(n).padStart(2, '0');
      dateReplanificationInput.value = tomorrow.getFullYear() + '-' +
        pad(tomorrow.getMonth() + 1) + '-' +
        pad(tomorrow.getDate()) + 'T09:00';
    }

    function cancelReplanification() {
      document.getElementById('btn-start-replanification').style.display = 'block';
      document.getElementById('form-replanification').style.display = 'none';
    }

    // ========================================
    // INITIALISATION
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      initCalendarEvents();
      renderCalendar();
    });
  </script>

  {% if messages %}
  {% for message in messages %}
  <div class="alert {{ message.tags }}" style="position:fixed; top:80px; left:50%; transform:translateX(-50%); z-index:9999; padding:1rem 1.5rem; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); background:white; border:1px solid var(--border)">
    {{ message }}
  </div>
  {% endfor %}

  <script>
  setTimeout(function() {
    document.querySelectorAll('.alert').forEach(el => {
      el.style.opacity = '0';
      el.style.transition = 'opacity 0.3s';
      setTimeout(() => el.remove(), 300);
    });
  }, 3000);
  </script>
  {% endif %}
</body>
</html>